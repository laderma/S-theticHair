"use strict";var grunt=require("../grunt"),fs=require("fs"),path=require("path"),file=module.exports={};file.glob=require("glob"),file.minimatch=require("minimatch"),file.findup=require("findup-sync");var YAML=require("js-yaml"),rimraf=require("rimraf"),iconv=require("iconv-lite"),win32="win32"===process.platform,unixifyPath=function(e){return win32?e.replace(/\\/g,"/"):e};file.setBase=function(){var e=path.join.apply(path,arguments);process.chdir(e)};var processPatterns=function(e,n){var t=[];return grunt.util._.flatten(e).forEach(function(e){var r=0===e.indexOf("!");r&&(e=e.slice(1));var a=n(e);t=r?grunt.util._.difference(t,a):grunt.util._.union(t,a)}),t};file.match=function(e,n,t){return"object"!==grunt.util.kindOf(e)&&(t=n,n=e,e={}),null==n||null==t?[]:(Array.isArray(n)||(n=[n]),Array.isArray(t)||(t=[t]),0===n.length||0===t.length?[]:processPatterns(n,function(n){return file.minimatch.match(t,n,e)}))},file.isMatch=function(){return file.match.apply(file,arguments).length>0},file.expand=function(){var e=grunt.util.toArray(arguments),n="object"===grunt.util.kindOf(e[0])?e.shift():{},t=Array.isArray(e[0])?e[0]:e;if(0===t.length)return[];var r=processPatterns(t,function(e){return file.glob.sync(e,n)});return n.filter&&(r=r.filter(function(e){e=path.join(n.cwd||"",e);try{return"function"==typeof n.filter?n.filter(e):fs.statSync(e)[n.filter]()}catch(t){return!1}})),r};var pathSeparatorRe=/[\/\\]/g,extDotRe={first:/(\.[^\/]*)?$/,last:/(\.[^\/\.]*)?$/};file.expandMapping=function(e,n,t){t=grunt.util._.defaults({},t,{extDot:"first",rename:function(e,n){return path.join(e||"",n)}});var r=[],a={};return file.expand(t,e).forEach(function(e){var i=e;t.flatten&&(i=path.basename(i)),"ext"in t&&(i=i.replace(extDotRe[t.extDot],t.ext));var s=t.rename(n,i,t);t.cwd&&(e=path.join(t.cwd,e)),s=s.replace(pathSeparatorRe,"/"),e=e.replace(pathSeparatorRe,"/"),a[s]?a[s].src.push(e):(r.push({src:[e],dest:s}),a[s]=r[r.length-1])}),r},file.mkdir=function(e,n){grunt.option("no-write")||(null==n&&(n=parseInt("0777",8)&~process.umask()),e.split(pathSeparatorRe).reduce(function(e,t){e+=t+"/";var r=path.resolve(e);if(!file.exists(r))try{fs.mkdirSync(r,n)}catch(a){throw grunt.util.error('Unable to create directory "'+r+'" (Error code: '+a.code+").",a)}return e},""))},file.recurse=function e(n,t,r){var a=r?path.join(n,r):n;fs.readdirSync(a).forEach(function(i){var s=path.join(a,i);fs.statSync(s).isDirectory()?e(n,t,unixifyPath(path.join(r||"",i||""))):t(unixifyPath(s),n,r,i)})},file.defaultEncoding="utf8",file.preserveBOM=!1,file.read=function(e,n){n||(n={});var t;grunt.verbose.write("Reading "+e+"...");try{return t=fs.readFileSync(String(e)),null!==n.encoding&&(t=iconv.decode(t,n.encoding||file.defaultEncoding),file.preserveBOM||65279!==t.charCodeAt(0)||(t=t.substring(1))),grunt.verbose.ok(),t}catch(r){throw grunt.verbose.error(),grunt.util.error('Unable to read "'+e+'" file (Error code: '+r.code+").",r)}},file.readJSON=function(e,n){var r,t=file.read(e,n);grunt.verbose.write("Parsing "+e+"...");try{return r=JSON.parse(t),grunt.verbose.ok(),r}catch(a){throw grunt.verbose.error(),grunt.util.error('Unable to parse "'+e+'" file ('+a.message+").",a)}},file.readYAML=function(e,n){var r,t=file.read(e,n);grunt.verbose.write("Parsing "+e+"...");try{return r=YAML.load(t),grunt.verbose.ok(),r}catch(a){throw grunt.verbose.error(),grunt.util.error('Unable to parse "'+e+'" file ('+a.problem+").",a)}},file.write=function(e,n,t){t||(t={});var r=grunt.option("no-write");grunt.verbose.write((r?"Not actually writing ":"Writing ")+e+"..."),file.mkdir(path.dirname(e));try{return Buffer.isBuffer(n)||(n=iconv.encode(n,t.encoding||file.defaultEncoding)),r||fs.writeFileSync(e,n),grunt.verbose.ok(),!0}catch(a){throw grunt.verbose.error(),grunt.util.error('Unable to write "'+e+'" file (Error code: '+a.code+").",a)}},file.copy=function(e,n,t){t||(t={});var r=t.process&&t.noProcess!==!0&&!(t.noProcess&&file.isMatch(t.noProcess,e)),a=r?t:{encoding:null},i=file.read(e,a);if(r){grunt.verbose.write("Processing source...");try{i=t.process(i,e),grunt.verbose.ok()}catch(s){throw grunt.verbose.error(),grunt.util.error('Error while processing "'+e+'" file.',s)}}i===!1?grunt.verbose.writeln("Write aborted."):file.write(n,i,a)},file["delete"]=function(e,n){e=String(e);var t=grunt.option("no-write");if(n||(n={force:grunt.option("force")||!1}),grunt.verbose.write((t?"Not actually deleting ":"Deleting ")+e+"..."),!file.exists(e))return grunt.verbose.error(),grunt.log.warn("Cannot delete nonexistent file."),!1;if(!n.force){if(file.isPathCwd(e))return grunt.verbose.error(),grunt.fail.warn("Cannot delete the current working directory."),!1;if(!file.isPathInCwd(e))return grunt.verbose.error(),grunt.fail.warn("Cannot delete files outside the current working directory."),!1}try{return t||rimraf.sync(e),grunt.verbose.ok(),!0}catch(r){throw grunt.verbose.error(),grunt.util.error('Unable to delete "'+e+'" file ('+r.message+").",r)}},file.exists=function(){var e=path.join.apply(path,arguments);return fs.existsSync(e)},file.isLink=function(){var e=path.join.apply(path,arguments);return file.exists(e)&&fs.lstatSync(e).isSymbolicLink()},file.isDir=function(){var e=path.join.apply(path,arguments);return file.exists(e)&&fs.statSync(e).isDirectory()},file.isFile=function(){var e=path.join.apply(path,arguments);return file.exists(e)&&fs.statSync(e).isFile()},file.isPathAbsolute=function(){var e=path.join.apply(path,arguments);return path.resolve(e)===e.replace(/[\/\\]+$/,"")},file.arePathsEquivalent=function(e){e=path.resolve(e);for(var n=1;n<arguments.length;n++)if(e!==path.resolve(arguments[n]))return!1;return!0},file.doesPathContain=function(e){e=path.resolve(e);for(var n,t=1;t<arguments.length;t++)if(n=path.relative(path.resolve(arguments[t]),e),""===n||/\w+/.test(n))return!1;return!0},file.isPathCwd=function(){var e=path.join.apply(path,arguments);try{return file.arePathsEquivalent(fs.realpathSync(process.cwd()),fs.realpathSync(e))}catch(n){return!1}},file.isPathInCwd=function(){var e=path.join.apply(path,arguments);try{return file.doesPathContain(fs.realpathSync(process.cwd()),fs.realpathSync(e))}catch(n){return!1}};