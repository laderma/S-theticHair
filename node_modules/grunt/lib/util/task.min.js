!function(e){"use strict";function n(){this.current={},this._tasks={},this._queue=[],this._placeholder={placeholder:!0},this._marker={marker:!0},this._options={},this._running=!1,this._success={}}e.Task=n,e.create=function(){return new n},n.prototype._throwIfRunning=function(e){if(this._running||!this._options.error)throw e;this._options.error.call({name:null},e)},n.prototype.registerTask=function(e,n,t){null==t&&(t=n,n=null);var r;return"function"!=typeof t?(r=this.parseArgs([t]),t=this.run.bind(this,t),t.alias=!0,n||(n='Alias for "'+r.join('", "')+'" task'+(1===r.length?"":"s")+".")):n||(n="Custom task."),this._tasks[e]={name:e,info:n,fn:t},this},n.prototype.isTaskAlias=function(e){return!!this._tasks[e].fn.alias},n.prototype.exists=function(e){return e in this._tasks},n.prototype.renameTask=function(e,n){if(!this._tasks[e])throw new Error('Cannot rename missing "'+e+'" task.');return this._tasks[n]=this._tasks[e],this._tasks[n].name=n,delete this._tasks[e],this},n.prototype.parseArgs=function(e){return Array.isArray(e[0])?e[0]:[].slice.call(e)},n.prototype.splitArgs=function(e){return e?(e=e.replace(/\\\\/g,"￿").replace(/\\:/g,"￾"),e.split(":").map(function(e){return e.replace(/\uFFFE/g,":").replace(/\uFFFF/g,"\\")})):[]},n.prototype._taskPlusArgs=function(e){var r,n=this.splitArgs(e),t=n.length;do r=this._tasks[n.slice(0,t).join(":")];while(!r&&--t>0);var a=n.slice(t),i={};return a.forEach(function(e){i[e]=!0}),{task:r,nameArgs:e,args:a,flags:i}},n.prototype._push=function(e){var n=this._queue.indexOf(this._placeholder);-1===n?this._queue=this._queue.concat(e):[].splice.apply(this._queue,[n,0].concat(e))},n.prototype.run=function(){var e=this.parseArgs(arguments).map(this._taskPlusArgs,this),n=e.filter(function(e){return!e.task});return n.length>0?(this._throwIfRunning(new Error('Task "'+n[0].nameArgs+'" not found.')),this):(this._push(e),this)},n.prototype.mark=function(){return this._push(this._marker),this},n.prototype.runTaskFn=function(e,n,t,r){var a=!1,i=function(n){var a=null;n===!1?a=new Error('Task "'+e.nameArgs+'" failed.'):n instanceof Error||"[object Error]"==={}.toString.call(n)?(a=n,n=!1):n=!0,this.current={},this._success[e.nameArgs]=n,!n&&this._options.error&&this._options.error.call({name:e.name,nameArgs:e.nameArgs},a),r?process.nextTick(function(){t(a,n)}):t(a,n)}.bind(this);e.async=function(){return a=!0,function(e){setTimeout(function(){i(e)},1)}},this.current=e;try{var s=n.call(e);a||i(s)}catch(o){i(o)}},n.prototype.start=function(e){if(e||(e={}),this._running)return!1;var n=function(){var t;do t=this._queue.shift();while(t===this._placeholder||t===this._marker);if(!t)return this._running=!1,void(this._options.done&&this._options.done());this._queue.unshift(this._placeholder);var r={nameArgs:t.nameArgs,name:t.task.name,args:t.args,flags:t.flags};this.runTaskFn(r,function(){return t.task.fn.apply(this,this.args)},n,!!e.asyncDone)}.bind(this);this._running=!0,n()},n.prototype.clearQueue=function(e){return e||(e={}),e.untilMarker?this._queue.splice(0,this._queue.indexOf(this._marker)+1):this._queue=[],this},n.prototype.requires=function(){this.parseArgs(arguments).forEach(function(e){var n=this._success[e];if(!n)throw new Error('Required task "'+e+'" '+(n===!1?"failed":"must be run first")+".")}.bind(this))},n.prototype.options=function(e){Object.keys(e).forEach(function(n){this._options[n]=e[n]}.bind(this))}}("object"==typeof exports&&exports||this);