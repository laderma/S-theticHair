(function(){var e,n,t,r,a,i,o,s,u,l,c,f,d,h,p,m,g,b,v,_,y,k,w,S,x,T,M,L,D,A,E,H,C,z,F,Y,q,j,O,B,I,N,P,$,R,U,W,K,G=[].indexOf||function(e){for(var n=0,t=this.length;t>n;n++)if(n in this&&this[n]===e)return n;return-1};W=require("./rewriter"),F=W.Rewriter,g=W.INVERSES,K=require("./helpers"),P=K.count,U=K.starts,N=K.compact,R=K.last,exports.Lexer=S=function(){function e(){}return e.prototype.tokenize=function(e,n){var t,r;for(null==n&&(n={}),I.test(e)&&(e="\n"+e),e=e.replace(/\r/g,"").replace(O,""),this.code=e,this.line=n.line||0,this.indent=0,this.indebt=0,this.outdebt=0,this.indents=[],this.ends=[],this.tokens=[],t=0;this.chunk=e.slice(t);)t+=this.identifierToken()||this.commentToken()||this.whitespaceToken()||this.lineToken()||this.heredocToken()||this.stringToken()||this.numberToken()||this.regexToken()||this.jsToken()||this.literalToken();return this.closeIndentation(),(r=this.ends.pop())&&this.error("missing "+r),n.rewrite===!1?this.tokens:(new F).rewrite(this.tokens)},e.prototype.identifierToken=function(){var e,n,t,o,s,u,l,c,f;return(s=p.exec(this.chunk))?(o=s[0],t=s[1],e=s[2],"own"===t&&"FOR"===this.tag()?(this.token("OWN",t),t.length):(n=e||(u=R(this.tokens))&&("."===(c=u[0])||"?."===c||"::"===c||!u.spaced&&"@"===u[0]),l="IDENTIFIER",!n&&(G.call(_,t)>=0||G.call(i,t)>=0)&&(l=t.toUpperCase(),"WHEN"===l&&(f=this.tag(),G.call(y,f)>=0)?l="LEADING_WHEN":"FOR"===l?this.seenFor=!0:"UNLESS"===l?l="IF":G.call(B,l)>=0?l="UNARY":G.call(C,l)>=0&&("INSTANCEOF"!==l&&this.seenFor?(l="FOR"+l,this.seenFor=!1):(l="RELATION","!"===this.value()&&(this.tokens.pop(),t="!"+t)))),G.call(v,t)>=0&&(n?(l="IDENTIFIER",t=new String(t),t.reserved=!0):G.call(z,t)>=0&&this.error('reserved word "'+t+'"')),n||(G.call(r,t)>=0&&(t=a[t]),l=function(){switch(t){case"!":return"UNARY";case"==":case"!=":return"COMPARE";case"&&":case"||":return"LOGIC";case"true":case"false":return"BOOL";case"break":case"continue":return"STATEMENT";default:return l}}()),this.token(l,t),e&&this.token(":",":"),o.length)):0},e.prototype.numberToken=function(){var e,n,t,r,a;return(t=A.exec(this.chunk))?(r=t[0],/^0[BOX]/.test(r)?this.error("radix prefix '"+r+"' must be lowercase"):/E/.test(r)&&!/^0x/.test(r)?this.error("exponential notation '"+r+"' must be indicated with a lowercase 'e'"):/^0\d*[89]/.test(r)?this.error("decimal literal '"+r+"' must not be prefixed with '0'"):/^0\d+/.test(r)&&this.error("octal literal '"+r+"' must be prefixed with '0o'"),n=r.length,(a=/^0o([0-7]+)/.exec(r))&&(r="0x"+parseInt(a[1],8).toString(16)),(e=/^0b([01]+)/.exec(r))&&(r="0x"+parseInt(e[1],2).toString(16)),this.token("NUMBER",r),n):0},e.prototype.stringToken=function(){var e,n,t;switch(this.chunk.charAt(0)){case"'":if(!(e=q.exec(this.chunk)))return 0;this.token("STRING",(t=e[0]).replace(T,"\\\n"));break;case'"':if(!(t=this.balancedString(this.chunk,'"')))return 0;0<t.indexOf("#{",1)?this.interpolateString(t.slice(1,-1)):this.token("STRING",this.escapeLines(t));break;default:return 0}return(n=/^(?:\\.|[^\\])*\\(?:0[0-7]|[1-7])/.test(t))&&this.error("octal escape sequences "+t+" are not allowed"),this.line+=P(t,"\n"),t.length},e.prototype.heredocToken=function(){var e,n,t,r;return(t=l.exec(this.chunk))?(n=t[0],r=n.charAt(0),e=this.sanitizeHeredoc(t[2],{quote:r,indent:null}),'"'===r&&0<=e.indexOf("#{")?this.interpolateString(e,{heredoc:!0}):this.token("STRING",this.makeString(e,r,!0)),this.line+=P(n,"\n"),n.length):0},e.prototype.commentToken=function(){var e,n,t;return(t=this.chunk.match(o))?(e=t[0],n=t[1],n&&this.token("HERECOMMENT",this.sanitizeHeredoc(n,{herecomment:!0,indent:Array(this.indent+1).join(" ")})),this.line+=P(e,"\n"),e.length):0},e.prototype.jsToken=function(){var e,n;return"`"===this.chunk.charAt(0)&&(e=b.exec(this.chunk))?(this.token("JS",(n=e[0]).slice(1,-1)),n.length):0},e.prototype.regexToken=function(){var e,n,t,r,a,i,o;return"/"!==this.chunk.charAt(0)?0:(t=d.exec(this.chunk))?(n=this.heregexToken(t),this.line+=P(t[0],"\n"),n):(r=R(this.tokens),r&&(i=r[0],G.call(r.spaced?L:D,i)>=0)?0:(t=H.exec(this.chunk))?(o=t,t=o[0],a=o[1],e=o[2],"/*"===a.slice(0,2)&&this.error("regular expressions cannot begin with `*`"),"//"===a&&(a="/(?:)/"),this.token("REGEX",""+a+e),t.length):0)},e.prototype.heregexToken=function(e){var n,t,r,a,i,o,s,u,l,c,f,d,p;if(r=e[0],n=e[1],t=e[2],0>n.indexOf("#{"))return a=n.replace(h,"").replace(/\//g,"\\/"),a.match(/^\*/)&&this.error("regular expressions cannot begin with `*`"),this.token("REGEX","/"+(a||"(?:)")+"/"+t),r.length;for(this.token("IDENTIFIER","RegExp"),this.tokens.push(["CALL_START","("]),o=[],c=this.interpolateString(n,{regex:!0}),u=0,l=c.length;l>u;u++){if(f=c[u],i=f[0],s=f[1],"TOKENS"===i)o.push.apply(o,s);else{if(!(s=s.replace(h,"")))continue;s=s.replace(/\\/g,"\\\\"),o.push(["STRING",this.makeString(s,'"',!0)])}o.push(["+","+"])}return o.pop(),"STRING"!==(null!=(d=o[0])?d[0]:void 0)&&this.tokens.push(["STRING",'""'],["+","+"]),(p=this.tokens).push.apply(p,o),t&&this.tokens.push([",",","],["STRING",'"'+t+'"']),this.token(")",")"),r.length},e.prototype.lineToken=function(){var e,n,t,r,a,i;if(!(t=M.exec(this.chunk)))return 0;if(n=t[0],this.line+=P(n,"\n"),this.seenFor=!1,a=R(this.tokens,1),i=n.length-1-n.lastIndexOf("\n"),r=this.unfinished(),i-this.indebt===this.indent)return r?this.suppressNewlines():this.newlineToken(),n.length;if(i>this.indent){if(r)return this.indebt=i-this.indent,this.suppressNewlines(),n.length;e=i-this.indent+this.outdebt,this.token("INDENT",e),this.indents.push(e),this.ends.push("OUTDENT"),this.outdebt=this.indebt=0}else this.indebt=0,this.outdentToken(this.indent-i,r);return this.indent=i,n.length},e.prototype.outdentToken=function(e,n){for(var t,r;e>0;)r=this.indents.length-1,void 0===this.indents[r]?e=0:this.indents[r]===this.outdebt?(e-=this.outdebt,this.outdebt=0):this.indents[r]<this.outdebt?(this.outdebt-=this.indents[r],e-=this.indents[r]):(t=this.indents.pop()-this.outdebt,e-=t,this.outdebt=0,this.pair("OUTDENT"),this.token("OUTDENT",t));for(t&&(this.outdebt-=e);";"===this.value();)this.tokens.pop();return"TERMINATOR"===this.tag()||n||this.token("TERMINATOR","\n"),this},e.prototype.whitespaceToken=function(){var e,n,t;return(e=I.exec(this.chunk))||(n="\n"===this.chunk.charAt(0))?(t=R(this.tokens),t&&(t[e?"spaced":"newLine"]=!0),e?e[0].length:0):0},e.prototype.newlineToken=function(){for(;";"===this.value();)this.tokens.pop();return"TERMINATOR"!==this.tag()&&this.token("TERMINATOR","\n"),this},e.prototype.suppressNewlines=function(){return"\\"===this.value()&&this.tokens.pop(),this},e.prototype.literalToken=function(){var e,r,a,i,o,l,c,f;if((e=E.exec(this.chunk))?(i=e[0],t.test(i)&&this.tagParameters()):i=this.chunk.charAt(0),a=i,r=R(this.tokens),"="===i&&r&&(!r[1].reserved&&(o=r[1],G.call(v,o)>=0)&&this.error('reserved word "'+this.value()+"\" can't be assigned"),"||"===(l=r[1])||"&&"===l))return r[0]="COMPOUND_ASSIGN",r[1]+="=",i.length;if(";"===i)this.seenFor=!1,a="TERMINATOR";else if(G.call(x,i)>=0)a="MATH";else if(G.call(s,i)>=0)a="COMPARE";else if(G.call(u,i)>=0)a="COMPOUND_ASSIGN";else if(G.call(B,i)>=0)a="UNARY";else if(G.call(Y,i)>=0)a="SHIFT";else if(G.call(w,i)>=0||"?"===i&&(null!=r?r.spaced:void 0))a="LOGIC";else if(r&&!r.spaced)if("("===i&&(c=r[0],G.call(n,c)>=0))"?"===r[0]&&(r[0]="FUNC_EXIST"),a="CALL_START";else if("["===i&&(f=r[0],G.call(m,f)>=0))switch(a="INDEX_START",r[0]){case"?":r[0]="INDEX_SOAK"}switch(i){case"(":case"{":case"[":this.ends.push(g[i]);break;case")":case"}":case"]":this.pair(i)}return this.token(a,i),i.length},e.prototype.sanitizeHeredoc=function(e,n){var t,r,a,i,o;if(a=n.indent,r=n.herecomment){if(c.test(e)&&this.error('block comment cannot contain "*/", starting'),e.indexOf("\n")<=0)return e}else for(;i=f.exec(e);)t=i[1],(null===a||0<(o=t.length)&&o<a.length)&&(a=t);return a&&(e=e.replace(RegExp("\\n"+a,"g"),"\n")),r||(e=e.replace(/^\n/,"")),e},e.prototype.tagParameters=function(){var e,n,t,r;if(")"!==this.tag())return this;for(n=[],r=this.tokens,e=r.length,r[--e][0]="PARAM_END";t=r[--e];)switch(t[0]){case")":n.push(t);break;case"(":case"CALL_START":if(!n.length)return"("===t[0]?(t[0]="PARAM_START",this):this;n.pop()}return this},e.prototype.closeIndentation=function(){return this.outdentToken(this.indent)},e.prototype.balancedString=function(e,n){var t,r,a,i,o,s,u,l;for(t=0,s=[n],r=u=1,l=e.length;l>=1?l>u:u>l;r=l>=1?++u:--u)if(t)--t;else{switch(a=e.charAt(r)){case"\\":++t;continue;case n:if(s.pop(),!s.length)return e.slice(0,r+1||9e9);n=s[s.length-1];continue}"}"!==n||'"'!==a&&"'"!==a?"}"===n&&"/"===a&&(i=d.exec(e.slice(r))||H.exec(e.slice(r)))?t+=i[0].length-1:"}"===n&&"{"===a?s.push(n="}"):'"'===n&&"#"===o&&"{"===a&&s.push(n="}"):s.push(n=a),o=a}return this.error("missing "+s.pop()+", starting")},e.prototype.interpolateString=function(n,t){var r,a,i,o,s,u,l,c,f,d,h,p,m,g,b,v,_,y;for(null==t&&(t={}),a=t.heredoc,d=t.regex,p=[],f=0,i=-1;l=n.charAt(i+=1);)"\\"!==l?"#"===l&&"{"===n.charAt(i+1)&&(r=this.balancedString(n.slice(i+1),"}"))&&(i>f&&p.push(["NEOSTRING",n.slice(f,i)]),o=r.slice(1,-1),o.length&&(c=(new e).tokenize(o,{line:this.line,rewrite:!1}),c.pop(),"TERMINATOR"===(null!=(v=c[0])?v[0]:void 0)&&c.shift(),(u=c.length)&&(u>1&&(c.unshift(["(","(",this.line]),c.push([")",")",this.line])),p.push(["TOKENS",c]))),i+=r.length,f=i+1):i+=1;if(i>f&&f<n.length&&p.push(["NEOSTRING",n.slice(f)]),d)return p;if(!p.length)return this.token("STRING",'""');for("NEOSTRING"!==p[0][0]&&p.unshift(["",""]),(s=p.length>1)&&this.token("(","("),i=g=0,b=p.length;b>g;i=++g)_=p[i],h=_[0],m=_[1],i&&this.token("+","+"),"TOKENS"===h?(y=this.tokens).push.apply(y,m):this.token("STRING",this.makeString(m,'"',a));return s&&this.token(")",")"),p},e.prototype.pair=function(e){var n,t;return e!==(t=R(this.ends))?("OUTDENT"!==t&&this.error("unmatched "+e),this.indent-=n=R(this.indents),this.outdentToken(n,!0),this.pair(e)):this.ends.pop()},e.prototype.token=function(e,n){return this.tokens.push([e,n,this.line])},e.prototype.tag=function(e,n){var t;return(t=R(this.tokens,e))&&(n?t[0]=n:t[0])},e.prototype.value=function(e,n){var t;return(t=R(this.tokens,e))&&(n?t[1]=n:t[1])},e.prototype.unfinished=function(){var e;return k.test(this.chunk)||"\\"===(e=this.tag())||"."===e||"?."===e||"UNARY"===e||"MATH"===e||"+"===e||"-"===e||"SHIFT"===e||"RELATION"===e||"COMPARE"===e||"LOGIC"===e||"THROW"===e||"EXTENDS"===e},e.prototype.escapeLines=function(e,n){return e.replace(T,n?"\\n":"")},e.prototype.makeString=function(e,n,t){return e?(e=e.replace(/\\([\s\S])/g,function(e,t){return"\n"===t||t===n?t:e}),e=e.replace(RegExp(""+n,"g"),"\\$&"),n+this.escapeLines(e,t)+n):n+n},e.prototype.error=function(e){throw SyntaxError(""+e+" on line "+(this.line+1))},e}(),_=["true","false","null","this","new","delete","typeof","in","instanceof","return","throw","break","continue","debugger","if","else","switch","for","while","do","try","catch","finally","class","extends","super"],i=["undefined","then","unless","until","loop","of","by","when"],a={and:"&&",or:"||",is:"==",isnt:"!=",not:"!",yes:"true",no:"false",on:"true",off:"false"},r=function(){var e;e=[];for($ in a)e.push($);return e}(),i=i.concat(r),z=["case","default","function","var","void","with","const","let","enum","export","import","native","__hasProp","__extends","__slice","__bind","__indexOf","implements","interface","let","package","private","protected","public","static","yield"],j=["arguments","eval"],v=_.concat(z).concat(j),exports.RESERVED=z.concat(_).concat(i).concat(j),exports.STRICT_PROSCRIBED=j,p=/^([$A-Za-z_\x7f-\uffff][$\w\x7f-\uffff]*)([^\n\S]*:(?!:))?/,A=/^0b[01]+|^0o[0-7]+|^0x[\da-f]+|^\d*\.?\d+(?:e[+-]?\d+)?/i,l=/^("""|''')([\s\S]*?)(?:\n[^\n\S]*)?\1/,E=/^(?:[-=]>|[-+*\/%<>&|^!?=]=|>>>=?|([-+:])\1|([&|<>])\2=?|\?\.|\.{2,3})/,I=/^[^\n\S]+/,o=/^###([^#][\s\S]*?)(?:###[^\n\S]*|(?:###)?$)|^(?:\s*#(?!##[^#]).*)+/,t=/^[-=]>/,M=/^(?:\n[^\n\S]*)+/,q=/^'[^\\']*(?:\\.[^\\']*)*'/,b=/^`[^\\`]*(?:\\.[^\\`]*)*`/,H=/^(\/(?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/)([imgy]{0,4})(?!\w)/,d=/^\/{3}([\s\S]+?)\/{3}([imgy]{0,4})(?!\w)/,h=/\s+(?:#.*)?/g,T=/\n/g,f=/\n+([^\n\S]*)/g,c=/\*\//,k=/^\s*(?:,|\??\.(?![.\d])|::)/,O=/\s+$/,u=["-=","+=","/=","*=","%=","||=","&&=","?=","<<=",">>=",">>>=","&=","^=","|="],B=["!","~","NEW","TYPEOF","DELETE","DO"],w=["&&","||","&","|","^"],Y=["<<",">>",">>>"],s=["==","!=","<",">","<=",">="],x=["*","/","%"],C=["IN","OF","INSTANCEOF"],e=["TRUE","FALSE"],L=["NUMBER","REGEX","BOOL","NULL","UNDEFINED","++","--","]"],D=L.concat(")","}","THIS","IDENTIFIER","STRING"),n=["IDENTIFIER","STRING","REGEX",")","]","}","?","::","@","THIS","SUPER"],m=n.concat("NUMBER","BOOL","NULL","UNDEFINED"),y=["INDENT","OUTDENT","TERMINATOR"]}).call(this);