(function(){var e,n,t,r,a,i,o,s,u,l,c,f,d,h,p,m,g,b,v,_,y,k,w,S,x,T,M,L,D,A,E,H,C,z,F,Y,q,j,B,O,I;f=require("fs"),S=require("path"),d=require("./helpers"),_=require("./optparse"),n=require("./coffee-script"),I=require("child_process"),E=I.spawn,l=I.exec,t=require("events").EventEmitter,d.extend(n,new t),x=function(e){return process.stdout.write(e+"\n")},M=function(e){return process.stderr.write(e+"\n")},h=function(e){return/^\.|~$/.test(e)},e="Usage: coffee [options] path/to/script.coffee -- [args]\n\nIf called without options, `coffee` will run your script.",r=[["-b","--bare","compile without a top-level function wrapper"],["-c","--compile","compile to JavaScript and save as .js files"],["-e","--eval","pass a string from the command line as input"],["-h","--help","display this help message"],["-i","--interactive","run an interactive CoffeeScript REPL"],["-j","--join [FILE]","concatenate the source CoffeeScript before compiling"],["-l","--lint","pipe the compiled JavaScript through JavaScript Lint"],["-n","--nodes","print out the parse tree that the parser produces"],["--nodejs [ARGS]",'pass options directly to the "node" binary'],["-o","--output [DIR]","set the output directory for compiled JavaScript"],["-p","--print","print out the compiled JavaScript"],["-r","--require [FILE*]","require a library before executing your script"],["-s","--stdio","listen for and compile scripts over stdio"],["-t","--tokens","print out the tokens that the lexer/rewriter produce"],["-v","--version","display the version number"],["-w","--watch","watch scripts for changes and rerun commands"]],y={},A=[],D=[],b={},B={},v=null,exports.run=function(){var e,n,t,r,a;if(w(),y.nodejs)return c();if(y.help)return z();if(y.version)return F();if(y.require&&g(),y.interactive)return require("./repl");if(y.watch&&!f.watch)return M("The --watch feature depends on Node v0.6.0+. You are running "+process.version+".");if(y.stdio)return u();if(y.eval)return s(null,A[0]);if(!A.length)return require("./repl");for(e=y.run?A.splice(1):[],process.argv=process.argv.slice(0,2).concat(e),process.argv[0]="coffee",process.execPath=require.main.filename,a=[],t=0,r=A.length;r>t;t++)n=A[t],a.push(o(n,!0,S.normalize(n)));return a},o=function(e,n,t){return f.stat(e,function(r,a){if(r&&"ENOENT"!==r.code)throw r;return"ENOENT"===(null!=r?r.code:void 0)?n&&".coffee"!==e.slice(-7)?(e=A[A.indexOf(e)]=""+e+".coffee",o(e,n,t)):void(n&&(console.error("File not found: "+e),process.exit(1))):a.isDirectory()?(y.watch&&j(e,t),f.readdir(e,function(n,r){var a,i,s,u;if(n&&"ENOENT"!==n.code)throw n;if("ENOENT"!==(null!=n?n.code:void 0))return i=A.indexOf(e),r=r.filter(function(e){return!h(e)}),[].splice.apply(A,[i,i-i+1].concat(s=function(){var n,t,i;for(i=[],n=0,t=r.length;t>n;n++)a=r[n],i.push(S.join(e,a));return i}())),s,[].splice.apply(D,[i,i-i+1].concat(u=r.map(function(){return null}))),u,r.forEach(function(n){return o(S.join(e,n),!1,t)})})):n||".coffee"===S.extname(e)?(y.watch&&q(e,t),f.readFile(e,function(n,r){if(n&&"ENOENT"!==n.code)throw n;if("ENOENT"!==(null!=n?n.code:void 0))return s(e,r.toString(),t)})):(b[e]=!0,L(e,t))})},s=function(e,t,r){var o,s,u,l;o=y,s=i(e);try{if(u=l={file:e,input:t,options:s},n.emit("compile",l),o.tokens)return T(n.tokens(u.input));if(o.nodes)return x(n.nodes(u.input).toString().trim());if(o.run)return n.run(u.input,u.options);if(o.join&&u.file!==o.join)return D[A.indexOf(u.file)]=u.input,a();if(u.output=n.compile(u.input,u.options),n.emit("success",l),o.print)return x(u.output.trim());if(o.compile)return O(u.file,u.output,r);if(o.lint)return m(u.file,u.output)}catch(c){if(n.emit("failure",c,l),n.listeners("failure").length)return;return o.watch?x(c.message+""):(M(c instanceof Error&&c.stack||"ERROR: "+c),process.exit(1))}},u=function(){var e,n;return e="",n=process.openStdin(),n.on("data",function(n){return n?e+=n.toString():void 0}),n.on("end",function(){return s(null,e)})},p=null,a=function(){return y.join?D.some(function(e){return null===e})?void 0:(clearTimeout(p),p=Y(100,function(){return s(y.join,D.join("\n"),y.join)})):void 0},g=function(){var e,n,t,r,a;for(e=module.filename,module.filename=".",a=y.require,t=0,r=a.length;r>t;t++)n=a[t],require(n);return module.filename=e},q=function(e,n){var t,r,i,o,u,l;i=null,r=null,u=function(r){if("ENOENT"!==r.code)throw r;if(-1!==A.indexOf(e))try{return o(),t()}catch(r){return L(e,n,!0),a()}},t=function(){return clearTimeout(r),r=Y(25,function(){return f.stat(e,function(t,r){return t?u(t):i&&r.size===i.size&&r.mtime.getTime()===i.mtime.getTime()?o():(i=r,f.readFile(e,function(t,r){return t?u(t):(s(e,r.toString(),n),o())}))})})};try{l=f.watch(e,t)}catch(c){u(c)}return o=function(){return null!=l&&l.close(),l=f.watch(e,t)}},j=function(e,n){var t,r;t=null;try{return r=f.watch(e,function(){return clearTimeout(t),t=Y(25,function(){return f.readdir(e,function(t,a){var i,s,u,l;if(t){if("ENOENT"!==t.code)throw t;return r.close(),C(e,n)}for(l=[],s=0,u=a.length;u>s;s++)i=a[s],h(i)||b[i]||(i=S.join(e,i),A.some(function(e){return e.indexOf(i)>=0})||(A.push(i),D.push(null),l.push(o(i,!1,n))));return l})})})}catch(a){if("ENOENT"!==a.code)throw a}},C=function(e,n){var t,r,i,o,s;for(r=A.slice(0),i=function(){var n,r,a;for(a=[],n=0,r=A.length;r>n;n++)t=A[n],t.indexOf(e)>=0&&a.push(t);return a}(),o=0,s=i.length;s>o;o++)t=i[o],L(t,n,!0);return A.some(function(e,n){return r[n]!==e})?a():void 0},L=function(e,n,t){var r,a;return r=A.indexOf(e),A.splice(r,1),D.splice(r,1),t&&!y.join?(a=k(e,n),S.exists(a,function(n){return n?f.unlink(a,function(n){if(n&&"ENOENT"!==n.code)throw n;return H("removed "+e)}):void 0})):void 0},k=function(e,n){var t,r,a,i;return a=S.basename(e,S.extname(e))+".js",i=S.dirname(e),t="."===n?i:i.substring(n.length),r=y.output?S.join(y.output,t):i,S.join(r,a)},O=function(e,n,t){var r,a,i;return i=k(e,t),a=S.dirname(i),r=function(){return n.length<=0&&(n=" "),f.writeFile(i,n,function(n){return n?x(n.message):y.compile&&y.watch?H("compiled "+e):void 0})},S.exists(a,function(e){return e?r():l("mkdir -p "+a,r)})},Y=function(e,n){return setTimeout(n,e)},H=function(e){return console.log(""+(new Date).toLocaleTimeString()+" - "+e)},m=function(e,n){var t,r,a;return a=function(n){return x(e+":	"+n.toString().trim())},t=__dirname+"/../../extras/jsl.conf",r=E("jsl",["-nologo","-stdin","-conf",t]),r.stdout.on("data",a),r.stderr.on("data",a),r.stdin.write(n),r.stdin.end()},T=function(e){var n,t,r,a;return n=function(){var n,i,o,s;for(s=[],n=0,i=e.length;i>n;n++)r=e[n],o=[r[0],r[1].toString().replace(/\n/,"\\n")],t=o[0],a=o[1],s.push("["+t+" "+a+"]");return s}(),x(n.join(" "))},w=function(){var n,t,a,i,o;for(v=new _.OptionParser(r,e),t=y=v.parse(process.argv.slice(2)),t.compile||(t.compile=!!t.output),t.run=!(t.compile||t.print||t.lint),t.print=!!(t.print||t.eval||t.stdio&&t.compile),A=t.arguments,n=i=0,o=A.length;o>i;n=++i)a=A[n],D[n]=null},i=function(e){return{filename:e,bare:y.bare,header:y.compile}},c=function(){var e,n;return n=y.nodejs.split(/\s+/),e=process.argv.slice(1),e.splice(e.indexOf("--nodejs"),2),E(process.execPath,n.concat(e),{cwd:process.cwd(),env:process.env,customFds:[0,1,2]})},z=function(){return x(new _.OptionParser(r,e).help())},F=function(){return x("CoffeeScript version "+n.VERSION)}}).call(this);