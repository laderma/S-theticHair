(function(){var e,n,t,r,a,i,o,s,u,l,c,f,d,h,p,m,g,b,v=[].indexOf||function(e){for(var n=0,t=this.length;t>n;n++)if(n in this&&this[n]===e)return n;return-1},_=[].slice;for(exports.Rewriter=function(){function e(){}return e.prototype.rewrite=function(e){return this.tokens=e,this.removeLeadingNewlines(),this.removeMidExpressionNewlines(),this.closeOpenCalls(),this.closeOpenIndexes(),this.addImplicitIndentation(),this.tagPostfixConditionals(),this.addImplicitBraces(),this.addImplicitParentheses(),this.tokens},e.prototype.scanTokens=function(e){var n,t,r;for(r=this.tokens,n=0;t=r[n];)n+=e.call(this,t,n,r);return!0},e.prototype.detectEnd=function(e,n,a){var i,o,s,u,l;for(s=this.tokens,i=0;o=s[e];){if(0===i&&n.call(this,o,e))return a.call(this,o,e);if(!o||0>i)return a.call(this,o,e-1);u=o[0],v.call(r,u)>=0?i+=1:(l=o[0],v.call(t,l)>=0&&(i-=1)),e+=1}return e-1},e.prototype.removeLeadingNewlines=function(){var e,n,t,r,a;for(a=this.tokens,e=t=0,r=a.length;r>t&&(n=a[e][0],"TERMINATOR"===n);e=++t);return e?this.tokens.splice(0,e):void 0},e.prototype.removeMidExpressionNewlines=function(){return this.scanTokens(function(e,t,r){var a;return"TERMINATOR"===e[0]&&(a=this.tag(t+1),v.call(n,a)>=0)?(r.splice(t,1),0):1})},e.prototype.closeOpenCalls=function(){var e,n;return n=function(e,n){var t;return")"===(t=e[0])||"CALL_END"===t||"OUTDENT"===e[0]&&")"===this.tag(n-1)},e=function(e,n){return this.tokens["OUTDENT"===e[0]?n-1:n][0]="CALL_END"},this.scanTokens(function(t,r){return"CALL_START"===t[0]&&this.detectEnd(r+1,n,e),1})},e.prototype.closeOpenIndexes=function(){var e,n;return n=function(e,n){var t;return"]"===(t=e[0])||"INDEX_END"===t},e=function(e,n){return e[0]="INDEX_END"},this.scanTokens(function(t,r){return"INDEX_START"===t[0]&&this.detectEnd(r+1,n,e),1})},e.prototype.addImplicitBraces=function(){var e,n,a,i,s,u,l,f;return i=[],s=null,f=null,a=!0,u=0,l=0,n=function(e,n){var t,r,i,s,u,d;return u=this.tokens.slice(n+1,n+3+1||9e9),t=u[0],s=u[1],i=u[2],"HERECOMMENT"===(null!=t?t[0]:void 0)?!1:(r=e[0],v.call(c,r)>=0&&(a=!1),("TERMINATOR"===r||"OUTDENT"===r||v.call(o,r)>=0&&a&&!(n-l===1))&&(!f&&","!==this.tag(n-1)||!(":"===(null!=s?s[0]:void 0)||"@"===(null!=t?t[0]:void 0)&&":"===(null!=i?i[0]:void 0)))||","===r&&t&&"IDENTIFIER"!==(d=t[0])&&"NUMBER"!==d&&"STRING"!==d&&"@"!==d&&"TERMINATOR"!==d&&"OUTDENT"!==d)},e=function(e,n){var t;return t=this.generate("}","}",e[2]),this.tokens.splice(n,0,t)},this.scanTokens(function(o,u,d){var h,p,m,g,b,_,y,k;if(y=g=o[0],v.call(r,y)>=0)return i.push(["INDENT"===g&&"{"===this.tag(u-1)?"{":g,u]),1;if(v.call(t,g)>=0)return s=i.pop(),1;if(":"!==g||":"!==(h=this.tag(u-2))&&"{"===(null!=(k=i[i.length-1])?k[0]:void 0))return 1;for(a=!0,l=u+1,i.push(["{"]),p="@"===h?u-2:u-1;"HERECOMMENT"===this.tag(p-2);)p-=2;return m=this.tag(p-1),f=!m||v.call(c,m)>=0,_=new String("{"),_.generated=!0,b=this.generate("{",_,o[2]),d.splice(p,0,b),this.detectEnd(u+2,n,e),2})},e.prototype.addImplicitParentheses=function(){var e,n,t,r,l;return t=l=r=!1,n=function(e,n){var t,i,s,u;return i=e[0],!l&&e.fromThen?!0:(("IF"===i||"ELSE"===i||"CATCH"===i||"->"===i||"=>"===i||"CLASS"===i)&&(l=!0),("IF"===i||"ELSE"===i||"SWITCH"===i||"TRY"===i||"="===i)&&(r=!0),"."!==i&&"?."!==i&&"::"!==i||"OUTDENT"!==this.tag(n-1)?!e.generated&&","!==this.tag(n-1)&&(v.call(o,i)>=0||"INDENT"===i&&!r)&&("INDENT"!==i||"CLASS"!==(s=this.tag(n-2))&&"EXTENDS"!==s&&(u=this.tag(n-1),v.call(a,u)<0)&&!((t=this.tokens[n+1])&&t.generated&&"{"===t[0])):!0)},e=function(e,n){return this.tokens.splice(n,0,this.generate("CALL_END",")",e[2]))},this.scanTokens(function(a,o,f){var d,h,p,m,g,b,_,y;return g=a[0],("CLASS"===g||"IF"===g||"FOR"===g||"WHILE"===g)&&(t=!0),b=f.slice(o-1,o+1+1||9e9),m=b[0],h=b[1],p=b[2],d=!t&&"INDENT"===g&&p&&p.generated&&"{"===p[0]&&m&&(_=m[0],v.call(s,_)>=0),l=!1,r=!1,v.call(c,g)>=0&&(t=!1),m&&!m.spaced&&"?"===g&&(a.call=!0),a.fromThen?1:d||(null!=m?m.spaced:void 0)&&(m.call||(y=m[0],v.call(s,y)>=0))&&(v.call(i,g)>=0||!a.spaced&&!a.newLine&&v.call(u,g)>=0)?(f.splice(o,0,this.generate("CALL_START","(",a[2])),this.detectEnd(o+1,n,e),"?"===m[0]&&(m[0]="FUNC_EXIST"),2):1})},e.prototype.addImplicitIndentation=function(){var e,n,t,r,a;return a=t=r=null,n=function(e,n){var t;return";"!==e[1]&&(t=e[0],v.call(f,t)>=0)&&!("ELSE"===e[0]&&"IF"!==a&&"THEN"!==a)},e=function(e,n){return this.tokens.splice(","===this.tag(n-1)?n-1:n,0,r)},this.scanTokens(function(i,o,s){var u,l,c;return u=i[0],"TERMINATOR"===u&&"THEN"===this.tag(o+1)?(s.splice(o,1),0):"ELSE"===u&&"OUTDENT"!==this.tag(o-1)?(s.splice.apply(s,[o,0].concat(_.call(this.indentation(i)))),2):"CATCH"!==u||"OUTDENT"!==(l=this.tag(o+2))&&"TERMINATOR"!==l&&"FINALLY"!==l?v.call(d,u)>=0&&"INDENT"!==this.tag(o+1)&&("ELSE"!==u||"IF"!==this.tag(o+1))?(a=u,c=this.indentation(i,!0),t=c[0],r=c[1],"THEN"===a&&(t.fromThen=!0),s.splice(o+1,0,t),this.detectEnd(o+2,n,e),"THEN"===u&&s.splice(o,1),1):1:(s.splice.apply(s,[o+2,0].concat(_.call(this.indentation(i)))),4)})},e.prototype.tagPostfixConditionals=function(){var e,n,t;return t=null,n=function(e,n){var t;return"TERMINATOR"===(t=e[0])||"INDENT"===t},e=function(e,n){return"INDENT"!==e[0]||e.generated&&!e.fromThen?t[0]="POST_"+t[0]:void 0},this.scanTokens(function(r,a){return"IF"!==r[0]?1:(t=r,this.detectEnd(a+1,n,e),1)})},e.prototype.indentation=function(e,n){var t,r;return null==n&&(n=!1),t=["INDENT",2,e[2]],r=["OUTDENT",2,e[2]],n&&(t.generated=r.generated=!0),[t,r]},e.prototype.generate=function(e,n,t){var r;return r=[e,n,t],r.generated=!0,r},e.prototype.tag=function(e){var n;return null!=(n=this.tokens[e])?n[0]:void 0},e}(),e=[["(",")"],["[","]"],["{","}"],["INDENT","OUTDENT"],["CALL_START","CALL_END"],["PARAM_START","PARAM_END"],["INDEX_START","INDEX_END"]],exports.INVERSES=l={},r=[],t=[],m=0,g=e.length;g>m;m++)b=e[m],h=b[0],p=b[1],r.push(l[p]=h),t.push(l[h]=p);n=["CATCH","WHEN","ELSE","FINALLY"].concat(t),s=["IDENTIFIER","SUPER",")","CALL_END","]","INDEX_END","@","THIS"],i=["IDENTIFIER","NUMBER","STRING","JS","REGEX","NEW","PARAM_START","CLASS","IF","TRY","SWITCH","THIS","BOOL","NULL","UNDEFINED","UNARY","SUPER","@","->","=>","[","(","{","--","++"],u=["+","-"],a=["->","=>","{","[",","],o=["POST_IF","FOR","WHILE","UNTIL","WHEN","BY","LOOP","TERMINATOR"],d=["ELSE","->","=>","TRY","FINALLY","THEN"],f=["TERMINATOR","CATCH","FINALLY","ELSE","OUTDENT","LEADING_WHEN"],c=["TERMINATOR","INDENT","OUTDENT"]}).call(this);