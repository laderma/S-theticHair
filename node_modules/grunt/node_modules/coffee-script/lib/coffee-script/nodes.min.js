(function(){var e,n,t,r,a,i,o,s,u,l,c,f,d,h,p,m,g,b,v,_,y,k,w,S,x,T,M,L,A,D,E,H,C,z,F,Y,j,q,O,B,I,N,P,$,R,U,W,K,G,V,J,Z,Q,X,ee,ne,te,re,ae,ie,oe,se,ue,le={}.hasOwnProperty,ce=function(e,n){function r(){this.constructor=e}for(var t in n)le.call(n,t)&&(e[t]=n[t]);return r.prototype=n.prototype,e.prototype=new r,e.__super__=n.prototype,e},fe=[].indexOf||function(e){for(var n=0,t=this.length;t>n;n++)if(n in this&&this[n]===e)return n;return-1};O=require("./scope").Scope,se=require("./lexer"),z=se.RESERVED,q=se.STRICT_PROSCRIBED,ue=require("./helpers"),J=ue.compact,ee=ue.flatten,X=ue.extend,te=ue.merge,Z=ue.del,ae=ue.starts,Q=ue.ends,ne=ue.last,exports.extend=X,V=function(){return!0},A=function(){return!1},$=function(){return this},L=function(){return this.negated=!this.negated,this},exports.Base=r=function(){function e(){}return e.prototype.compile=function(e,n){var t;return e=X({},e),n&&(e.level=n),t=this.unfoldSoak(e)||this,t.tab=e.indent,e.level!==x&&t.isStatement(e)?t.compileClosure(e):t.compileNode(e)},e.prototype.compileClosure=function(e){if(this.jumps())throw SyntaxError("cannot use a pure statement in an expression.");return e.sharedScope=!0,s.wrap(this).compileNode(e)},e.prototype.cache=function(e,n,r){var a,i;return this.isComplex()?(a=new T(r||e.scope.freeVariable("ref")),i=new t(a,this),n?[i.compile(e,n),a.value]:[i,a]):(a=n?this.compile(e,n):this,[a,a])},e.prototype.compileLoopReference=function(e,n){var t,r;return t=r=this.compile(e,k),+t>-(1/0)&&1/0>+t||h.test(t)&&e.scope.check(t,!0)||(t=""+(r=e.scope.freeVariable(n))+" = "+t),[t,r]},e.prototype.makeReturn=function(e){var n;return n=this.unwrapAll(),e?new i(new T(""+e+".push"),[n]):new Y(n)},e.prototype.contains=function(e){var n;return n=!1,this.traverseChildren(!1,function(t){return e(t)?(n=!0,!1):void 0}),n},e.prototype.containsType=function(e){return this instanceof e||this.contains(function(n){return n instanceof e})},e.prototype.lastNonComment=function(e){var n;for(n=e.length;n--;)if(!(e[n]instanceof l))return e[n];return null},e.prototype.toString=function(e,n){var t;return null==e&&(e=""),null==n&&(n=this.constructor.name),t="\n"+e+n,this.soak&&(t+="?"),this.eachChild(function(n){return t+=n.toString(e+P)}),t},e.prototype.eachChild=function(e){var n,t,r,a,i,o,s,u;if(!this.children)return this;for(s=this.children,r=0,i=s.length;i>r;r++)if(n=s[r],this[n])for(u=ee([this[n]]),a=0,o=u.length;o>a;a++)if(t=u[a],e(t)===!1)return this;return this},e.prototype.traverseChildren=function(e,n){return this.eachChild(function(t){return n(t)===!1?!1:t.traverseChildren(e,n)})},e.prototype.invert=function(){return new E("!",this)},e.prototype.unwrapAll=function(){var e;for(e=this;e!==(e=e.unwrap()););return e},e.prototype.children=[],e.prototype.isStatement=A,e.prototype.jumps=A,e.prototype.isComplex=V,e.prototype.isChainable=A,e.prototype.isAssignable=A,e.prototype.unwrap=$,e.prototype.unfoldSoak=A,e.prototype.assigns=A,e}(),exports.Block=a=function(e){function n(e){this.expressions=J(ee(e||[]))}return ce(n,e),n.prototype.children=["expressions"],n.prototype.push=function(e){return this.expressions.push(e),this},n.prototype.pop=function(){return this.expressions.pop()},n.prototype.unshift=function(e){return this.expressions.unshift(e),this},n.prototype.unwrap=function(){return 1===this.expressions.length?this.expressions[0]:this},n.prototype.isEmpty=function(){return!this.expressions.length},n.prototype.isStatement=function(e){var n,t,r,a;for(a=this.expressions,t=0,r=a.length;r>t;t++)if(n=a[t],n.isStatement(e))return!0;return!1},n.prototype.jumps=function(e){var n,t,r,a;for(a=this.expressions,t=0,r=a.length;r>t;t++)if(n=a[t],n.jumps(e))return n},n.prototype.makeReturn=function(e){var n,t;for(t=this.expressions.length;t--;)if(n=this.expressions[t],!(n instanceof l)){this.expressions[t]=n.makeReturn(e),n instanceof Y&&!n.expression&&this.expressions.splice(t,1);break}return this},n.prototype.compile=function(e,t){return null==e&&(e={}),e.scope?n.__super__.compile.call(this,e,t):this.compileRoot(e)},n.prototype.compileNode=function(e){var t,r,a,i,o,s,u;for(this.tab=e.indent,i=e.level===x,r=[],u=this.expressions,o=0,s=u.length;s>o;o++)a=u[o],a=a.unwrapAll(),a=a.unfoldSoak(e)||a,a instanceof n?r.push(a.compileNode(e)):i?(a.front=!0,t=a.compile(e),a.isStatement(e)||(t=""+this.tab+t+";",a instanceof T&&(t=""+t+"\n")),r.push(t)):r.push(a.compile(e,k));return i?this.spaced?"\n"+r.join("\n\n")+"\n":r.join("\n"):(t=r.join(", ")||"void 0",r.length>1&&e.level>=k?"("+t+")":t)},n.prototype.compileRoot=function(e){var n,t,r,a,i,o;return e.indent=e.bare?"":P,e.scope=new O(null,this,null),e.level=x,this.spaced=!0,a="",e.bare||(i=function(){var e,n,a,i;for(a=this.expressions,i=[],r=e=0,n=a.length;n>e&&(t=a[r],t.unwrap()instanceof l);r=++e)i.push(t);return i}.call(this),o=this.expressions.slice(i.length),this.expressions=i,i.length&&(a=""+this.compileNode(te(e,{indent:""}))+"\n"),this.expressions=o),n=this.compileWithDeclarations(e),e.bare?n:""+a+"(function() {\n"+n+"\n}).call(this);\n"},n.prototype.compileWithDeclarations=function(e){var n,t,r,a,i,o,s,u,c,f,d,h,p,m;for(t=o="",h=this.expressions,i=f=0,d=h.length;d>f&&(a=h[i],a=a.unwrap(),a instanceof l||a instanceof T);i=++f);return e=te(e,{level:x}),i&&(s=this.expressions.splice(i,9e9),p=[this.spaced,!1],c=p[0],this.spaced=p[1],m=[this.compileNode(e),c],t=m[0],this.spaced=m[1],this.expressions=s),o=this.compileNode(e),u=e.scope,u.expressions===this&&(r=e.scope.hasDeclarations(),n=u.hasAssignments,(r||n)&&(i&&(t+="\n"),t+=""+this.tab+"var ",r&&(t+=u.declaredVariables().join(", ")),n&&(r&&(t+=",\n"+(this.tab+P)),t+=u.assignedVariables().join(",\n"+(this.tab+P))),t+=";\n")),t+o},n.wrap=function(e){return 1===e.length&&e[0]instanceof n?e[0]:new n(e)},n}(r),exports.Literal=T=function(e){function n(e){this.value=e}return ce(n,e),n.prototype.makeReturn=function(){return this.isStatement()?this:n.__super__.makeReturn.apply(this,arguments)},n.prototype.isAssignable=function(){return h.test(this.value)},n.prototype.isStatement=function(){var e;return"break"===(e=this.value)||"continue"===e||"debugger"===e},n.prototype.isComplex=A,n.prototype.assigns=function(e){return e===this.value},n.prototype.jumps=function(e){return("break"!==this.value||(null!=e?e.loop:void 0)||(null!=e?e.block:void 0))&&("continue"!==this.value||(null!=e?e.loop:void 0))?void 0:this},n.prototype.compileNode=function(e){var n,t;return n="this"===this.value?(null!=(t=e.scope.method)?t.bound:void 0)?e.scope.method.context:this.value:this.value.reserved?'"'+this.value+'"':this.value,this.isStatement()?""+this.tab+n+";":n},n.prototype.toString=function(){return' "'+this.value+'"'},n}(r),exports.Undefined=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return ce(n,e),n.prototype.isAssignable=A,n.prototype.isComplex=A,n.prototype.compileNode=function(e){return e.level>=_?"(void 0)":"void 0"},n}(r),exports.Null=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return ce(n,e),n.prototype.isAssignable=A,n.prototype.isComplex=A,n.prototype.compileNode=function(){return"null"},n}(r),exports.Bool=function(e){function n(e){this.val=e}return ce(n,e),n.prototype.isAssignable=A,n.prototype.isComplex=A,n.prototype.compileNode=function(){return this.val},n}(r),exports.Return=Y=function(e){function n(e){e&&!e.unwrap().isUndefined&&(this.expression=e)}return ce(n,e),n.prototype.children=["expression"],n.prototype.isStatement=V,n.prototype.makeReturn=$,n.prototype.jumps=$,n.prototype.compile=function(e,t){var r,a;return r=null!=(a=this.expression)?a.makeReturn():void 0,!r||r instanceof n?n.__super__.compile.call(this,e,t):r.compile(e,t)},n.prototype.compileNode=function(e){return this.tab+("return"+[this.expression?" "+this.expression.compile(e,S):void 0]+";")},n}(r),exports.Value=K=function(e){function r(e,n,t){return!n&&e instanceof r?e:(this.base=e,this.properties=n||[],t&&(this[t]=!0),this)}return ce(r,e),r.prototype.children=["base","properties"],r.prototype.add=function(e){return this.properties=this.properties.concat(e),this},r.prototype.hasProperties=function(){return!!this.properties.length},r.prototype.isArray=function(){return!this.properties.length&&this.base instanceof n},r.prototype.isComplex=function(){return this.hasProperties()||this.base.isComplex()},r.prototype.isAssignable=function(){return this.hasProperties()||this.base.isAssignable()},r.prototype.isSimpleNumber=function(){return this.base instanceof T&&j.test(this.base.value)},r.prototype.isString=function(){return this.base instanceof T&&m.test(this.base.value)},r.prototype.isAtomic=function(){var e,n,t,r;for(r=this.properties.concat(this.base),n=0,t=r.length;t>n;n++)if(e=r[n],e.soak||e instanceof i)return!1;return!0},r.prototype.isStatement=function(e){return!this.properties.length&&this.base.isStatement(e)},r.prototype.assigns=function(e){return!this.properties.length&&this.base.assigns(e)},r.prototype.jumps=function(e){return!this.properties.length&&this.base.jumps(e)},r.prototype.isObject=function(e){return this.properties.length?!1:this.base instanceof D&&(!e||this.base.generated)},r.prototype.isSplice=function(){return ne(this.properties)instanceof B},r.prototype.unwrap=function(){return this.properties.length?this:this.base},r.prototype.cacheReference=function(e){var n,a,i,o;return i=ne(this.properties),this.properties.length<2&&!this.base.isComplex()&&!(null!=i?i.isComplex():void 0)?[this,this]:(n=new r(this.base,this.properties.slice(0,-1)),n.isComplex()&&(a=new T(e.scope.freeVariable("base")),n=new r(new C(new t(a,n)))),i?(i.isComplex()&&(o=new T(e.scope.freeVariable("name")),i=new v(new t(o,i.index)),o=new v(o)),[n.add(i),new r(a||n.base,[o||i])]):[n,a])},r.prototype.compileNode=function(e){var n,t,r,a,i;for(this.base.front=this.front,r=this.properties,n=this.base.compile(e,r.length?_:null),(this.base instanceof C||r.length)&&j.test(n)&&(n=""+n+"."),a=0,i=r.length;i>a;a++)t=r[a],n+=t.compile(e);return n},r.prototype.unfoldSoak=function(e){var n,a=this;return null!=this.unfoldedSoak?this.unfoldedSoak:(n=function(){var n,i,o,s,u,l,f,d,h;if(o=a.base.unfoldSoak(e))return Array.prototype.push.apply(o.body.properties,a.properties),o;for(h=a.properties,i=f=0,d=h.length;d>f;i=++f)if(s=h[i],s.soak)return s.soak=!1,n=new r(a.base,a.properties.slice(0,i)),l=new r(a.base,a.properties.slice(i)),n.isComplex()&&(u=new T(e.scope.freeVariable("ref")),n=new C(new t(u,n)),l.base=u),new g(new c(n),l,{soak:!0});return null}(),this.unfoldedSoak=n||!1)},r}(r),exports.Comment=l=function(e){function n(e){this.comment=e}return ce(n,e),n.prototype.isStatement=V,n.prototype.makeReturn=$,n.prototype.compileNode=function(e,n){var t;return t="/*"+re(this.comment,this.tab)+("\n"+this.tab+"*/\n"),(n||e.level)===x&&(t=e.indent+t),t},n}(r),exports.Call=i=function(n){function r(e,n,t){this.args=null!=n?n:[],this.soak=t,this.isNew=!1,this.isSuper="super"===e,this.variable=this.isSuper?null:e}return ce(r,n),r.prototype.children=["variable","args"],r.prototype.newInstance=function(){var e,n;return e=(null!=(n=this.variable)?n.base:void 0)||this.variable,e instanceof r&&!e.isNew?e.newInstance():this.isNew=!0,this},r.prototype.superReference=function(n){var t,r,a;if(r=n.scope.namedMethod(),!r)throw SyntaxError("cannot call super outside of a function.");if(a=r.name,null==a)throw SyntaxError("cannot call super on an anonymous function.");return r.klass?(t=[new e(new T("__super__"))],r["static"]&&t.push(new e(new T("constructor"))),t.push(new e(new T(a))),new K(new T(r.klass),t).compile(n)):""+a+".__super__.constructor"},r.prototype.superThis=function(e){var n;return n=e.scope.method,n&&!n.klass&&n.context||"this"},r.prototype.unfoldSoak=function(e){var n,t,a,i,o,s,u,l,c;if(this.soak){if(this.variable){if(t=ie(e,this,"variable"))return t;l=new K(this.variable).cacheReference(e),a=l[0],o=l[1]}else a=new T(this.superReference(e)),o=new K(a);return o=new r(o,this.args),o.isNew=this.isNew,a=new T("typeof "+a.compile(e)+' === "function"'),new g(a,new K(o),{soak:!0})}for(n=this,i=[];;)if(n.variable instanceof r)i.push(n),n=n.variable;else{if(!(n.variable instanceof K))break;if(i.push(n),!((n=n.variable.base)instanceof r))break}for(c=i.reverse(),s=0,u=c.length;u>s;s++)n=c[s],t&&(n.variable instanceof r?n.variable=t:n.variable.base=t),t=ie(e,n,"variable");return t},r.prototype.filterImplicitObjects=function(e){var n,r,a,i,o,s,u,c,f,d;for(r=[],s=0,c=e.length;c>s;s++)if(n=e[s],("function"==typeof n.isObject?n.isObject():void 0)&&n.base.generated)for(a=null,d=n.base.properties,u=0,f=d.length;f>u;u++)i=d[u],i instanceof t||i instanceof l?(a||r.push(a=new D(o=[],!0)),o.push(i)):(r.push(i),a=null);else r.push(n);return r},r.prototype.compileNode=function(e){var n,t,r,a;return null!=(a=this.variable)&&(a.front=this.front),(r=I.compileSplattedArray(e,this.args,!0))?this.compileSplat(e,r):(t=this.filterImplicitObjects(this.args),t=function(){var r,a,i;for(i=[],r=0,a=t.length;a>r;r++)n=t[r],i.push(n.compile(e,k));return i}().join(", "),this.isSuper?this.superReference(e)+(".call("+this.superThis(e)+(t&&", "+t)+")"):(this.isNew?"new ":"")+this.variable.compile(e,_)+("("+t+")"))},r.prototype.compileSuper=function(e,n){return""+this.superReference(n)+".call("+this.superThis(n)+(e.length?", ":"")+e+")"},r.prototype.compileSplat=function(e,n){var t,r,a,i,o;return this.isSuper?""+this.superReference(e)+".apply("+this.superThis(e)+", "+n+")":this.isNew?(a=this.tab+P,"(function(func, args, ctor) {\n"+a+"ctor.prototype = func.prototype;\n"+a+"var child = new ctor, result = func.apply(child, args), t = typeof result;\n"+a+'return t == "object" || t == "function" ? result || child : child;\n'+this.tab+"})("+this.variable.compile(e,k)+", "+n+", function(){})"):(t=new K(this.variable),(i=t.properties.pop())&&t.isComplex()?(o=e.scope.freeVariable("ref"),r="("+o+" = "+t.compile(e,k)+")"+i.compile(e)):(r=t.compile(e,_),j.test(r)&&(r="("+r+")"),i?(o=r,r+=i.compile(e)):o="null"),""+r+".apply("+o+", "+n+")")},r}(r),exports.Extends=f=function(e){function n(e,n){this.child=e,this.parent=n}return ce(n,e),n.prototype.children=["child","parent"],n.prototype.compile=function(e){return new i(new K(new T(oe("extends"))),[this.child,this.parent]).compile(e)},n}(r),exports.Access=e=function(e){function n(e,n){this.name=e,this.name.asKey=!0,this.soak="soak"===n}return ce(n,e),n.prototype.children=["name"],n.prototype.compile=function(e){var n;return n=this.name.compile(e),h.test(n)?"."+n:"["+n+"]"},n.prototype.isComplex=A,n}(r),exports.Index=v=function(e){function n(e){this.index=e}return ce(n,e),n.prototype.children=["index"],n.prototype.compile=function(e){return"["+this.index.compile(e,S)+"]"},n.prototype.isComplex=function(){return this.index.isComplex()},n}(r),exports.Range=F=function(e){function n(e,n,t){this.from=e,this.to=n,this.exclusive="exclusive"===t,this.equals=this.exclusive?"":"="}return ce(n,e),n.prototype.children=["from","to"],n.prototype.compileVariables=function(e){var n,t,r,a,i;return e=te(e,{top:!0}),t=this.from.cache(e,k),this.fromC=t[0],this.fromVar=t[1],r=this.to.cache(e,k),this.toC=r[0],this.toVar=r[1],(n=Z(e,"step"))&&(a=n.cache(e,k),this.step=a[0],this.stepVar=a[1]),i=[this.fromVar.match(j),this.toVar.match(j)],this.fromNum=i[0],this.toNum=i[1],this.stepVar?this.stepNum=this.stepVar.match(j):void 0},n.prototype.compileNode=function(e){var n,t,r,a,i,o,s,u,l,c,f,d,h,p;return this.fromVar||this.compileVariables(e),e.index?(s=this.fromNum&&this.toNum,i=Z(e,"index"),o=Z(e,"name"),l=o&&o!==i,d=""+i+" = "+this.fromC,this.toC!==this.toVar&&(d+=", "+this.toC),this.step!==this.stepVar&&(d+=", "+this.step),h=[""+i+" <"+this.equals,""+i+" >"+this.equals],u=h[0],a=h[1],t=this.stepNum?+this.stepNum>0?""+u+" "+this.toVar:""+a+" "+this.toVar:s?(p=[+this.fromNum,+this.toNum],r=p[0],f=p[1],p,f>=r?""+u+" "+f:""+a+" "+f):(n=""+this.fromVar+" <= "+this.toVar,""+n+" ? "+u+" "+this.toVar+" : "+a+" "+this.toVar),c=this.stepVar?""+i+" += "+this.stepVar:s?l?f>=r?"++"+i:"--"+i:f>=r?""+i+"++":""+i+"--":l?""+n+" ? ++"+i+" : --"+i:""+n+" ? "+i+"++ : "+i+"--",l&&(d=""+o+" = "+d),l&&(c=""+o+" = "+c),""+d+"; "+t+"; "+c):this.compileArray(e)},n.prototype.compileArray=function(e){var n,t,r,a,i,o,s,u,l,c,f,h,m;return this.fromNum&&this.toNum&&Math.abs(this.fromNum-this.toNum)<=20?(l=function(){m=[];for(var e=h=+this.fromNum,n=+this.toNum;n>=h?n>=e:e>=n;n>=h?e++:e--)m.push(e);return m}.apply(this),this.exclusive&&l.pop(),"["+l.join(", ")+"]"):(o=this.tab+P,i=e.scope.freeVariable("i"),c=e.scope.freeVariable("results"),u="\n"+o+c+" = [];",this.fromNum&&this.toNum?(e.index=i,t=this.compileNode(e)):(f=""+i+" = "+this.fromC+(this.toC!==this.toVar?", "+this.toC:""),r=""+this.fromVar+" <= "+this.toVar,t="var "+f+"; "+r+" ? "+i+" <"+this.equals+" "+this.toVar+" : "+i+" >"+this.equals+" "+this.toVar+"; "+r+" ? "+i+"++ : "+i+"--"),s="{ "+c+".push("+i+"); }\n"+o+"return "+c+";\n"+e.indent,a=function(e){return null!=e?e.contains(function(e){return e instanceof T&&"arguments"===e.value&&!e.asKey}):void 0},(a(this.from)||a(this.to))&&(n=", arguments"),"(function() {"+u+"\n"+o+"for ("+t+")"+s+"}).apply(this"+(null!=n?n:"")+")")},n}(r),exports.Slice=B=function(e){function n(e){this.range=e,n.__super__.constructor.call(this)}return ce(n,e),n.prototype.children=["range"],n.prototype.compileNode=function(e){var n,t,r,a,i,o;return o=this.range,a=o.to,t=o.from,r=t&&t.compile(e,S)||"0",n=a&&a.compile(e,S),a&&(this.range.exclusive||-1!==+n)&&(i=", "+(this.range.exclusive?n:j.test(n)?""+(+n+1):(n=a.compile(e,_),""+n+" + 1 || 9e9"))),".slice("+r+(i||"")+")"},n}(r),exports.Obj=D=function(e){function n(e,n){this.generated=null!=n?n:!1,this.objects=this.properties=e||[]}return ce(n,e),n.prototype.children=["properties"],n.prototype.compileNode=function(e){var n,r,a,i,o,s,u,c,f,d,h,p,m,g,b,v;for(h=this.properties,d=[],v=this.properties,p=0,g=v.length;g>p;p++)if(c=v[p],c.isComplex()&&(c=c.variable),null!=c){if(f=c.unwrapAll().value.toString(),fe.call(d,f)>=0)throw SyntaxError('multiple object literal properties named "'+f+'"');d.push(f)}if(!h.length)return this.front?"({})":"{}";if(this.generated)for(m=0,b=h.length;b>m;m++)if(s=h[m],s instanceof K)throw new Error("cannot have an implicit value in an implicit object");return r=e.indent+=P,o=this.lastNonComment(this.properties),h=function(){var s,u,f;for(f=[],n=s=0,u=h.length;u>s;n=++s)c=h[n],i=n===h.length-1?"":c===o||c instanceof l?"\n":",\n",a=c instanceof l?"":r,c instanceof K&&c["this"]&&(c=new t(c.properties[0].name,c,"object")),c instanceof l||(c instanceof t||(c=new t(c,c,"object")),(c.variable.base||c.variable).asKey=!0),f.push(a+c.compile(e,x)+i);return f}(),h=h.join(""),u="{"+(h&&"\n"+h+"\n"+this.tab)+"}",this.front?"("+u+")":u},n.prototype.assigns=function(e){var n,t,r,a;for(a=this.properties,t=0,r=a.length;r>t;t++)if(n=a[t],n.assigns(e))return!0;return!1},n}(r),exports.Arr=n=function(e){function n(e){this.objects=e||[]}return ce(n,e),n.prototype.children=["objects"],n.prototype.filterImplicitObjects=i.prototype.filterImplicitObjects,n.prototype.compileNode=function(e){var n,t,r;return this.objects.length?(e.indent+=P,r=this.filterImplicitObjects(this.objects),(n=I.compileSplattedArray(e,r))?n:(n=function(){var n,a,i;for(i=[],n=0,a=r.length;a>n;n++)t=r[n],i.push(t.compile(e,k));return i}().join(", "),n.indexOf("\n")>=0?"[\n"+e.indent+n+"\n"+this.tab+"]":"["+n+"]")):"[]"},n.prototype.assigns=function(e){var n,t,r,a;for(a=this.objects,t=0,r=a.length;r>t;t++)if(n=a[t],n.assigns(e))return!0;return!1},n}(r),exports.Class=o=function(n){function r(e,n,t){this.variable=e,this.parent=n,this.body=null!=t?t:new a,this.boundFuncs=[],this.body.classBody=!0}return ce(r,n),r.prototype.children=["variable","parent","body"],r.prototype.determineName=function(){var n,t;if(!this.variable)return null;if(n=(t=ne(this.variable.properties))?t instanceof e&&t.name.value:this.variable.base.value,fe.call(q,n)>=0)throw SyntaxError("variable name may not be "+n);return n&&(n=h.test(n)&&n)},r.prototype.setContext=function(e){return this.body.traverseChildren(!1,function(n){return n.classBody?!1:n instanceof T&&"this"===n.value?n.value=e:n instanceof u&&(n.klass=e,n.bound)?n.context=e:void 0})},r.prototype.addBoundFunctions=function(n){var t,r,a,i,o,s;if(this.boundFuncs.length){for(o=this.boundFuncs,s=[],a=0,i=o.length;i>a;a++)t=o[a],r=new K(new T("this"),[new e(t)]).compile(n),s.push(this.ctor.body.unshift(new T(""+r+" = "+oe("bind")+"("+r+", this)")));return s}},r.prototype.addProperties=function(n,r,a){var i,o,s,l,c;return c=n.base.properties.slice(0),s=function(){var n;for(n=[];i=c.shift();){if(i instanceof t)if(o=i.variable.base,delete i.context,l=i.value,"constructor"===o.value){if(this.ctor)throw new Error("cannot define more than one constructor in a class");if(l.bound)throw new Error("cannot define a constructor as a bound function");l instanceof u?i=this.ctor=l:(this.externalCtor=a.scope.freeVariable("class"),i=new t(new T(this.externalCtor),l))}else i.variable["this"]?(l["static"]=!0,l.bound&&(l.context=r)):(i.variable=new K(new T(r),[new e(new T("prototype")),new e(o)]),l instanceof u&&l.bound&&(this.boundFuncs.push(o),l.bound=!1));n.push(i)}return n}.call(this),J(s)},r.prototype.walkBody=function(e,n){var t=this;return this.traverseChildren(!1,function(i){var o,s,u,l,c,f;if(i instanceof r)return!1;if(i instanceof a){for(f=o=i.expressions,s=l=0,c=f.length;c>l;s=++l)u=f[s],u instanceof K&&u.isObject(!0)&&(o[s]=t.addProperties(u,e,n));return i.expressions=o=ee(o)}})},r.prototype.hoistDirectivePrologue=function(){var e,n,t;for(n=0,e=this.body.expressions;(t=e[n])&&t instanceof l||t instanceof K&&t.isString();)++n;return this.directives=e.splice(0,n)},r.prototype.ensureConstructor=function(e){return this.ctor||(this.ctor=new u,this.parent&&this.ctor.body.push(new T(""+e+".__super__.constructor.apply(this, arguments)")),this.externalCtor&&this.ctor.body.push(new T(""+this.externalCtor+".apply(this, arguments)")),this.ctor.body.makeReturn(),this.body.expressions.unshift(this.ctor)),this.ctor.ctor=this.ctor.name=e,this.ctor.klass=null,this.ctor.noReturn=!0},r.prototype.compileNode=function(e){var n,r,a,i,o,l,c;return r=this.determineName(),o=r||"_Class",o.reserved&&(o="_"+o),i=new T(o),this.hoistDirectivePrologue(),this.setContext(o),this.walkBody(o,e),this.ensureConstructor(o),this.body.spaced=!0,this.ctor instanceof u||this.body.expressions.unshift(this.ctor),this.body.expressions.push(i),(c=this.body.expressions).unshift.apply(c,this.directives),this.addBoundFunctions(e),n=s.wrap(this.body),this.parent&&(this.superClass=new T(e.scope.freeVariable("super",!1)),this.body.expressions.unshift(new f(i,this.superClass)),n.args.push(this.parent),l=n.variable.params||n.variable.base.params,l.push(new H(this.superClass))),a=new C(n,!0),this.variable&&(a=new t(this.variable,a)),a.compile(e)},r}(r),exports.Assign=t=function(n){function t(e,n,t,r){var a,i,o;if(this.variable=e,this.value=n,this.context=t,this.param=r&&r.param,this.subpattern=r&&r.subpattern,o=i=this.variable.unwrapAll().value,a=fe.call(q,o)>=0,a&&"object"!==this.context)throw SyntaxError('variable name may not be "'+i+'"')}return ce(t,n),t.prototype.children=["variable","value"],t.prototype.isStatement=function(e){return(null!=e?e.level:void 0)===x&&null!=this.context&&fe.call(this.context,"?")>=0},t.prototype.assigns=function(e){return this["object"===this.context?"value":"variable"].assigns(e)},t.prototype.unfoldSoak=function(e){return ie(e,this,"variable")},t.prototype.compileNode=function(e){var n,t,r,a,i,o,s,l,c;if(n=this.variable instanceof K){if(this.variable.isArray()||this.variable.isObject())return this.compilePatternMatch(e);if(this.variable.isSplice())return this.compileSplice(e);if("||="===(o=this.context)||"&&="===o||"?="===o)return this.compileConditional(e)}if(r=this.variable.compile(e,k),!this.context){if(!(i=this.variable.unwrapAll()).isAssignable())throw SyntaxError('"'+this.variable.compile(e)+'" cannot be assigned.');("function"==typeof i.hasProperties?i.hasProperties():void 0)||(this.param?e.scope.add(r,"var"):e.scope.find(r))}return this.value instanceof u&&(t=M.exec(r))&&(t[1]&&(this.value.klass=t[1]),this.value.name=null!=(s=null!=(l=null!=(c=t[2])?c:t[3])?l:t[4])?s:t[5]),a=this.value.compile(e,k),"object"===this.context?""+r+": "+a:(a=r+(" "+(this.context||"=")+" ")+a,e.level<=k?a:"("+a+")")},t.prototype.compilePatternMatch=function(n){var r,a,i,o,s,u,l,c,f,d,p,m,g,b,_,y,S,M,L,A,D,E,H,F,Y,j,q;if(_=n.level===x,S=this.value,d=this.variable.base.objects,!(p=d.length))return i=S.compile(n),n.level>=w?"("+i+")":i;if(u=this.variable.isObject(),_&&1===p&&!((f=d[0])instanceof I)){if(f instanceof t?(D=f,E=D.variable,s=E.base,f=D.value):f.base instanceof C?(H=new K(f.unwrapAll()).cacheReference(n),f=H[0],s=H[1]):s=u?f["this"]?f.properties[0].name:f:new T(0),r=h.test(s.unwrap().value||0),S=new K(S),S.properties.push(new(r?e:v)(s)),F=f.unwrap().value,fe.call(z,F)>=0)throw new SyntaxError("assignment to a reserved word: "+f.compile(n)+" = "+S.compile(n));return new t(f,S,null,{param:this.param}).compile(n,x)}for(M=S.compile(n,k),a=[],b=!1,(!h.test(M)||this.variable.assigns(M))&&(a.push(""+(m=n.scope.freeVariable("ref"))+" = "+M),M=m),o=L=0,A=d.length;A>L;o=++L){if(f=d[o],s=o,u&&(f instanceof t?(Y=f,j=Y.variable,s=j.base,f=Y.value):f.base instanceof C?(q=new K(f.unwrapAll()).cacheReference(n),f=q[0],s=q[1]):s=f["this"]?f.properties[0].name:f),!b&&f instanceof I)c=f.name.unwrap().value,f=f.unwrap(),y=""+p+" <= "+M+".length ? "+oe("slice")+".call("+M+", "+o,(g=p-o-1)?(l=n.scope.freeVariable("i"),y+=", "+l+" = "+M+".length - "+g+") : ("+l+" = "+o+", [])"):y+=") : []",y=new T(y),b=""+l+"++";else{if(c=f.unwrap().value,f instanceof I)throw f=f.name.compile(n),new SyntaxError("multiple splats are disallowed in an assignment: "+f+"...");"number"==typeof s?(s=new T(b||s),r=!1):r=u&&h.test(s.unwrap().value||0),y=new K(new T(M),[new(r?e:v)(s)])}if(null!=c&&fe.call(z,c)>=0)throw new SyntaxError("assignment to a reserved word: "+f.compile(n)+" = "+y.compile(n));a.push(new t(f,y,null,{param:this.param,subpattern:!0}).compile(n,k))}return _||this.subpattern||a.push(M),i=a.join(", "),n.level<k?i:"("+i+")"},t.prototype.compileConditional=function(e){var n,r,a;if(a=this.variable.cacheReference(e),n=a[0],r=a[1],!n.properties.length&&n.base instanceof T&&"this"!==n.base.value&&!e.scope.check(n.base.value))throw new Error('the variable "'+n.base.value+"\" can't be assigned with "+this.context+" because it has not been defined.");return fe.call(this.context,"?")>=0&&(e.isExistentialEquals=!0),new E(this.context.slice(0,-1),n,new t(r,this.value,"=")).compile(e)},t.prototype.compileSplice=function(e){var n,t,r,a,i,o,s,u,l,c,f,d;return c=this.variable.properties.pop().range,r=c.from,s=c.to,t=c.exclusive,o=this.variable.compile(e),f=(null!=r?r.cache(e,w):void 0)||["0","0"],a=f[0],i=f[1],s?(null!=r?r.isSimpleNumber():void 0)&&s.isSimpleNumber()?(s=+s.compile(e)-+i,t||(s+=1)):(s=s.compile(e,_)+" - "+i,t||(s+=" + 1")):s="9e9",d=this.value.cache(e,k),u=d[0],l=d[1],n="[].splice.apply("+o+", ["+a+", "+s+"].concat("+u+")), "+l,e.level>x?"("+n+")":n},t}(r),exports.Code=u=function(e){function r(e,n,t){this.params=e||[],this.body=n||new a,this.bound="boundfunc"===t,this.bound&&(this.context="_this")}return ce(r,e),r.prototype.children=["params","body"],r.prototype.isStatement=function(){return!!this.ctor},r.prototype.jumps=A,r.prototype.compileNode=function(e){var r,a,i,o,s,u,l,c,f,d,h,p,m,b,v,y,k,w,S,x,M,L,A,D,H,C,z,F,Y,j,q,B,I;for(e.scope=new O(e.scope,this.body,this),e.scope.shared=Z(e,"sharedScope"),e.indent+=P,delete e.bare,delete e.isExistentialEquals,f=[],a=[],z=this.paramNames(),v=0,S=z.length;S>v;v++)u=z[v],e.scope.check(u)||e.scope.parameter(u);for(F=this.params,y=0,x=F.length;x>y;y++)if(c=F[y],c.splat){for(Y=this.params,k=0,M=Y.length;M>k;k++)l=Y[k].name,l["this"]&&(l=l.properties[0].name),l.value&&e.scope.add(l.value,"var",!0);h=new t(new K(new n(function(){var n,t,r,a;for(r=this.params,a=[],n=0,t=r.length;t>n;n++)l=r[n],a.push(l.asReference(e));return a}.call(this))),new K(new T("arguments")));break}for(j=this.params,w=0,L=j.length;L>w;w++)c=j[w],c.isComplex()?(m=d=c.asReference(e),c.value&&(m=new E("?",d,c.value)),a.push(new t(new K(c.name),m,"=",{param:!0}))):(d=c,c.value&&(s=new T(d.name.value+" == null"),m=new t(new K(c.name),c.value,"="),a.push(new g(s,m)))),h||f.push(d);for(b=this.body.isEmpty(),h&&a.unshift(h),a.length&&(q=this.body.expressions).unshift.apply(q,a),i=H=0,A=f.length;A>H;i=++H)l=f[i],e.scope.parameter(f[i]=l.compile(e));for(p=[],B=this.paramNames(),C=0,D=B.length;D>C;C++){if(u=B[C],fe.call(p,u)>=0)throw SyntaxError("multiple parameters named '"+u+"'");p.push(u)}return b||this.noReturn||this.body.makeReturn(),this.bound&&((null!=(I=e.scope.parent.method)?I.bound:void 0)?this.bound=this.context=e.scope.parent.method.context:this["static"]||e.scope.parent.assign("_this","this")),o=e.indent,r="function",this.ctor&&(r+=" "+this.name),r+="("+f.join(", ")+") {",this.body.isEmpty()||(r+="\n"+this.body.compileWithDeclarations(e)+"\n"+this.tab),r+="}",this.ctor?this.tab+r:this.front||e.level>=_?"("+r+")":r},r.prototype.paramNames=function(){var e,n,t,r,a;for(e=[],a=this.params,t=0,r=a.length;r>t;t++)n=a[t],e.push.apply(e,n.names());return e},r.prototype.traverseChildren=function(e,n){return e?r.__super__.traverseChildren.call(this,e,n):void 0},r}(r),exports.Param=H=function(e){function n(e,n,t){var r;if(this.name=e,this.value=n,this.splat=t,r=e=this.name.unwrapAll().value,fe.call(q,r)>=0)throw SyntaxError('parameter name "'+e+'" is not allowed')}return ce(n,e),n.prototype.children=["name","value"],n.prototype.compile=function(e){return this.name.compile(e,k)},n.prototype.asReference=function(e){var n;return this.reference?this.reference:(n=this.name,n["this"]?(n=n.properties[0].name,n.value.reserved&&(n=new T(e.scope.freeVariable(n.value)))):n.isComplex()&&(n=new T(e.scope.freeVariable("arg"))),n=new K(n),this.splat&&(n=new I(n)),this.reference=n)},n.prototype.isComplex=function(){return this.name.isComplex()},n.prototype.names=function(e){var n,r,a,i,o,s;if(null==e&&(e=this.name),n=function(e){var n;return n=e.properties[0].name.value,n.reserved?[]:[n]},e instanceof T)return[e.value];if(e instanceof K)return n(e);for(r=[],s=e.objects,i=0,o=s.length;o>i;i++)if(a=s[i],a instanceof t)r.push(a.value.unwrap().value);else if(a instanceof I)r.push(a.name.unwrap().value);else{if(!(a instanceof K))throw SyntaxError("illegal parameter "+a.compile());a.isArray()||a.isObject()?r.push.apply(r,this.names(a.base)):a["this"]?r.push.apply(r,n(a)):r.push(a.base.value)}return r},n}(r),exports.Splat=I=function(e){function n(e){this.name=e.compile?e:new T(e)}return ce(n,e),n.prototype.children=["name"],n.prototype.isAssignable=V,n.prototype.assigns=function(e){return this.name.assigns(e)},n.prototype.compile=function(e){return null!=this.index?this.compileParam(e):this.name.compile(e)},n.prototype.unwrap=function(){return this.name},n.compileSplattedArray=function(e,t,r){var a,i,o,s,u,l,c,f;for(u=-1;(l=t[++u])&&!(l instanceof n););if(u>=t.length)return"";if(1===t.length)return o=t[0].compile(e,k),r?o:""+oe("slice")+".call("+o+")";for(a=t.slice(u),s=c=0,f=a.length;f>c;s=++c)l=a[s],o=l.compile(e,k),a[s]=l instanceof n?""+oe("slice")+".call("+o+")":"["+o+"]";return 0===u?a[0]+(".concat("+a.slice(1).join(", ")+")"):(i=function(){var n,r,a,i;for(a=t.slice(0,u),i=[],n=0,r=a.length;r>n;n++)l=a[n],i.push(l.compile(e,k));return i}(),"["+i.join(", ")+"].concat("+a.join(", ")+")")},n}(r),exports.While=G=function(e){function n(e,n){this.condition=(null!=n?n.invert:void 0)?e.invert():e,this.guard=null!=n?n.guard:void 0}return ce(n,e),n.prototype.children=["condition","guard","body"],n.prototype.isStatement=V,n.prototype.makeReturn=function(e){return e?n.__super__.makeReturn.apply(this,arguments):(this.returns=!this.jumps({loop:!0}),this)},n.prototype.addBody=function(e){return this.body=e,this},n.prototype.jumps=function(){var e,n,t,r;if(e=this.body.expressions,!e.length)return!1;for(t=0,
r=e.length;r>t;t++)if(n=e[t],n.jumps({loop:!0}))return n;return!1},n.prototype.compileNode=function(e){var n,t,r,i;return e.indent+=P,i="",n=this.body,n.isEmpty()?n="":(this.returns&&(n.makeReturn(r=e.scope.freeVariable("results")),i=""+this.tab+r+" = [];\n"),this.guard&&(n.expressions.length>1?n.expressions.unshift(new g(new C(this.guard).invert(),new T("continue"))):this.guard&&(n=a.wrap([new g(this.guard,n)]))),n="\n"+n.compile(e,x)+"\n"+this.tab),t=i+this.tab+("while ("+this.condition.compile(e,S)+") {"+n+"}"),this.returns&&(t+="\n"+this.tab+"return "+r+";"),t},n}(r),exports.Op=E=function(e){function a(e,t,r,a){if("in"===e)return new b(t,r);if("do"===e)return this.generateDo(t);if("new"===e){if(t instanceof i&&!t["do"]&&!t.isNew)return t.newInstance();(t instanceof u&&t.bound||t["do"])&&(t=new C(t))}return this.operator=n[e]||e,this.first=t,this.second=r,this.flip=!!a,this}var n,r;return ce(a,e),n={"==":"===","!=":"!==",of:"in"},r={"!==":"===","===":"!=="},a.prototype.children=["first","second"],a.prototype.isSimpleNumber=A,a.prototype.isUnary=function(){return!this.second},a.prototype.isComplex=function(){var e;return!(this.isUnary()&&("+"===(e=this.operator)||"-"===e))||this.first.isComplex()},a.prototype.isChainable=function(){var e;return"<"===(e=this.operator)||">"===e||">="===e||"<="===e||"==="===e||"!=="===e},a.prototype.invert=function(){var e,n,t,i,o;if(this.isChainable()&&this.first.isChainable()){for(e=!0,n=this;n&&n.operator;)e&&(e=n.operator in r),n=n.first;if(!e)return new C(this).invert();for(n=this;n&&n.operator;)n.invert=!n.invert,n.operator=r[n.operator],n=n.first;return this}return(i=r[this.operator])?(this.operator=i,this.first.unwrap()instanceof a&&this.first.invert(),this):this.second?new C(this).invert():"!"===this.operator&&(t=this.first.unwrap())instanceof a&&("!"===(o=t.operator)||"in"===o||"instanceof"===o)?t:new a("!",this)},a.prototype.unfoldSoak=function(e){var n;return("++"===(n=this.operator)||"--"===n||"delete"===n)&&ie(e,this,"first")},a.prototype.generateDo=function(e){var n,r,a,o,s,l,c,f;for(o=[],r=e instanceof t&&(s=e.value.unwrap())instanceof u?s:e,f=r.params||[],l=0,c=f.length;c>l;l++)a=f[l],a.value?(o.push(a.value),delete a.value):o.push(a);return n=new i(e,o),n["do"]=!0,n},a.prototype.compileNode=function(e){var n,t,r,a;if(t=this.isChainable()&&this.first.isChainable(),t||(this.first.front=this.front),"delete"===this.operator&&e.scope.check(this.first.unwrapAll().value))throw SyntaxError("delete operand may not be argument or var");if(("--"===(r=this.operator)||"++"===r)&&(a=this.first.unwrapAll().value,fe.call(q,a)>=0))throw SyntaxError("prefix increment/decrement may not have eval or arguments operand");return this.isUnary()?this.compileUnary(e):t?this.compileChain(e):"?"===this.operator?this.compileExistence(e):(n=this.first.compile(e,w)+" "+this.operator+" "+this.second.compile(e,w),e.level<=w?n:"("+n+")")},a.prototype.compileChain=function(e){var n,t,r,a;return a=this.first.second.cache(e),this.first.second=a[0],r=a[1],t=this.first.compile(e,w),n=""+t+" "+(this.invert?"&&":"||")+" "+r.compile(e)+" "+this.operator+" "+this.second.compile(e,w),"("+n+")"},a.prototype.compileExistence=function(e){var n,r;return this.first.isComplex()?(r=new T(e.scope.freeVariable("ref")),n=new C(new t(r,this.first))):(n=this.first,r=n),new g(new c(n),r,{type:"if"}).addElse(this.second).compile(e)},a.prototype.compileUnary=function(e){var n,t,r;return e.level>=_?new C(this).compile(e):(t=[n=this.operator],r="+"===n||"-"===n,("new"===n||"typeof"===n||"delete"===n||r&&this.first instanceof a&&this.first.operator===n)&&t.push(" "),(r&&this.first instanceof a||"new"===n&&this.first.isStatement(e))&&(this.first=new C(this.first)),t.push(this.first.compile(e,w)),this.flip&&t.reverse(),t.join(""))},a.prototype.toString=function(e){return a.__super__.toString.call(this,e,this.constructor.name+" "+this.operator)},a}(r),exports.In=b=function(e){function n(e,n){this.object=e,this.array=n}return ce(n,e),n.prototype.children=["object","array"],n.prototype.invert=L,n.prototype.compileNode=function(e){var n,t,r,a,i;if(this.array instanceof K&&this.array.isArray()){for(i=this.array.base.objects,r=0,a=i.length;a>r;r++)if(t=i[r],t instanceof I){n=!0;break}if(!n)return this.compileOrTest(e)}return this.compileLoopTest(e)},n.prototype.compileOrTest=function(e){var n,t,r,a,i,o,s,u,l;return 0===this.array.base.objects.length?""+!!this.negated:(u=this.object.cache(e,w),o=u[0],i=u[1],l=this.negated?[" !== "," && "]:[" === "," || "],n=l[0],t=l[1],s=function(){var t,s,u,l;for(u=this.array.base.objects,l=[],r=t=0,s=u.length;s>t;r=++t)a=u[r],l.push((r?i:o)+n+a.compile(e,_));return l}.call(this),s=s.join(t),e.level<w?s:"("+s+")")},n.prototype.compileLoopTest=function(e){var n,t,r,a;return a=this.object.cache(e,k),r=a[0],t=a[1],n=oe("indexOf")+(".call("+this.array.compile(e,k)+", "+t+") ")+(this.negated?"< 0":">= 0"),r===t?n:(n=r+", "+n,e.level<k?n:"("+n+")")},n.prototype.toString=function(e){return n.__super__.toString.call(this,e,this.constructor.name+(this.negated?"!":""))},n}(r),exports.Try=U=function(e){function n(e,n,t,r){this.attempt=e,this.error=n,this.recovery=t,this.ensure=r}return ce(n,e),n.prototype.children=["attempt","recovery","ensure"],n.prototype.isStatement=V,n.prototype.jumps=function(e){var n;return this.attempt.jumps(e)||(null!=(n=this.recovery)?n.jumps(e):void 0)},n.prototype.makeReturn=function(e){return this.attempt&&(this.attempt=this.attempt.makeReturn(e)),this.recovery&&(this.recovery=this.recovery.makeReturn(e)),this},n.prototype.compileNode=function(e){var n,t,r,a;return e.indent+=P,r=this.error?" ("+this.error.compile(e)+") ":" ",a=this.attempt.compile(e,x),n=function(){var n;if(this.recovery){if(n=this.error.value,fe.call(q,n)>=0)throw SyntaxError('catch variable may not be "'+this.error.value+'"');return e.scope.check(this.error.value)||e.scope.add(this.error.value,"param")," catch"+r+"{\n"+this.recovery.compile(e,x)+"\n"+this.tab+"}"}return this.ensure||this.recovery?void 0:" catch (_error) {}"}.call(this),t=this.ensure?" finally {\n"+this.ensure.compile(e,x)+"\n"+this.tab+"}":"",""+this.tab+"try {\n"+a+"\n"+this.tab+"}"+(n||"")+t},n}(r),exports.Throw=R=function(e){function n(e){this.expression=e}return ce(n,e),n.prototype.children=["expression"],n.prototype.isStatement=V,n.prototype.jumps=A,n.prototype.makeReturn=$,n.prototype.compileNode=function(e){return this.tab+("throw "+this.expression.compile(e)+";")},n}(r),exports.Existence=c=function(e){function n(e){this.expression=e}return ce(n,e),n.prototype.children=["expression"],n.prototype.invert=L,n.prototype.compileNode=function(e){var n,t,r,a;return this.expression.front=this.front,r=this.expression.compile(e,w),h.test(r)&&!e.scope.check(r)?(a=this.negated?["===","||"]:["!==","&&"],n=a[0],t=a[1],r="typeof "+r+" "+n+' "undefined" '+t+" "+r+" "+n+" null"):r=""+r+" "+(this.negated?"==":"!=")+" null",e.level<=y?r:"("+r+")"},n}(r),exports.Parens=C=function(e){function n(e){this.body=e}return ce(n,e),n.prototype.children=["body"],n.prototype.unwrap=function(){return this.body},n.prototype.isComplex=function(){return this.body.isComplex()},n.prototype.compileNode=function(e){var n,t,r;return r=this.body.unwrap(),r instanceof K&&r.isAtomic()?(r.front=this.front,r.compile(e)):(t=r.compile(e,S),n=e.level<w&&(r instanceof E||r instanceof i||r instanceof d&&r.returns),n?t:"("+t+")")},n}(r),exports.For=d=function(e){function n(e,n){var t;if(this.source=n.source,this.guard=n.guard,this.step=n.step,this.name=n.name,this.index=n.index,this.body=a.wrap([e]),this.own=!!n.own,this.object=!!n.object,this.object&&(t=[this.index,this.name],this.name=t[0],this.index=t[1]),this.index instanceof K)throw SyntaxError("index cannot be a pattern matching expression");if(this.range=this.source instanceof K&&this.source.base instanceof F&&!this.source.properties.length,this.pattern=this.name instanceof K,this.range&&this.index)throw SyntaxError("indexes do not apply to range loops");if(this.range&&this.pattern)throw SyntaxError("cannot pattern match over range loops");this.returns=!1}return ce(n,e),n.prototype.children=["body","source","guard","step"],n.prototype.compileNode=function(e){var n,r,i,o,s,u,l,c,f,d,p,m,b,v,_,y,S,M,L,A,D,E,H,z,F;return n=a.wrap([this.body]),p=null!=(F=ne(n.expressions))?F.jumps():void 0,p&&p instanceof Y&&(this.returns=!1),A=this.range?this.source.base:this.source,L=e.scope,b=this.name&&this.name.compile(e,k),l=this.index&&this.index.compile(e,k),b&&!this.pattern&&L.find(b),l&&L.find(l),this.returns&&(M=L.freeVariable("results")),c=this.object&&l||L.freeVariable("i"),f=this.range&&b||l||c,d=f!==c?""+f+" = ":"",this.step&&!this.range&&(E=L.freeVariable("step")),this.pattern&&(b=c),z="",s="",r="",u=this.tab+P,this.range?i=A.compile(te(e,{index:c,name:b,step:this.step})):(H=this.source.compile(e,k),!b&&!this.own||h.test(H)||(r=""+this.tab+(_=L.freeVariable("ref"))+" = "+H+";\n",H=_),b&&!this.pattern&&(v=""+b+" = "+H+"["+f+"]"),this.object||(m=L.freeVariable("len"),o=""+d+c+" = 0, "+m+" = "+H+".length",this.step&&(o+=", "+E+" = "+this.step.compile(e,w)),D=""+d+(this.step?""+c+" += "+E:f!==c?"++"+c:""+c+"++"),i=""+o+"; "+c+" < "+m+"; "+D)),this.returns&&(y=""+this.tab+M+" = [];\n",S="\n"+this.tab+"return "+M+";",n.makeReturn(M)),this.guard&&(n.expressions.length>1?n.expressions.unshift(new g(new C(this.guard).invert(),new T("continue"))):this.guard&&(n=a.wrap([new g(this.guard,n)]))),this.pattern&&n.expressions.unshift(new t(this.name,new T(""+H+"["+f+"]"))),r+=this.pluckDirectCall(e,n),v&&(z="\n"+u+v+";"),this.object&&(i=""+f+" in "+H,this.own&&(s="\n"+u+"if (!"+oe("hasProp")+".call("+H+", "+f+")) continue;")),n=n.compile(te(e,{indent:u}),x),n&&(n="\n"+n+"\n"),""+r+(y||"")+this.tab+"for ("+i+") {"+s+z+n+this.tab+"}"+(S||"")},n.prototype.pluckDirectCall=function(e,n){var r,a,o,s,l,c,f,d,h,p,m,g,b,v,_;for(a="",p=n.expressions,l=d=0,h=p.length;h>d;l=++d)o=p[l],o=o.unwrapAll(),o instanceof i&&(f=o.variable.unwrapAll(),(f instanceof u||f instanceof K&&(null!=(m=f.base)?m.unwrapAll():void 0)instanceof u&&1===f.properties.length&&("call"===(g=null!=(b=f.properties[0].name)?b.value:void 0)||"apply"===g))&&(s=(null!=(v=f.base)?v.unwrapAll():void 0)||f,c=new T(e.scope.freeVariable("fn")),r=new K(c),f.base&&(_=[r,f],f.base=_[0],r=_[1]),n.expressions[l]=new i(r,o.args),a+=this.tab+new t(c,s).compile(e,x)+";\n"));return a},n}(G),exports.Switch=N=function(e){function n(e,n,t){this.subject=e,this.cases=n,this.otherwise=t}return ce(n,e),n.prototype.children=["subject","cases","otherwise"],n.prototype.isStatement=V,n.prototype.jumps=function(e){var n,t,r,a,i,o,s;for(null==e&&(e={block:!0}),i=this.cases,r=0,a=i.length;a>r;r++)if(o=i[r],t=o[0],n=o[1],n.jumps(e))return n;return null!=(s=this.otherwise)?s.jumps(e):void 0},n.prototype.makeReturn=function(e){var n,t,r,i,o;for(i=this.cases,t=0,r=i.length;r>t;t++)n=i[t],n[1].makeReturn(e);return e&&(this.otherwise||(this.otherwise=new a([new T("void 0")]))),null!=(o=this.otherwise)&&o.makeReturn(e),this},n.prototype.compileNode=function(e){var n,t,r,a,i,o,s,u,l,c,f,d,h,p,m,g,b;for(u=e.indent+P,l=e.indent=u+P,r=this.tab+("switch ("+((null!=(p=this.subject)?p.compile(e,S):void 0)||!1)+") {\n"),m=this.cases,s=c=0,d=m.length;d>c;s=++c){for(g=m[s],i=g[0],n=g[1],b=ee([i]),f=0,h=b.length;h>f;f++)a=b[f],this.subject||(a=a.invert()),r+=u+("case "+a.compile(e,S)+":\n");if((t=n.compile(e,x))&&(r+=t+"\n"),s===this.cases.length-1&&!this.otherwise)break;o=this.lastNonComment(n.expressions),o instanceof Y||o instanceof T&&o.jumps()&&"debugger"!==o.value||(r+=l+"break;\n")}return this.otherwise&&this.otherwise.expressions.length&&(r+=u+("default:\n"+this.otherwise.compile(e,x)+"\n")),r+this.tab+"}"},n}(r),exports.If=g=function(e){function n(e,n,t){this.body=n,null==t&&(t={}),this.condition="unless"===t.type?e.invert():e,this.elseBody=null,this.isChain=!1,this.soak=t.soak}return ce(n,e),n.prototype.children=["condition","body","elseBody"],n.prototype.bodyNode=function(){var e;return null!=(e=this.body)?e.unwrap():void 0},n.prototype.elseBodyNode=function(){var e;return null!=(e=this.elseBody)?e.unwrap():void 0},n.prototype.addElse=function(e){return this.isChain?this.elseBodyNode().addElse(e):(this.isChain=e instanceof n,this.elseBody=this.ensureBlock(e)),this},n.prototype.isStatement=function(e){var n;return(null!=e?e.level:void 0)===x||this.bodyNode().isStatement(e)||(null!=(n=this.elseBodyNode())?n.isStatement(e):void 0)},n.prototype.jumps=function(e){var n;return this.body.jumps(e)||(null!=(n=this.elseBody)?n.jumps(e):void 0)},n.prototype.compileNode=function(e){return this.isStatement(e)?this.compileStatement(e):this.compileExpression(e)},n.prototype.makeReturn=function(e){return e&&(this.elseBody||(this.elseBody=new a([new T("void 0")]))),this.body&&(this.body=new a([this.body.makeReturn(e)])),this.elseBody&&(this.elseBody=new a([this.elseBody.makeReturn(e)])),this},n.prototype.ensureBlock=function(e){return e instanceof a?e:new a([e])},n.prototype.compileStatement=function(e){var t,r,a,i,o;return r=Z(e,"chainChild"),(i=Z(e,"isExistentialEquals"))?new n(this.condition.invert(),this.elseBodyNode(),{type:"if"}).compile(e):(a=this.condition.compile(e,S),e.indent+=P,t=this.ensureBlock(this.body),o="if ("+a+") {\n"+t.compile(e)+"\n"+this.tab+"}",r||(o=this.tab+o),this.elseBody?o+" else "+(this.isChain?(e.indent=this.tab,e.chainChild=!0,this.elseBody.unwrap().compile(e,x)):"{\n"+this.elseBody.compile(e,x)+"\n"+this.tab+"}"):o)},n.prototype.compileExpression=function(e){var n,t,r,a;return a=this.condition.compile(e,y),t=this.bodyNode().compile(e,k),n=this.elseBodyNode()?this.elseBodyNode().compile(e,k):"void 0",r=""+a+" ? "+t+" : "+n,e.level>=y?"("+r+")":r},n.prototype.unfoldSoak=function(){return this.soak&&this},n}(r),s={wrap:function(n,t,r){var o,s,l,c,f;return n.jumps()?n:(l=new u([],a.wrap([n])),o=[],((c=n.contains(this.literalArgs))||n.contains(this.literalThis))&&(f=new T(c?"apply":"call"),o=[new T("this")],c&&o.push(new T("arguments")),l=new K(l,[new e(f)])),l.noReturn=r,s=new i(l,o),t?a.wrap([s]):s)},literalArgs:function(e){return e instanceof T&&"arguments"===e.value&&!e.asKey},literalThis:function(e){return e instanceof T&&"this"===e.value&&!e.asKey||e instanceof u&&e.bound||e instanceof i&&e.isSuper}},ie=function(e,n,t){var r;if(r=n[t].unfoldSoak(e))return n[t]=r.body,r.body=new K(n),r},W={"extends":function(){return"function(child, parent) { for (var key in parent) { if ("+oe("hasProp")+".call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; }"},bind:function(){return"function(fn, me){ return function(){ return fn.apply(me, arguments); }; }"},indexOf:function(){return"[].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; }"},hasProp:function(){return"{}.hasOwnProperty"},slice:function(){return"[].slice"}},x=1,S=2,k=3,y=4,w=5,_=6,P="  ",p="[$A-Za-z_\\x7f-\\uffff][$\\w\\x7f-\\uffff]*",h=RegExp("^"+p+"$"),j=/^[+-]?\d+$/,M=RegExp("^(?:("+p+")\\.prototype(?:\\.("+p+")|\\[(\"(?:[^\\\\\"\\r\\n]|\\\\.)*\"|'(?:[^\\\\'\\r\\n]|\\\\.)*')\\]|\\[(0x[\\da-fA-F]+|\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\]))|("+p+")$"),m=/^['"]/,oe=function(e){var n;return n="__"+e,O.root.assign(n,W[e]()),n},re=function(e,n){return e=e.replace(/\n/g,"$&"+n),e.replace(/\s+$/,"")}}).call(this);