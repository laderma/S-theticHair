function nopt(e,n,t,r){t=t||process.argv,e=e||{},n=n||{},"number"!=typeof r&&(r=2),debug(e,n,t,r),t=t.slice(r);var a={},s=[],o=t,l=t.slice(0);return parse(t,a,s,e,n),clean(a,e,exports.typeDefs),a.argv={remain:s,cooked:o,original:l},a.argv.toString=function(){return this.original.map(JSON.stringify).join(" ")},a}function clean(e,n,t){t=t||exports.typeDefs;var r={},a=[!1,!0,null,String,Number];Object.keys(e).forEach(function(i){if("argv"!==i){var s=e[i],o=Array.isArray(s),l=n[i];o||(s=[s]),l||(l=a),l===Array&&(l=a.concat(Array)),Array.isArray(l)||(l=[l]),debug("val=%j",s),debug("types=",l),s=s.map(function(a){if("string"==typeof a&&(debug("string %j",a),a=a.trim(),"null"===a&&~l.indexOf(null)||"true"===a&&(~l.indexOf(!0)||~l.indexOf(Boolean))||"false"===a&&(~l.indexOf(!1)||~l.indexOf(Boolean))?(a=JSON.parse(a),debug("jsonable %j",a)):~l.indexOf(Number)&&!isNaN(a)?(debug("convert to number",a),a=+a):~l.indexOf(Date)&&!isNaN(Date.parse(a))&&(debug("convert to date",a),a=new Date(a))),!n.hasOwnProperty(i))return a;a!==!1||!~l.indexOf(null)||~l.indexOf(!1)||~l.indexOf(Boolean)||(a=null);var s={};return s[i]=a,debug("prevalidated val",s,a,n[i]),validate(s,i,a,n[i],t)?(debug("validated val",s,a,n[i]),s[i]):(exports.invalidHandler?exports.invalidHandler(i,a,n[i],e):exports.invalidHandler!==!1&&debug("invalid: "+i+"="+a,n[i]),r)}).filter(function(e){return e!==r}),s.length?o?(debug(o,e[i],s),e[i]=s):e[i]=s[0]:delete e[i],debug("k=%s val=%j",i,s,e[i])}})}function validateString(e,n,t){e[n]=String(t)}function validatePath(e,n,t){return e[n]=path.resolve(String(t)),!0}function validateNumber(e,n,t){return debug("validate Number %j %j %j",n,t,isNaN(t)),isNaN(t)?!1:void(e[n]=+t)}function validateDate(e,n,t){debug("validate Date %j %j %j",n,t,Date.parse(t));var r=Date.parse(t);return isNaN(r)?!1:void(e[n]=new Date(t))}function validateBoolean(e,n,t){t=t instanceof Boolean?t.valueOf():"string"==typeof t?isNaN(t)?"null"===t||"false"===t?!1:!0:!!+t:!!t,e[n]=t}function validateUrl(e,n,t){return t=url.parse(String(t)),t.host?void(e[n]=t.href):!1}function validateStream(e,n,t){return t instanceof Stream?void(e[n]=t):!1}function validate(e,n,t,r,a){if(Array.isArray(r)){for(var i=0,s=r.length;s>i;i++)if(r[i]!==Array&&validate(e,n,t,r[i],a))return!0;return delete e[n],!1}if(r===Array)return!0;if(r!==r)return debug("Poison NaN",n,t,r),delete e[n],!1;if(t===r)return debug("Explicitly allowed %j",t),e[n]=t,!0;for(var o=!1,l=Object.keys(a),i=0,s=l.length;s>i;i++){debug("test type %j %j %j",n,t,l[i]);var u=a[l[i]];if(u&&r===u.type){var c={};if(o=!1!==u.validate(c,n,t),t=c[n],o){e[n]=t;break}}}return debug("OK? %j (%j %j %j)",o,n,t,l[i]),o||delete e[n],o}function parse(e,n,t,r,a){debug("parse",e,n,t);for(var s=abbrev(Object.keys(r)),o=abbrev(Object.keys(a)),l=0;l<e.length;l++){var u=e[l];if(debug("arg",u),u.match(/^-{2,}$/)){t.push.apply(t,e.slice(l+1)),e[l]="--";break}if("-"!==u.charAt(0))t.push(u);else{if(-1!==u.indexOf("=")){var c=u.split("=");u=c.shift(),c=c.join("="),e.splice.apply(e,[l,1].concat([u,c]))}var d=resolveShort(u,a,o,s);if(debug("arg=%j shRes=%j",u,d),d&&(debug(u,d),e.splice.apply(e,[l,1].concat(d)),u!==d[0])){l--;continue}u=u.replace(/^-+/,"");for(var f=!1;0===u.toLowerCase().indexOf("no-");)f=!f,u=u.substr(3);s[u]&&(u=s[u]);var p,h=r[u]===Array||Array.isArray(r[u])&&-1!==r[u].indexOf(Array),m=e[l+1],g=f||r[u]===Boolean||Array.isArray(r[u])&&-1!==r[u].indexOf(Boolean)||"false"===m&&(null===r[u]||Array.isArray(r[u])&&~r[u].indexOf(null));if(g){p=!f,("true"===m||"false"===m)&&(p=JSON.parse(m),m=null,f&&(p=!p),l++),Array.isArray(r[u])&&m&&(~r[u].indexOf(m)?(p=m,l++):"null"===m&&~r[u].indexOf(null)?(p=null,l++):m.match(/^-{2,}[^-]/)||isNaN(m)||!~r[u].indexOf(Number)?!m.match(/^-[^-]/)&&~r[u].indexOf(String)&&(p=m,l++):(p=+m,l++)),h?(n[u]=n[u]||[]).push(p):n[u]=p;continue}m&&m.match(/^-{2,}$/)&&(m=void 0,l--),p=void 0===m?!0:m,h?(n[u]=n[u]||[]).push(p):n[u]=p,l++}}}function resolveShort(e,n,t,r){if(e=e.replace(/^-+/,""),r[e]&&!n[e])return null;if(t[e])e=t[e];else{var a=n.___singles;a||(a=Object.keys(n).filter(function(e){return 1===e.length}).reduce(function(e,n){return e[n]=!0,e},{}),n.___singles=a);var i=e.split("").filter(function(e){return a[e]});if(i.join("")===e)return i.map(function(e){return n[e]}).reduce(function(e,n){return e.concat(n)},[])}return n[e]&&!Array.isArray(n[e])&&(n[e]=n[e].split(/\s+/)),n[e]}var debug=process.env.DEBUG_NOPT||process.env.NOPT_DEBUG?function(){console.error.apply(console,arguments)}:function(){},url=require("url"),path=require("path"),Stream=require("stream").Stream,abbrev=require("abbrev");if(module.exports=exports=nopt,exports.clean=clean,exports.typeDefs={String:{type:String,validate:validateString},Boolean:{type:Boolean,validate:validateBoolean},url:{type:url,validate:validateUrl},Number:{type:Number,validate:validateNumber},path:{type:path,validate:validatePath},Stream:{type:Stream,validate:validateStream},Date:{type:Date,validate:validateDate}},module===require.main){var assert=require("assert"),util=require("util"),shorthands={s:["--loglevel","silent"],d:["--loglevel","info"],dd:["--loglevel","verbose"],ddd:["--loglevel","silly"],noreg:["--no-registry"],reg:["--registry"],"no-reg":["--no-registry"],silent:["--loglevel","silent"],verbose:["--loglevel","verbose"],h:["--usage"],H:["--usage"],"?":["--usage"],help:["--usage"],v:["--version"],f:["--force"],desc:["--description"],"no-desc":["--no-description"],local:["--no-global"],l:["--long"],p:["--parseable"],porcelain:["--parseable"],g:["--global"]},types={aoa:Array,nullstream:[null,Stream],date:Date,str:String,browser:String,cache:path,color:["always",Boolean],depth:Number,description:Boolean,dev:Boolean,editor:path,force:Boolean,global:Boolean,globalconfig:path,group:[String,Number],gzipbin:String,logfd:[Number,Stream],loglevel:["silent","win","error","warn","info","verbose","silly"],"long":Boolean,"node-version":[!1,String],npaturl:url,npat:Boolean,"onload-script":[!1,String],outfd:[Number,Stream],parseable:Boolean,pre:Boolean,prefix:path,proxy:url,"rebuild-bundle":Boolean,registry:url,searchopts:String,searchexclude:[null,String],shell:path,t:[Array,String],tag:String,tar:String,tmp:path,"unsafe-perm":Boolean,usage:Boolean,user:String,username:String,userconfig:path,version:Boolean,viewer:path,_exit:Boolean};[["-v",{version:!0},[]],["---v",{version:!0},[]],["ls -s --no-reg connect -d",{loglevel:"info",registry:null},["ls","connect"]],["ls ---s foo",{loglevel:"silent"},["ls","foo"]],["ls --registry blargle",{},["ls"]],["--no-registry",{registry:null},[]],["--no-color true",{color:!1},[]],["--no-color false",{color:!0},[]],["--no-color",{color:!1},[]],["--color false",{color:!1},[]],["--color --logfd 7",{logfd:7,color:!0},[]],["--color=true",{color:!0},[]],["--logfd=10",{logfd:10},[]],["--tmp=/tmp -tar=gtar",{tmp:"/tmp",tar:"gtar"},[]],["--tmp=tmp -tar=gtar",{tmp:path.resolve(process.cwd(),"tmp"),tar:"gtar"},[]],["--logfd x",{},[]],["a -true -- -no-false",{"true":!0},["a","-no-false"]],["a -no-false",{"false":!1},["a"]],["a -no-no-true",{"true":!0},["a"]],["a -no-no-no-false",{"false":!1},["a"]],["---NO-no-No-no-no-no-nO-no-no-No-no-no-no-no-no-no-no-no-no-no-no-no-NO-NO-no-no-no-no-no-no-no-body-can-do-the-boogaloo-like-I-do",{"body-can-do-the-boogaloo-like-I-do":!1},[]],["we are -no-strangers-to-love --you-know the-rules --and so-do-i ---im-thinking-of=a-full-commitment --no-you-would-get-this-from-any-other-guy --no-gonna-give-you-up -no-gonna-let-you-down=true --no-no-gonna-run-around false --desert-you=false --make-you-cry false --no-tell-a-lie --no-no-and-hurt-you false",{"strangers-to-love":!1,"you-know":"the-rules",and:"so-do-i","you-would-get-this-from-any-other-guy":!1,"gonna-give-you-up":!1,"gonna-let-you-down":!1,"gonna-run-around":!1,"desert-you":!1,"make-you-cry":!1,"tell-a-lie":!1,"and-hurt-you":!1},["we","are"]],["-t one -t two -t three",{t:["one","two","three"]},[]],["-t one -t null -t three four five null",{t:["one","null","three"]},["four","five","null"]],["-t foo",{t:["foo"]},[]],["--no-t",{t:["false"]},[]],["-no-no-t",{t:["true"]},[]],["-aoa one -aoa null -aoa 100",{aoa:["one",null,100]},[]],["-str 100",{str:"100"},[]],["--color always",{color:"always"},[]],["--no-nullstream",{nullstream:null},[]],["--nullstream false",{nullstream:null},[]],["--notadate 2011-01-25",{notadate:"2011-01-25"},[]],["--date 2011-01-25",{date:new Date("2011-01-25")},[]]].forEach(function(e){var n=e[0].split(/\s+/),t=e[1],r=e[2],a=nopt(types,shorthands,n,0),i=a.argv;delete a.argv,console.log(util.inspect(a,!1,2,!0),i.remain);for(var s in t){var o=JSON.stringify(t[s]),l=JSON.stringify(void 0===a[s]?null:a[s]);o&&"object"==typeof o?assert.deepEqual(o,l):assert.equal(o,l)}assert.deepEqual(r,i.remain)})}