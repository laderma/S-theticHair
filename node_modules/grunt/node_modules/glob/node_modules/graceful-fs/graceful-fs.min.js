function OpenReq(e,n,t,r){this.path=e,this.flags=n,this.mode=t,this.cb=r}function noop(){}function gracefulOpen(e,n,t,r){return"function"==typeof t&&(r=t,t=null),"function"!=typeof r&&(r=noop),fs._curOpen>=fs.MAX_OPEN?(queue.push(new OpenReq(e,n,t,r)),void setTimeout(flush)):void open(e,n,t,function(a,i){return a&&"EMFILE"===a.code&&fs._curOpen>fs.MIN_MAX_OPEN?(fs.MAX_OPEN=fs._curOpen-1,fs.open(e,n,t,r)):void r(a,i)})}function open(e,n,t,r){r=r||noop,fs._curOpen++,fs._originalFs.open.call(fs,e,n,t,function(e,n){e&&onclose(),r(e,n)})}function onclose(){fs._curOpen--,flush()}function flush(){for(;fs._curOpen<fs.MAX_OPEN;){var e=queue.shift();if(!e)return;switch(e.constructor.name){case"OpenReq":open(e.path,e.flags||"r",e.mode||511,e.cb);break;case"ReaddirReq":readdir(e.path,e.cb);break;case"ReadFileReq":readFile(e.path,e.options,e.cb);break;case"WriteFileReq":writeFile(e.path,e.data,e.options,e.cb);break;default:throw new Error("Unknown req type: "+e.constructor.name)}}}function gracefulReaddir(e,n){return fs._curOpen>=fs.MAX_OPEN?(queue.push(new ReaddirReq(e,n)),void setTimeout(flush)):void readdir(e,function(t,r){return t&&"EMFILE"===t.code&&fs._curOpen>fs.MIN_MAX_OPEN?(fs.MAX_OPEN=fs._curOpen-1,fs.readdir(e,n)):void n(t,r)})}function readdir(e,n){n=n||noop,fs._curOpen++,fs._originalFs.readdir.call(fs,e,function(e,t){onclose(),n(e,t)})}function ReaddirReq(e,n){this.path=e,this.cb=n}function gracefulReadFile(e,n,t){return"function"==typeof n&&(t=n,n=null),"function"!=typeof t&&(t=noop),fs._curOpen>=fs.MAX_OPEN?(queue.push(new ReadFileReq(e,n,t)),void setTimeout(flush)):void readFile(e,n,function(r,a){return r&&"EMFILE"===r.code&&fs._curOpen>fs.MIN_MAX_OPEN?(fs.MAX_OPEN=fs._curOpen-1,fs.readFile(e,n,t)):void t(r,a)})}function readFile(e,n,t){t=t||noop,fs._curOpen++,fs._originalFs.readFile.call(fs,e,n,function(e,n){onclose(),t(e,n)})}function ReadFileReq(e,n,t){this.path=e,this.options=n,this.cb=t}function gracefulWriteFile(e,n,t,r){return"function"==typeof t&&(r=t,t=null),"function"!=typeof r&&(r=noop),fs._curOpen>=fs.MAX_OPEN?(queue.push(new WriteFileReq(e,n,t,r)),void setTimeout(flush)):void writeFile(e,n,t,function(a){return a&&"EMFILE"===a.code&&fs._curOpen>fs.MIN_MAX_OPEN?(fs.MAX_OPEN=fs._curOpen-1,fs.writeFile(e,n,t,r)):void r(a)})}function writeFile(e,n,t,r){r=r||noop,fs._curOpen++,fs._originalFs.writeFile.call(fs,e,n,t,function(e){onclose(),r(e)})}function WriteFileReq(e,n,t,r){this.path=e,this.data=n,this.options=t,this.cb=r}function chownFix(e){return e?function(n,t,r,a){return e.call(fs,n,t,r,function(e,n){chownErOk(e)&&(e=null),a(e,n)})}:e}function chownFixSync(e){return e?function(n,t,r){try{return e.call(fs,n,t,r)}catch(a){if(!chownErOk(a))throw a}}:e}function chownErOk(e){return e&&(process.getuid&&0===process.getuid()||"EINVAL"!==e.code&&"EPERM"!==e.code)?void 0:!0}var fs=exports=module.exports={};fs._originalFs=require("fs"),Object.getOwnPropertyNames(fs._originalFs).forEach(function(e){var n=Object.getOwnPropertyDescriptor(fs._originalFs,e);Object.defineProperty(fs,e,n)});var queue=[],constants=require("constants");fs._curOpen=0,fs.MIN_MAX_OPEN=64,fs.MAX_OPEN=1024,fs.open=gracefulOpen,fs.openSync=function(e,n,t){var r;return r=fs._originalFs.openSync.call(fs,e,n,t),fs._curOpen++,r},fs.close=function(e,n){n=n||noop,fs._originalFs.close.call(fs,e,function(e){onclose(),n(e)})},fs.closeSync=function(e){try{return fs._originalFs.closeSync.call(fs,e)}finally{onclose()}},fs.readdir=gracefulReaddir,fs.readFile=gracefulReadFile,fs.writeFile=gracefulWriteFile;var constants=require("constants");if(constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&(fs.lchmod=function(e,n,t){t=t||noop,fs.open(e,constants.O_WRONLY|constants.O_SYMLINK,n,function(e,r){return e?void t(e):void fs.fchmod(r,n,function(e){fs.close(r,function(n){t(e||n)})})})},fs.lchmodSync=function(e,n){var r,a,t=fs.openSync(e,constants.O_WRONLY|constants.O_SYMLINK,n);try{var i=fs.fchmodSync(t,n)}catch(o){r=o}try{fs.closeSync(t)}catch(o){a=o}if(r||a)throw r||a;return i}),fs.lutimes||(constants.hasOwnProperty("O_SYMLINK")?(fs.lutimes=function(e,n,t,r){fs.open(e,constants.O_SYMLINK,function(e,a){return r=r||noop,e?r(e):void fs.futimes(a,n,t,function(e){fs.close(a,function(n){return r(e||n)})})})},fs.lutimesSync=function(e,n,t){var a,i,o,r=fs.openSync(e,constants.O_SYMLINK);try{var o=fs.futimesSync(r,n,t)}catch(s){a=s}try{fs.closeSync(r)}catch(s){i=s}if(a||i)throw a||i;return o}):fs.utimensat&&constants.hasOwnProperty("AT_SYMLINK_NOFOLLOW")?(fs.lutimes=function(e,n,t,r){fs.utimensat(e,n,t,constants.AT_SYMLINK_NOFOLLOW,r)},fs.lutimesSync=function(e,n,t){return fs.utimensatSync(e,n,t,constants.AT_SYMLINK_NOFOLLOW)}):(fs.lutimes=function(e,n,t,r){process.nextTick(r)},fs.lutimesSync=function(){})),fs.chown=chownFix(fs.chown),fs.fchown=chownFix(fs.fchown),fs.lchown=chownFix(fs.lchown),fs.chownSync=chownFixSync(fs.chownSync),fs.fchownSync=chownFixSync(fs.fchownSync),fs.lchownSync=chownFixSync(fs.lchownSync),fs.lchmod||(fs.lchmod=function(e,n,t){process.nextTick(t)},fs.lchmodSync=function(){}),fs.lchown||(fs.lchown=function(e,n,t,r){process.nextTick(r)},fs.lchownSync=function(){}),"win32"===process.platform){var rename_=fs.rename;fs.rename=function(e,n,t){var r=Date.now();rename_(e,n,function a(i){return i&&("EACCES"===i.code||"EPERM"===i.code)&&Date.now()-r<1e3?rename_(e,n,a):void t(i)})}}var read=fs.read;fs.read=function(e,n,t,r,a,i){var o;if(i&&"function"==typeof i){var s=0;o=function(u,l,c){return u&&"EAGAIN"===u.code&&10>s?(s++,read.call(fs,e,n,t,r,a,o)):void i.apply(this,arguments)}}return read.call(fs,e,n,t,r,a,o)};var readSync=fs.readSync;fs.readSync=function(e,n,t,r,a){for(var i=0;;)try{return readSync.call(fs,e,n,t,r,a)}catch(o){if("EAGAIN"===o.code&&10>i){i++;continue}throw o}};