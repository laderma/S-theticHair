"use strict";var spawn=require("child_process").spawn,nodeUtil=require("util"),path=require("path"),util=module.exports={};util.namespace=require("getobject"),util.hooker=require("hooker"),util.async=require("async");var _=util._=require("lodash"),which=require("which").sync;util.exit=require("exit"),_.str=require("underscore.string"),_.mixin(_.str.exports()),util.callbackify=function(e){return function(){var n=e.apply(this,arguments),t=arguments.length;if(t!==e.length){var r=arguments[t-1];"function"==typeof r&&r(n)}}},util.error=function(e,n){return nodeUtil.isError(e)||(e=new Error(e)),n&&(e.origError=n),e},util.linefeed="win32"===process.platform?"\r\n":"\n",util.normalizelf=function(e){return e.replace(/\r\n|\n/g,util.linefeed)};var kindsOf={};"Number String Boolean Function RegExp Array Date Error".split(" ").forEach(function(e){kindsOf["[object "+e+"]"]=e.toLowerCase()}),util.kindOf=function(e){return null==e?String(e):kindsOf[kindsOf.toString.call(e)]||"object"},util.toArray=_.toArray,util.repeat=function(e,n){return new Array(e+1).join(n||" ")},util.pluralize=function(e,n,t){var r=n.split(t||"/");return 1===e?r[0]||"":r[1]||""},util.recurse=function(e,n,t){function r(e,n,t,a){var i;if(-1!==a.objs.indexOf(e))throw i=new Error("Circular reference detected ("+a.path+")"),i.path=a.path,i;var s,o;if(t&&t(e)===!1)return e;if("array"===util.kindOf(e))return e.map(function(i,s){return r(i,n,t,{objs:a.objs.concat([e]),path:a.path+"["+s+"]"})});if("object"!==util.kindOf(e)||Buffer.isBuffer(e))return n(e);s={};for(o in e)s[o]=r(e[o],n,t,{objs:a.objs.concat([e]),path:a.path+(/\W/.test(o)?'["'+o+'"]':"."+o)});return s}return r(e,n,t,{objs:[],path:""})},util.spawn=function(e,n){var r,a,t=function(t,r,a){r=_.rtrim(r),a=_.rtrim(a);var i={stdout:r,stderr:a,code:t,toString:function(){return 0===t?r:"fallback"in e?e.fallback:e.grunt?a||r:a}};n(0===t||"fallback"in e?null:new Error(a),i,t)},i=/[\\\/]/g;if(e.grunt)r=process.execPath,a=process.execArgv.concat(process.argv[1],e.args);else{try{r=i.test(e.cmd)?e.cmd.replace(i,path.sep):which(e.cmd)}catch(s){return void t(127,"",String(s))}a=e.args||[]}var o=spawn(r,a,e.opts),l=new Buffer(""),u=new Buffer("");return o.stdout&&o.stdout.on("data",function(e){l=Buffer.concat([l,new Buffer(e)])}),o.stderr&&o.stderr.on("data",function(e){u=Buffer.concat([u,new Buffer(e)])}),o.on("close",function(e){t(e,l.toString(),u.toString())}),o};