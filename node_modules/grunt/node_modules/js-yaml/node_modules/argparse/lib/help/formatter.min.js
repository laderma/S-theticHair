"use strict";function Section(e,n){this._parent=e,this._heading=n,this._items=[]}var _=require("underscore");_.str=require("underscore.string");var $$=require("../const");Section.prototype.addItem=function(e){this._items.push(e)},Section.prototype.formatHelp=function(e){var n,t;if(this._parent&&e._indent(),n=this._items.map(function(n){var t,r,i;return t=e,r=n[0],i=n[1],r.apply(t,i)}),n=e._joinParts(n),this._parent&&e._dedent(),!n)return"";if(t="",this._heading&&this._heading!==$$.SUPPRESS){var r=e.currentIndent;t=_.str.repeat(" ",r)+this._heading+":"+$$.EOL}return e._joinParts([$$.EOL,t,n,$$.EOL])};var HelpFormatter=module.exports=function(e){e=e||{},this._prog=e.prog,this._maxHelpPosition=e.maxHelpPosition||24,this._width=e.width||(process.env.COLUMNS||80)-2,this._currentIndent=0,this._indentIncriment=e.indentIncriment||2,this._level=0,this._actionMaxLength=0,this._rootSection=new Section(null),this._currentSection=this._rootSection,this._whitespaceMatcher=new RegExp("\\s+","g"),this._longBreakMatcher=new RegExp($$.EOL+$$.EOL+$$.EOL+"+","g")};HelpFormatter.prototype._indent=function(){this._currentIndent+=this._indentIncriment,this._level+=1},HelpFormatter.prototype._dedent=function(){if(this._currentIndent-=this._indentIncriment,this._level-=1,this._currentIndent<0)throw new Error("Indent decreased below 0.")},HelpFormatter.prototype._addItem=function(e,n){this._currentSection.addItem([e,n])},HelpFormatter.prototype.startSection=function(e){this._indent();var n=new Section(this._currentSection,e),t=n.formatHelp.bind(n);this._addItem(t,[this]),this._currentSection=n},HelpFormatter.prototype.endSection=function(){this._currentSection=this._currentSection._parent,this._dedent()},HelpFormatter.prototype.addText=function(e){e&&e!==$$.SUPPRESS&&this._addItem(this._formatText,[e])},HelpFormatter.prototype.addUsage=function(e,n,t,r){e!==$$.SUPPRESS&&this._addItem(this._formatUsage,[e,n,t,r])},HelpFormatter.prototype.addArgument=function(e){if(e.help!==$$.SUPPRESS){var i,n=this,t=[this._formatActionInvocation(e)],r=t[0].length;e._getSubactions&&(this._indent(),e._getSubactions().forEach(function(e){var i=n._formatActionInvocation(e);t.push(i),r=Math.max(r,i.length)}),this._dedent()),i=r+this._currentIndent,this._actionMaxLength=Math.max(this._actionMaxLength,i),this._addItem(this._formatAction,[e])}},HelpFormatter.prototype.addArguments=function(e){var n=this;e.forEach(function(e){n.addArgument(e)})},HelpFormatter.prototype.formatHelp=function(){var e=this._rootSection.formatHelp(this);return e&&(e=e.replace(this._longBreakMatcher,$$.EOL+$$.EOL),e=_.str.strip(e,$$.EOL)+$$.EOL),e},HelpFormatter.prototype._joinParts=function(e){return e.filter(function(e){return!!e&&e!==$$.SUPPRESS}).join("")},HelpFormatter.prototype._formatUsage=function(e,n,t,r){if(r||_.isString(r)||(r="usage: "),n=n||[],t=t||[],e)e=_.str.sprintf(e,{prog:this._prog});else if(e||0!==n.length){if(!e){var s,u,i=this._prog,a=[],o=[];if(n.forEach(function(e){e.isOptional()?a.push(e):o.push(e)}),s=this._formatActionsUsage([].concat(a,o),t),e=[i,s].join(" "),u=this._width-this._currentIndent,r.length+e.length>u){var l=new RegExp("\\(.*?\\)+|\\[.*?\\]+|\\S+","g"),c=this._formatActionsUsage(a,t),f=this._formatActionsUsage(o,t),d=c.match(l),p=f.match(l)||[];if(d.join(" ")!==c)throw new Error("assert \"optionalParts.join(' ') === optionalUsage\"");if(p.join(" ")!==f)throw new Error("assert \"positionalParts.join(' ') === positionalUsage\"");var m,g,v,h=function(e,n,t){var r=[],i=[],a=t?t.length-1:n.length-1;return e.forEach(function(e){a+1+e.length>u&&(r.push(n+i.join(" ")),i=[],a=n.length-1),i.push(e),a+=e.length+1}),i&&r.push(n+i.join(" ")),t&&(r[0]=r[0].substr(n.length)),r};r.length+i.length<=.75*u?(g=_.str.repeat(" ",r.length+i.length+1),m=d?[].concat(h([i].concat(d),g,r),h(p,g)):p?h([i].concat(p),g,r):[i]):(g=_.str.repeat(" ",r.length),v=d+p,m=h(v,g),m.length>1&&(m=[].concat(h(d,g),h(p,g))),m=[i]+m),e=m.join($$.EOL)}}}else e=this._prog;return r+e+$$.EOL+$$.EOL},HelpFormatter.prototype._formatActionsUsage=function(e,n){var t=[],r=[],i=this;n.forEach(function(n){var i,a,o=e.indexOf(n._groupActions[0]);if(o>=0&&(i=o+n._groupActions.length,_.isEqual(e.slice(o,i),n._groupActions)))for(n._groupActions.forEach(function(e){t.push(e)}),n.required?(r[o]?r[o]+=" (":r[o]="(",r[i]=")"):(r[o]?r[o]+=" [":r[o]="[",r[i]="]"),a=o+1;i>a;a+=1)r[a]="|"});var a=[];e.forEach(function(e,n){var o,s,u,l;e.help===$$.SUPPRESS?(a.push(null),"|"===r[n]?r.splice(n,n):"|"===r[n+1]&&r.splice(n+1,n+1)):e.isOptional()?(s=e.optionStrings[0],0===e.nargs?o=""+s:(u=e.dest.toUpperCase(),l=i._formatArgs(e,u),o=s+" "+l),!e.required&&t.indexOf(e)<0&&(o="["+o+"]"),a.push(o)):(o=i._formatArgs(e,e.dest),t.indexOf(e)>=0&&"["===o[0]&&"]"===o[o.length-1]&&(o=o.slice(1,-1)),a.push(o))});for(var o=r.length-1;o>=0;--o)null!==r[o]&&a.splice(o,0,r[o]);var s=a.filter(function(e){return!!e}).join(" ");return s=s.replace(/([\[(]) /g,"$1"),s=s.replace(/ ([\])])/g,"$1"),s=s.replace(/\[ *\]/g,""),s=s.replace(/\( *\)/g,""),s=s.replace(/\(([^|]*)\)/g,"$1"),s=_.str.strip(s)},HelpFormatter.prototype._formatText=function(e){e=_.str.sprintf(e,{prog:this._prog});var n=this._width-this._currentIndent,t=_.str.repeat(" ",this._currentIndent);return this._fillText(e,n,t)+$$.EOL+$$.EOL},HelpFormatter.prototype._formatAction=function(e){var t,r,i,a,n=this,o=Math.min(this._actionMaxLength+2,this._maxHelpPosition),s=this._width-o,u=o-this._currentIndent-2,l=this._formatActionInvocation(e);return e.help?l.length<=u?(l=_.str.repeat(" ",this._currentIndent)+l+"  "+_.str.repeat(" ",u-l.length),a=0):(l=_.str.repeat(" ",this._currentIndent)+l+$$.EOL,a=o):l=_.str.repeat(" ",this._currentIndent)+l+$$.EOL,i=[l],e.help?(t=this._expandHelp(e),r=this._splitLines(t,s),i.push(_.str.repeat(" ",a)+r[0]+$$.EOL),r.slice(1).forEach(function(e){i.push(_.str.repeat(" ",o)+e+$$.EOL)})):l.charAt(l.length-1)!==$$.EOL&&i.push($$.EOL),e._getSubactions&&(this._indent(),e._getSubactions().forEach(function(e){i.push(n._formatAction(e))}),this._dedent()),this._joinParts(i)},HelpFormatter.prototype._formatActionInvocation=function(e){if(e.isOptional()){var i,a,r=[];return 0===e.nargs?r=r.concat(e.optionStrings):(i=e.dest.toUpperCase(),a=this._formatArgs(e,i),e.optionStrings.forEach(function(e){r.push(e+" "+a)})),r.join(", ")}var n=this._metavarFormatter(e,e.dest),t=n(1);return t[0]},HelpFormatter.prototype._metavarFormatter=function(e,n){var t;if(e.metavar||""===e.metavar)t=e.metavar;else if(e.choices){var r=e.choices;r=_.isString(r)?r.split("").join(", "):_.isArray(r)?r.join(","):_.keys(r).join(","),t="{"+r+"}"}else t=n;return function(e){if(Array.isArray(t))return t;for(var n=[],r=0;e>r;r+=1)n.push(t);return n}},HelpFormatter.prototype._formatArgs=function(e,n){var t,r,i=this._metavarFormatter(e,n);switch(e.nargs){case void 0:case null:r=i(1),t=""+r[0];break;case $$.OPTIONAL:r=i(1),t="["+r[0]+"]";break;case $$.ZERO_OR_MORE:r=i(2),t="["+r[0]+" ["+r[1]+" ...]]";break;case $$.ONE_OR_MORE:r=i(2),t=""+r[0]+" ["+r[1]+" ...]";break;case $$.REMAINDER:t="...";break;case $$.PARSER:r=i(1),t=r[0]+" ...";break;default:r=i(e.nargs),t=r.join(" ")}return t},HelpFormatter.prototype._expandHelp=function(e){var n={prog:this._prog};return Object.keys(e).forEach(function(t){var r=e[t];r!==$$.SUPPRESS&&(n[t]=r)}),n.choices&&(_.isString(n.choices)?n.choices=n.choices.split("").join(", "):_.isArray(n.choices)?n.choices=n.choices.join(", "):n.choices=_.keys(n.choices).join(", ")),_.str.sprintf(this._getHelpString(e),n)},HelpFormatter.prototype._splitLines=function(e,n){var t=[],r=[" ",".",",","!","?"],i=new RegExp("["+r.join("")+"][^"+r.join("")+"]*$");return e=e.replace(/[\n\|\t]/g," "),e=_.str.strip(e),e=e.replace(this._whitespaceMatcher," "),e.split($$.EOL).forEach(function(e){if(n>=e.length)return void t.push(e);for(var a=0,o=n,s=0;o<=e.length;)o!==e.length&&r.indexOf(e[o]<-1)&&(s=(i.exec(e.substring(a,o))||{}).index,o=a+s+1),t.push(e.substring(a,o)),a=o,o+=n;a<e.length&&t.push(e.substring(a,o))}),t},HelpFormatter.prototype._fillText=function(e,n,t){var r=this._splitLines(e,n);return r=r.map(function(e){return t+e}),r.join($$.EOL)},HelpFormatter.prototype._getHelpString=function(e){return e.help};