"use strict";var format=require("util").format,_=require("underscore");_.str=require("underscore.string");var $$=require("./const"),ActionHelp=require("./action/help"),ActionAppend=require("./action/append"),ActionAppendConstant=require("./action/append/constant"),ActionCount=require("./action/count"),ActionStore=require("./action/store"),ActionStoreConstant=require("./action/store/constant"),ActionStoreTrue=require("./action/store/true"),ActionStoreFalse=require("./action/store/false"),ActionVersion=require("./action/version"),ActionSubparsers=require("./action/subparsers"),argumentErrorHelper=require("./argument/error"),ActionContainer=module.exports=function(e){e=e||{},this.description=e.description,this.argumentDefault=e.argumentDefault,this.prefixChars=e.prefixChars||"",this.conflictHandler=e.conflictHandler,this._registries={},this.register("action",null,ActionStore),this.register("action","store",ActionStore),this.register("action","storeConst",ActionStoreConstant),this.register("action","storeTrue",ActionStoreTrue),this.register("action","storeFalse",ActionStoreFalse),this.register("action","append",ActionAppend),this.register("action","appendConst",ActionAppendConstant),this.register("action","count",ActionCount),this.register("action","help",ActionHelp),this.register("action","version",ActionVersion),this.register("action","parsers",ActionSubparsers),this._getHandler(),this._actions=[],this._optionStringActions={},this._actionGroups=[],this._mutuallyExclusiveGroups=[],this._defaults={},this._regexpNegativeNumber=new RegExp("^[-]?[0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?$"),this._hasNegativeNumberOptionals=[]},ArgumentGroup=require("./argument/group"),MutuallyExclusiveGroup=require("./argument/exclusive");ActionContainer.prototype.register=function(e,n,t){this._registries[e]=this._registries[e]||{},this._registries[e][n]=t},ActionContainer.prototype._registryGet=function(e,n,t){return 3>arguments.length&&(t=null),this._registries[e][n]||t},ActionContainer.prototype.setDefaults=function(e){e=e||{};for(var n in e)this._defaults[n]=e[n];this._actions.forEach(function(n){n.dest in e&&(n.defaultValue=e[n.dest])})},ActionContainer.prototype.getDefault=function(e){var n=_.has(this._defaults,e)?this._defaults[e]:null;return this._actions.forEach(function(t){t.dest===e&&_.has(t,"defaultValue")&&(n=t.defaultValue)}),n},ActionContainer.prototype.addArgument=function(e,n){if(e=e,n=n||{},!_.isArray(e))throw new TypeError("addArgument first argument should be an array");if(!_.isObject(n)||_.isArray(n))throw new TypeError("addArgument second argument should be a hash");if(!e||1===e.length&&this.prefixChars.indexOf(e[0][0])<0){if(e&&n.dest)throw new Error("dest supplied twice for positional argument");n=this._getPositional(e,n)}else n=this._getOptional(e,n);if(_.isUndefined(n.defaultValue)){var t=n.dest;_.has(this._defaults,t)?n.defaultValue=this._defaults[t]:_.isUndefined(this.argumentDefault)||(n.defaultValue=this.argumentDefault)}var r=this._popActionClass(n);if(!_.isFunction(r))throw new Error(format('Unknown action "%s".',r));var i=new r(n),a=this._registryGet("type",i.type,i.type);if(!_.isFunction(a))throw new Error(format('"%s" is not callable',a));return this._addAction(i)},ActionContainer.prototype.addArgumentGroup=function(e){var n=new ArgumentGroup(this,e);return this._actionGroups.push(n),n},ActionContainer.prototype.addMutuallyExclusiveGroup=function(e){var n=new MutuallyExclusiveGroup(this,e);return this._mutuallyExclusiveGroups.push(n),n},ActionContainer.prototype._addAction=function(e){var n=this;return this._checkConflict(e),this._actions.push(e),e.container=this,e.optionStrings.forEach(function(t){n._optionStringActions[t]=e}),e.optionStrings.forEach(function(e){e.match(n._regexpNegativeNumber)&&(_.any(n._hasNegativeNumberOptionals)||n._hasNegativeNumberOptionals.push(!0))}),e},ActionContainer.prototype._removeAction=function(e){var n=this._actions.indexOf(e);n>=0&&this._actions.splice(n,1)},ActionContainer.prototype._addContainerActions=function(e){function r(e){return e.getName()}var n={};this._actionGroups.forEach(function(e){if(n[e.title])throw new Error(format('Cannot merge actions - two groups are named "%s".',e.title));n[e.title]=e});var t={};e._actionGroups.forEach(function(e){n[e.title]||(n[e.title]=this.addArgumentGroup({title:e.title,description:e.description})),e._groupActions.forEach(function(i){t[r(i)]=n[e.title]})},this);var i;e._mutuallyExclusiveGroups.forEach(function(e){i=this.addMutuallyExclusiveGroup({required:e.required}),e._groupActions.forEach(function(e){t[r(e)]=i})},this),e._actions.forEach(function(e){var n=r(e);t[n]?t[n]._addAction(e):this._addAction(e)})},ActionContainer.prototype._getPositional=function(e,n){if(_.isArray(e)&&(e=_.first(e)),n.required)throw new Error('"required" is an invalid argument for positionals.');return n.nargs!==$$.OPTIONAL&&n.nargs!==$$.ZERO_OR_MORE&&(n.required=!0),n.nargs===$$.ZERO_OR_MORE&&void 0===n.defaultValue&&(n.required=!0),n.dest=e,n.optionStrings=[],n},ActionContainer.prototype._getOptional=function(e,n){var t=this.prefixChars,r=[],i=[];e.forEach(function(e){if(t.indexOf(e[0])<0)throw new Error(format('Invalid option string "%s": must start with a "%s".',e,t));r.push(e),e.length>1&&t.indexOf(e[1])>=0&&i.push(e)});var a=n.dest||null;if(delete n.dest,!a){var o=i.length?i[0]:r[0];if(a=_.str.strip(o,this.prefixChars),0===a.length)throw new Error(format('dest= is required for options like "%s"',r.join(", ")));a=a.replace(/-/g,"_")}return n.dest=a,n.optionStrings=r,n},ActionContainer.prototype._popActionClass=function(e,n){n=n||null;var t=e.action||n;delete e.action;var r=this._registryGet("action",t,t);return r},ActionContainer.prototype._getHandler=function(){var e=this.conflictHandler,n="_handleConflict"+_.str.capitalize(e),t=this[n];if("undefined"==typeof t){var r="invalid conflict resolution value: "+e;throw new Error(r)}return t},ActionContainer.prototype._checkConflict=function(e){var n=this._optionStringActions,t=[];if(e.optionStrings.forEach(function(e){var r=n[e];"undefined"!=typeof r&&t.push([e,r])}),t.length>0){var r=this._getHandler();r.call(this,e,t)}},ActionContainer.prototype._handleConflictError=function(e,n){var t=_.map(n,function(e){return e[0]});throw t=t.join(", "),argumentErrorHelper(e,format("Conflicting option string(s): %s",t))},ActionContainer.prototype._handleConflictResolve=function(e,n){var t=this;n.forEach(function(e){var n=e[0],r=e[1],i=r.optionStrings.indexOf(n);i>=0&&r.optionStrings.splice(i,1),delete t._optionStringActions[n],0===r.optionStrings.length&&r.container._removeAction(r)})};