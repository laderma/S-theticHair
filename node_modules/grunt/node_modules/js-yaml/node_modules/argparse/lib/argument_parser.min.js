"use strict";var util=require("util"),format=require("util").format,Path=require("path"),_=require("underscore");_.str=require("underscore.string");var $$=require("./const"),ActionContainer=require("./action_container"),argumentErrorHelper=require("./argument/error"),HelpFormatter=require("./help/formatter"),Namespace=require("./namespace"),ArgumentParser=module.exports=function(e){var n=this;e=e||{},e.description=e.description||null,e.argumentDefault=e.argumentDefault||null,e.prefixChars=e.prefixChars||"-",e.conflictHandler=e.conflictHandler||"error",ActionContainer.call(this,e),e.addHelp=void 0===e.addHelp||!!e.addHelp,e.parents=e.parents||[],e.prog=e.prog||Path.basename(process.argv[1]),this.prog=e.prog,this.usage=e.usage,this.epilog=e.epilog,this.version=e.version,this.debug=e.debug===!0,this.formatterClass=e.formatterClass||HelpFormatter,this.fromfilePrefixChars=e.fromfilePrefixChars||null,this._positionals=this.addArgumentGroup({title:"Positional arguments"}),this._optionals=this.addArgumentGroup({title:"Optional arguments"}),this._subparsers=null;var t=function(e){return e};this.register("type","auto",t),this.register("type",null,t),this.register("type","int",function(e){var n=parseInt(e,10);if(isNaN(n))throw new Error(e+" is not a valid integer.");return n}),this.register("type","float",function(e){var n=parseFloat(e);if(isNaN(n))throw new Error(e+" is not a valid float.");return n}),this.register("type","string",function(e){return""+e});var r=this.prefixChars.indexOf("-")>-1?"-":this.prefixChars[0];e.addHelp&&this.addArgument([r+"h",r+r+"help"],{action:"help",defaultValue:$$.SUPPRESS,help:"Show this help message and exit."}),void 0!==this.version&&this.addArgument([r+"v",r+r+"version"],{action:"version",version:this.version,defaultValue:$$.SUPPRESS,help:"Show program's version number and exit."}),e.parents.forEach(function(e){if(n._addContainerActions(e),void 0!==e._defaults)for(var t in e._defaults)e._defaults.hasOwnProperty(t)&&(n._defaults[t]=e._defaults[t])})};util.inherits(ArgumentParser,ActionContainer),ArgumentParser.prototype.addSubparsers=function(e){if(this._subparsers&&this.error("Cannot have multiple subparser arguments."),e=e||{},e.debug=this.debug===!0,e.optionStrings=[],e.parserClass=e.parserClass||ArgumentParser,e.title||e.description?(this._subparsers=this.addArgumentGroup({title:e.title||"subcommands",description:e.description}),delete e.title,delete e.description):this._subparsers=this._positionals,!e.prog){var n=this._getFormatter(),t=this._getPositionalActions(),r=this._mutuallyExclusiveGroups;n.addUsage(this.usage,t,r,""),e.prog=_.str.strip(n.formatHelp())}var i=this._popActionClass(e,"parsers"),a=new i(e);return this._subparsers._addAction(a),a},ArgumentParser.prototype._addAction=function(e){return e.isOptional()?this._optionals._addAction(e):this._positionals._addAction(e),e},ArgumentParser.prototype._getOptionalActions=function(){return this._actions.filter(function(e){return e.isOptional()})},ArgumentParser.prototype._getPositionalActions=function(){return this._actions.filter(function(e){return e.isPositional()})},ArgumentParser.prototype.parseArgs=function(e,n){var t,r=this.parseKnownArgs(e,n);return e=r[0],t=r[1],t&&t.length>0&&this.error(format("Unrecognized arguments: %s.",t.join(" "))),e},ArgumentParser.prototype.parseKnownArgs=function(e,n){var t=this;e=e||process.argv.slice(2),n=n||new Namespace,t._actions.forEach(function(e){if(e.dest!==$$.SUPPRESS&&!_.has(n,e.dest)&&e.defaultValue!==$$.SUPPRESS){var r=e.defaultValue;_.isString(e.defaultValue)&&(r=t._getValue(e,r)),n[e.dest]=r}}),_.keys(t._defaults).forEach(function(e){n[e]=t._defaults[e]});try{var r=this._parseKnownArgs(e,n);return n=r[0],e=r[1],_.has(n,$$._UNRECOGNIZED_ARGS_ATTR)&&(e=_.union(e,n[$$._UNRECOGNIZED_ARGS_ATTR]),delete n[$$._UNRECOGNIZED_ARGS_ATTR]),[n,e]}catch(i){this.error(i)}},ArgumentParser.prototype._parseKnownArgs=function(e,n){function i(e){return e.getName()}function h(e,r,a){f.push(e);var o=t._getValues(e,r);o!==e.defaultValue&&(d.push(e),s[i(e)]&&s[i(e)].forEach(function(n){if(d.indexOf(n)>=0)throw argumentErrorHelper(e,format('Not allowed with argument "%s".',n.getName()))})),o!==$$.SUPPRESS&&e.call(t,n,o,a)}function p(n){for(var f,d,p,m,i=u[n],a=i[0],o=i[1],s=i[2],l=[];;){if(!a)return r.push(e[n]),n+1;if(!s){p=n+1;var k=c.substr(p);d=t._matchArgument(a,k),m=p+d,f=e.slice(p,m),l.push([a,f,o]);break}d=t._matchArgument(a,"A");var g=t.prefixChars;if(!(0===d&&g.indexOf(o[1])<0)){if(1===d){m=n+1,f=[s],l.push([a,f,o]);break}var w="ignored explicit argument %r";throw argumentErrorHelper(a,_.str.sprintf(w,s))}l.push([a,[],o]),o=o[0]+s[0];var v=s.slice(1)||null,b=t._optionStringActions;if(!(_.keys(b).indexOf(o)>=0)){var y="ignored explicit argument %r";throw argumentErrorHelper(a,y)}a=b[o],s=v}if(l.length<1)throw new Error("length should be > 0");for(var S=0;S<l.length;S++)h.apply(t,l[S]);return m}function g(n){var r=c.substr(n),i=t._matchArgumentsPartial(m,r);return _.zip(m,i).forEach(function(t){var r=t[0],i=t[1];if(void 0!==i){var a=e.slice(n,n+i);n+=i,h(r,a)}}),m=m.slice(i.length),n}var t=this,r=[];null!==this.fromfilePrefixChars&&(e=this._readArgsFromFiles(e));var a,o,s={};this._mutuallyExclusiveGroups.forEach(function(e){e._groupActions.forEach(function(e,n,t){o=i(e),_.has(s,o)||(s[o]=[]),a=s[o],a.push.apply(a,t.slice(0,n)),a.push.apply(a,t.slice(n+1))})});var u={},l=[];e.forEach(function(n,r){if("--"===n)for(l.push("-");r<e.length;)l.push("A"),r++;else{var i,a=t._parseOptional(n);a?(u[r]=a,i="O"):i="A",l.push(i)}});var b,c=l.join(""),f=[],d=[],m=t._getPositionalActions(),v=0,y=-1;Object.keys(u).forEach(function(e){y=Math.max(y,parseInt(e,10))});for(var w,k;y>=v;){k=null;for(b in u)u.hasOwnProperty(b)&&(b=parseInt(b,10),b>=v&&(k=null!==k?Math.min(k,b):b));if(v!==k){if(w=g(v),w>v){v=w;continue}v=w}if(!u[v]){var S=e.slice(v,k);r=r.concat(S),v=k}v=p(v)}var x=g(v);r=r.concat(_.rest(e,x)),m.length>0&&t.error("too few arguments"),t._actions.forEach(function(e){e.required&&_.indexOf(f,e)<0&&t.error(format('Argument "%s" is required',e.getName()))});var T=!1;return t._mutuallyExclusiveGroups.forEach(function(e){if(e.required&&(T=_.any(e._groupActions,function(e){return _.contains(d,e)}),!T)){var n=[];e._groupActions.forEach(function(e){e.help!==$$.SUPPRESS&&n.push(e.getName())}),n=n.join(" ");var r="one of the arguments "+n+" is required";t.error(r)}}),[n,r]},ArgumentParser.prototype._readArgsFromFiles=function(e){var n=this,t=require("fs"),r=[];return e.forEach(function(e){if(n.fromfilePrefixChars.indexOf(e[0])<0)r.push(e);else try{var i=[],a=e.slice(1),o=t.readFileSync(a,"utf8");o=o.trim().split("\n"),o.forEach(function(e){n.convertArgLineToArgs(e).forEach(function(e){i.push(e)}),i=n._readArgsFromFiles(i)}),r.push.apply(r,i)}catch(s){return n.error(s.message)}}),r},ArgumentParser.prototype.convertArgLineToArgs=function(e){return[e]},ArgumentParser.prototype._matchArgument=function(e,n){var i,t=new RegExp("^"+this._getNargsPattern(e)),r=n.match(t);if(!r){switch(e.nargs){case void 0:case null:i="Expected one argument.";break;case $$.OPTIONAL:i="Expected at most one argument.";break;case $$.ONE_OR_MORE:i="Expected at least one argument.";break;default:i="Expected %s argument(s)"}throw argumentErrorHelper(e,format(i,e.nargs))}return r[1].length},ArgumentParser.prototype._matchArgumentsPartial=function(e,n){var i,a,o,s,u,t=this,r=[],l=function(e){return e.length};for(s=e.length;s>0;s--){for(a="",i=e.slice(0,s),u=0;u<i.length;u++)a+=t._getNargsPattern(i[u]);if(a=new RegExp("^"+a),o=n.match(a),o&&o.length>0){o=o.splice(1),r=r.concat(o.map(l));break}}return r},ArgumentParser.prototype._parseOptional=function(e){var n,t,r,i;if(!e)return null;if(this.prefixChars.indexOf(e[0])<0)return null;if(this._optionStringActions[e])return[this._optionStringActions[e],e,null];if(1===e.length)return null;if(e.indexOf("=")>=0){var a=e.split("=");if(t=a[0],r=a[1],this._optionStringActions[t])return n=this._optionStringActions[t],[n,t,r]}if(i=this._getOptionTuples(e),i.length>1){var o=i.map(function(e){return e[1]});this.error(format('Ambiguous option: "%s" could match %s.',e,o.join(", ")))}else if(1===i.length)return i[0];return e.match(this._regexpNegativeNumber)&&!_.any(this._hasNegativeNumberOptionals)?null:e.search(" ")>=0?null:[null,e,null]},ArgumentParser.prototype._getOptionTuples=function(e){var r,i,a,o,n=[],t=this.prefixChars;if(t.indexOf(e[0])>=0&&t.indexOf(e[1])>=0){if(e.indexOf("=")>=0){var s=e.split("=",1);r=s[0],i=s[1]}else r=e,i=null;for(o in this._optionStringActions)o.substr(0,r.length)===r&&(a=this._optionStringActions[o],n.push([a,o,i]))}else{if(!(t.indexOf(e[0])>=0&&t.indexOf(e[1])<0))throw new Error(format("Unexpected option string: %s.",e));r=e,i=null;var u=e.substr(0,2),l=e.substr(2);for(o in this._optionStringActions)a=this._optionStringActions[o],o===u?n.push([a,o,l]):o.substr(0,r.length)===r&&n.push([a,o,i])}return n},ArgumentParser.prototype._getNargsPattern=function(e){var n;switch(e.nargs){case void 0:case null:n="(-*A-*)";break;case $$.OPTIONAL:n="(-*A?-*)";break;case $$.ZERO_OR_MORE:n="(-*[A-]*)";break;case $$.ONE_OR_MORE:n="(-*A[A-]*)";break;case $$.REMAINDER:n="([-AO]*)";break;case $$.PARSER:n="(-*A[-AO]*)";break;default:n="(-*"+_.str.repeat("-*A",e.nargs)+"-*)"}return e.isOptional()&&(n=n.replace(/-\*/g,""),n=n.replace(/-/g,"")),n},ArgumentParser.prototype._getValues=function(e,n){var t=this;e.nargs!==$$.PARSER&&e.nargs!==$$.REMAINDER&&(n=n.filter(function(e){return"--"!==e}));var r,i;return 0===n.length&&e.nargs===$$.OPTIONAL?(r=e.isOptional()?e.constant:e.defaultValue,"string"==typeof r&&(r=this._getValue(e,r),this._checkValue(e,r))):0===n.length&&e.nargs===$$.ZERO_OR_MORE&&0===e.optionStrings.length?(r=e.defaultValue||n,this._checkValue(e,r)):1!==n.length||e.nargs&&e.nargs!==$$.OPTIONAL?e.nargs===$$.REMAINDER?r=n.map(function(n){return t._getValue(e,n)}):e.nargs===$$.PARSER?(r=n.map(function(n){return t._getValue(e,n)}),this._checkValue(e,r[0])):(r=n.map(function(n){return t._getValue(e,n)}),r.forEach(function(n){t._checkValue(e,n)})):(i=n[0],r=this._getValue(e,i),this._checkValue(e,r)),r},ArgumentParser.prototype._getValue=function(e,n){var t,r=this._registryGet("type",e.type,e.type);if(!_.isFunction(r)){var i=format("%s is not callable",r);throw argumentErrorHelper(e,i)}try{t=r(n)}catch(a){var o=null;o=_.isString(e.type)?e.type:e.type.name||e.type.displayName||"<function>";var s=format("Invalid %s value: %s",o,n);throw"<function>"===o&&(s+="\n"+a.message),argumentErrorHelper(e,s)}return t},ArgumentParser.prototype._checkValue=function(e,n){var t=e.choices;if(t){if((_.isString(t)||_.isArray(t))&&-1!==t.indexOf(n))return;if(_.isObject(t)&&!_.isArray(t)&&t[n])return;t=_.isString(t)?t.split("").join(", "):_.isArray(t)?t.join(", "):_.keys(t).join(", ");var r=format("Invalid choice: %s (choose from [%s])",n,t);throw argumentErrorHelper(e,r)}},ArgumentParser.prototype.formatUsage=function(){var e=this._getFormatter();return e.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups),e.formatHelp()},ArgumentParser.prototype.formatHelp=function(){var e=this._getFormatter();return e.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups),e.addText(this.description),this._actionGroups.forEach(function(n){e.startSection(n.title),e.addText(n.description),e.addArguments(n._groupActions),e.endSection()}),e.addText(this.epilog),e.formatHelp()},ArgumentParser.prototype._getFormatter=function(){var e=this.formatterClass,n=new e({prog:this.prog});return n},ArgumentParser.prototype.printUsage=function(){this._printMessage(this.formatUsage())},ArgumentParser.prototype.printHelp=function(){this._printMessage(this.formatHelp())},ArgumentParser.prototype._printMessage=function(e,n){n||(n=process.stdout),e&&n.write(""+e)},ArgumentParser.prototype.exit=function(e,n){n&&(0===e?this._printMessage(n):this._printMessage(n,process.stderr)),process.exit(e)},ArgumentParser.prototype.error=function(e){var n;if(e instanceof Error){if(this.debug===!0)throw e;n=e.message}else n=e;var t=format("%s: error: %s",this.prog,n)+$$.EOL;if(this.debug===!0)throw new Error(t);return this.printUsage(process.stderr),this.exit(2,t)};