function sendMessage(e){process.stdout.write(JSON.stringify(e)+"\n")}var path=require("path"),fs=require("fs"),nodeunit=require("nodeunit"),filepaths=fs.readdirSync("test").map(function(e){return path.join("test",e)}),unfinished={},currentModule;process.on("uncaughtException",function(e){sendMessage({error:[e.name,e.message,e.stack]}),process.exit()});var unfinished={};process.on("exit",function(e){var n=Object.keys(unfinished).length;sendMessage(n>0?{exit:["UNFINISHED"]}:{exit:["finished"]})}),nodeunit.reporters.test={run:function(e,n,t){var r=e.map(function(e){return path.resolve(e)});nodeunit.runFiles(r,{testspec:void 0,moduleStart:function(e){currentModule=e,sendMessage({moduleStart:[e.toString()]})},moduleDone:function(e){e===currentModule&&sendMessage({moduleDone:[e.toString()]})},testStart:function(e){unfinished[e]=e,sendMessage({testStart:[e.toString()]})},testDone:function(e,n){delete unfinished[e],sendMessage({testDone:[e.toString(),n.failures(),n.map(function(e){var n=e.error;return n&&(e.error={name:n.name,message:n.message,stack:n.stack}),e})]})},done:function(e){sendMessage({done:[e.failures(),e.duration,e]})}})}},nodeunit.reporters.test.run(filepaths,{});