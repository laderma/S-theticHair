"use strict";function Connection(n,e,a){var t,r=this;e instanceof Server?(this.server=e,this.path=null,this.host=null):(this.server=null,this.path=e.path,this.host=e.host),this.socket=n,this.readyState=this.CONNECTING,this.buffer=new Buffer(0),this.frameBuffer=null,this.outStream=null,this.key=null,this.headers={},n.on("readable",function(){r.doRead()}),n.on("error",function(n){r.emit("error",n)}),this.server||(t="CleartextStream"===n.constructor.name?"secureConnect":"connect",n.on(t,function(){r.startHandshake()}));var i=function(){(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&r.emit("close",1006,""),r.readyState=this.CLOSED,r.frameBuffer instanceof InStream&&(r.frameBuffer.end(),r.frameBuffer=null),r.outStream instanceof OutStream&&(r.outStream.end(),r.outStream=null)};n.once("close",i),n.once("finish",i),events.EventEmitter.call(this),a&&this.once("connect",a)}var util=require("util"),events=require("events"),crypto=require("crypto"),InStream=require("./InStream"),OutStream=require("./OutStream"),frame=require("./frame"),Server=require("./Server");util.inherits(Connection,events.EventEmitter),module.exports=Connection,Connection.binaryFragmentation=524288,Connection.maxBufferLength=2097152,Connection.prototype.CONNECTING=0,Connection.prototype.OPEN=1,Connection.prototype.CLOSING=2,Connection.prototype.CLOSED=3,Connection.prototype.sendText=function(n,e){if(this.readyState===this.OPEN){if(!this.outStream)return this.socket.write(frame.createTextFrame(n,!this.server),e);this.emit("error",new Error("You can't send a text frame until you finish sending binary frames"))}this.emit("error",new Error("You can't write to a non-open connection"))},Connection.prototype.beginBinary=function(){if(this.readyState===this.OPEN){if(!this.outStream)return this.outStream=new OutStream(this,Connection.binaryFragmentation);this.emit("error",new Error("You can't send more binary frames until you finish sending the previous binary frames"))}this.emit("error",new Error("You can't write to a non-open connection"))},Connection.prototype.sendBinary=function(n,e){if(this.readyState===this.OPEN){if(!this.outStream)return this.socket.write(frame.createBinaryFrame(n,!this.server,!0,!0),e);this.emit("error",new Error("You can't send more binary frames until you finish sending the previous binary frames"))}this.emit("error",new Error("You can't write to a non-open connection"))},Connection.prototype.close=function(n,e){this.readyState===this.OPEN?(this.socket.write(frame.createCloseFrame(n,e,!this.server)),this.readyState=this.CLOSING):this.readyState!==this.CLOSED&&(this.socket.end(),this.readyState=this.CLOSED),this.emit("close",n,e)},Connection.prototype.doRead=function(){var n,e;if(n=this.socket.read(),n&&(this.buffer=Buffer.concat([this.buffer,n],this.buffer.length+n.length),(this.readyState!==this.CONNECTING||this.readHandshake())&&this.readyState!==this.CLOSED)){for(;(e=this.extractFrame())===!0;);e===!1?this.close(1002):this.buffer.length>Connection.maxBufferLength&&this.close(1009)}},Connection.prototype.startHandshake=function(){var n,e,a;for(a=new Buffer(16),e=0;16>e;e++)a[e]=Math.floor(256*Math.random());this.key=a.toString("base64"),n="GET "+this.path+" HTTP/1.1\r\nHost: "+this.host+"\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Key: "+this.key+"\r\nSec-WebSocket-Version: 13\r\n\r\n",this.socket.write(n)},Connection.prototype.readHandshake=function(){var e,a,n=!1;if(this.buffer.length>Connection.maxBufferLength)return this.socket.end(this.server?"HTTP/1.1 400 Bad Request\r\n\r\n":void 0),!1;for(e=0;e<this.buffer.length-3;e++)if(13===this.buffer[e]&&13===this.buffer[e+2]&&10===this.buffer[e+1]&&10===this.buffer[e+3]){n=!0;break}return n?(a=this.buffer.slice(0,e+4).toString().split("\r\n"),(this.server?this.answerHandshake(a):this.checkHandshake(a))?(this.buffer=this.buffer.slice(e+4),this.readyState=this.OPEN,this.emit("connect"),!0):(this.socket.end(this.server?"HTTP/1.1 400 Bad Request\r\n\r\n":void 0),!1)):!1},Connection.prototype.readHeaders=function(n){var e,a;for(e=1;e<n.length;e++)(a=n[e].match(/^([a-z-]+): (.+)$/i))&&(this.headers[a[1].toLowerCase()]=a[2])},Connection.prototype.checkHandshake=function(n){var e,a;return n.length<4?!1:n[0].match(/^HTTP\/\d\.\d 101( .*)?$/i)?(this.readHeaders(n),"upgrade"in this.headers&&"sec-websocket-accept"in this.headers&&"connection"in this.headers?"websocket"!==this.headers.upgrade.toLowerCase()||-1===this.headers.connection.toLowerCase().split(", ").indexOf("upgrade")?!1:(e=this.headers["sec-websocket-accept"],a=crypto.createHash("sha1"),a.end(this.key+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),e!==a.read().toString("base64")?!1:!0):!1):!1},Connection.prototype.answerHandshake=function(n){var e,a,r;return n.length<6?!1:(e=n[0].match(/^GET (.+) HTTP\/\d\.\d$/i))?(this.path=e[1],this.readHeaders(n),"host"in this.headers&&"sec-websocket-key"in this.headers&&"upgrade"in this.headers&&"connection"in this.headers?"websocket"!==this.headers.upgrade.toLowerCase()||-1===this.headers.connection.toLowerCase().split(", ").indexOf("upgrade")?!1:"13"!==this.headers["sec-websocket-version"]?!1:(this.key=this.headers["sec-websocket-key"],r=crypto.createHash("sha1"),r.end(this.key+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),a=r.read().toString("base64"),this.socket.write("HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: "+a+"\r\n\r\n"),!0):!1):!1},Connection.prototype.extractFrame=function(){var n,e,a,r,t,i,s,l,o,u;if(!(this.buffer.length<2)){if(a=this.buffer[0],r=a>>4,r%8)return!1;if(n=8===r,e=a%16,0!==e&&1!==e&&2!==e&&8!==e&&9!==e&&10!==e)return!1;if(e>=8&&!n)return!1;if(a=this.buffer[1],u=a>>7,this.server&&!u||!this.server&&u)return!1;if(i=a%128,l=u?6:2,!(this.buffer.length<l+i||(126===i?(i=this.buffer.readUInt16BE(2),l+=2):127===i&&(i=this.buffer.readUInt32BE(2)*Math.pow(2,32)+this.buffer.readUInt32BE(6),l+=8),this.buffer.length<l+i))){if(s=this.buffer.slice(l,l+i),u)for(t=this.buffer.slice(l-4,l),o=0;o<s.length;o++)s[o]^=t[o%4];return this.buffer=this.buffer.slice(l+i),this.processFrame(n,e,s)}}},Connection.prototype.processFrame=function(n,e,a){return 8===e?(this.readyState===this.CLOSING?this.socket.end():this.readyState===this.OPEN&&this.processCloseFrame(a),!0):9===e?(this.readyState===this.OPEN&&this.socket.write(frame.createPongFrame(a.toString(),!this.server)),!0):10===e?!0:this.readyState!==this.OPEN?!0:0===e&&null===this.frameBuffer?!1:0!==e&&null!==this.frameBuffer?!1:(e||(e="string"==typeof this.frameBuffer?1:2),1===e?(a=a.toString(),this.frameBuffer=this.frameBuffer?this.frameBuffer+a:a,n&&(this.emit("text",this.frameBuffer),this.frameBuffer=null)):(this.frameBuffer||(this.frameBuffer=new InStream,this.emit("binary",this.frameBuffer)),this.frameBuffer.addData(a),n&&(this.frameBuffer.end(),this.frameBuffer=null)),!0)},Connection.prototype.processCloseFrame=function(n){var e,a;n.length>=2?(e=n.readUInt16BE(0),a=n.slice(2).toString()):(e=1005,a=""),this.socket.write(frame.createCloseFrame(e,a,!this.server)),this.readyState=this.CLOSED,this.emit("close",e,a)};