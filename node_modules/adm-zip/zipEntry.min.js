var Utils=require("./util"),Headers=require("./headers"),Constants=Utils.Constants,Methods=require("./methods");module.exports=function(n){function l(){return n&&Buffer.isBuffer(n)?(e.loadDataHeaderFromBinary(n),n.slice(e.realDataOffset,e.realDataOffset+e.compressedSize)):new Buffer(0)}function o(n){return e.flags&!1&&Utils.crc32(n)!=e.crc?!1:!0}function u(n,r,i){if("undefined"==typeof r&&"string"==typeof n&&(i=n,n=void 0),t)return n&&r&&r(new Buffer(0),Utils.Errors.DIRECTORY_CONTENT_ERROR),new Buffer(0);var s=l();if(0==s.length)return n&&r&&r(s,Utils.Errors.NO_DATA),s;var u=new Buffer(e.size);switch(u.fill(0),e.method){case Utils.Constants.STORED:return s.copy(u),o(u)?(n&&r&&r(u),u):(n&&r&&r(u,Utils.Errors.BAD_CRC),Utils.Errors.BAD_CRC);case Utils.Constants.DEFLATED:var h=new Methods.Inflater(s);if(!n)return h.inflate(u),o(u)||console.warn(Utils.Errors.BAD_CRC+" "+a.toString()),u;h.inflateAsync(function(n){n.copy(u,0),o(u)?r&&r(u):r&&r(u,Utils.Errors.BAD_CRC)});break;default:return n&&r&&r(new Buffer(0),Utils.Errors.UNKNOWN_METHOD),Utils.Errors.UNKNOWN_METHOD}}function h(a,r){if((!i||!i.length)&&Buffer.isBuffer(n))return a&&r&&r(l()),l();if(i.length&&!t){var s;switch(e.method){case Utils.Constants.STORED:return e.compressedSize=e.size,s=new Buffer(i.length),i.copy(s),a&&r&&r(s),s;default:case Utils.Constants.DEFLATED:var o=new Methods.Deflater(i);if(!a){var u=o.deflate();return e.compressedSize=u.length,u}o.deflateAsync(function(n){s=new Buffer(n.length),e.compressedSize=n.length,n.copy(s),r&&r(s)}),o=null}}else{if(!a||!r)return new Buffer(0);r(new Buffer(0))}}function d(n,e){return(n.readUInt32LE(e+4)<<4)+n.readUInt32LE(e)}function c(n){for(var a,r,t,e=0;e<n.length;)a=n.readUInt16LE(e),e+=2,r=n.readUInt16LE(e),e+=2,t=n.slice(e,e+r),e+=r,Constants.ID_ZIP64===a&&f(t)}function f(n){var a,r,t,i;n.length>=Constants.EF_ZIP64_SCOMP&&(a=d(n,Constants.EF_ZIP64_SUNCOMP),e.size===Constants.EF_ZIP64_OR_32&&(e.size=a)),n.length>=Constants.EF_ZIP64_RHO&&(r=d(n,Constants.EF_ZIP64_SCOMP),e.compressedSize===Constants.EF_ZIP64_OR_32&&(e.compressedSize=r)),n.length>=Constants.EF_ZIP64_DSN&&(t=d(n,Constants.EF_ZIP64_RHO),e.offset===Constants.EF_ZIP64_OR_32&&(e.offset=t)),n.length>=Constants.EF_ZIP64_DSN+4&&(i=n.readUInt32LE(Constants.EF_ZIP64_DSN),e.diskNumStart===Constants.EF_ZIP64_OR_16&&(e.diskNumStart=i))}var e=new Headers.EntryHeader,a=new Buffer(0),r=new Buffer(0),t=!1,i=null,s=new Buffer(0);return{get entryName(){return a.toString()},get rawEntryName(){return a},set entryName(n){a=Utils.toBuffer(n);var r=a[a.length-1];t=47==r||92==r,e.fileNameLength=a.length},get extra(){return s},set extra(n){s=n,e.extraLength=n.length,c(n)},get comment(){return r.toString()},set comment(n){r=Utils.toBuffer(n),e.commentLength=r.length},get name(){var n=a.toString();return t?n.substr(n.length-1).split("/").pop():n.split("/").pop()},get isDirectory(){return t},getCompressedData:function(){return h(!1,null)},getCompressedDataAsync:function(n){h(!0,n)},setData:function(n){i=Utils.toBuffer(n),!t&&i.length?(e.size=i.length,e.method=Utils.Constants.DEFLATED,e.crc=Utils.crc32(n)):e.method=Utils.Constants.STORED},getData:function(n){return u(!1,null,n)},getDataAsync:function(n,e){u(!0,n,e)},set attr(n){e.attr=n},get attr(){return e.attr},set header(n){e.loadFromBinary(n)},get header(){return e},packHeader:function(){var n=e.entryHeaderToBinary();return a.copy(n,Utils.Constants.CENHDR),e.extraLength&&s.copy(n,Utils.Constants.CENHDR+a.length),e.commentLength&&r.copy(n,Utils.Constants.CENHDR+a.length+e.extraLength,r.length),n},toString:function(){return'{\n	"entryName" : "'+a.toString()+'",\n	"name" : "'+a.toString().split("/").pop()+'",\n	"comment" : "'+r.toString()+'",\n	"isDirectory" : '+t+',\n	"header" : '+e.toString().replace(/\t/gm,"		")+',\n	"compressedData" : <'+(n&&n.length+" bytes buffer"||"null")+'>\n	"data" : <'+(i&&i.length+" bytes buffer"||"null")+">\n}"}}};