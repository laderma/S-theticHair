var fs=require("fs"),pth=require("path");fs.existsSync=fs.existsSync||pth.existsSync;var ZipEntry=require("./zipEntry"),ZipFile=require("./zipFile"),Utils=require("./util");module.exports=function(n){function r(n){if(n&&e){var a;if("string"==typeof n&&(a=e.getEntry(n)),"object"==typeof n&&void 0!=n.entryName&&void 0!=n.header&&(a=e.getEntry(n.entryName)),a)return a}return null}var e=void 0,a="";if(n&&"string"==typeof n){if(!fs.existsSync(n))throw Utils.Errors.INVALID_FILENAME;a=n,e=new ZipFile(n,Utils.Constants.FILE)}else e=n&&Buffer.isBuffer(n)?new ZipFile(n,Utils.Constants.BUFFER):new ZipFile(null,Utils.Constants.NONE);return{readFile:function(n){var e=r(n);return e&&e.getData()||null},readFileAsync:function(n,e){var a=r(n);a?a.getDataAsync(e):e(null,"getEntry failed for:"+n)},readAsText:function(n,e){var a=r(n);if(a){var t=a.getData();if(t&&t.length)return t.toString(e||"utf8")}return""},readAsTextAsync:function(n,e,a){var t=r(n);t?t.getDataAsync(function(n){e(n&&n.length?n.toString(a||"utf8"):"")}):e("")},deleteFile:function(n){var a=r(n);a&&e.deleteEntry(a.entryName)},addZipComment:function(n){e.comment=n},getZipComment:function(){return e.comment||""},addZipEntryComment:function(n,e){var a=r(n);a&&(a.comment=e)},getZipEntryComment:function(n){var e=r(n);return e?e.comment||"":""},updateFile:function(n,e){var a=r(n);a&&a.setData(e)},addLocalFile:function(n,e,a){if(!fs.existsSync(n))throw Utils.Errors.FILE_NOT_FOUND.replace("%s",n);e?(e=e.split("\\").join("/"),"/"!=e.charAt(e.length-1)&&(e+="/")):e="";var r=n.split("\\").join("/").split("/").pop();a?this.addFile(e+a,fs.readFileSync(n),"",0):this.addFile(e+r,fs.readFileSync(n),"",0)},addLocalFolder:function(n,e,a){if(void 0===a?a=function(){return!0}:a instanceof RegExp&&(a=function(n){return function(e){return n.test(e)}}(a)),e?(e=e.split("\\").join("/"),"/"!=e.charAt(e.length-1)&&(e+="/")):e="",n=n.split("\\").join("/"),n=pth.normalize(n),"/"!=n.charAt(n.length-1)&&(n+="/"),!fs.existsSync(n))throw Utils.Errors.FILE_NOT_FOUND.replace("%s",n);var r=Utils.findFiles(n),t=this;r.length&&r.forEach(function(r){var i=r.split("\\").join("/").replace(new RegExp(n,"i"),"");a(i)&&("/"!==i.charAt(i.length-1)?t.addFile(e+i,fs.readFileSync(r),"",0):t.addFile(e+i,new Buffer(0),"",0))})},addFile:function(n,a,r,t){var i=new ZipEntry;i.entryName=n,i.comment=r||"",i.attr=t||438,i.isDirectory&&a.length,i.setData(a),e.setEntry(i)},getEntries:function(){return e?e.entries:[]},getEntry:function(n){return r(n)},extractEntryTo:function(n,a,t,i){i=i||!1,t="undefined"==typeof t?!0:t;var s=r(n);if(!s)throw Utils.Errors.NO_ENTRY;var l=pth.resolve(a,t?s.entryName:pth.basename(s.entryName));if(s.isDirectory){l=pth.resolve(l,"..");var o=e.getEntryChildren(s);return o.forEach(function(n){if(!n.isDirectory){var e=n.getData();if(!e)throw Utils.Errors.CANT_EXTRACT_FILE;Utils.writeFileTo(pth.resolve(a,t?n.entryName:n.entryName.substr(s.entryName.length)),e,i)}}),!0}var u=s.getData();if(!u)throw Utils.Errors.CANT_EXTRACT_FILE;if(fs.existsSync(l)&&!i)throw Utils.Errors.CANT_OVERRIDE;return Utils.writeFileTo(l,u,i),!0},extractAllTo:function(n,a){if(a=a||!1,!e)throw Utils.Errors.NO_ZIP;e.entries.forEach(function(e){if(e.isDirectory)return void Utils.makeDir(pth.resolve(n,e.entryName.toString()));var r=e.getData();if(!r)throw Utils.Errors.CANT_EXTRACT_FILE+"2";Utils.writeFileTo(pth.resolve(n,e.entryName.toString()),r,a)})},extractAllToAsync:function(n,a,r){if(a=a||!1,!e)return void r(new Error(Utils.Errors.NO_ZIP));var t=e.entries,i=t.length;t.forEach(function(e){return 0>=i?void 0:e.isDirectory?(Utils.makeDir(pth.resolve(n,e.entryName.toString())),void(0==--i&&r(void 0))):void e.getDataAsync(function(t){return 0>=i?void 0:t?void Utils.writeFileToAsync(pth.resolve(n,e.entryName.toString()),t,a,function(n){return 0>=i?void 0:n?void(0==--i&&r(void 0)):(i=0,void r(new Error("Unable to write")))}):(i=0,void r(new Error(Utils.Errors.CANT_EXTRACT_FILE+"2")))})})},writeZip:function(n,r){if(1==arguments.length&&"function"==typeof n&&(r=n,n=""),!n&&a&&(n=a),n){var t=e.compressToBuffer();if(t){var i=Utils.writeFileTo(n,t,!0);"function"==typeof r&&r(i?null:new Error("failed"),"")}}},toBuffer:function(n,a,r,t){return this.valueOf=2,"function"==typeof n?(e.toAsyncBuffer(n,a,r,t),null):e.compressToBuffer()}}};