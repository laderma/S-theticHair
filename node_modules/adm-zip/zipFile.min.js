var ZipEntry=require("./zipEntry"),Headers=require("./headers"),Utils=require("./util");module.exports=function(n,e){function u(){r={},a=new Array(o.diskEntries);for(var n=o.offset,e=0;e<a.length;e++){var t=n,i=new ZipEntry(l);i.header=l.slice(t,t+=Utils.Constants.CENHDR),i.entryName=l.slice(t,t+=i.header.fileNameLength),i.header.extraLength&&(i.extra=l.slice(t,t+=i.header.extraLength)),i.header.commentLength&&(i.comment=l.slice(t,t+i.header.commentLength)),n+=i.header.entryHeaderSize,a[e]=i,r[i.entryName]=i}}function h(){var n=l.length-Utils.Constants.ENDHDR,e=Math.max(0,n-65535),a=-1;for(n;n>=e;n--)if(80==l[n]&&l.readUInt32LE(n)==Utils.Constants.ENDSIG){a=n;break}if(!~a)throw Utils.Errors.INVALID_FORMAT;o.loadFromBinary(l.slice(a,a+Utils.Constants.ENDHDR)),o.commentLength&&(t=l.slice(a+Utils.Constants.ENDHDR)),u()}var a=[],r={},t=new Buffer(0),i="",s=require("fs"),l=null,o=new Headers.MainHeader;return e==Utils.Constants.FILE?(i=n,l=s.readFileSync(i),h()):e==Utils.Constants.BUFFER&&(l=n,h()),{get entries(){return a},get comment(){return t.toString()},set comment(n){o.commentLength=n.length,t=n},getEntry:function(n){return r[n]||null},setEntry:function(n){a.push(n),r[n.entryName]=n,o.totalEntries=a.length},deleteEntry:function(n){var e=r[n];if(e&&e.isDirectory){var t=this;this.getEntryChildren(e).forEach(function(e){e.entryName!=n&&t.deleteEntry(e.entryName)})}a.splice(a.indexOf(e),1),delete r[n],o.totalEntries=a.length},getEntryChildren:function(n){if(n.isDirectory){var e=[],r=n.entryName,t=r.length;return a.forEach(function(n){n.entryName.substr(0,t)==r&&e.push(n)}),e}return[]},compressToBuffer:function(){a.length>1&&a.sort(function(n,e){var a=n.entryName.toLowerCase(),r=e.entryName.toLowerCase();return r>a?-1:a>r?1:0});var n=0,e=[],r=[],i=0;o.size=0,o.offset=0,a.forEach(function(a){a.header.offset=i;var t=a.getCompressedData(),s=a.header.dataHeaderToBinary(),l=new Buffer(a.entryName+a.extra.toString()),u=s.length+l.length+t.length;i+=u,e.push(s),e.push(l),e.push(t);var h=a.packHeader();r.push(h),o.size+=h.length,n+=u+h.length}),n+=o.mainHeaderSize,o.offset=i,i=0;var s=new Buffer(n);e.forEach(function(n){n.copy(s,i),i+=n.length}),r.forEach(function(n){n.copy(s,i),i+=n.length});var l=o.toBinary();return t&&t.copy(l,Utils.Constants.ENDHDR),l.copy(s,i),s},toAsyncBuffer:function(n,e,r,i){a.length>1&&a.sort(function(n,e){var a=n.entryName.toLowerCase(),r=e.entryName.toLowerCase();return a>r?-1:r>a?1:0});var s=0,l=[],u=[],h=0;o.size=0,o.offset=0;var d=function(e){var d,a=arguments.callee;if(e.length){var d=e.pop(),c=d.entryName+d.extra.toString();r&&r(c),d.getCompressedDataAsync(function(r){i&&i(c),d.header.offset=h;var f=d.header.dataHeaderToBinary(),g=new Buffer(c),m=f.length+g.length+r.length;h+=m,l.push(f),l.push(g),l.push(r);var p=d.packHeader();if(u.push(p),o.size+=p.length,s+=m+p.length,e.length)a(e);else{s+=o.mainHeaderSize,o.offset=h,h=0;var b=new Buffer(s);l.forEach(function(n){n.copy(b,h),h+=n.length}),u.forEach(function(n){n.copy(b,h),h+=n.length});var H=o.toBinary();t&&t.copy(H,Utils.Constants.ENDHDR),H.copy(b,h),n(b)}})}};d(a)}}};