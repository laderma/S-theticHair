var request=require("supertest"),assert=require("assert"),parse=require("url").parse,WebSocket=require("faye-websocket").Client,Server=require("..").Server,listen=require("./helpers/listen");describe("tiny-lr",function(){before(listen()),it("accepts ws clients",function(e){var n=parse(this.request.url),t=this.app,r=this.ws=new WebSocket("ws://"+n.host+"/livereload");r.onopen=function(e){var n={command:"hello",protocols:["http://livereload.com/protocols/official-7"]};r.send(JSON.stringify(n))},r.onmessage=function(n){assert.deepEqual(n.data,JSON.stringify({command:"hello",protocols:["http://livereload.com/protocols/official-7"],serverName:"tiny-lr"})),assert.ok(Object.keys(t.clients).length),e()}}),it("properly cleans up established connection on exit",function(e){var n=this.ws;n.onclose=e.bind(null,null),request(this.server).get("/kill").expect(200,function(){})})});