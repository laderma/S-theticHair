var Stream=require("stream").Stream,util=require("util"),EventTarget=require("./api/event_target"),Event=require("./api/event"),API=function(e){e=e||{},this.readable=this.writable=!0;var n=e.headers;if(n)for(var t in n)this._driver.setHeader(t,n[t]);this._ping=e.ping,this._pingId=0,this.readyState=API.CONNECTING,this.bufferedAmount=0,this.protocol="",this.url=this._driver.url,this.version=this._driver.version;var r=this;this._stream.setTimeout(0),this._stream.setNoDelay(!0),["close","end"].forEach(function(e){this._stream.on(e,function(){r._finalize("",1006)})},this),this._stream.on("error",function(e){var n=new Event("error",{message:"Network error: "+r.url+": "+e.message});n.initEvent("error",!1,!1),r.dispatchEvent(n),r._finalize("",1006)}),this._driver.on("open",function(e){r._open()}),this._driver.on("message",function(e){r._receiveMessage(e.data)}),this._driver.on("close",function(e){r._finalize(e.reason,e.code)}),this._driver.on("error",function(e){var n=new Event("error",{message:e.message});n.initEvent("error",!1,!1),r.dispatchEvent(n)}),this.on("error",function(){}),this._driver.messages.on("drain",function(){r.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){r._pingId+=1,r.ping(r._pingId.toString())},1e3*this._ping)),this._stream.pipe(this._driver.io),this._driver.io.pipe(this._stream)};util.inherits(API,Stream),API.CONNECTING=0,API.OPEN=1,API.CLOSING=2,API.CLOSED=3;var instance={write:function(e){return this.send(e)},end:function(e){void 0!==e&&this.send(e),this.close()},pause:function(){return this._driver.messages.pause()},resume:function(){return this._driver.messages.resume()},send:function(e){return this.readyState>API.OPEN?!1:(e instanceof Buffer||(e=String(e)),this._driver.messages.write(e))},ping:function(e,n){return this.readyState>API.OPEN?!1:this._driver.ping(e,n)},close:function(){this.readyState!==API.CLOSED&&(this.readyState=API.CLOSING),this._driver.close()},_open:function(){if(this.readyState===API.CONNECTING){this.readyState=API.OPEN,this.protocol=this._driver.protocol||"";var e=new Event("open");e.initEvent("open",!1,!1),this.dispatchEvent(e)}},_receiveMessage:function(e){if(this.readyState>API.OPEN)return!1;this.readable&&this.emit("data",e);var n=new Event("message",{data:e});n.initEvent("message",!1,!1),this.dispatchEvent(n)},_finalize:function(e,n){if(this.readyState!==API.CLOSED){this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end(),this.readable&&this.emit("end"),this.readable=this.writable=!1,this.readyState=API.CLOSED;var t=new Event("close",{code:n||1e3,reason:e||""});t.initEvent("close",!1,!1),this.dispatchEvent(t)}}};for(var method in instance)API.prototype[method]=instance[method];for(var key in EventTarget)API.prototype[key]=EventTarget[key];module.exports=API;