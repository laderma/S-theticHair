var Utils=require("./utils"),internals={delimiter:"&",depth:5,arrayLimit:20,parameterLimit:1e3};internals.parseValues=function(e,n){for(var t={},r=e.split(n.delimiter,n.parameterLimit===1/0?void 0:n.parameterLimit),a=0,i=r.length;i>a;++a){var o=r[a],s=-1===o.indexOf("]=")?o.indexOf("="):o.indexOf("]=")+1;if(-1===s)t[Utils.decode(o)]="";else{var u=Utils.decode(o.slice(0,s)),l=Utils.decode(o.slice(s+1));t.hasOwnProperty(u)?t[u]=[].concat(t[u]).concat(l):t[u]=l}}return t},internals.parseObject=function(e,n,t){if(!e.length)return n;var r=e.shift(),a={};if("[]"===r)a=[],a=a.concat(internals.parseObject(e,n,t));else{var i="["===r[0]&&"]"===r[r.length-1]?r.slice(1,r.length-1):r,o=parseInt(i,10),s=""+o;!isNaN(o)&&r!==i&&s===i&&o<=t.arrayLimit?(a=[],a[o]=internals.parseObject(e,n,t)):a[i]=internals.parseObject(e,n,t)}return a},internals.parseKeys=function(e,n,t){if(e){var r=/^([^\[\]]*)/,a=/(\[[^\[\]]*\])/g,i=r.exec(e);if(!Object.prototype.hasOwnProperty(i[1])){var o=[];i[1]&&o.push(i[1]);for(var s=0;null!==(i=a.exec(e))&&s<t.depth;)++s,Object.prototype.hasOwnProperty(i[1].replace(/\[|\]/g,""))||o.push(i[1]);return i&&o.push("["+e.slice(i.index)+"]"),internals.parseObject(o,n,t)}}},module.exports=function(e,n){if(""===e||null===e||"undefined"==typeof e)return{};n=n||{},n.delimiter="string"==typeof n.delimiter||Utils.isRegExp(n.delimiter)?n.delimiter:internals.delimiter,n.depth="number"==typeof n.depth?n.depth:internals.depth,n.arrayLimit="number"==typeof n.arrayLimit?n.arrayLimit:internals.arrayLimit,n.parameterLimit="number"==typeof n.parameterLimit?n.parameterLimit:internals.parameterLimit;for(var t="string"==typeof e?internals.parseValues(e,n):e,r={},a=Object.keys(t),i=0,o=a.length;o>i;++i){var s=a[i],u=internals.parseKeys(s,t[s],n);r=Utils.merge(r,u)}return Utils.compact(r)};