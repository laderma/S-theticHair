(function(){var e,n,t,r,a,i={}.hasOwnProperty;e=require("./connector").Connector,a=require("./timer").Timer,t=require("./options").Options,r=require("./reloader").Reloader,exports.LiveReload=n=function(){function n(n){var o,s,u;if(this.window=n,this.listeners={},this.plugins=[],this.pluginIdentifiers={},this.console=this.window.console&&this.window.console.log&&this.window.console.error?this.window.location.href.match(/LR-verbose/)?this.window.console:{log:function(){},error:this.window.console.error.bind(this.window.console)}:{log:function(){},error:function(){}},!(this.WebSocket=this.window.WebSocket||this.window.MozWebSocket))return void this.console.error("LiveReload disabled because the browser does not seem to support web sockets");if("LiveReloadOptions"in n){this.options=new t,u=n.LiveReloadOptions;for(o in u)i.call(u,o)&&(s=u[o],this.options.set(o,s))}else if(this.options=t.extract(this.window.document),!this.options)return void this.console.error("LiveReload disabled because it could not find its own <SCRIPT> tag");this.reloader=new r(this.window,this.console,a),this.connector=new e(this.options,this.WebSocket,a,{connecting:function(e){return function(){}}(this),socketConnected:function(e){return function(){}}(this),connected:function(e){return function(n){var t;return"function"==typeof(t=e.listeners).connect&&t.connect(),e.log("LiveReload is connected to "+e.options.host+":"+e.options.port+" (protocol v"+n+")."),e.analyze()}}(this),error:function(e){return function(e){if(e instanceof ProtocolError){if("undefined"!=typeof console&&null!==console)return console.log(""+e.message+".")}else if("undefined"!=typeof console&&null!==console)return console.log("LiveReload internal error: "+e.message)}}(this),disconnected:function(e){return function(n,t){var r;switch("function"==typeof(r=e.listeners).disconnect&&r.disconnect(),n){case"cannot-connect":return e.log("LiveReload cannot connect to "+e.options.host+":"+e.options.port+", will retry in "+t+" sec.");case"broken":return e.log("LiveReload disconnected from "+e.options.host+":"+e.options.port+", reconnecting in "+t+" sec.");case"handshake-timeout":return e.log("LiveReload cannot connect to "+e.options.host+":"+e.options.port+" (handshake timeout), will retry in "+t+" sec.");case"handshake-failed":return e.log("LiveReload cannot connect to "+e.options.host+":"+e.options.port+" (handshake failed), will retry in "+t+" sec.");case"manual":break;case"error":break;default:return e.log("LiveReload disconnected from "+e.options.host+":"+e.options.port+" ("+n+"), reconnecting in "+t+" sec.")}}}(this),message:function(e){return function(n){switch(n.command){case"reload":return e.performReload(n);case"alert":return e.performAlert(n)}}}(this)}),this.initialized=!0}return n.prototype.on=function(e,n){return this.listeners[e]=n},n.prototype.log=function(e){return this.console.log(""+e)},n.prototype.performReload=function(e){var n,t;return this.log("LiveReload received reload request: "+JSON.stringify(e,null,2)),this.reloader.reload(e.path,{liveCSS:null!=(n=e.liveCSS)?n:!0,liveImg:null!=(t=e.liveImg)?t:!0,originalPath:e.originalPath||"",overrideURL:e.overrideURL||"",serverURL:"http://"+this.options.host+":"+this.options.port})},n.prototype.performAlert=function(e){return alert(e.message)},n.prototype.shutDown=function(){var e;if(this.initialized)return this.connector.disconnect(),this.log("LiveReload disconnected."),"function"==typeof(e=this.listeners).shutdown?e.shutdown():void 0},n.prototype.hasPlugin=function(e){return!!this.pluginIdentifiers[e]},n.prototype.addPlugin=function(e){var n;this.initialized&&(this.hasPlugin(e.identifier)||(this.pluginIdentifiers[e.identifier]=!0,n=new e(this.window,{_livereload:this,_reloader:this.reloader,_connector:this.connector,console:this.console,Timer:a,generateCacheBustUrl:function(e){return function(n){return e.reloader.generateCacheBustUrl(n)}}(this)}),this.plugins.push(n),this.reloader.addPlugin(n)))},n.prototype.analyze=function(){var e,n,t,r,a,i;if(this.initialized&&this.connector.protocol>=7){for(t={},i=this.plugins,r=0,a=i.length;a>r;r++)e=i[r],t[e.constructor.identifier]=n=("function"==typeof e.analyze?e.analyze():void 0)||{},n.version=e.constructor.version;this.connector.sendCommand({command:"info",plugins:t,url:this.window.location.href})}},n}()}).call(this);