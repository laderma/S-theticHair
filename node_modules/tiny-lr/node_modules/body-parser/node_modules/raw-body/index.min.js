function getDecoder(e){if(!e)return null;try{return iconv.getCodec(e).decoder()}catch(n){var t=makeError("specified encoding unsupported","encoding.unsupported");throw t.status=t.statusCode=415,t.encoding=e,t}}function halt(e){unpipe(e),"function"==typeof e.pause&&e.pause()}function makeError(e,n){var t=new Error;return t.message=e,Object.defineProperty(t,"type",{value:n,enumerable:!0,writable:!0,configurable:!0}),t}function unpipe(e){if("function"==typeof e.unpipe)return void e.unpipe();for(var n,t=e.listeners("close"),r=0;r<t.length;r++)n=t[r],("cleanup"===n.name||"onclose"===n.name)&&n.call(e)}var bytes=require("bytes"),iconv=require("iconv-lite");module.exports=function(e,n,t){function f(e){t=e}function d(n){if(u+=n.length,l?c+=l.write(n):c.push(n),null!==i&&u>i){var r=makeError("request entity too large","entity.too.large");r.status=r.statusCode=413,r.received=u,r.limit=i,p(),halt(e),t(r)}}function h(n){if(n)p(),halt(e),t(n);else if(null!==a&&u!==a)n=makeError("request size did not match content length","request.size.invalid"),n.status=n.statusCode=400,n.received=u,n.length=n.expected=a,p(),t(n);else{var r=l?c+(l.end()||""):Buffer.concat(c);p(),t(null,r)}}function p(){u=c=null,e.removeListener("data",d),e.removeListener("end",h),e.removeListener("error",h),e.removeListener("close",p)}(n===!0||"string"==typeof n)&&(n={encoding:n}),n=n||{},"function"==typeof n&&(t=n,n={});var r=n.encoding!==!0?n.encoding:"utf-8",i=null;"number"==typeof n.limit&&(i=n.limit),"string"==typeof n.limit&&(i=bytes(n.limit));var a=null;if(null==n.length||isNaN(n.length)||(a=parseInt(n.length,10)),null!==i&&null!==a&&a>i){var o=makeError("request entity too large","entity.too.large");return o.status=o.statusCode=413,o.length=o.expected=a,o.limit=i,p(),halt(e),process.nextTick(function(){t(o)}),f}var s=e._readableState;if(e._decoder||s&&(s.encoding||s.decoder)){var o=makeError("stream encoding should not be set","stream.encoding.set");return o.status=o.statusCode=500,p(),halt(e),process.nextTick(function(){t(o)}),f}var l,u=0;try{l=getDecoder(r)}catch(o){return p(),halt(e),process.nextTick(function(){t(o)}),f}var c=l?"":[];return e.on("data",d),e.once("end",h),e.once("error",h),e.once("close",p),f};