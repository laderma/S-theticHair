function utf7EncoderWrite(e){return new Buffer(e.replace(nonDirectChars,function(e){return"+"+("+"===e?"":this.iconv.encode(e,"utf16-be").toString("base64").replace(/=+$/,""))+"-"}.bind(this)))}function utf7DecoderWrite(e){for(var n="",t=0,r=this.inBase64,i=this.base64Accum,a=0;a<e.length;a++)if(r){if(!base64Chars[e[a]]){if(a==t&&e[a]==minusChar)n+="+";else{var o=i+e.slice(t,a).toString();n+=this.iconv.decode(new Buffer(o,"base64"),"utf16-be")}e[a]!=minusChar&&a--,t=a+1,r=!1,i=""}}else e[a]==plusChar&&(n+=this.iconv.decode(e.slice(t,a),"ascii"),t=a+1,r=!0);if(r){var o=i+e.slice(t).toString(),s=o.length-o.length%8;i=o.slice(s),o=o.slice(0,s),n+=this.iconv.decode(new Buffer(o,"base64"),"utf16-be")}else n+=this.iconv.decode(e.slice(t),"ascii");return this.inBase64=r,this.base64Accum=i,n}function utf7DecoderEnd(){var e="";return this.inBase64&&this.base64Accum.length>0&&(e=this.iconv.decode(new Buffer(this.base64Accum,"base64"),"utf16-be")),this.inBase64=!1,this.base64Accum="",e}function utf7ImapEncoderWrite(e){for(var n=this.inBase64,t=this.base64Accum,r=this.base64AccumIdx,i=new Buffer(5*e.length+10),a=0,o=0;o<e.length;o++){var s=e.charCodeAt(o);s>=32&&126>=s?(n&&(r>0&&(a+=i.write(t.slice(0,r).toString("base64").replace(/\//g,",").replace(/=+$/,""),a),r=0),i[a++]=minusChar,n=!1),n||(i[a++]=s,s===andChar&&(i[a++]=minusChar))):(n||(i[a++]=andChar,n=!0),n&&(t[r++]=s>>8,t[r++]=255&s,r==t.length&&(a+=i.write(t.toString("base64").replace(/\//g,","),a),r=0)))}return this.inBase64=n,this.base64AccumIdx=r,i.slice(0,a)}function utf7ImapEncoderEnd(){var e=new Buffer(10),n=0;return this.inBase64&&(this.base64AccumIdx>0&&(n+=e.write(this.base64Accum.slice(0,this.base64AccumIdx).toString("base64").replace(/\//g,",").replace(/=+$/,""),n),this.base64AccumIdx=0),e[n++]=minusChar,this.inBase64=!1),e.slice(0,n)}function utf7ImapDecoderWrite(e){for(var n="",t=0,r=this.inBase64,i=this.base64Accum,a=0;a<e.length;a++)if(r){if(!base64IMAPChars[e[a]]){if(a==t&&e[a]==minusChar)n+="&";else{var o=i+e.slice(t,a).toString().replace(/,/g,"/");n+=this.iconv.decode(new Buffer(o,"base64"),"utf16-be")}e[a]!=minusChar&&a--,t=a+1,r=!1,i=""}}else e[a]==andChar&&(n+=this.iconv.decode(e.slice(t,a),"ascii"),t=a+1,r=!0);if(r){var o=i+e.slice(t).toString().replace(/,/g,"/"),s=o.length-o.length%8;i=o.slice(s),o=o.slice(0,s),n+=this.iconv.decode(new Buffer(o,"base64"),"utf16-be")}else n+=this.iconv.decode(e.slice(t),"ascii");return this.inBase64=r,this.base64Accum=i,n}function utf7ImapDecoderEnd(){var e="";return this.inBase64&&this.base64Accum.length>0&&(e=this.iconv.decode(new Buffer(this.base64Accum,"base64"),"utf16-be")),this.inBase64=!1,this.base64Accum="",e}exports.utf7=function(e){return{encoder:function(){return{write:utf7EncoderWrite,end:function(){},iconv:e.iconv}},decoder:function(){return{write:utf7DecoderWrite,end:utf7DecoderEnd,iconv:e.iconv,inBase64:!1,base64Accum:""}}}};for(var nonDirectChars=/[^A-Za-z0-9'\(\),-\.\/:\? \n\r\t]+/g,base64Regex=/[A-Za-z0-9\/+]/,base64Chars=[],i=0;256>i;i++)base64Chars[i]=base64Regex.test(String.fromCharCode(i));var plusChar="+".charCodeAt(0),minusChar="-".charCodeAt(0),andChar="&".charCodeAt(0);exports.utf7imap=function(e){return{encoder:function(){return{write:utf7ImapEncoderWrite,end:utf7ImapEncoderEnd,iconv:e.iconv,inBase64:!1,base64Accum:new Buffer(6),base64AccumIdx:0}},decoder:function(){return{write:utf7ImapDecoderWrite,end:utf7ImapDecoderEnd,iconv:e.iconv,inBase64:!1,base64Accum:""}}}};var base64IMAPChars=base64Chars.slice();base64IMAPChars[",".charCodeAt(0)]=!0;