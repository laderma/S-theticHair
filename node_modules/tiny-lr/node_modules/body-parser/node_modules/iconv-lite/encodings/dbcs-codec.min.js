function DBCSCodec(e){if(this.options=e,!e)throw new Error("DBCS codec is called without the data.");if(!e.table)throw new Error("Encoding '"+e.encodingName+"' has no data.");var n=e.table();this.decodeTables=[],this.decodeTables[0]=UNASSIGNED_NODE.slice(0),this.decodeTableSeq=[];for(var t=0;t<n.length;t++)this._addDecodeChunk(n[t]);this.defaultCharUnicode=e.iconv.defaultCharUnicode,this.encodeTable=[],this.encodeTableSeq=[];var r={};if(e.encodeSkipVals)for(var t=0;t<e.encodeSkipVals.length;t++)for(var i=e.encodeSkipVals[t],a=i.from;a<=i.to;a++)r[a]=!0;this._fillEncodeTable(0,0,r);for(var o in e.encodeAdd||{})this._setEncodeChar(o.charCodeAt(0),e.encodeAdd[o]);if(this.defCharSB=this.encodeTable[0][e.iconv.defaultCharSingleByte.charCodeAt(0)],this.defCharSB===UNASSIGNED&&(this.defCharSB=this.encodeTable[0]["?"]),this.defCharSB===UNASSIGNED&&(this.defCharSB="?".charCodeAt(0)),"function"==typeof e.gb18030){this.gb18030=e.gb18030();for(var s=this.decodeTables.length,u=this.decodeTables[s]=UNASSIGNED_NODE.slice(0),l=this.decodeTables.length,c=this.decodeTables[l]=UNASSIGNED_NODE.slice(0),t=129;254>=t;t++)for(var f=NODE_START-this.decodeTables[0][t],d=this.decodeTables[f],a=48;57>=a;a++)d[a]=NODE_START-s;for(var t=129;254>=t;t++)u[t]=NODE_START-l;for(var t=48;57>=t;t++)c[t]=GB18030_CODE}}function encoderDBCSWrite(e){for(var n=new Buffer(e.length*(this.gb18030?4:3)),t=this.leadSurrogate,r=this.seqObj,i=-1,a=0,o=0;;){if(-1===i){if(a==e.length)break;var s=e.charCodeAt(a++)}else{var s=i;i=-1}if(s>=55296&&57344>s)if(56320>s){if(-1===t){t=s;continue}t=s,s=UNASSIGNED}else-1!==t?(s=65536+1024*(t-55296)+(s-56320),t=-1):s=UNASSIGNED;else-1!==t&&(i=s,s=UNASSIGNED,t=-1);var u=UNASSIGNED;if(void 0!==r&&s!=UNASSIGNED){var l=r[s];if("object"==typeof l){r=l;continue}"number"==typeof l?u=l:void 0==l&&(l=r[DEF_CHAR],void 0!==l&&(u=l,i=s)),r=void 0}else if(s>=0){var c=this.encodeTable[s>>8];if(void 0!==c&&(u=c[255&s]),SEQ_START>=u){r=this.encodeTableSeq[SEQ_START-u];continue}if(u==UNASSIGNED&&this.gb18030){var f=findIdx(this.gb18030.uChars,s);if(-1!=f){var u=this.gb18030.gbChars[f]+(s-this.gb18030.uChars[f]);n[o++]=129+Math.floor(u/12600),u%=12600,n[o++]=48+Math.floor(u/1260),u%=1260,n[o++]=129+Math.floor(u/10),u%=10,n[o++]=48+u;continue}}}u===UNASSIGNED&&(u=this.defaultCharSingleByte),256>u?n[o++]=u:65536>u?(n[o++]=u>>8,n[o++]=255&u):(n[o++]=u>>16,n[o++]=u>>8&255,n[o++]=255&u)}return this.seqObj=r,this.leadSurrogate=t,n.slice(0,o)}function encoderDBCSEnd(){if(-1!==this.leadSurrogate||void 0!==this.seqObj){var e=new Buffer(10),n=0;if(this.seqObj){var t=this.seqObj[DEF_CHAR];void 0!==t&&(256>t?e[n++]=t:(e[n++]=t>>8,e[n++]=255&t)),this.seqObj=void 0}return-1!==this.leadSurrogate&&(e[n++]=this.defaultCharSingleByte,this.leadSurrogate=-1),e.slice(0,n)}}function decoderDBCSWrite(e){var o,n=new Buffer(2*e.length),t=this.nodeIdx,r=this.prevBuf,i=this.prevBuf.length,a=-this.prevBuf.length;i>0&&(r=Buffer.concat([r,e.slice(0,10)]));for(var s=0,u=0;s<e.length;s++){var l=s>=0?e[s]:r[s+i],o=this.decodeTables[t][l];if(o>=0);else if(o===UNASSIGNED)s=a,o=this.defaultCharUnicode.charCodeAt(0);else if(o===GB18030_CODE){var c=a>=0?e.slice(a,s+1):r.slice(a+i,s+1+i),f=12600*(c[0]-129)+1260*(c[1]-48)+10*(c[2]-129)+(c[3]-48),d=findIdx(this.gb18030.gbChars,f);o=this.gb18030.uChars[d]+f-this.gb18030.gbChars[d]}else{if(NODE_START>=o){t=NODE_START-o;continue}if(!(SEQ_START>=o))throw new Error("Unknown table value when decoding: "+val);for(var h=this.decodeTableSeq[SEQ_START-o],p=0;p<h.length-1;p++)o=h[p],n[u++]=255&o,n[u++]=o>>8;o=h[h.length-1]}if(o>65535){o-=65536;var m=55296+Math.floor(o/1024);n[u++]=255&m,n[u++]=m>>8,o=56320+o%1024}n[u++]=255&o,n[u++]=o>>8,t=0,a=s+1}return this.nodeIdx=t,this.prevBuf=a>=0?e.slice(a):r.slice(a+i),n.slice(0,u).toString("ucs2")}function decoderDBCSEnd(){for(var e="";this.prevBuf.length>0;){e+=this.defaultCharUnicode;var n=this.prevBuf.slice(1);this.prevBuf=new Buffer(0),this.nodeIdx=0,n.length>0&&(e+=decoderDBCSWrite.call(this,n))}return this.nodeIdx=0,e}function findIdx(e,n){if(e[0]>n)return-1;for(var t=0,r=e.length;r-1>t;){var i=t+Math.floor((r-t+1)/2);e[i]<=n?t=i:r=i}return t}exports._dbcs=function(e){return new DBCSCodec(e)};for(var UNASSIGNED=-1,GB18030_CODE=-2,SEQ_START=-10,NODE_START=-1e3,UNASSIGNED_NODE=new Array(256),DEF_CHAR=-1,i=0;256>i;i++)UNASSIGNED_NODE[i]=UNASSIGNED;DBCSCodec.prototype.encoder=function(e){return{write:encoderDBCSWrite,end:encoderDBCSEnd,leadSurrogate:-1,seqObj:void 0,encodeTable:this.encodeTable,encodeTableSeq:this.encodeTableSeq,defaultCharSingleByte:this.defCharSB,gb18030:this.gb18030,findIdx:findIdx}},DBCSCodec.prototype.decoder=function(e){return{write:decoderDBCSWrite,end:decoderDBCSEnd,nodeIdx:0,prevBuf:new Buffer(0),decodeTables:this.decodeTables,decodeTableSeq:this.decodeTableSeq,defaultCharUnicode:this.defaultCharUnicode,gb18030:this.gb18030}},DBCSCodec.prototype._getDecodeTrieNode=function(e){for(var n=[];e>0;e>>=8)n.push(255&e);0==n.length&&n.push(0);for(var t=this.decodeTables[0],r=n.length-1;r>0;r--){var i=t[n[r]];if(i==UNASSIGNED)t[n[r]]=NODE_START-this.decodeTables.length,this.decodeTables.push(t=UNASSIGNED_NODE.slice(0));else{if(!(NODE_START>=i))throw new Error("Overwrite byte in "+this.options.encodingName+", addr: "+e.toString(16));t=this.decodeTables[NODE_START-i]}}return t},DBCSCodec.prototype._addDecodeChunk=function(e){var n=parseInt(e[0],16),t=this._getDecodeTrieNode(n);n=255&n;for(var r=1;r<e.length;r++){var i=e[r];if("string"==typeof i)for(var a=0;a<i.length;){var o=i.charCodeAt(a++);if(o>=55296&&56320>o){var s=i.charCodeAt(a++);if(!(s>=56320&&57344>s))throw new Error("Incorrect surrogate pair in "+this.options.encodingName+" at chunk "+e[0]);t[n++]=65536+1024*(o-55296)+(s-56320)}else if(o>4080&&4095>=o){for(var u=4095-o+2,l=[],c=0;u>c;c++)l.push(i.charCodeAt(a++));t[n++]=SEQ_START-this.decodeTableSeq.length,this.decodeTableSeq.push(l)}else t[n++]=o}else{if("number"!=typeof i)throw new Error("Incorrect type '"+typeof i+"' given in "+this.options.encodingName+" at chunk "+e[0]);for(var f=t[n-1]+1,a=0;i>a;a++)t[n++]=f++}}if(n>255)throw new Error("Incorrect chunk in "+this.options.encodingName+" at addr "+e[0]+": too long"+n)},DBCSCodec.prototype._getEncodeBucket=function(e){var n=e>>8;return void 0===this.encodeTable[n]&&(this.encodeTable[n]=UNASSIGNED_NODE.slice(0)),this.encodeTable[n]},DBCSCodec.prototype._setEncodeChar=function(e,n){var t=this._getEncodeBucket(e),r=255&e;t[r]<=SEQ_START?this.encodeTableSeq[SEQ_START-t[r]][DEF_CHAR]=n:t[r]==UNASSIGNED&&(t[r]=n)},DBCSCodec.prototype._setEncodeSequence=function(e,n){var a,t=e[0],r=this._getEncodeBucket(t),i=255&t;r[i]<=SEQ_START?a=this.encodeTableSeq[SEQ_START-r[i]]:(a={},r[i]!==UNASSIGNED&&(a[DEF_CHAR]=r[i]),r[i]=SEQ_START-this.encodeTableSeq.length,this.encodeTableSeq.push(a));for(var o=1;o<e.length-1;o++){var s=a[t];"object"==typeof s?a=s:(a=a[t]={},void 0!==s&&(a[DEF_CHAR]=s))}t=e[e.length-1],a[t]=n},DBCSCodec.prototype._fillEncodeTable=function(e,n,t){for(var r=this.decodeTables[e],i=0;256>i;i++){var a=r[i],o=n+i;t[o]||(a>=0?this._setEncodeChar(a,o):NODE_START>=a?this._fillEncodeTable(NODE_START-a,o<<8,t):SEQ_START>=a&&this._setEncodeSequence(this.decodeTableSeq[SEQ_START-a],o))}};