function escapeRegExp(n){return n.replace(/[\-\/\\\^$*+?.()|\[\]{}]/g,"\\$&")}function TokenParser(n,e,t,r,a){this.out=[],this.state=[],this.filterApplyIdx=[],this._parsers={},this.line=r,this.filename=a,this.filters=e,this.escape=t,this.parse=function(){var e=this;return e._parsers.start&&e._parsers.start.call(e),utils.each(n,function(t,r){var a=n[r-1];if(e.isLast=r===n.length-1,a)for(;a.type===_t.WHITESPACE;)r-=1,a=n[r-1];e.prevToken=a,e.parseToken(t)}),e._parsers.end&&e._parsers.end.call(e),e.escape&&(e.filterApplyIdx=[0],"string"==typeof e.escape?(e.parseToken({type:_t.FILTER,match:"e"}),e.parseToken({type:_t.COMMA,match:","}),e.parseToken({type:_t.STRING,match:String(t)}),e.parseToken({type:_t.PARENCLOSE,match:")"})):e.parseToken({type:_t.FILTEREMPTY,match:"e"})),e.out}}var utils=require("./utils"),lexer=require("./lexer"),_t=lexer.types,_reserved=["break","case","catch","continue","debugger","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with"];TokenParser.prototype={on:function(n,e){this._parsers[n]=e},parseToken:function(n){var o,e=this,t=e._parsers[n.type]||e._parsers["*"],r=n.match,a=e.prevToken,i=a?a.type:null,s=e.state.length?e.state[e.state.length-1]:null;if(!t||"function"!=typeof t||t.call(this,n))switch(s&&a&&s===_t.FILTER&&i===_t.FILTER&&n.type!==_t.PARENCLOSE&&n.type!==_t.COMMA&&n.type!==_t.OPERATOR&&n.type!==_t.FILTER&&n.type!==_t.FILTEREMPTY&&e.out.push(", "),s&&s===_t.METHODOPEN&&(e.state.pop(),n.type!==_t.PARENCLOSE&&e.out.push(", ")),n.type){case _t.WHITESPACE:break;case _t.STRING:e.filterApplyIdx.push(e.out.length),e.out.push(r.replace(/\\/g,"\\\\"));break;case _t.NUMBER:case _t.BOOL:e.filterApplyIdx.push(e.out.length),e.out.push(r);break;case _t.FILTER:e.filters.hasOwnProperty(r)&&"function"==typeof e.filters[r]||utils.throwError('Invalid filter "'+r+'"',e.line,e.filename),e.escape=e.filters[r].safe?!1:e.escape,e.out.splice(e.filterApplyIdx[e.filterApplyIdx.length-1],0,'_filters["'+r+'"]('),e.state.push(n.type);break;case _t.FILTEREMPTY:e.filters.hasOwnProperty(r)&&"function"==typeof e.filters[r]||utils.throwError('Invalid filter "'+r+'"',e.line,e.filename),e.escape=e.filters[r].safe?!1:e.escape,e.out.splice(e.filterApplyIdx[e.filterApplyIdx.length-1],0,'_filters["'+r+'"]('),e.out.push(")");break;case _t.FUNCTION:case _t.FUNCTIONEMPTY:e.out.push("((typeof _ctx."+r+' !== "undefined") ? _ctx.'+r+" : ((typeof "+r+' !== "undefined") ? '+r+" : _fn))("),e.escape=!1,n.type===_t.FUNCTIONEMPTY?e.out[e.out.length-1]=e.out[e.out.length-1]+")":e.state.push(n.type),e.filterApplyIdx.push(e.out.length-1);break;case _t.PARENOPEN:e.state.push(n.type),e.filterApplyIdx.length?(e.out.splice(e.filterApplyIdx[e.filterApplyIdx.length-1],0,"("),a&&i===_t.VAR?(o=a.match.split(".").slice(0,-1),e.out.push(" || _fn).call("+e.checkMatch(o)),e.state.push(_t.METHODOPEN),e.escape=!1):e.out.push(" || _fn)("),e.filterApplyIdx.push(e.out.length-3)):(e.out.push("("),e.filterApplyIdx.push(e.out.length-1));break;case _t.PARENCLOSE:o=e.state.pop(),o!==_t.PARENOPEN&&o!==_t.FUNCTION&&o!==_t.FILTER&&utils.throwError("Mismatched nesting state",e.line,e.filename),e.out.push(")"),e.filterApplyIdx.pop(),o!==_t.FILTER&&e.filterApplyIdx.pop();break;case _t.COMMA:s!==_t.FUNCTION&&s!==_t.FILTER&&s!==_t.ARRAYOPEN&&s!==_t.CURLYOPEN&&s!==_t.PARENOPEN&&s!==_t.COLON&&utils.throwError("Unexpected comma",e.line,e.filename),s===_t.COLON&&e.state.pop(),e.out.push(", "),e.filterApplyIdx.pop();break;case _t.LOGIC:case _t.COMPARATOR:a&&i!==_t.COMMA&&i!==n.type&&i!==_t.BRACKETOPEN&&i!==_t.CURLYOPEN&&i!==_t.PARENOPEN&&i!==_t.FUNCTION||utils.throwError("Unexpected logic",e.line,e.filename),e.out.push(n.match);break;case _t.NOT:e.out.push(n.match);break;case _t.VAR:e.parseVar(n,r,s);break;case _t.BRACKETOPEN:!a||i!==_t.VAR&&i!==_t.BRACKETCLOSE&&i!==_t.PARENCLOSE?(e.state.push(_t.ARRAYOPEN),e.filterApplyIdx.push(e.out.length)):e.state.push(n.type),e.out.push("[");break;case _t.BRACKETCLOSE:o=e.state.pop(),o!==_t.BRACKETOPEN&&o!==_t.ARRAYOPEN&&utils.throwError("Unexpected closing square bracket",e.line,e.filename),e.out.push("]"),e.filterApplyIdx.pop();break;case _t.CURLYOPEN:e.state.push(n.type),e.out.push("{"),e.filterApplyIdx.push(e.out.length-1);break;case _t.COLON:s!==_t.CURLYOPEN&&utils.throwError("Unexpected colon",e.line,e.filename),e.state.push(n.type),e.out.push(":"),e.filterApplyIdx.pop();break;case _t.CURLYCLOSE:s===_t.COLON&&e.state.pop(),e.state.pop()!==_t.CURLYOPEN&&utils.throwError("Unexpected closing curly brace",e.line,e.filename),e.out.push("}"),e.filterApplyIdx.pop();break;case _t.DOTKEY:(!a||i!==_t.VAR&&i!==_t.BRACKETCLOSE&&i!==_t.DOTKEY&&i!==_t.PARENCLOSE&&i!==_t.FUNCTIONEMPTY&&i!==_t.FILTEREMPTY&&i!==_t.CURLYCLOSE)&&utils.throwError('Unexpected key "'+r+'"',e.line,e.filename),e.out.push("."+r);break;case _t.OPERATOR:e.out.push(" "+r+" "),e.filterApplyIdx.pop()}},parseVar:function(n,e,t){var r=this;return e=e.split("."),-1!==_reserved.indexOf(e[0])&&utils.throwError('Reserved keyword "'+e[0]+'" attempted to be used as a variable',r.line,r.filename),r.filterApplyIdx.push(r.out.length),t===_t.CURLYOPEN?(e.length>1&&utils.throwError("Unexpected dot",r.line,r.filename),void r.out.push(e[0])):void r.out.push(r.checkMatch(e))},checkMatch:function(n){function r(t){var r=t+e,a=n,i="";return i="(typeof "+r+' !== "undefined" && '+r+" !== null",utils.each(a,function(n,e){0!==e&&(i+=" && "+r+"."+n+" !== undefined && "+r+"."+n+" !== null",r+="."+n)}),i+=")"}function a(e){return"("+r(e)+" ? "+e+n.join(".")+' : "")'}var t,e=n[0];return t="("+r("_ctx.")+" ? "+a("_ctx.")+" : "+a("")+")","("+t+" !== null ? "+t+' : "" )'}},exports.parse=function(n,e,t,r,a){function z(n,e){var s,o,r=lexer.read(utils.strip(n));return s=new TokenParser(r,a,i,e,t.filename),o=s.parse().join(""),s.state.length&&utils.throwError('Unable to parse "'+n+'"',e,t.filename),{compile:function(){return"_output += "+o+";\n"}}}function E(e,s){var o,l,u,d,c,h,f;if(utils.startsWith(e,"end")){if(f=S[S.length-1],f&&f.name===e.split(/\s+/)[0].replace(/^end/,"")&&f.ends){switch(f.name){case"autoescape":i=t.autoescape;break;case"raw":Y=!1}return void S.pop()}Y||utils.throwError('Unexpected end of tag "'+e.replace(/^end/,"")+'"',s,t.filename)}if(!Y){switch(u=e.split(/\s+(.+)?/),d=u.shift(),r.hasOwnProperty(d)||utils.throwError('Unexpected tag "'+e+'"',s,t.filename),o=lexer.read(utils.strip(u.join(" "))),l=new TokenParser(o,a,!1,s,t.filename),c=r[d],c.parse(u[1],s,l,_t,S,t,n)||utils.throwError('Unexpected tag "'+d+'"',s,t.filename),l.parse(),h=l.out,d){case"autoescape":i="false"!==h[0]?h[0]:!1;break;case"raw":Y=!0}return{block:!!r[d].block,compile:c.compile,args:h,content:[],ends:c.ends,name:d}}}function F(n){return"string"==typeof n&&(n=n.replace(/\s*$/,"")),n}e=e.replace(/\r\n/g,"\n");var x,i=t.autoescape,s=t.tagControls[0],o=t.tagControls[1],l=t.varControls[0],u=t.varControls[1],d=escapeRegExp(s),c=escapeRegExp(o),h=escapeRegExp(l),f=escapeRegExp(u),m=new RegExp("^"+d+"-?\\s*-?|-?\\s*-?"+c+"$","g"),p=new RegExp("^"+d+"-"),g=new RegExp("-"+c+"$"),_=new RegExp("^"+h+"-?\\s*-?|-?\\s*-?"+f+"$","g"),b=new RegExp("^"+h+"-"),v=new RegExp("-"+f+"$"),k=t.cmtControls[0],y=t.cmtControls[1],M="[\\s\\S]*?",w=new RegExp("("+d+M+c+"|"+h+M+f+"|"+escapeRegExp(k)+M+escapeRegExp(y)+")"),L=1,S=[],H=null,D=[],T={},Y=!1;return exports.parseVariable=z,utils.each(e.split(w),function(n){var e,t,r,a,i;if(n){if(!Y&&utils.startsWith(n,l)&&utils.endsWith(n,u))r=b.test(n),x=v.test(n),e=z(n.replace(_,""),L);else if(utils.startsWith(n,s)&&utils.endsWith(n,o))r=p.test(n),x=g.test(n),e=E(n.replace(m,""),L),e&&("extends"===e.name?H=e.args.join("").replace(/^\'|\'$/g,"").replace(/^\"|\"$/g,""):e.block&&!S.length&&(T[e.args.join("")]=e)),Y&&!e&&(e=n);else if(Y||!utils.startsWith(n,k)&&!utils.endsWith(n,y))e=x?n.replace(/^\s*/,""):n,x=!1;else if(utils.startsWith(n,k)&&utils.endsWith(n,y))return;r&&D.length&&(a=D.pop(),"string"==typeof a?a=F(a):a.content&&a.content.length&&(i=F(a.content.pop()),a.content.push(i)),D.push(a)),e&&(S.length?S[S.length-1].content.push(e):D.push(e),e.name&&e.ends&&S.push(e),t=n.match(/\n/g),L+=t?t.length:0)}}),{name:t.filename,parent:H,tokens:D,blocks:T}},exports.compile=function(n,e,t,r){var a="",i=utils.isArray(n)?n:n.tokens;return utils.each(i,function(n){var i;return"string"==typeof n?void(a+='_output += "'+n.replace(/\\/g,"\\\\").replace(/\n|\r/g,"\\n").replace(/"/g,'\\"')+'";\n'):(i=n.compile(exports.compile,n.args?n.args.slice(0):[],n.content?n.content.slice(0):[],e,t,r),void(a+=i||""))}),a};