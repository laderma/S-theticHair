function Option(e,n){this.flags=e,this.required=~e.indexOf("<"),this.optional=~e.indexOf("["),this.bool=!~e.indexOf("-no-"),e=e.split(/[ ,|]+/),e.length>1&&!/^[[<]/.test(e[1])&&(this["short"]=e.shift()),this["long"]=e.shift(),this.description=n||""}function Command(e){this.commands=[],this.options=[],this._execs=[],this._args=[],this._name=e}function camelcase(e){return e.split("-").reduce(function(e,n){return e+n[0].toUpperCase()+n.slice(1)})}function pad(e,n){var t=Math.max(0,n-e.length);return e+Array(t+1).join(" ")}function outputHelpIfNecessary(e,n){n=n||[];for(var t=0;t<n.length;t++)("--help"==n[t]||"-h"==n[t])&&(e.outputHelp(),process.exit(0))}var EventEmitter=require("events").EventEmitter,spawn=require("child_process").spawn,fs=require("fs"),exists=fs.existsSync,path=require("path"),dirname=path.dirname,basename=path.basename;exports=module.exports=new Command,exports.Command=Command,exports.Option=Option,Option.prototype.name=function(){return this["long"].replace("--","").replace("no-","")},Option.prototype.is=function(e){return e==this["short"]||e==this["long"]},Command.prototype.__proto__=EventEmitter.prototype,Command.prototype.command=function(e,n){var t=e.split(/ +/),r=new Command(t.shift());return n&&r.description(n),n&&(this.executables=!0),n&&(this._execs[r._name]=!0),this.commands.push(r),r.parseExpectedArgs(t),r.parent=this,n?this:r},Command.prototype.addImplicitHelpCommand=function(){this.command("help [cmd]","display help for [cmd]")},Command.prototype.parseExpectedArgs=function(e){if(e.length){var n=this;return e.forEach(function(e){switch(e[0]){case"<":n._args.push({required:!0,name:e.slice(1,-1)});break;case"[":n._args.push({required:!1,name:e.slice(1,-1)})}}),this}},Command.prototype.action=function(e){var n=this;return this.parent.on(this._name,function(t,r){r=r||[];var a=n.parseOptions(r);outputHelpIfNecessary(n,a.unknown),a.unknown.length>0&&n.unknownOption(a.unknown[0]),a.args.length&&(t=a.args.concat(t)),n._args.forEach(function(e,r){e.required&&null==t[r]&&n.missingArgument(e.name)}),n._args.length?t[n._args.length]=n:t.push(n),e.apply(this,t)}),this},Command.prototype.option=function(e,n,t,r){var a=this,i=new Option(e,n),o=i.name(),s=camelcase(o);return"function"!=typeof t&&(r=t,t=null),(0==i.bool||i.optional||i.required)&&(0==i.bool&&(r=!0),void 0!==r&&(a[s]=r)),this.options.push(i),this.on(o,function(e){null!=e&&t&&(e=t(e)),"boolean"==typeof a[s]||"undefined"==typeof a[s]?null==e?a[s]=i.bool?r||!0:!1:a[s]=e:null!==e&&(a[s]=e)}),this},Command.prototype.parse=function(e){this.executables&&this.addImplicitHelpCommand(),this.rawArgs=e,this._name=this._name||basename(e[1]);var n=this.parseOptions(this.normalize(e.slice(2))),t=this.args=n.args,r=this.parseArgs(this.args,n.unknown),a=r.args[0];return this._execs[a]?this.executeSubCommand(e,t,n.unknown):r},Command.prototype.executeSubCommand=function(e,n,t){n=n.concat(t),n.length||this.help(),"help"==n[0]&&1==n.length&&this.help(),"help"==n[0]&&(n[0]=n[1],n[1]="--help");var r=dirname(e[1]),a=basename(e[1])+"-"+n[0],i=path.join(r,a);n=n.slice(1);var o=spawn(i,n,{stdio:"inherit",customFds:[0,1,2]});o.on("error",function(e){"ENOENT"==e.code?console.error("\n  %s(1) does not exist, try --help\n",a):"EACCES"==e.code&&console.error("\n  %s(1) not executable. try chmod or run with root\n",a)}),this.runningCommand=o},Command.prototype.normalize=function(e){for(var t,r,a,n=[],i=0,o=e.length;o>i;++i)t=e[i],i>0&&(r=this.optionFor(e[i-1])),r&&r.required?n.push(t):t.length>1&&"-"==t[0]&&"-"!=t[1]?t.slice(1).split("").forEach(function(e){n.push("-"+e)}):/^--/.test(t)&&~(a=t.indexOf("="))?n.push(t.slice(0,a),t.slice(a+1)):n.push(t);return n},Command.prototype.parseArgs=function(e,n){var a,t=this.commands;t.length;return e.length?(a=e[0],this.listeners(a).length?this.emit(e.shift(),e,n):this.emit("*",e)):(outputHelpIfNecessary(this,n),n.length>0&&this.unknownOption(n[0])),this},Command.prototype.optionFor=function(e){for(var n=0,t=this.options.length;t>n;++n)if(this.options[n].is(e))return this.options[n]},Command.prototype.parseOptions=function(e){for(var r,a,i,n=[],t=e.length,o=[],s=0;t>s;++s)if(i=e[s],"--"!=i)if(r)n.push(i);else if(a=this.optionFor(i))if(a.required){if(i=e[++s],null==i)return this.optionMissingArgument(a);this.emit(a.name(),i)}else a.optional?(i=e[s+1],null==i||"-"==i[0]&&"-"!=i?i=null:++s,this.emit(a.name(),i)):this.emit(a.name());else i.length>1&&"-"==i[0]?(o.push(i),e[s+1]&&"-"!=e[s+1][0]&&o.push(e[++s])):n.push(i);else r=!0;return{args:n,unknown:o}},Command.prototype.missingArgument=function(e){console.error(),console.error("  error: missing required argument `%s'",e),console.error(),process.exit(1)},Command.prototype.optionMissingArgument=function(e,n){console.error(),n?console.error("  error: option `%s' argument missing, got `%s'",e.flags,n):console.error("  error: option `%s' argument missing",e.flags),console.error(),process.exit(1)},Command.prototype.unknownOption=function(e){console.error(),console.error("  error: unknown option `%s'",e),console.error(),process.exit(1)},Command.prototype.version=function(e,n){return 0==arguments.length?this._version:(this._version=e,n=n||"-V, --version",this.option(n,"output the version number"),this.on("version",function(){console.log(e),process.exit(0)}),this)},Command.prototype.description=function(e){return 0==arguments.length?this._description:(this._description=e,this)},Command.prototype.usage=function(e){var n=this._args.map(function(e){return e.required?"<"+e.name+">":"["+e.name+"]"}),t="[options"+(this.commands.length?"] [command":"")+"]"+(this._args.length?" "+n:"");return 0==arguments.length?this._usage||t:(this._usage=e,this)},Command.prototype.largestOptionLength=function(){return this.options.reduce(function(e,n){return Math.max(e,n.flags.length)},0)},Command.prototype.optionHelp=function(){var e=this.largestOptionLength();return[pad("-h, --help",e)+"  output usage information"].concat(this.options.map(function(n){return pad(n.flags,e)+"  "+n.description})).join("\n")},Command.prototype.commandHelp=function(){return this.commands.length?["","  Commands:","",this.commands.map(function(e){var n=e._args.map(function(e){return e.required?"<"+e.name+">":"["+e.name+"]"}).join(" ");return pad(e._name+(e.options.length?" [options]":"")+" "+n,22)+(e.description()?" "+e.description():"")}).join("\n").replace(/^/gm,"    "),""].join("\n"):""},Command.prototype.helpInformation=function(){return["","  Usage: "+this._name+" "+this.usage(),""+this.commandHelp(),"  Options:","",""+this.optionHelp().replace(/^/gm,"    "),"",""].join("\n")},Command.prototype.outputHelp=function(){process.stdout.write(this.helpInformation()),this.emit("--help")},Command.prototype.help=function(){this.outputHelp(),process.exit()};