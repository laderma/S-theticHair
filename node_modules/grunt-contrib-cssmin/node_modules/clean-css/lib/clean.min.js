var ColorShortener=require("./colors/shortener"),ColorHSLToHex=require("./colors/hsl-to-hex"),ColorRGBToHex=require("./colors/rgb-to-hex"),ColorLongToShortHex=require("./colors/long-to-short-hex"),ShorthandNotations=require("./properties/shorthand-notations"),ImportInliner=require("./imports/inliner"),UrlRebase=require("./images/url-rebase"),EmptyRemoval=require("./selectors/empty-removal"),CommentsProcessor=require("./text/comments"),ExpressionsProcessor=require("./text/expressions"),FreeTextProcessor=require("./text/free"),UrlsProcessor=require("./text/urls"),SelectorsOptimizer=require("./selectors/optimizer"),CleanCSS=module.exports=function e(n){return n=n||{},this instanceof e?(n.keepBreaks=n.keepBreaks||!1,void 0===n.processImport&&(n.processImport=!0),n.selectorsMergeMode&&(console.warn("selectorsMergeMode is deprecated and will be removed in clean-css 2.2. Please use compatibility: '%s' option instead.",n.selectorsMergeMode),n.compatibility=n.selectorsMergeMode),this.options=n,this.stats={},this.context={errors:[],warnings:[],debug:n.debug},this.errors=this.context.errors,this.warnings=this.context.warnings,void(this.lineBreak="win32"==process.platform?"\r\n":"\n")):new e(n)};CleanCSS.prototype.minify=function(e,n){var t=this.options;if(Buffer.isBuffer(e)&&(e=e.toString()),t.processImport){var r=this,a=n?process.nextTick:function(e){return e()};return a(function(){return new ImportInliner(r.context,t.inliner).process(e,{localOnly:!n,root:t.root||process.cwd(),relativeTo:t.relativeTo,whenDone:function(e){return minify.call(r,e,n)}})})}return minify.call(this,e,n)};var minify=function(e,n){var t,r=this.stats,a=this.options,i=this.context,s=this.lineBreak,o=new CommentsProcessor("keepSpecialComments"in a?a.keepSpecialComments:"*",a.keepBreaks,s),l=new ExpressionsProcessor,u=new FreeTextProcessor,c=new UrlsProcessor;a.debug&&(this.startedAt=process.hrtime(),this.stats.originalSize=e.length);var d=function(){"function"==typeof arguments[0]?arguments[0]():e=e.replace.apply(e,arguments)};if(a.benchmark){var f=d;d=function(e,n){var t="function"==typeof e?/function (\w+)\(/.exec(e.toString())[1]:e,r=process.hrtime();f(e,n);var a=process.hrtime(r);console.log("%d ms: "+t,1e3*a[0]+a[1]/1e6)}}a.debug&&(t=process.hrtime(),r.originalSize=e.length),d(function(){e=o.escape(e)}),d(/\\(\r\n|\n)/gm,""),d(/url\((['"])([^\)]+)['"]\)/g,function(e,n,t){var r=0===t.indexOf("data:")&&null===t.match(/data:\w+\/[^;]+;base64,/);return null!==t.match(/[ \t]/g)||r?"url("+n+t+n+")":"url("+t+")"}),d(/(animation|animation\-name|font|font\-family):([^;}]+)/g,function(e,n,t){return 0===t.indexOf("'{")?e:n+":"+t.replace(/['"]([a-zA-Z][a-zA-Z\d\-_]+)['"]/g,"$1")}),d(/@(\-moz\-|\-o\-|\-webkit\-)?keyframes ([^{]+)/g,function(e,n,t){return n=n||"","@"+n+"keyframes "+(t.indexOf(" ")>-1?t:t.replace(/['"]/g,""))}),d(/progid:DXImageTransform\.Microsoft\.(Alpha|Chroma)(\([^\)]+\))([;}'"])/g,function(e,n,t,r){return n.toLowerCase()+t+r}),d(function(){e=l.escape(e)}),d(/\[([^\]]+)\]/g,function(e,n){var t=n.indexOf("="),r=n.indexOf("'"),a=n.indexOf('"');if(0>t&&0>r&&0>a)return e;if(0===r||0===a)return e;var i=n.substring(0,t),s=n.substring(t+1,n.length);return/^['"](?:[a-zA-Z][a-zA-Z\d\-_]+)['"]$/.test(s)?"["+i+"="+s.substring(1,s.length-1)+"]":e}),d(function(){e=u.escape(e)}),d(function(){e=c.escape(e)}),d(/\[([^\]]+)\]/g,function(e){return e.replace(/\s/g,"")}),d(/[\r]?\n/g," "),d(/[\t ]+/g," "),d(/;[ ]?;+/g,";"),d(/ (?:\r\n|\n)/g,s),d(/(?:\r\n|\n)+/g,s),d(/ ([+~>]) /g,"$1"),d(/([!\(\{\}:;=,\n]) /g,"$1"),d(/ ([!\)\{\};=,\n])/g,"$1"),d(/(?:\r\n|\n)\}/g,"}"),d(/([\{;,])(?:\r\n|\n)/g,"$1"),d(/ :([^\{\};]+)([;}])/g,":$1$2"),d(/progid:[^(]+\(([^\)]+)/g,function(e){return e.replace(/,/g,", ")}),d(/;\}/g,"}"),d(function(){e=new ColorHSLToHex(e).process()}),d(function(){e=new ColorRGBToHex(e).process()}),d(function(){e=new ColorLongToShortHex(e).process()}),d(function(){e=new ColorShortener(e).process()}),d(/(font\-weight|font):(normal|bold)([ ;\}!])(\w*)/g,function(e,n,t,r,a){return" "==r&&a.length>0&&!/[.\d]/.test(a)?e:"normal"==t?n+":400"+r+a:"bold"==t?n+":700"+r+a:e});var h=/(\s|:|,|\()\-0([^\.])/g;d(h,"$10$2"),d(h,"$10$2"),d(/(\s|:|,)0+([1-9])/g,"$1$2"),d(/\.(\d{3,})px/g,function(e,n){return"."+Math.round(100*parseFloat("."+n))+"px"}),d(/(\D)\.0+(,|\}|\))/g,"$10$2"),d(/\.([1-9]*)0+(\D)/g,function(e,n,t){return(n.length>0?".":"")+n+t});var p=["px","em","ex","cm","mm","in","pt","pc","%"];if(-1==["ie7","ie8"].indexOf(a.compatibility)&&p.push("rem"),d(new RegExp("(\\s|:|,)\\-?0(?:"+p.join("|")+")","g"),"$10"),d(new RegExp("(\\s|:|,)\\-?(\\d)\\.(\\D)","g"),"$1$2$3"),d(new RegExp("rect\\(0(?:"+p.join("|")+")","g"),"rect(0"),d(/(rgb|rgba|hsl|hsla)\(([^\)]+)\)/g,function(e,n,t){var r=t.split(","),a="hsl"==n||"hsla"==n||r[0].indexOf("%")>-1;return a?(-1==r[1].indexOf("%")&&(r[1]+="%"),-1==r[2].indexOf("%")&&(r[2]+="%"),n+"("+r.join(",")+")"):e}),d(/outline:none/g,"outline:0"),d(/background:(?:none|transparent)([;}])/g,"background:0 0$1"),d(/box-shadow:0 0 0 0([^\.])/g,"box-shadow:0 0$1"),d(/:0 0 0 0([^\.])/g,":0$1"),d(/([: ,=\-])0\.(\d)/g,"$1.$2"),d(function(){e=new ShorthandNotations(e).process()}),d(/rect\(\s?0(\s|,)0[ ,]0[ ,]0\s?\)/g,"rect(0$10$10$10)"),d(/\*([\.#:\[])/g,"$1"),d(/calc\([^\}]+\}/g,function(e){return e.replace(/\+/g," + ")}),d(/(rgba|hsla)\(([^\)]+)\) /g,"$1($2)"),a.noAdvanced?a.keepBreaks&&d(/\}/g,"}"+s):d(function(){var n=["ie7","ie8"].indexOf(a.compatibility)>-1?a.compatibility:"*";e=new SelectorsOptimizer(e,i,{keepBreaks:a.keepBreaks,lineBreak:s,selectorsMergeMode:n,compatibility:a.compatibility}).process()}),d(function(){e=c.restore(e)}),d(function(){e=a.noRebase?e:new UrlRebase(a,i).process(e)}),d(function(){e=u.restore(e)}),d(function(){e=o.restore(e)}),d(function(){e=l.restore(e)}),d(function(){var n=e.match(/@charset [^;]+;/),t=n?n[0]:null;t&&(e=t+(a.keepBreaks?s:"")+e.replace(new RegExp("@charset [^;]+;("+s+")?","g"),"").trim())}),a.noAdvanced&&d(function(){e=new EmptyRemoval(e).process()}),e=e.trim(),a.debug){var m=process.hrtime(t);r.timeSpent=~~(1e3*m[0]+m[1]/1e6),r.efficiency=1-e.length/r.originalSize,r.minifiedSize=e.length}return n?n.call(this,this.context.errors.length>0?this.context.errors:null,e):e};