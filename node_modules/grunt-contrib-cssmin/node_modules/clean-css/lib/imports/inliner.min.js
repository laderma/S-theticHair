var fs=require("fs"),path=require("path"),http=require("http"),https=require("https"),url=require("url"),UrlRewriter=require("../images/url-rewriter"),merge=function(e,n){var t={};for(var r in e)t[r]=e[r];for(var a in n)t[a]=n[a];return t};module.exports=function(e,n){var t={timeout:5e3,request:{}},r=merge(t,n||{}),a=function(e,n){n._shared=n._shared||{done:[],left:[]};var t=n._shared,r=0,a=0,l=0,c=o(e),f=s(e);for(n.relativeTo=n.relativeTo||n.root,n._baseRelativeTo=n._baseRelativeTo||n.relativeTo,n.visited=n.visited||[];a<e.length&&(r=e.indexOf("@import",l),-1!=r);){if(!c(r)){if(a=e.indexOf(";",r),-1==a){l=e.length,e="";break}return t.done.push(e.substring(0,r)),t.left.unshift([e.substring(a+1),n]),f(r)?i(n):u(e,r,a,n)}l=r+1}return t.done.push(e),i(n)},i=function(e){return e._shared.left.length>0?a.apply(null,e._shared.left.shift()):e.whenDone(e._shared.done.join(""))},o=function(e){var n=/(\/\*(?!\*\/)[\s\S]*?\*\/)/,t=0,r=0,a=!1,i=function(o){var s,u=0,l=0,c=0,f=0;return a?!1:o>t&&r>o?!0:(s=e.match(n))?(t=u=s.index,l=u+s[0].length,f=l+r,c=f-s[0].length,e=e.substring(l),r=f,o>f?i(o):f>o&&o>c):(a=!0,!1)};return i},s=function(e){for(var n=o(e),t=-1;;)if(t=e.indexOf("{",t+1),-1==t||!n(t))break;return function(e){return t>-1?e>t:!1}},u=function(n,t,r,a){var o=n.substring(n.indexOf(" ",t)+1,r).trim(),s=0===o.indexOf("url("),u=s?4:0,d=/^['"]/.exec(o.substring(u,u+2)),h=d?o.indexOf(d[0],u+1):o.split(" ")[0].length,p=o.substring(u,h).replace(/['"]/g,"").replace(/\)$/,"").trim(),m=o.substring(h+1).replace(/^\)/,"").trim(),g=a.isRemote||/^(http|https):\/\//.test(p)||/^\/\//.test(p);if(a.localOnly&&g)return e.warnings.push('Ignoring remote @import declaration of "'+p+'" as no callback given.'),f(p,m,a),i(a);var v=g?l:c;return v(p,m,a)},l=function(n,t,o){var s=/^https?:\/\//.test(n)?n:url.resolve(o.relativeTo,n);if(0===s.indexOf("//")&&(s="http:"+s),o.visited.indexOf(s)>-1)return i(o);e.debug&&console.error("Inlining remote stylesheet: "+s),o.visited.push(s);var u=0===s.indexOf("http://")?http.get:https.get,c=!1,d=function(n){e.errors.push('Broken @import declaration of "'+s+'" - '+n),f(s,t,o),i(o)},h=merge(url.parse(s),r.request);u(h,function(e){if(e.statusCode<200||e.statusCode>399)return d("error "+e.statusCode);if(e.statusCode>299){var n=url.resolve(s,e.headers.location);return l(n,t,o)}var r=[],i=url.parse(s);e.on("data",function(e){r.push(e.toString())}),e.on("end",function(){var e=r.join("");e=UrlRewriter.process(e,{toBase:s}),t.length>0&&(e="@media "+t+"{"+e+"}"),a(e,{isRemote:!0,relativeTo:i.protocol+"//"+i.host,_shared:o._shared,whenDone:o.whenDone,visited:o.visited})})}).on("error",function(e){d(e.message)}).on("timeout",function(){c||(d("timeout"),c=!0)}).setTimeout(r.timeout)},c=function(n,t,r){var o="/"==n[0]?r.root:r.relativeTo,s=path.resolve(path.join(o,n));if(!fs.existsSync(s)||!fs.statSync(s).isFile())return e.errors.push('Broken @import declaration of "'+n+'"'),i(r);if(r.visited.indexOf(s)>-1)return i(r);e.debug&&console.error("Inlining local stylesheet: "+s),r.visited.push(s);var u=fs.readFileSync(s,"utf8"),l=path.dirname(s);return u=UrlRewriter.process(u,{relative:!0,fromBase:l,toBase:r._baseRelativeTo}),t.length>0&&(u="@media "+t+"{"+u+"}"),a(u,{root:r.root,relativeTo:l,_baseRelativeTo:r._baseRelativeTo,_shared:r._shared,visited:r.visited,whenDone:r.whenDone,localOnly:r.localOnly})},f=function(e,n,t){var r="@import url("+e+")"+(n.length>0?" "+n:"")+";";t._shared.done.push(r)};return{process:a}};