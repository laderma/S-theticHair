var Tokenizer=require("./tokenizer"),PropertyOptimizer=require("../properties/optimizer");module.exports=function(e,n,t){var r={"*":/\-(moz|ms|o|webkit)\-/,ie8:/(\-moz\-|\-ms\-|\-o\-|\-webkit\-|:root|:nth|:first\-of|:last|:only|:empty|:target|:checked|::selection|:enabled|:disabled|:not)/,ie7:/(\-moz\-|\-ms\-|\-o\-|\-webkit\-|:focus|:before|:after|:root|:nth|:first\-of|:last|:only|:empty|:target|:checked|::selection|:enabled|:disabled|:not)/},a=[],i=new PropertyOptimizer(t.compatibility),o=function(e){if(-1==e.indexOf(","))return e;for(var n=[],t=0,r=0,a=-1==e.indexOf("("),i=function(n){if(a)return!1;var t=e.lastIndexOf("(",n),r=e.lastIndexOf(")",n);return-1==t?!1:r>0&&n>r?!1:!0};;){var s,o=e.indexOf(",",t+1);if(-1===o)o=e.length;else if(i(o)){t=o+1;continue}if(s=e.substring(r,o),r=t=o+1,-1==n.indexOf(s)&&n.push(s),o===e.length)break}return n.sort().join(",")},s=function(e){return r[t.selectorsMergeMode||"*"].test(e)},u=function(e){for(var n={},t=[],r=0,i=e.length;i>r;r++){var o=e[r];if("string"!=typeof o&&!o.block){var s=o.body+"@"+o.selector,u=n[s];u?(t.push(u[0]),u.unshift(r)):n[s]=[r]}}t=t.sort(function(e,n){return e>n?1:-1});for(var l=0,c=t.length;c>l;l++)e.splice(t[l]-l,1);a.unshift(t.length>0)},l=function(e){for(var n=[],t={selector:null,body:null},r=0,u=e.length;u>r;r++){var l=e[r];if("string"!=typeof l&&!l.block)if(l.selector==t.selector){var c=[t.body.split(";").length];t.body=i.process(t.body+";"+l.body,c),n.push(r)}else l.body!=t.body||s(l.selector)||s(t.selector)?t=l:(t.selector=o(t.selector+","+l.selector),n.push(r))}for(var f=0,d=n.length;d>f;f++)e.splice(n[f]-f,1);a.unshift(n.length>0)},c=function(e){for(var u,l,c,n={},t=[],r=[],o=!1,f=0,d=e.length;d>f;f++)if(u=e[f],l=u.selector,"string"!=typeof u&&!u.block){c=l.indexOf(",")>0&&!s(l)?l.split(",").concat(l):[l];for(var h=0,p=c.length;p>h;h++){var m=c[h],g=n[m];g?(1==g.length&&t.push(m),g.push(f)):n[m]=[f]}}for(t.forEach(function(t){var c,a=n[t],s=[],u=[],l=[];for(c=0,p=a.length;p>c;c++){var f=e[a[c]].body,d=f.split(";");s.push(f),u.push(d),l.push((l[c-1]||0)+d.length)}var h=i.process(s.join(";"),l),m=h.split(";");c=m.length-1;for(var g=a.length-1;g>=0;)if(u[g].indexOf(m[c])>-1&&c>-1)c--;else{for(var v=a[g],b=e[v],_=m.splice(c+1),y=[],k=0,w=_.length;w>k;k++)_[k].length>0&&y.push(_[k]);if(b.selector==t){var S=y.join(";");o=o||b.body!=S,b.body=S}else b._partials=b._partials||[],b._partials.push(y.join(";")),-1==r.indexOf(v)&&r.push(v);g-=1}}),f=0,d=r.length;d>f;f++){if(u=e[r[f]],u.body!=u._partials[0]&&u._partials.length==u.selector.split(",").length){for(var v=u._partials[0],b=1,_=u._partials.length;_>b&&u._partials[b]==v;b++);b==_&&(u.body=v,o=o||!0)}delete u._partials}a.unshift(o)},f=function(e){var n=function(){return a.length>4&&a[0]===!1&&a[1]===!1};e=Array.isArray(e)?e:[e];for(var t=0,r=e.length;r>t;t++){var s=e[t];s.selector?(s.selector=o(s.selector),s.body=i.process(s.body,!1)):s.block&&f(s.body)}for(a=[];;){if(n())break;if(u(e),n())break;if(l(e),n())break;c(e)}},d=function(e){var n=[];e=Array.isArray(e)?e:[e];for(var r=0,a=e.length;a>r;r++){var i=e[r];if("string"!=typeof i){var o=i.block||i.selector,s=i.block?d(i.body):i.body;s.length>0&&n.push(o+"{"+s+"}")}else n.push(i)}return n.join(t.keepBreaks?t.lineBreak:"")};return{process:function(){var t=new Tokenizer(e,n).process();return f(t),d(t)}}};