"use strict";var lpad=require("lpad"),async=require("async"),cpCache=[];module.exports=function(n){n.registerMultiTask("concurrent","Run grunt tasks concurrently",function(){var e,t=this.async(),r=this.options({limit:Math.max(require("os").cpus().length,2)}),a=this.data.tasks||this.data;r.limit<a.length&&n.log.oklns("Warning: There are more tasks than your concurrency limit. After this limit is reached no further tasks will be run until the current tasks are completed. You can adjust the limit in the concurrent task options"),r.logConcurrentOutput&&(e={stdio:"inherit"}),lpad.stdout("    "),async.eachLimit(a,r.limit,function(t,r){var a=n.util.spawn({grunt:!0,args:[t].concat(n.option.flags()),opts:e},function(e,t,a){(e||a>0)&&n.warn(t.stderr||t.stdout),n.log.writeln("\n"+t.stdout),r()});cpCache.push(a)},function(){lpad.stdout(),t()})})},process.on("exit",function(){cpCache.forEach(function(n){n.kill()})});