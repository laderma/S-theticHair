"use strict";var util=require("util"),inspect=function(n){return util.inspect(n,!1,4,!0)},getFlowFromConfig=function(n,e){var t=require("../lib/flow"),r=new t({steps:{js:["concat","uglifyjs"],css:["concat","cssmin"]},post:{}});return n.options&&n.options.flow&&(n.options.flow[e]?(r.setSteps(n.options.flow[e].steps),r.setPost(n.options.flow[e].post)):(r.setSteps(n.options.flow.steps),r.setPost(n.options.flow.post))),r},getLocator=function(n,e){var t;return t=e.revmap?n.file.readJSON(e.revmap):n.filerev&&n.filerev.summary?n.filerev.summary:function(e){return n.file.expand({filter:"isFile"},e)}};module.exports=function(n){var e=require("../lib/fileprocessor"),t=require("../lib/revvedfinder"),r=require("../lib/configwriter"),a=n.util._;n.registerMultiTask("usemin","Replaces references to non-minified scripts / stylesheets",function(){var r=require("debug")("usemin:usemin"),a=this.options({type:this.target});r("Looking at %s target",this.target);var i;a.patterns&&a.patterns[this.target]?(r("Using user defined pattern for %s",this.target),i=a.patterns[this.target]):(r("Using predefined pattern for %s",this.target),i=a.type);var s=getLocator(n,a),o=new t(s),l=new e(i,o,function(e){n.log.writeln(e)});this.files.forEach(function(e){var t=n.file.expand({nonull:!0},e.src);t.forEach(function(e){r("looking at file %s",e),n.log.subhead("Processing as "+a.type.toUpperCase()+" - "+e);var t=l.process(e,a.assetsDirs);n.file.write(e,t)})})}),n.registerMultiTask("useminPrepare","Using HTML markup as the primary source of information",function(){var e=this.options(),t=e.dest||"dist",i=e.staging||".tmp",s=e.root;n.log.writeln("Going through "+n.log.wordlist(this.filesSrc)+" to update the config").writeln("Looking for build script HTML comment blocks");var o=getFlowFromConfig(n.config("useminPrepare"),this.target),l=new r(o,{root:s,dest:t,staging:i}),u=[];l.stepWriters().forEach(function(n){u.push(n.name)}),l.postWriters().forEach(function(n){u.push(n.name)});var c={};a.each(u,function(e){c[e]=n.config(e)||{}}),this.filesSrc.forEach(function(e){var t;try{t=l.process(e,n.config())}catch(r){n.fail.fatal(r)}a.each(u,function(e){c[e]=n.config(e)||{},n.config(e,a.extend(c[e],t[e]))})}),n.log.subhead("Configuration is now:"),a.each(u,function(e){n.log.subhead("  "+e+":").writeln("  "+inspect(n.config(e)))})})};