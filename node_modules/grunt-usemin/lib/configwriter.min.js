"use strict";var path=require("path"),File=require("./file"),_=require("lodash"),deepMerge=function(n,e){var t=n;return n.files&&e.files?t.files=_.union(n.files,e.files):e.files&&(t.files=e.files),t},ConfigWriter=module.exports=function(n,e){var t=this;this.flow=n,this.root=e.root,this.dest=e.dest,this.staging=e.staging,this.steps={},this.postprocessors=[],n.blockTypes().forEach(function(e){t.steps[e]=[],t.postprocessors[e]=[],n.steps(e).forEach(function(n){var r;r="string"==typeof n||n instanceof String?require(path.join(__dirname,"config",n)):n,t.steps[e].push(r)}),n.post(e).forEach(function(n){var r;r="string"==typeof n||n instanceof String?require(path.join(__dirname,"config",n)):n,t.postprocessors[e].push(r)})})};ConfigWriter.prototype.stepWriters=function(n){var e;return e=n?this.steps[n]||[]:_.uniq(_.flatten(_.values(this.steps),!0))},ConfigWriter.prototype.postWriters=function(n){return this.postprocessors[n]||[]},ConfigWriter.prototype.forEachStep=function(n,e){var t=this.stepWriters(n).length;this.stepWriters(n).forEach(function(n,r){e(n,r===t-1)})},ConfigWriter.prototype.process=function(n,e){var t=this,r=n;return e=e||{},("string"==typeof n||n instanceof String)&&(r=new File(n)),r.blocks.forEach(function(n){var a={inDir:t.root||r.searchPath[0],inFiles:n.src,outFiles:[]};n.searchPath.length>0&&(a.inDir=n.searchPath[0]),t.forEachStep(n.type,function(r,i){a.outDir=i?t.dest:path.join(t.staging,r.name),a.last=i,e[r.name]=e[r.name]||{},e[r.name].generated=e[r.name].generated||{},a.options=e[r.name],e[r.name].generated=deepMerge(e[r.name].generated,r.createConfig(a,n)),a.inDir=a.outDir,a.inFiles=a.outFiles,a.outFiles=[],a.options=null}),a.inDir=r.searchPath[0],n.searchPath.length>0&&(a.inDir=n.searchPath[0]),a.inFiles=n.src,t.postprocessors.forEach(function(t){e[t.name]=e[t.name]||{},a.options=e[t.name],e[t.name]=_.extend(e[t.name],t.createConfig(a,n)),a.options=null})}),e};