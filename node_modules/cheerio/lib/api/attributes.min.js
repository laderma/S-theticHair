var _=require("lodash"),utils=require("../utils"),isTag=utils.isTag,domEach=utils.domEach,hasOwn=Object.prototype.hasOwnProperty,camelCase=utils.camelCase,cssCase=utils.cssCase,rspace=/\s+/,dataAttrPrefix="data-",primitives={"null":null,"true":!0,"false":!1},rboolean=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,getAttr=function(e,n){return e&&isTag(e)?(e.attribs||(e.attribs={}),n?hasOwn.call(e.attribs,n)?rboolean.test(n)?n:e.attribs[n]:void 0:e.attribs):void 0},setAttr=function(e,n,t){null===t?removeAttribute(e,n):e.attribs[n]=t+""};exports.attr=function(e,n){return"object"==typeof e||void 0!==n?"function"==typeof n?domEach(this,function(t,r){setAttr(r,e,n.call(r,t,r.attribs[e]))}):domEach(this,function(t,r){isTag(r)&&("object"==typeof e?_.each(e,function(e,n){r.attribs[n]=e+""}):setAttr(r,e,n))}):getAttr(this[0],e)};var setData=function(e,n,t){return"object"==typeof n?_.extend(e.data,n):void("string"==typeof n&&void 0!==t?e.data[n]=t:"object"==typeof n&&_.exend(e.data,n))},readData=function(e,n){var r,a,i,s,o,l,u,t=1===arguments.length;for(t?(r=Object.keys(e.attribs).filter(function(e){return e.slice(0,dataAttrPrefix.length)===dataAttrPrefix}),i=r.map(function(e){return camelCase(e.slice(dataAttrPrefix.length))})):(r=[dataAttrPrefix+cssCase(n)],i=[n]),l=0,u=r.length;u>l;++l)a=r[l],s=i[l],hasOwn.call(e.attribs,a)&&(o=e.attribs[a],hasOwn.call(primitives,o)?o=primitives[o]:o===String(Number(o))?o=Number(o):rbrace.test(o)&&(o=JSON.parse(o)),e.data[s]=o);return t?e.data:o};exports.data=function(e,n){var t=this[0];if(t&&isTag(t))return t.data||(t.data={}),e?"object"==typeof e||void 0!==n?(domEach(this,function(t,r){setData(r,e,n)}),this):hasOwn.call(t.data,e)?t.data[e]:readData(t,e):readData(t)},exports.val=function(e){var n=0===arguments.length,t=this[0];if(t)switch(t.name){case"textarea":return this.text(e);case"input":switch(this.attr("type")){case"radio":var a,i,r='input[type=radio][name="'+this.attr("name")+'"]:checked';return a=this.closest("form"),0===a.length&&(i=(this.parents().last()[0]||this[0]).root,a=this._make(i)),n?a.find(r).attr("value"):(a.find(":checked").removeAttr("checked"),a.find('input[type=radio][value="'+e+'"]').attr("checked",""),this);default:return this.attr("value",e)}return;case"select":var o,s=this.find("option:selected");if(void 0===s)return void 0;if(!n){if(!this.attr().hasOwnProperty("multiple")&&"object"==typeof e)return this;"object"!=typeof e&&(e=[e]),this.find("option").removeAttr("selected");for(var l=0;l<e.length;l++)this.find('option[value="'+e[l]+'"]').attr("selected","");return this}return o=s.attr("value"),this.attr().hasOwnProperty("multiple")&&(o=[],domEach(s,function(e,n){o.push(n.attribs.value)})),o;case"option":return n?this.attr("value"):(this.attr("value",e),this)}};var removeAttribute=function(e,n){e.attribs&&hasOwn.call(e.attribs,n)&&delete e.attribs[n]};exports.removeAttr=function(e){return domEach(this,function(n,t){removeAttribute(t,e)}),this},exports.hasClass=function(e){return _.any(this,function(n){var i,t=n.attribs,r=t&&t["class"],a=-1;if(r)for(;(a=r.indexOf(e,a+1))>-1;)if(i=a+e.length,(0===a||rspace.test(r[a-1]))&&(i===r.length||rspace.test(r[i])))return!0})},exports.addClass=function(e){if("function"==typeof e)return domEach(this,function(n,t){var r=t.attribs["class"]||"";exports.addClass.call([t],e.call(t,n,r))});if(!e||"string"!=typeof e)return this;for(var n=e.split(rspace),t=this.length,r=0;t>r;r++)if(isTag(this[r])){var i,s,a=getAttr(this[r],"class");if(a){s=" "+a+" ",i=n.length;for(var o=0;i>o;o++){var l=n[o]+" ";~s.indexOf(" "+l)||(s+=l)}setAttr(this[r],"class",s.trim())}else setAttr(this[r],"class",n.join(" ").trim())}return this};var splitClass=function(e){return e?e.trim().split(rspace):[]};exports.removeClass=function(e){var n,t,r;return"function"==typeof e?domEach(this,function(n,t){exports.removeClass.call([t],e.call(t,n,t.attribs["class"]||""))}):(n=splitClass(e),t=n.length,r=0===arguments.length,domEach(this,function(e,a){if(isTag(a))if(r)a.attribs["class"]="";else{for(var s,o,i=splitClass(a.attribs["class"]),l=0;t>l;l++)s=i.indexOf(n[l]),s>=0&&(i.splice(s,1),o=!0,l--);o&&(a.attribs["class"]=i.join(" "))}}))},exports.toggleClass=function(e,n){if("function"==typeof e)return domEach(this,function(t,r){exports.toggleClass.call([r],e.call(r,t,r.attribs["class"]||"",n),n)});if(!e||"string"!=typeof e)return this;for(var s,o,t=e.split(rspace),r=t.length,a="boolean"==typeof n?n?1:-1:0,i=this.length,l=0;i>l;l++)if(isTag(this[l])){s=splitClass(this[l].attribs["class"]);for(var u=0;r>u;u++)o=s.indexOf(t[u]),a>=0&&0>o?s.push(t[u]):0>=a&&o>=0&&s.splice(o,1);this[l].attribs["class"]=s.join(" ")}return this},exports.is=function(e){return e?this.filter(e).length>0:!1};