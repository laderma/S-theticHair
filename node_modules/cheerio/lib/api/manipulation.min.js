var _=require("lodash"),parse=require("../parse"),$=require("../static"),updateDOM=parse.update,evaluate=parse.evaluate,utils=require("../utils"),domEach=utils.domEach,slice=Array.prototype.slice;exports._makeDomArray=function e(n){return null==n?[]:n.cheerio?n.get():Array.isArray(n)?_.flatten(n.map(e,this)):"string"==typeof n?evaluate(n,this.options):[n]};var _insert=function(e){return function(){var n=this,t=slice.call(arguments),r=this._makeDomArray(t);return"function"==typeof t[0]?domEach(this,function(a,i){r=n._makeDomArray(t[0].call(i,a,$.html(i.children))),e(r,i.children,i)}):domEach(this,function(n,t){e(r,t.children,t)})}},uniqueSplice=function(e,n,t,r,a){var l,u,c,d,h,i=[n,t].concat(r),s=e[n-1]||null,o=e[n]||null;for(l=0,u=r.length;u>l;++l)d=r[l],h=d.parent||d.root,c=h&&h.children.indexOf(r[l]),h&&c>-1&&(h.children.splice(c,1),a===h&&n>c&&i[0]--),d.root=null,d.parent=a,d.prev&&(d.prev.next=d.next||null),d.next&&(d.next.prev=d.prev||null),d.prev=r[l-1]||s,d.next=r[l+1]||o;return s&&(s.next=r[0]),o&&(o.prev=r[r.length-1]),e.splice.apply(e,i)};exports.append=_insert(function(e,n,t){uniqueSplice(n,n.length,0,e,t)}),exports.prepend=_insert(function(e,n,t){uniqueSplice(n,0,0,e,t)}),exports.after=function(){var e=slice.call(arguments),n=this._makeDomArray(e),t=this;return domEach(this,function(r,a){var i=a.parent||a.root;if(i){var s=i.children,o=s.indexOf(a);~o&&("function"==typeof e[0]&&(n=t._makeDomArray(e[0].call(a,r,$.html(a.children)))),uniqueSplice(s,++o,0,n,i))}}),this},exports.before=function(){var e=slice.call(arguments),n=this._makeDomArray(e),t=this;return domEach(this,function(r,a){var i=a.parent||a.root;if(i){var s=i.children,o=s.indexOf(a);~o&&("function"==typeof e[0]&&(n=t._makeDomArray(e[0].call(a,r,$.html(a.children)))),uniqueSplice(s,o,0,n,i))}}),this},exports.remove=function(e){var n=this;return e&&(n=n.filter(e)),domEach(n,function(e,n){var t=n.parent||n.root;if(t){var r=t.children,a=r.indexOf(n);~a&&(r.splice(a,1),n.prev&&(n.prev.next=n.next),n.next&&(n.next.prev=n.prev),n.prev=n.next=n.parent=n.root=null)}}),this},exports.replaceWith=function(e){var n=this;return domEach(this,function(t,r){var a=r.parent||r.root;if(a){var o,i=a.children,s=n._makeDomArray("function"==typeof e?e.call(r,t,r):e);updateDOM(s,null),o=i.indexOf(r),uniqueSplice(i,o,1,s,a),r.parent=r.prev=r.next=r.root=null}}),this},exports.empty=function(){return domEach(this,function(e,n){_.each(n.children,function(e){e.next=e.prev=e.parent=null}),n.children.length=0}),this},exports.html=function(e){if(void 0===e)return this[0]&&this[0].children?$.html(this[0].children,this.options):null;var n=this.options;return domEach(this,function(t,r){_.each(r.children,function(e){e.next=e.prev=e.parent=null});var a=e.cheerio?e.clone().get():evaluate(e,n);updateDOM(a,r)}),this},exports.toString=function(){return $.html(this)},exports.text=function(e){return void 0===e?$.text(this):"function"==typeof e?domEach(this,function(n,t){var r=[t];return exports.text.call(r,e.call(t,n,$.text(r)))}):(domEach(this,function(n,t){_.each(t.children,function(e){e.next=e.prev=e.parent=null});var r={data:e,type:"text",parent:t,prev:null,next:null,children:[]};updateDOM(r,t)}),this)},exports.clone=function(){return this._make($.html(this,this.options))};