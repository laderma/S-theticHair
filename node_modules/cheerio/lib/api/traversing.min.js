function traverseParents(e,n,t,r){for(var a=[];n&&a.length<r;)(!t||exports.filter.call([n],t,e).length)&&a.push(n),n=n.parent;return a}var _=require("lodash"),select=require("CSSselect"),utils=require("../utils"),domEach=utils.domEach,uniqueSort=require("htmlparser2").DomUtils.uniqueSort,isTag=utils.isTag;exports.find=function(e){var r,n=_.reduce(this,function(e,n){return e.concat(_.filter(n.children,isTag))},[]),t=this.constructor.contains;return e&&"string"!=typeof e?(r=e.cheerio?e.get():[e],this._make(r.filter(function(e){var n,r;for(n=0,r=this.length;r>n;++n)if(t(this[n],e))return!0},this))):this._make(select(e,n,this.options))},exports.parent=function(e){var n=[];return domEach(this,function(e,t){var r=t.parent;r&&n.indexOf(r)<0&&n.push(r)}),arguments.length&&(n=exports.filter.call(n,e,this)),this._make(n)},exports.parents=function(e){var n=[];return this.get().reverse().forEach(function(t){traverseParents(this,t.parent,e,1/0).forEach(function(e){-1===n.indexOf(e)&&n.push(e)})},this),this._make(n)},exports.parentsUntil=function(e,n){var r,a,t=[];return"string"==typeof e?r=select(e,this.parents().toArray(),this.options)[0]:e&&e.cheerio?a=e.toArray():e&&(r=e),this.toArray().reverse().forEach(function(e){for(;(e=e.parent)&&(r&&e!==r||a&&-1===a.indexOf(e)||!r&&!a);)isTag(e)&&-1===t.indexOf(e)&&t.push(e)},this),this._make(n?select(n,t,this.options):t)},exports.closest=function(e){var n=[];return e?(domEach(this,function(t,r){var a=traverseParents(this,r,e,1)[0];a&&n.indexOf(a)<0&&n.push(a)}.bind(this)),this._make(n)):this._make(n)},exports.next=function(e){if(!this[0])return this;var n=[];return _.forEach(this,function(e){for(;e=e.next;)if(isTag(e))return void n.push(e)}),e?exports.filter.call(n,e,this):this._make(n)},exports.nextAll=function(e){if(!this[0])return this;var n=[];return _.forEach(this,function(e){for(;e=e.next;)isTag(e)&&-1===n.indexOf(e)&&n.push(e)}),e?exports.filter.call(n,e,this):this._make(n)},exports.nextUntil=function(e,n){if(!this[0])return this;var r,a,t=[];return"string"==typeof e?r=select(e,this.nextAll().get(),this.options)[0]:e&&e.cheerio?a=e.get():e&&(r=e),_.forEach(this,function(e){for(;(e=e.next)&&(r&&e!==r||a&&-1===a.indexOf(e)||!r&&!a);)isTag(e)&&-1===t.indexOf(e)&&t.push(e)}),n?exports.filter.call(t,n,this):this._make(t)},exports.prev=function(e){if(!this[0])return this;var n=[];return _.forEach(this,function(e){for(;e=e.prev;)if(isTag(e))return void n.push(e)}),e?exports.filter.call(n,e,this):this._make(n)},exports.prevAll=function(e){if(!this[0])return this;var n=[];return _.forEach(this,function(e){for(;e=e.prev;)isTag(e)&&-1===n.indexOf(e)&&n.push(e)}),e?exports.filter.call(n,e,this):this._make(n)},exports.prevUntil=function(e,n){if(!this[0])return this;var r,a,t=[];return"string"==typeof e?r=select(e,this.prevAll().get(),this.options)[0]:e&&e.cheerio?a=e.get():e&&(r=e),_.forEach(this,function(e){for(;(e=e.prev)&&(r&&e!==r||a&&-1===a.indexOf(e)||!r&&!a);)isTag(e)&&-1===t.indexOf(e)&&t.push(e)}),n?exports.filter.call(t,n,this):this._make(t)},exports.siblings=function(e){var n=this.parent(),t=_.filter(n?n.children():this.siblingsAndMe(),function(e){return isTag(e)&&!this.is(e)},this);return void 0!==e?exports.filter.call(t,e,this):this._make(t)},exports.children=function(e){var n=_.reduce(this,function(e,n){return e.concat(_.filter(n.children,isTag))},[]);return void 0===e?this._make(n):"number"==typeof e?this._make(n[e]):exports.filter.call(n,e,this)},exports.contents=function(){return this._make(_.reduce(this,function(e,n){return e.push.apply(e,n.children),e},[]))},exports.each=function(e){for(var n=0,t=this.length;t>n&&e.call(this[n],n,this[n])!==!1;)++n;return this},exports.map=function(e){return this._make(_.reduce(this,function(n,t,r){var a=e.call(t,r,t);return null==a?n:n.concat(a)},[]))};var makeFilterMethod=function(e){return function(n,t){var r;return t=t||this,r="string"==typeof n?select.compile(n,t.options):"function"==typeof n?function(e,t){return n.call(e,t,e)}:n.cheerio?n.is.bind(n):function(e){return n===e},t._make(e(this,r))}};exports.filter=makeFilterMethod(_.filter),exports.not=makeFilterMethod(_.reject),exports.has=function(e){var n=this;return exports.filter.call(this,function(){return n._make(this).find(e).length>0})},exports.first=function(){return this.length>1?this._make(this[0]):this},exports.last=function(){return this.length>1?this._make(this[this.length-1]):this},exports.eq=function(e){return e=+e,0===e&&this.length<=1?this:(0>e&&(e=this.length+e),this[e]?this._make(this[e]):this._make([]))},exports.get=function(e){return null==e?Array.prototype.slice.call(this):this[0>e?this.length+e:e]},exports.index=function(e){var n,t;return 0===arguments.length?(n=this.parent().children(),t=this[0]):"string"==typeof e?(n=this._make(e),t=this[0]):(n=this,t=e.cheerio?e[0]:e),n.get().indexOf(t)},exports.slice=function(){return this._make([].slice.apply(this,arguments))},exports.end=function(){return this.prevObject||this._make([])},exports.add=function(e,n){for(var t=this._make(e,n),r=uniqueSort(t.get().concat(this.get())),a=0;a<r.length;++a)t[a]=r[a];return t.length=r.length,t},exports.addBack=function(e){return this.add(arguments.length?this.prevObject.filter(e):this.prevObject)};