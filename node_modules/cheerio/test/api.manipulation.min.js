var expect=require("expect.js"),cheerio=require(".."),fruits=require("./fixtures").fruits,toArray=Function.call.bind(Array.prototype.slice);describe("$(...)",function(){var n,e;beforeEach(function(){n=cheerio.load(fruits),e=n("#fruits")}),describe(".append",function(){it("() : should do nothing",function(){expect(n("#fruits").append()[0].tagName).to.equal("ul")}),it("(html) : should add element as last child",function(){e.append('<li class="plum">Plum</li>'),expect(e.children(3).hasClass("plum")).to.be.ok()}),it("($(...)) : should add element as last child",function(){var t=n('<li class="plum">Plum</li>');e.append(t),expect(e.children(3).hasClass("plum")).to.be.ok()}),it("(Node) : should add element as last child",function(){var t=n('<li class="plum">Plum</li>')[0];e.append(t),expect(e.children(3).hasClass("plum")).to.be.ok()}),it("(existing Node) : should remove node from previous location",function(){var t,n=e.children()[0];expect(e.children()).to.have.length(3),e.append(n),t=e.children(),expect(t).to.have.length(3),expect(t[0]).to.not.equal(n),expect(t[2]).to.equal(n)}),it("(existing Node) : should remove existing node from previous location",function(){var r,t=e.children()[0],a=n("<div></div>");expect(e.children()).to.have.length(3),a.append(t),r=e.children(),expect(r).to.have.length(2),expect(r[0]).to.not.equal(t),expect(a.children()).to.have.length(1),expect(a.children()[0]).to.equal(t)}),it("(existing Node) : should update original direct siblings",function(){n(".pear").append(n(".orange")),expect(n(".apple").next()[0]).to.be(n(".pear")[0]),expect(n(".pear").prev()[0]).to.be(n(".apple")[0])}),it("(elem) : should NOP if removed",function(){var t=n(".apple");t.remove(),e.append(t),expect(e.children(2).hasClass("apple")).to.be.ok()}),it("($(...), html) : should add multiple elements as last children",function(){var t=n('<li class="plum">Plum</li>'),r='<li class="grape">Grape</li>';e.append(t,r),expect(e.children(3).hasClass("plum")).to.be.ok(),expect(e.children(4).hasClass("grape")).to.be.ok()}),it("(Array) : should append all elements in the array",function(){var t=n('<li class="plum">Plum</li><li class="grape">Grape</li>').get();e.append(t),expect(e.children(3).hasClass("plum")).to.be.ok(),expect(e.children(4).hasClass("grape")).to.be.ok()}),it("(fn) : should invoke the callback with the correct arguments and context",function(){e=e.children();var n=[],t=[];e.append(function(){n.push(toArray(arguments)),t.push(this)}),expect(n).to.eql([[0,"Apple"],[1,"Orange"],[2,"Pear"]]),expect(t).to.eql([e[0],e[1],e[2]])}),it("(fn) : should add returned string as last child",function(){e=e.children();var n,t,r;e.append(function(){return'<div class="first">'}),n=e.eq(0),t=e.eq(1),r=e.eq(2),expect(n.find(".first")[0]).to.equal(n.contents()[1]),expect(t.find(".first")[0]).to.equal(t.contents()[1]),expect(r.find(".first")[0]).to.equal(r.contents()[1])}),it("(fn) : should add returned Cheerio object as last child",function(){var t,r,a;e=e.children(),e.append(function(){return n('<div class="second">')}),t=e.eq(0),r=e.eq(1),a=e.eq(2),expect(t.find(".second")[0]).to.equal(t.contents()[1]),expect(r.find(".second")[0]).to.equal(r.contents()[1]),expect(a.find(".second")[0]).to.equal(a.contents()[1])}),it("(fn) : should add returned Node as last child",function(){var t,r,a;e=e.children(),e.append(function(){return n('<div class="third">')[0]}),t=e.eq(0),r=e.eq(1),a=e.eq(2),expect(t.find(".third")[0]).to.equal(t.contents()[1]),expect(r.find(".third")[0]).to.equal(r.contents()[1]),expect(a.find(".third")[0]).to.equal(a.contents()[1])}),it("should maintain correct object state (Issue: #10)",function(){var e=n("<div></div>").append("<div><div></div></div>").children().children().parent();expect(e).to.be.ok()}),it("($(...)) : should remove from root element",function(){var t=n('<li class="plum">Plum</li>'),r=t[0].root;expect(r).to.be.ok(),e.append(t),expect(t[0].root).to.not.be.ok(),expect(r.childNodes).to.not.contain(t[0])})}),describe(".prepend",function(){it("() : should do nothing",function(){expect(n("#fruits").prepend()[0].tagName).to.equal("ul")}),it("(html) : should add element as first child",function(){e.prepend('<li class="plum">Plum</li>'),expect(e.children(0).hasClass("plum")).to.be.ok()}),it("($(...)) : should add element as first child",function(){var t=n('<li class="plum">Plum</li>');e.prepend(t),expect(e.children(0).hasClass("plum")).to.be.ok()}),it("(Node) : should add node as first child",function(){var t=n('<li class="plum">Plum</li>')[0];e.prepend(t),expect(e.children(0).hasClass("plum")).to.be.ok()}),it("(existing Node) : should remove existing nodes from previous locations",function(){var t,n=e.children()[2];expect(e.children()).to.have.length(3),e.prepend(n),t=e.children(),expect(t).to.have.length(3),expect(t[2]).to.not.equal(n),expect(t[0]).to.equal(n)}),it("(existing Node) : should update original direct siblings",function(){n(".pear").prepend(n(".orange")),expect(n(".apple").next()[0]).to.be(n(".pear")[0]),expect(n(".pear").prev()[0]).to.be(n(".apple")[0])}),it("(elem) : should handle if removed",function(){var t=n(".apple");t.remove(),e.prepend(t),expect(e.children(0).hasClass("apple")).to.be.ok()}),it("(Array) : should add all elements in the array as inital children",function(){var t=n('<li class="plum">Plum</li><li class="grape">Grape</li>').get();e.prepend(t),expect(e.children(0).hasClass("plum")).to.be.ok(),expect(e.children(1).hasClass("grape")).to.be.ok()}),it("(html, $(...), html) : should add multiple elements as first children",function(){var t=n('<li class="plum">Plum</li>'),r='<li class="grape">Grape</li>';e.prepend(t,r),expect(e.children(0).hasClass("plum")).to.be.ok(),expect(e.children(1).hasClass("grape")).to.be.ok()}),it("(fn) : should invoke the callback with the correct arguments and context",function(){var n=[],t=[];e=e.children(),e.prepend(function(){n.push(toArray(arguments)),t.push(this)}),expect(n).to.eql([[0,"Apple"],[1,"Orange"],[2,"Pear"]]),expect(t).to.eql([e[0],e[1],e[2]])}),it("(fn) : should add returned string as first child",function(){var n,t,r;e=e.children(),e.prepend(function(){return'<div class="first">'}),n=e.eq(0),t=e.eq(1),r=e.eq(2),expect(n.find(".first")[0]).to.equal(n.contents()[0]),expect(t.find(".first")[0]).to.equal(t.contents()[0]),expect(r.find(".first")[0]).to.equal(r.contents()[0])}),it("(fn) : should add returned Cheerio object as first child",function(){var t,r,a;e=e.children(),e.prepend(function(){return n('<div class="second">')}),t=e.eq(0),r=e.eq(1),a=e.eq(2),expect(t.find(".second")[0]).to.equal(t.contents()[0]),expect(r.find(".second")[0]).to.equal(r.contents()[0]),expect(a.find(".second")[0]).to.equal(a.contents()[0])}),it("(fn) : should add returned Node as first child",function(){var t,r,a;e=e.children(),e.prepend(function(){return n('<div class="third">')[0]}),t=e.eq(0),r=e.eq(1),a=e.eq(2),expect(t.find(".third")[0]).to.equal(t.contents()[0]),expect(r.find(".third")[0]).to.equal(r.contents()[0]),expect(a.find(".third")[0]).to.equal(a.contents()[0])}),it("($(...)) : should remove from root element",function(){var t=n('<li class="plum">Plum</li>'),r=t[0].root;expect(r).to.be.ok(),e.prepend(t),expect(t[0].root).to.not.be.ok(),expect(r.childNodes).to.not.contain(t[0])})}),describe(".after",function(){it("() : should do nothing",function(){expect(n("#fruits").after()[0].tagName).to.equal("ul")}),it("(html) : should add element as next sibling",function(){var e='<li class="grape">Grape</li>';n(".apple").after(e),expect(n(".apple").next().hasClass("grape")).to.be.ok()}),it("(Array) : should add all elements in the array as next sibling",function(){var t=n('<li class="plum">Plum</li><li class="grape">Grape</li>').get();n(".apple").after(t),expect(e.children(1).hasClass("plum")).to.be.ok(),expect(e.children(2).hasClass("grape")).to.be.ok()}),it("($(...)) : should add element as next sibling",function(){var e=n('<li class="plum">Plum</li>');n(".apple").after(e),expect(n(".apple").next().hasClass("plum")).to.be.ok()}),it("(Node) : should add element as next sibling",function(){var e=n('<li class="plum">Plum</li>')[0];n(".apple").after(e),expect(n(".apple").next().hasClass("plum")).to.be.ok()}),it("(existing Node) : should remove existing nodes from previous locations",function(){var r,t=e.children()[2];n(".apple").after(t),r=e.children(),expect(r).to.have.length(3),expect(r[1]).to.be(t)}),it("(existing Node) : should update original direct siblings",function(){n(".pear").after(n(".orange")),expect(n(".apple").next()[0]).to.be(n(".pear")[0]),expect(n(".pear").prev()[0]).to.be(n(".apple")[0])}),it("(elem) : should handle if removed",function(){var e=n(".apple"),t=n('<li class="plum">Plum</li>');e.remove(),e.after(t),expect(t.prev()).to.be.empty()}),it("($(...), html) : should add multiple elements as next siblings",function(){var e=n('<li class="plum">Plum</li>'),t='<li class="grape">Grape</li>';n(".apple").after(e,t),expect(n(".apple").next().hasClass("plum")).to.be.ok(),expect(n(".plum").next().hasClass("grape")).to.be.ok()}),it("(fn) : should invoke the callback with the correct arguments and context",function(){var n=[],t=[];e=e.children(),e.after(function(){n.push(toArray(arguments)),t.push(this)}),expect(n).to.eql([[0,"Apple"],[1,"Orange"],[2,"Pear"]]),expect(t).to.eql([e[0],e[1],e[2]])}),it("(fn) : should add returned string as next sibling",function(){e=e.children(),e.after(function(){return'<li class="first">'}),expect(n(".first")[0]).to.equal(n("#fruits").contents()[1]),expect(n(".first")[1]).to.equal(n("#fruits").contents()[3]),expect(n(".first")[2]).to.equal(n("#fruits").contents()[5])}),it("(fn) : should add returned Cheerio object as next sibling",function(){e=e.children(),e.after(function(){return n('<li class="second">')}),expect(n(".second")[0]).to.equal(n("#fruits").contents()[1]),expect(n(".second")[1]).to.equal(n("#fruits").contents()[3]),expect(n(".second")[2]).to.equal(n("#fruits").contents()[5])}),it("(fn) : should add returned element as next sibling",function(){e=e.children(),e.after(function(){return n('<li class="third">')[0]}),expect(n(".third")[0]).to.equal(n("#fruits").contents()[1]),expect(n(".third")[1]).to.equal(n("#fruits").contents()[3]),expect(n(".third")[2]).to.equal(n("#fruits").contents()[5])}),it("($(...)) : should remove from root element",function(){var t=n('<li class="plum">Plum</li>'),r=t[0].root;expect(r).to.be.ok(),e.after(t),expect(t[0].root).to.not.be.ok(),expect(r.childNodes).to.not.contain(t[0])})}),describe(".before",function(){it("() : should do nothing",function(){expect(n("#fruits").before()[0].tagName).to.equal("ul")}),it("(html) : should add element as previous sibling",function(){var e='<li class="grape">Grape</li>';n(".apple").before(e),expect(n(".apple").prev().hasClass("grape")).to.be.ok()}),it("($(...)) : should add element as previous sibling",function(){var e=n('<li class="plum">Plum</li>');n(".apple").before(e),expect(n(".apple").prev().hasClass("plum")).to.be.ok()}),it("(Node) : should add element as previous sibling",function(){var e=n('<li class="plum">Plum</li>');n(".apple").before(e),expect(n(".apple").prev().hasClass("plum")).to.be.ok()}),it("(existing Node) : should remove existing nodes from previous locations",function(){var r,t=e.children()[2];n(".apple").before(t),r=e.children(),expect(r).to.have.length(3),expect(r[0]).to.be(t)}),it("(existing Node) : should update original direct siblings",function(){n(".apple").before(n(".orange")),expect(n(".apple").next()[0]).to.be(n(".pear")[0]),expect(n(".pear").prev()[0]).to.be(n(".apple")[0])}),it("(elem) : should handle if removed",function(){var e=n(".apple"),t=n('<li class="plum">Plum</li>');e.remove(),e.before(t),expect(t.next()).to.be.empty()}),it("(Array) : should add all elements in the array as previous sibling",function(){var t=n('<li class="plum">Plum</li><li class="grape">Grape</li>').get();n(".apple").before(t),expect(e.children(0).hasClass("plum")).to.be.ok(),expect(e.children(1).hasClass("grape")).to.be.ok()}),it("($(...), html) : should add multiple elements as previous siblings",function(){var e=n('<li class="plum">Plum</li>'),t='<li class="grape">Grape</li>';n(".apple").before(e,t),expect(n(".apple").prev().hasClass("grape")).to.be.ok(),expect(n(".grape").prev().hasClass("plum")).to.be.ok()}),it("(fn) : should invoke the callback with the correct arguments and context",function(){var n=[],t=[];e=e.children(),e.before(function(){n.push(toArray(arguments)),t.push(this)}),expect(n).to.eql([[0,"Apple"],[1,"Orange"],[2,"Pear"]]),expect(t).to.eql([e[0],e[1],e[2]])}),it("(fn) : should add returned string as previous sibling",function(){e=e.children(),e.before(function(){return'<li class="first">'}),expect(n(".first")[0]).to.equal(n("#fruits").contents()[0]),expect(n(".first")[1]).to.equal(n("#fruits").contents()[2]),expect(n(".first")[2]).to.equal(n("#fruits").contents()[4])}),it("(fn) : should add returned Cheerio object as previous sibling",function(){e=e.children(),e.before(function(){return n('<li class="second">')}),expect(n(".second")[0]).to.equal(n("#fruits").contents()[0]),expect(n(".second")[1]).to.equal(n("#fruits").contents()[2]),expect(n(".second")[2]).to.equal(n("#fruits").contents()[4])}),it("(fn) : should add returned Node as previous sibling",function(){e=e.children(),e.before(function(){return n('<li class="third">')[0]}),expect(n(".third")[0]).to.equal(n("#fruits").contents()[0]),expect(n(".third")[1]).to.equal(n("#fruits").contents()[2]),expect(n(".third")[2]).to.equal(n("#fruits").contents()[4])}),it("($(...)) : should remove from root element",function(){var t=n('<li class="plum">Plum</li>'),r=t[0].root;expect(r).to.be.ok(),e.before(t),expect(t[0].root).to.not.be.ok(),expect(r.childNodes).to.not.contain(t[0])})}),describe(".remove",function(){it("() : should remove selected elements",function(){n(".apple").remove(),expect(e.find(".apple")).to.have.length(0)}),it("() : should be reentrant",function(){var t=n(".apple");t.remove(),t.remove(),expect(e.find(".apple")).to.have.length(0)}),it("(selector) : should remove matching selected elements",function(){n("li").remove(".apple"),expect(e.find(".apple")).to.have.length(0)}),it("($(...)) : should remove from root element",function(){var e=n('<li class="plum">Plum</li>'),t=e[0].root;expect(t).to.be.ok(),e.remove(),expect(e[0].root).to.not.be.ok(),expect(t.childNodes).to.not.contain(e[0])})}),describe(".replaceWith",function(){it("(elem) : should replace one <li> tag with another",function(){var e=n('<li class="plum">Plum</li>');n(".pear").replaceWith(e),expect(n(".orange").next().hasClass("plum")).to.be.ok(),expect(n(".orange").next().html()).to.equal("Plum")}),it("(Array) : should replace one <li> tag with the elements in the array",function(){var t=n('<li class="plum">Plum</li><li class="grape">Grape</li>').get();n(".pear").replaceWith(t),expect(e.children(2).hasClass("plum")).to.be.ok(),expect(e.children(3).hasClass("grape")).to.be.ok(),expect(e.children()).to.have.length(4)}),it("(Node) : should replace the selected element with given node",function(){var e=n("<h2>hi <span>there</span></h2>"),t=n("<ul></ul>"),r=e.find("span").replaceWith(t[0]);expect(t[0].parentNode).to.equal(e[0]),expect(r[0].parentNode).to.equal(null),expect(n.html(e)).to.equal("<h2>hi <ul></ul></h2>")}),it("(existing element) : should remove element from its previous location",function(){n(".pear").replaceWith(n(".apple")),expect(e.children()).to.have.length(2),expect(e.children()[0]).to.equal(n(".orange")[0]),expect(e.children()[1]).to.equal(n(".apple")[0])}),it("(elem) : should NOP if removed",function(){var e=n(".pear"),t=n('<li class="plum">Plum</li>');e.remove(),e.replaceWith(t),expect(n(".orange").next().hasClass("plum")).to.not.be.ok()}),it("(elem) : should replace the single selected element with given element",function(){var e=n("<h2>hi <span>there</span></h2>"),t=n("<div>here</div>"),r=e.find("span").replaceWith(t);expect(t[0].parentNode).to.equal(e[0]),expect(r[0].parentNode).to.equal(null),expect(n.html(e)).to.equal("<h2>hi <div>here</div></h2>")}),it("(str) : should accept strings",function(){var e=n("<h2>hi <span>there</span></h2>"),t="<div>here</div>",r=e.find("span").replaceWith(t);expect(r[0].parentNode).to.equal(null),expect(n.html(e)).to.equal("<h2>hi <div>here</div></h2>")}),it("(str) : should replace all selected elements",function(){var e=n("<b>a<br>b<br>c<br>d</b>"),t=e.find("br").replaceWith(" ");expect(t[0].parentNode).to.equal(null),expect(n.html(e)).to.equal("<b>a b c d</b>")}),it("(fn) : should invoke the callback with the correct argument and context",function(){var n=e.children().get(),t=[],r=[];e.children().replaceWith(function(){return t.push(toArray(arguments)),r.push(this),'<li class="first">'}),expect(t).to.eql([[0,n[0]],[1,n[1]],[2,n[2]]]),expect(r).to.eql([n[0],n[1],n[2]])}),it("(fn) : should replace the selected element with the returned string",function(){e.children().replaceWith(function(){return'<li class="first">'}),expect(e.find(".first")).to.have.length(3)}),it("(fn) : should replace the selected element with the returned Cheerio object",function(){e.children().replaceWith(function(){return n('<li class="second">')}),expect(e.find(".second")).to.have.length(3)}),it("(fn) : should replace the selected element with the returned node",function(){e.children().replaceWith(function(){return n('<li class="third">')[0]}),expect(e.find(".third")).to.have.length(3)}),it("($(...)) : should remove from root element",function(){var t=n('<li class="plum">Plum</li>'),r=t[0].root;expect(r).to.be.ok(),e.children().replaceWith(t),expect(t[0].root).to.not.be.ok(),expect(r.childNodes).to.not.contain(t[0])})}),describe(".empty",function(){it("() : should remove all children from selected elements",function(){expect(e.children()).to.have.length(3),e.empty(),expect(e.children()).to.have.length(0)}),it("() : should allow element reinsertion",function(){var t=e.children();e.empty(),expect(e.children()).to.have.length(0),expect(t).to.have.length(3),e.append(n("<div></div><div></div>"));var r=e.children().eq(0);r.replaceWith(t),expect(e.children()).to.have.length(4)}),it("() : should destroy children's references to the parent",function(){var n=e.children();e.empty(),expect(n.eq(0).parent()).to.have.length(0),expect(n.eq(0).next()).to.have.length(0),expect(n.eq(0).prev()).to.have.length(0),expect(n.eq(1).parent()).to.have.length(0),expect(n.eq(1).next()).to.have.length(0),expect(n.eq(1).prev()).to.have.length(0),expect(n.eq(2).parent()).to.have.length(0),expect(n.eq(2).next()).to.have.length(0),expect(n.eq(2).prev()).to.have.length(0)})}),describe(".html",function(){it("() : should get the innerHTML for an element",function(){expect(e.html()).to.equal(['<li class="apple">Apple</li>','<li class="orange">Orange</li>','<li class="pear">Pear</li>'].join(""))}),it("() : should get innerHTML even if its just text",function(){var e='<li class="pear">Pear</li>';expect(n(".pear",e).html()).to.equal("Pear")}),it("() : should return empty string if nothing inside",function(){var e="<li></li>";expect(n("li",e).html()).to.equal("")}),it("(html) : should set the html for its children",function(){e.html('<li class="durian">Durian</li>');var n=e.html();expect(n).to.equal('<li class="durian">Durian</li>')}),it("(html) : should add new elements for each element in selection",function(){var e=n("li");e.html('<li class="durian">Durian</li>');var t=0;e.each(function(){expect(n(this).children().parent().get(0)).to.equal(this),t++}),expect(t).to.equal(3)}),it("(elem) : should set the html for its children with element",function(){e.html(n('<li class="durian">Durian</li>'));var t=e.html();expect(t).to.equal('<li class="durian">Durian</li>')}),it("() : should allow element reinsertion",function(){var n=e.children();e.html("<div></div><div></div>"),expect(e.children()).to.have.length(2);var t=e.children().eq(0);t.replaceWith(n),expect(e.children()).to.have.length(4)})}),describe(".toString",function(){it("() : should get the outerHTML for an element",function(){expect(e.toString()).to.equal(fruits)}),it("() : should return an html string for a set of elements",function(){expect(e.find("li").toString()).to.equal('<li class="apple">Apple</li><li class="orange">Orange</li><li class="pear">Pear</li>')}),it("() : should be called implicitly",function(){var e=[n("<foo>"),n("<bar>"),n("<baz>")].join("");expect(e).to.equal("<foo></foo><bar></bar><baz></baz>")})}),describe(".text",function(){it("() : gets the text for a single element",function(){expect(n(".apple").text()).to.equal("Apple")}),it("() : combines all text from children text nodes",function(){expect(n("#fruits").text()).to.equal("AppleOrangePear")}),it("(text) : sets the text for the child node",function(){n(".apple").text("Granny Smith Apple"),expect(n(".apple")[0].childNodes[0].data).to.equal("Granny Smith Apple")}),it("(text) : inserts separate nodes for all children",function(){n("li").text("Fruits");var e=0;n("li").each(function(){expect(this.childNodes[0].parent).to.equal(this),e++}),expect(e).to.equal(3)}),it("should allow functions as arguments",function(){n(".apple").text(function(n,e){return expect(n).to.equal(0),expect(e).to.equal("Apple"),"whatever mate"}),expect(n(".apple")[0].childNodes[0].data).to.equal("whatever mate")}),it("should decode special chars",function(){var e=n("<p>M&amp;M</p>").text();expect(e).to.equal("M&M")}),it("should work with special chars added as strings",function(){var e=n("<p>M&M</p>").text();expect(e).to.equal("M&M")}),it("( undefined ) : should act as an accessor",function(){var e=n("<div>test</div>");expect(e.text(void 0)).to.be.a("string"),expect(e.text()).to.be("test")}),it('( "" ) : should convert to string',function(){var e=n("<div>test</div>");expect(e.text("").text()).to.equal("")}),it("( null ) : should convert to string",function(){expect(n("<div>").text(null).text()).to.equal("null")}),it("( 0 ) : should convert to string",function(){expect(n("<div>").text(0).text()).to.equal("0")}),it("(str) should encode then decode unsafe characters",function(){var e=n(".apple");e.text('blah <script>alert("XSS!")</script> blah'),expect(e[0].childNodes[0].data).to.equal('blah <script>alert("XSS!")</script> blah'),expect(e.text()).to.equal('blah <script>alert("XSS!")</script> blah'),e.text('blah <script>alert("XSS!")</script> blah'),expect(e.html()).to.not.contain('<script>alert("XSS!")</script>')})})});