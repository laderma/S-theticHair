"use strict";function funescape(e,n,t){var r="0x"+n-65536;return r!==r||t?n:0>r?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,1023&r|56320)}function unescapeCSS(e){return e.replace(re_escape,funescape)}function getClosingPos(e){for(var n=1,t=1,r=e.length;t>0&&r>n;n++)"("===e.charAt(n)?t++:")"===e.charAt(n)&&t--;return n}function parse(e,n){function u(){var n=e.match(re_name)[0];return e=e.substr(n.length),unescapeCSS(n)}e=(e+"").trimLeft();for(var i,o,s,t=[],r=[],a=!1;""!==e;)if(re_name.test(e))a&&(r.push({type:"descendant"}),a=!1),s=u(),n&&("lowerCaseTags"in n?!n.lowerCaseTags:n.xmlMode)||(s=s.toLowerCase()),r.push({type:"tag",name:s});else if(re_ws.test(e))a=!0,e=e.trimLeft();else{if(o=e.charAt(0),e=e.substr(1),o in simpleSelectors){r.push({type:simpleSelectors[o]}),e=e.trimLeft(),a=!1;continue}if(","===o){if(0===r.length)throw new SyntaxError("empty sub-selector");t.push(r),r=[],e=e.trimLeft(),a=!1;continue}if(a&&(r.push({type:"descendant"}),a=!1),"*"===o)r.push({type:"universal"});else if(o in attribSelectors)r.push({type:"attribute",name:attribSelectors[o][0],action:attribSelectors[o][1],value:u(),ignoreCase:!1});else if("["===o){if(i=e.match(re_attr),!i)throw new SyntaxError("Malformed attribute selector: "+e);e=e.substr(i[0].length),s=unescapeCSS(i[1]),n&&("lowerCaseAttributeNames"in n?!n.lowerCaseAttributeNames:n.xmlMode)||(s=s.toLowerCase()),r.push({type:"attribute",name:s,action:actionTypes[i[2]],value:unescapeCSS(i[4]||i[5]||""),ignoreCase:!!i[6]})}else{if(":"!==o)throw new SyntaxError("Unmatched selector: "+o+e);if(s=u().toLowerCase(),i=null,"("===e.charAt(0)){var l=getClosingPos(e);i=e.substr(1,l-2),e=e.substr(l)}r.push({type:"pseudo",name:s,data:i})}}if(t.length>0&&0===r.length)throw new SyntaxError("empty sub-selector");return t.push(r),t}module.exports=parse;var re_ws=/^\s/,re_name=/^(?:\\.|[\w\-\u00c0-\uFFFF])+/,re_escape=/\\([\da-f]{1,6}\s?|(\s)|.)/gi,re_attr=/^\s*((?:\\.|[\w\u00c0-\uFFFF\-])+)\s*(?:(\S?)=\s*(?:(['"])(.*?)\3|(#?(?:\\.|[\w\u00c0-\uFFFF\-])*)|)|)\s*(i)?\]/,actionTypes={__proto__:null,undefined:"exists","":"equals","~":"element","^":"start",$:"end","*":"any","!":"not","|":"hyphen"},simpleSelectors={__proto__:null,">":"child","<":"parent","~":"sibling","+":"adjacent"},attribSelectors={__proto__:null,"#":["id","equals"],".":["class","element"]};