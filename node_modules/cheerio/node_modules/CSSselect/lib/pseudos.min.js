function getFirstElement(e){for(var n=0;e&&n<e.length;n++)if(isTag(e[n]))return e[n]}function getAttribFunc(e,n){var t={name:e,value:n};return function(e){return checkAttrib(e,t)}}function getChildFunc(e){return function(n){return!!getParent(n)&&e(n)}}function verifyArgs(e,n,t){if(null===t){if(e.length>1)throw new SyntaxError("pseudo-selector :"+n+" requires an argument")}else if(1===e.length)throw new SyntaxError("pseudo-selector :"+n+" doesn't have any arguments")}var DomUtils=require("domutils"),isTag=DomUtils.isTag,getText=DomUtils.getText,getParent=DomUtils.getParent,getChildren=DomUtils.getChildren,getSiblings=DomUtils.getSiblings,hasAttrib=DomUtils.hasAttrib,getName=DomUtils.getName,getAttribute=DomUtils.getAttributeValue,getNCheck=require("./nth-check.js"),checkAttrib=require("./attributes.js").rules.equals,BaseFuncs=require("./basefunctions.js"),trueFunc=BaseFuncs.trueFunc,falseFunc=BaseFuncs.falseFunc,filters={contains:function(e,n){return'"'!==n.charAt(0)&&"'"!==n.charAt(0)||n.charAt(0)!==n.substr(-1)||(n=n.slice(1,-1)),function(t){return getText(t).indexOf(n)>=0&&e(t)}},"first-child":function(e){return function(n){return getFirstElement(getSiblings(n))===n&&e(n)}},"last-child":function(e){return function(n){for(var t=getSiblings(n),r=t.length-1;r>=0;r--){if(t[r]===n)return e(n);if(isTag(t[r]))break}return!1}},"first-of-type":function(e){return function(n){for(var t=getSiblings(n),r=0;r<t.length;r++)if(isTag(t[r])){if(t[r]===n)return e(n);if(getName(t[r])===getName(n))break}return!1}},"last-of-type":function(e){return function(n){for(var t=getSiblings(n),r=t.length-1;r>=0;r--)if(isTag(t[r])){if(t[r]===n)return e(n);if(getName(t[r])===getName(n))break}return!1}},"only-of-type":function(e){return function(n){for(var t=getSiblings(n),r=0,a=t.length;a>r;r++)if(isTag(t[r])){if(t[r]===n)continue;if(getName(t[r])===getName(n))return!1}return e(n)}},"only-child":function(e){return function(n){for(var t=getSiblings(n),r=0;r<t.length;r++)if(isTag(t[r])&&t[r]!==n)return!1;return e(n)}},"nth-child":function(e,n){var t=getNCheck(n);return t===falseFunc?t:t===trueFunc?getChildFunc(e):function(n){for(var r=getSiblings(n),a=0,i=0;a<r.length;a++)if(isTag(r[a])){if(r[a]===n)break;i++}return t(i)&&e(n)}},"nth-last-child":function(e,n){var t=getNCheck(n);return t===falseFunc?t:t===trueFunc?getChildFunc(e):function(n){for(var r=getSiblings(n),a=0,i=r.length-1;i>=0;i--)if(isTag(r[i])){if(r[i]===n)break;a++}return t(a)&&e(n)}},"nth-of-type":function(e,n){var t=getNCheck(n);return t===falseFunc?t:t===trueFunc?getChildFunc(e):function(n){for(var r=getSiblings(n),a=0,i=0;i<r.length;i++)if(isTag(r[i])){if(r[i]===n)break;getName(r[i])===getName(n)&&a++}return t(a)&&e(n)}},"nth-last-of-type":function(e,n){var t=getNCheck(n);return t===falseFunc?t:t===trueFunc?getChildFunc(e):function(n){for(var r=getSiblings(n),a=0,i=r.length-1;i>=0&&r[i]!==n;i--)getName(r[i])===getName(n)&&a++;return t(a)&&e(n)}},checkbox:getAttribFunc("type","checkbox"),file:getAttribFunc("type","file"),password:getAttribFunc("type","password"),radio:getAttribFunc("type","radio"),reset:getAttribFunc("type","reset"),image:getAttribFunc("type","image"),submit:getAttribFunc("type","submit")},pseudos={root:function(e){return!getParent(e)},empty:function(e){return!getChildren(e).some(function(e){return isTag(e)||"text"===e.type})},selected:function(e){if(hasAttrib(e,"selected"))return!0;if("option"!==getName(e))return!1;var n=getParent(e);if(!n||"select"!==getName(n))return!1;for(var t=getChildren(n),r=!1,a=0;a<t.length;a++)if(isTag(t[a]))if(t[a]===e)r=!0;else{if(!r)return!1;if(hasAttrib(t[a],"selected"))return!1}return r},disabled:function(e){return hasAttrib(e,"disabled")},enabled:function(e){return!hasAttrib(e,"disabled")},checked:function(e){return hasAttrib(e,"checked")||pseudos.selected(e)},parent:function(e){return!pseudos.empty(e)},header:function(e){var n=getName(e);return"h1"===n||"h2"===n||"h3"===n||"h4"===n||"h5"===n||"h6"===n},button:function(e){var n=getName(e);return"button"===n||"input"===n&&"button"===getAttribute(e,"type")},input:function(e){var n=getName(e);return"input"===n||"textarea"===n||"select"===n||"button"===n},text:function(e){var n;return"input"===getName(e)&&(!(n=getAttribute(e,"type"))||"text"===n.toLowerCase())}};module.exports={compile:function(e,n){var t=n.name,r=n.data;if("function"==typeof filters[t])return verifyArgs(filters[t],t,r),filters[t](e,r);if("function"==typeof pseudos[t]){var a=pseudos[t];return verifyArgs(a,t,r),function(n){return a(n,r)&&e(n)}}throw new SyntaxError("unmatched pseudo-class :"+t)},filters:filters,pseudos:pseudos};