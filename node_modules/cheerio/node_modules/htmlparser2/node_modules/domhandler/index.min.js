function DomHandler(e,n,t){"object"==typeof e?(t=n,n=e,e=null):"function"==typeof n&&(t=n,n=defaultOpts),this._callback=e,this._options=n||defaultOpts,this._elementCB=t,this.dom=[],this._done=!1,this._tagStack=[],this._parser=this._parser||null}var ElementType=require("domelementtype"),re_whitespace=/\s+/g,NodePrototype=require("./lib/node"),ElementPrototype=require("./lib/element"),defaultOpts={normalizeWhitespace:!1,withStartIndices:!1};DomHandler.prototype.onparserinit=function(e){this._parser=e},DomHandler.prototype.onreset=function(){DomHandler.call(this,this._callback,this._options,this._elementCB)},DomHandler.prototype.onend=function(){this._done||(this._done=!0,this._parser=null,this._handleCallback(null))},DomHandler.prototype._handleCallback=DomHandler.prototype.onerror=function(e){if("function"==typeof this._callback)this._callback(e,this.dom);else if(e)throw e},DomHandler.prototype.onclosetag=function(){var e=this._tagStack.pop();this._elementCB&&this._elementCB(e)},DomHandler.prototype._addDomElement=function(e){var n=this._tagStack[this._tagStack.length-1],t=n?n.children:this.dom,r=t[t.length-1];e.next=null,this._options.withStartIndices&&(e.startIndex=this._parser.startIndex),this._options.withDomLvl1&&(e.__proto__="tag"===e.type?ElementPrototype:NodePrototype),r?(e.prev=r,r.next=e):e.prev=null,t.push(e),e.parent=n||null},DomHandler.prototype.onopentag=function(e,n){var t={type:"script"===e?ElementType.Script:"style"===e?ElementType.Style:ElementType.Tag,name:e,attribs:n,children:[]};this._addDomElement(t),this._tagStack.push(t)},DomHandler.prototype.ontext=function(e){var t,n=this._options.normalizeWhitespace||this._options.ignoreWhitespace;!this._tagStack.length&&this.dom.length&&(t=this.dom[this.dom.length-1]).type===ElementType.Text?n?t.data=(t.data+e).replace(re_whitespace," "):t.data+=e:this._tagStack.length&&(t=this._tagStack[this._tagStack.length-1])&&(t=t.children[t.children.length-1])&&t.type===ElementType.Text?n?t.data=(t.data+e).replace(re_whitespace," "):t.data+=e:(n&&(e=e.replace(re_whitespace," ")),this._addDomElement({data:e,type:ElementType.Text}))},DomHandler.prototype.oncomment=function(e){var n=this._tagStack[this._tagStack.length-1];if(n&&n.type===ElementType.Comment)return void(n.data+=e);var t={data:e,type:ElementType.Comment};this._addDomElement(t),this._tagStack.push(t)},DomHandler.prototype.oncdatastart=function(){var e={children:[{data:"",type:ElementType.Text}],type:ElementType.CDATA};this._addDomElement(e),this._tagStack.push(e)},DomHandler.prototype.oncommentend=DomHandler.prototype.oncdataend=function(){this._tagStack.pop()},DomHandler.prototype.onprocessinginstruction=function(e,n){this._addDomElement({name:e,data:n,type:ElementType.Directive})},module.exports=DomHandler;