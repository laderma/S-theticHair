function WriteReq(e,n,t){this.chunk=e,this.encoding=n,this.callback=t}function WritableState(e,n){var t=require("./_stream_duplex");e=e||{};var r=e.highWaterMark,i=e.objectMode?16:16384;this.highWaterMark=r||0===r?r:i,this.objectMode=!!e.objectMode,n instanceof t&&(this.objectMode=this.objectMode||!!e.writableObjectMode),this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var a=e.decodeStrings===!1;this.decodeStrings=!a,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){onwrite(n,e)},this.writecb=null,this.writelen=0,this.buffer=[],this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1}function Writable(e){var n=require("./_stream_duplex");return this instanceof Writable||this instanceof n?(this._writableState=new WritableState(e,this),this.writable=!0,void Stream.call(this)):new Writable(e)}function writeAfterEnd(e,n,t){var r=new Error("write after end");e.emit("error",r),process.nextTick(function(){t(r)})}function validChunk(e,n,t,r){var i=!0;if(!(util.isBuffer(t)||util.isString(t)||util.isNullOrUndefined(t)||n.objectMode)){var a=new TypeError("Invalid non-string/buffer chunk");e.emit("error",a),process.nextTick(function(){r(a)}),i=!1}return i}function decodeChunk(e,n,t){return!e.objectMode&&e.decodeStrings!==!1&&util.isString(n)&&(n=new Buffer(n,t)),n}function writeOrBuffer(e,n,t,r,i){t=decodeChunk(n,t,r),util.isBuffer(t)&&(r="buffer");var a=n.objectMode?1:t.length;n.length+=a;var o=n.length<n.highWaterMark;return o||(n.needDrain=!0),n.writing||n.corked?n.buffer.push(new WriteReq(t,r,i)):doWrite(e,n,!1,a,t,r,i),o}function doWrite(e,n,t,r,i,a,o){n.writelen=r,n.writecb=o,n.writing=!0,n.sync=!0,t?e._writev(i,n.onwrite):e._write(i,a,n.onwrite),n.sync=!1}function onwriteError(e,n,t,r,i){t?process.nextTick(function(){n.pendingcb--,i(r)}):(n.pendingcb--,i(r)),e._writableState.errorEmitted=!0,e.emit("error",r)}function onwriteStateUpdate(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function onwrite(e,n){var t=e._writableState,r=t.sync,i=t.writecb;if(onwriteStateUpdate(t),n)onwriteError(e,t,r,n,i);else{var a=needFinish(e,t);a||t.corked||t.bufferProcessing||!t.buffer.length||clearBuffer(e,t),r?process.nextTick(function(){afterWrite(e,t,a,i)}):afterWrite(e,t,a,i)}}function afterWrite(e,n,t,r){t||onwriteDrain(e,n),n.pendingcb--,r(),finishMaybe(e,n)}function onwriteDrain(e,n){0===n.length&&n.needDrain&&(n.needDrain=!1,e.emit("drain"))}function clearBuffer(e,n){if(n.bufferProcessing=!0,e._writev&&n.buffer.length>1){for(var t=[],r=0;r<n.buffer.length;r++)t.push(n.buffer[r].callback);n.pendingcb++,doWrite(e,n,!0,n.length,n.buffer,"",function(e){for(var r=0;r<t.length;r++)n.pendingcb--,t[r](e)}),n.buffer=[]}else{for(var r=0;r<n.buffer.length;r++){var i=n.buffer[r],a=i.chunk,o=i.encoding,s=i.callback,u=n.objectMode?1:a.length;if(doWrite(e,n,!1,u,a,o,s),n.writing){r++;break}}r<n.buffer.length?n.buffer=n.buffer.slice(r):n.buffer.length=0}n.bufferProcessing=!1}function needFinish(e,n){return n.ending&&0===n.length&&!n.finished&&!n.writing}function prefinish(e,n){n.prefinished||(n.prefinished=!0,e.emit("prefinish"))}function finishMaybe(e,n){var t=needFinish(e,n);return t&&(0===n.pendingcb?(prefinish(e,n),n.finished=!0,e.emit("finish")):prefinish(e,n)),t}function endWritable(e,n,t){n.ending=!0,finishMaybe(e,n),t&&(n.finished?process.nextTick(t):e.once("finish",t)),n.ended=!0}module.exports=Writable;var Buffer=require("buffer").Buffer;Writable.WritableState=WritableState;var util=require("core-util-is");util.inherits=require("inherits");var Stream=require("stream");util.inherits(Writable,Stream),Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe. Not readable."))},Writable.prototype.write=function(e,n,t){var r=this._writableState,i=!1;return util.isFunction(n)&&(t=n,n=null),util.isBuffer(e)?n="buffer":n||(n=r.defaultEncoding),util.isFunction(t)||(t=function(){}),r.ended?writeAfterEnd(this,r,t):validChunk(this,r,e,t)&&(r.pendingcb++,i=writeOrBuffer(this,r,e,n,t)),i},Writable.prototype.cork=function(){var e=this._writableState;e.corked++},Writable.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.finished||e.bufferProcessing||!e.buffer.length||clearBuffer(this,e))},Writable.prototype._write=function(e,n,t){t(new Error("not implemented"))},Writable.prototype._writev=null,Writable.prototype.end=function(e,n,t){var r=this._writableState;util.isFunction(e)?(t=e,e=null,n=null):util.isFunction(n)&&(t=n,n=null),util.isNullOrUndefined(e)||this.write(e,n),r.corked&&(r.corked=1,this.uncork()),r.ending||r.finished||endWritable(this,r,t)};