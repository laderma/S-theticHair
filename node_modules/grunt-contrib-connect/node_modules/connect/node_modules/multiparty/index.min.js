function Form(e){var n=this;stream.Writable.call(n),e=e||{},n.error=null,n.finished=!1,n.autoFields=!!e.autoFields,n.autoFiles=!!e.autoFiles,n.maxFields=e.maxFields||1e3,n.maxFieldsSize=e.maxFieldsSize||2097152,n.maxFilesSize=e.maxFilesSize||1/0,n.uploadDir=e.uploadDir||os.tmpDir(),n.encoding=e.encoding||"utf8",n.hash=e.hash||!1,n.bytesReceived=0,n.bytesExpected=null,n.openedFiles=[],n.totalFieldSize=0,n.totalFieldCount=0,n.totalFileSize=0,n.flushing=0,n.backpressure=!1,n.writeCbs=[],e.boundary&&setUpParser(n,e.boundary),n.on("newListener",function(e){"file"===e?n.autoFiles=!0:"field"===e&&(n.autoFields=!0)})}function flushWriteCbs(e){e.writeCbs.forEach(function(e){process.nextTick(e)}),e.writeCbs=[],e.backpressure=!1}function getBytesExpected(e){var n=e["content-length"];return n?parseInt(n,10):null==e["transfer-encoding"]?0:null}function beginFlush(e){e.flushing+=1}function endFlush(e){e.flushing-=1,maybeClose(e)}function maybeClose(e){e.flushing||!e.finished||e.error||e.emit("close")}function destroyFile(e,n){n.ws&&(n.ws.removeAllListeners("close"),n.ws.on("close",function(){fs.unlink(n.path,function(n){n&&!e.error&&e.handleError(n)})}),n.ws.destroy())}function handleFile(e,n){if(!e.error){var t={fieldName:n.name,originalFilename:n.filename,path:uploadPath(e.uploadDir,n.filename),headers:n.headers};beginFlush(e),t.ws=fs.createWriteStream(t.path),e.openedFiles.push(t),n.pipe(t.ws);var r=new StreamCounter,a=0;n.pipe(r);var i,o=null;e.hash&&(i=stream.Writable(),o=crypto.createHash(e.hash),i._write=function(e,n,t){o.update(e),t()},n.pipe(i)),r.on("progress",function(){var o=r.bytes-a;a+=o,e.totalFileSize+=o,e.totalFileSize>e.maxFilesSize&&(i&&n.unpipe(i),n.unpipe(r),n.unpipe(t.ws),e.handleError(new Error("maxFilesSize "+e.maxFilesSize+" exceeded")))}),t.ws.on("error",function(n){e.error||e.handleError(n)}),t.ws.on("close",function(){o&&(t.hash=o.digest("hex")),t.size=r.bytes,e.emit("file",n.name,t),endFlush(e)}),beginFlush(e),n.on("end",function(){endFlush(e)})}}function handleField(e,n){var t="",r=new StringDecoder(e.encoding);beginFlush(e),n.on("readable",function(){var a=n.read();if(a)return e.totalFieldSize+=a.length,e.totalFieldSize>e.maxFieldsSize?void e.handleError(new Error("maxFieldsSize "+e.maxFieldsSize+" exceeded")):void(t+=r.write(a))}),n.on("end",function(){e.emit("field",n.name,t),endFlush(e)})}function clearPartVars(e){e.partHeaders={},e.partName=null,e.partFilename=null,e.partTransferEncoding="binary",e.destStream=null,e.headerFieldDecoder=new StringDecoder(e.encoding),e.headerField="",e.headerValueDecoder=new StringDecoder(e.encoding),e.headerValue=""}function setUpParser(e,n){e.boundary=new Buffer(n.length+4),e.boundary.write("\r\n--",0,n.length+4,"ascii"),e.boundary.write(n,4,n.length,"ascii"),e.lookbehind=new Buffer(e.boundary.length+8),e.state=START,e.boundaryChars={};for(var t=0;t<e.boundary.length;t++)e.boundaryChars[e.boundary[t]]=!0;e.index=null,e.partBoundaryFlag=!1,e.on("finish",function(){e.state===HEADER_FIELD_START&&0===e.index||e.state===PART_DATA&&e.index===e.boundary.length?e.onParsePartEnd():e.state!==END&&e.handleError(new Error("stream ended unexpectedly")),e.finished=!0,maybeClose(e)})}function uploadPath(e,n){var t=path.extname(n).replace(FILE_EXT_RE,"$1"),r=process.pid+"-"+(4294967296*Math.random()+1).toString(36)+t;return path.join(e,r)}function parseFilename(e){var n=e.match(/\bfilename="(.*?)"($|; )/i);if(!n){if(n=e.match(/\bfilename\*=utf-8\'\'(.*?)($|; )/i),!n)return;n[1]=decodeURI(n[1])}var t=n[1].substr(n[1].lastIndexOf("\\")+1);return t=t.replace(/%22/g,'"'),t=t.replace(/&#([\d]{4});/g,function(e,n){return String.fromCharCode(n)})}function lower(e){return 32|e}exports.Form=Form;var stream=require("readable-stream"),util=require("util"),fs=require("fs"),crypto=require("crypto"),path=require("path"),os=require("os"),StringDecoder=require("string_decoder").StringDecoder,StreamCounter=require("stream-counter"),START=0,START_BOUNDARY=1,HEADER_FIELD_START=2,HEADER_FIELD=3,HEADER_VALUE_START=4,HEADER_VALUE=5,HEADER_VALUE_ALMOST_DONE=6,HEADERS_ALMOST_DONE=7,PART_DATA_START=8,PART_DATA=9,PART_END=10,CLOSE_BOUNDARY=11,END=12,LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,CONTENT_TYPE_RE=/^multipart\/(?:form-data|related)(?:;|$)/i,CONTENT_TYPE_PARAM_RE=/;\s*([^=]+)=(?:"([^"]+)"|([^;]+))/gi,FILE_EXT_RE=/(\.[_\-a-zA-Z0-9]{0,16}).*/,LAST_BOUNDARY_SUFFIX_LEN=4;util.inherits(Form,stream.Writable),Form.prototype.parse=function(e,n){function d(){a=!1,r.emit("aborted"),p(new Error("Request aborted"))}function h(){a=!1}function p(n){var t=!r.error;t&&(r.error=n,e.removeListener("aborted",d),e.removeListener("end",h)),r.openedFiles.forEach(function(e){destroyFile(r,e)}),r.openedFiles=[],t&&r.emit("error",n)}function m(e){process.nextTick(p.bind(null,e))}var t=!1,r=this,a=!0;if(n){r.autoFields=!0,r.autoFiles=!0;var i=function(n){t||(t=!0,process.nextTick(function(){return a&&e.readable?(e.resume(),void e.once("end",n)):void n()}))},o={},s={};r.on("error",function(e){i(function(){n(e)})}),r.on("field",function(e,n){var t=o[e]||(o[e]=[]);t.push(n)}),r.on("file",function(e,n){var t=s[e]||(s[e]=[]);t.push(n)}),r.on("close",function(){i(function(){n(null,o,s)})})}r.handleError=p,r.bytesExpected=getBytesExpected(e.headers),e.on("end",h),e.on("error",function(e){a=!1,p(e)}),e.on("aborted",d);var u=e._readableState;if(e._decoder||u&&(u.encoding||u.decoder))return void m(new Error("request encoding must not be set"));var l=e.headers["content-type"];if(!l)return void m(new Error("missing content-type header"));var c=CONTENT_TYPE_RE.exec(l);if(!c)return void m(new Error("unrecognized content-type: "+l));var f;for(CONTENT_TYPE_PARAM_RE.lastIndex=c.index+c[0].length-1;c=CONTENT_TYPE_PARAM_RE.exec(l);)if("boundary"===c[1].toLowerCase()){f=c[2]||c[3];break}return f?(setUpParser(r,f),void e.pipe(r)):void m(new Error("content-type missing boundary: "+require("util").inspect(c)))},Form.prototype._write=function(e,n,t){if(!this.error){var m,g,r=this,a=0,i=e.length,o=r.index,s=r.index,u=r.state,l=r.lookbehind,c=r.boundary,f=r.boundaryChars,d=r.boundary.length,h=d-1,p=e.length;for(a=0;i>a;a++)switch(m=e[a],u){case START:s=0,u=START_BOUNDARY;case START_BOUNDARY:if(s===d-2&&m===HYPHEN){s=1,u=CLOSE_BOUNDARY;break}if(s===d-2){if(m!==CR)return r.handleError(new Error("Expected CR Received "+m));s++;break}if(s===d-1){if(m!==LF)return r.handleError(new Error("Expected LF Received "+m));s=0,r.onParsePartBegin(),u=HEADER_FIELD_START;break}m!==c[s+2]&&(s=-2),m===c[s+2]&&s++;break;case HEADER_FIELD_START:u=HEADER_FIELD,r.headerFieldMark=a,s=0;case HEADER_FIELD:if(m===CR){r.headerFieldMark=null,u=HEADERS_ALMOST_DONE;break}if(s++,m===HYPHEN)break;if(m===COLON){if(1===s)return void r.handleError(new Error("Empty header field"));r.onParseHeaderField(e.slice(r.headerFieldMark,a)),r.headerFieldMark=null,u=HEADER_VALUE_START;break}if(g=lower(m),A>g||g>Z)return void r.handleError(new Error("Expected alphabetic character, received "+m));break;case HEADER_VALUE_START:if(m===SPACE)break;r.headerValueMark=a,u=HEADER_VALUE;case HEADER_VALUE:m===CR&&(r.onParseHeaderValue(e.slice(r.headerValueMark,a)),r.headerValueMark=null,r.onParseHeaderEnd(),u=HEADER_VALUE_ALMOST_DONE);break;case HEADER_VALUE_ALMOST_DONE:if(m!==LF)return r.handleError(new Error("Expected LF Received "+m));u=HEADER_FIELD_START;break;case HEADERS_ALMOST_DONE:if(m!==LF)return r.handleError(new Error("Expected LF Received "+m));var v=r.onParseHeadersEnd(a+1);if(v)return r.handleError(v);u=PART_DATA_START;break;case PART_DATA_START:u=PART_DATA,r.partDataMark=a;case PART_DATA:if(o=s,0===s){for(a+=h;p>a&&!(e[a]in f);)a+=d;a-=h,m=e[a]}if(d>s)c[s]===m?(0===s&&(r.onParsePartData(e.slice(r.partDataMark,a)),r.partDataMark=null),s++):s=0;else if(s===d)if(s++,m===CR)r.partBoundaryFlag=!0;else{if(m===HYPHEN){s=1,u=CLOSE_BOUNDARY;break}s=0}else if(s-1===d)if(r.partBoundaryFlag){if(s=0,m===LF){r.partBoundaryFlag=!1,r.onParsePartEnd(),r.onParsePartBegin(),u=HEADER_FIELD_START;break}}else s=0;s>0?l[s-1]=m:o>0&&(r.onParsePartData(l.slice(0,o)),o=0,r.partDataMark=a,a--);break;case CLOSE_BOUNDARY:if(m!==HYPHEN)return r.handleError(new Error("Expected HYPHEN Received "+m));if(1===s)r.onParsePartEnd(),u=END;else if(s>1)return r.handleError(new Error("Parser has invalid state."));s++;break;case END:break;default:return void r.handleError(new Error("Parser has invalid state."))}null!=r.headerFieldMark&&(r.onParseHeaderField(e.slice(r.headerFieldMark)),r.headerFieldMark=0),null!=r.headerValueMark&&(r.onParseHeaderValue(e.slice(r.headerValueMark)),r.headerValueMark=0),null!=r.partDataMark&&(r.onParsePartData(e.slice(r.partDataMark)),r.partDataMark=0),r.index=s,r.state=u,r.bytesReceived+=e.length,r.emit("progress",r.bytesReceived,r.bytesExpected),r.backpressure?r.writeCbs.push(t):t()}},Form.prototype.onParsePartBegin=function(){clearPartVars(this)},Form.prototype.onParseHeaderField=function(e){this.headerField+=this.headerFieldDecoder.write(e)},Form.prototype.onParseHeaderValue=function(e){this.headerValue+=this.headerValueDecoder.write(e)},Form.prototype.onParseHeaderEnd=function(){this.headerField=this.headerField.toLowerCase(),this.partHeaders[this.headerField]=this.headerValue;var e;"content-disposition"===this.headerField?((e=this.headerValue.match(/\bname="([^"]+)"/i))&&(this.partName=e[1]),this.partFilename=parseFilename(this.headerValue)):"content-transfer-encoding"===this.headerField&&(this.partTransferEncoding=this.headerValue.toLowerCase()),this.headerFieldDecoder=new StringDecoder(this.encoding),this.headerField="",this.headerValueDecoder=new StringDecoder(this.encoding),this.headerValue=""},Form.prototype.onParsePartData=function(e){"base64"===this.partTransferEncoding?this.backpressure=!this.destStream.write(e.toString("ascii"),"base64"):this.backpressure=!this.destStream.write(e)},Form.prototype.onParsePartEnd=function(){if(this.destStream){flushWriteCbs(this);var e=this.destStream;process.nextTick(function(){e.end()})}clearPartVars(this)},Form.prototype.onParseHeadersEnd=function(e){var n=this;switch(n.partTransferEncoding){case"binary":case"7bit":case"8bit":n.partTransferEncoding="binary";break;case"base64":break;default:return new Error("unknown transfer-encoding: "+n.partTransferEncoding)}if(n.totalFieldCount+=1,n.totalFieldCount>n.maxFields)return new Error("maxFields "+n.maxFields+" exceeded.");n.destStream=new stream.PassThrough,n.destStream.on("drain",function(){flushWriteCbs(n)}),n.destStream.headers=n.partHeaders,n.destStream.name=n.partName,n.destStream.filename=n.partFilename,n.destStream.byteOffset=n.bytesReceived+e;var t=n.destStream.headers["content-length"];n.destStream.byteCount=t?parseInt(t,10):n.bytesExpected?n.bytesExpected-n.destStream.byteOffset-n.boundary.length-LAST_BOUNDARY_SUFFIX_LEN:void 0,n.emit("part",n.destStream),null==n.destStream.filename&&n.autoFields?handleField(n,n.destStream):null!=n.destStream.filename&&n.autoFiles?handleFile(n,n.destStream):(beginFlush(n),n.destStream.on("end",function(){endFlush(n)}))};