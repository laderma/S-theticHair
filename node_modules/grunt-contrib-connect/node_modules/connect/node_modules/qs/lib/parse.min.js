var Utils=require("./utils"),internals={delimiter:"&",depth:5,arrayLimit:20,parameterLimit:1e3,strictNullHandling:!1,plainObjects:!1,allowPrototypes:!1};internals.parseValues=function(e,n){for(var t={},r=e.split(n.delimiter,n.parameterLimit===1/0?void 0:n.parameterLimit),i=0,a=r.length;a>i;++i){var o=r[i],s=-1===o.indexOf("]=")?o.indexOf("="):o.indexOf("]=")+1;if(-1===s)t[Utils.decode(o)]="",n.strictNullHandling&&(t[Utils.decode(o)]=null);else{var l=Utils.decode(o.slice(0,s)),u=Utils.decode(o.slice(s+1));Object.prototype.hasOwnProperty.call(t,l)?t[l]=[].concat(t[l]).concat(u):t[l]=u}}return t},internals.parseObject=function(e,n,t){if(!e.length)return n;var i,r=e.shift();if("[]"===r)i=[],i=i.concat(internals.parseObject(e,n,t));else{i=t.plainObjects?Object.create(null):{};var a="["===r[0]&&"]"===r[r.length-1]?r.slice(1,r.length-1):r,o=parseInt(a,10),s=""+o;!isNaN(o)&&r!==a&&s===a&&o>=0&&t.parseArrays&&o<=t.arrayLimit?(i=[],i[o]=internals.parseObject(e,n,t)):i[a]=internals.parseObject(e,n,t)}return i},internals.parseKeys=function(e,n,t){if(e){t.allowDots&&(e=e.replace(/\.([^\.\[]+)/g,"[$1]"));var r=/^([^\[\]]*)/,i=/(\[[^\[\]]*\])/g,a=r.exec(e),o=[];if(a[1]){if(!t.plainObjects&&Object.prototype.hasOwnProperty(a[1])&&!t.allowPrototypes)return;o.push(a[1])}for(var s=0;null!==(a=i.exec(e))&&s<t.depth;)++s,(t.plainObjects||!Object.prototype.hasOwnProperty(a[1].replace(/\[|\]/g,""))||t.allowPrototypes)&&o.push(a[1]);return a&&o.push("["+e.slice(a.index)+"]"),internals.parseObject(o,n,t)}},module.exports=function(e,n){if(n=n||{},n.delimiter="string"==typeof n.delimiter||Utils.isRegExp(n.delimiter)?n.delimiter:internals.delimiter,n.depth="number"==typeof n.depth?n.depth:internals.depth,n.arrayLimit="number"==typeof n.arrayLimit?n.arrayLimit:internals.arrayLimit,n.parseArrays=n.parseArrays!==!1,n.allowDots=n.allowDots!==!1,n.plainObjects="boolean"==typeof n.plainObjects?n.plainObjects:internals.plainObjects,n.allowPrototypes="boolean"==typeof n.allowPrototypes?n.allowPrototypes:internals.allowPrototypes,n.parameterLimit="number"==typeof n.parameterLimit?n.parameterLimit:internals.parameterLimit,n.strictNullHandling="boolean"==typeof n.strictNullHandling?n.strictNullHandling:internals.strictNullHandling,""===e||null===e||"undefined"==typeof e)return n.plainObjects?Object.create(null):{};for(var t="string"==typeof e?internals.parseValues(e,n):e,r=n.plainObjects?Object.create(null):{},i=Object.keys(t),a=0,o=i.length;o>a;++a){var s=i[a],l=internals.parseKeys(s,t[s],n);r=Utils.merge(r,l,n)}return Utils.compact(r)};