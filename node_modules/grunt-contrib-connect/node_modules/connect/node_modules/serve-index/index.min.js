"use strict";function serveIndex(e,n){var t=n||{};if(!e)throw new TypeError("serveIndex() root path required");var r=normalize(resolve(e)+sep),a=t.filter,i=t.hidden,o=t.icons,s=t.stylesheet||defaultStylesheet,u=t.template||defaultTemplate,l=t.view||"tiles";return function(e,n,t){if("GET"!==e.method&&"HEAD"!==e.method)return n.statusCode="OPTIONS"===e.method?200:405,n.setHeader("Allow","GET, HEAD, OPTIONS"),n.setHeader("Content-Length","0"),void n.end();var c=parseUrl(e),f=parseUrl.original(e),d=decodeURIComponent(c.pathname),h=decodeURIComponent(f.pathname),p=normalize(join(r,d));if(~p.indexOf("\x00"))return t(createError(400));if((p+sep).substr(0,r.length)!==r)return debug('malicious path "%s"',p),t(createError(403));var m=normalize(resolve(p)+sep)!==r;debug('stat "%s"',p),fs.stat(p,function(r,c){return r&&"ENOENT"===r.code?t():r?(r.status="ENAMETOOLONG"===r.code?414:500,t(r)):c.isDirectory()?(debug('readdir "%s"',p),void fs.readdir(p,function(r,c){if(r)return t(r);i||(c=removeHidden(c)),a&&(c=c.filter(function(e,n,t){return a(e,n,t,p)})),c.sort();var f=accepts(e),d=f.type(mediaTypes);return d?void serveIndex[mediaType[d]](e,n,c,t,h,m,o,p,l,u,s):t(createError(406))})):t()})}}function createHtmlFileList(e,n,t,r){var a='<ul id="files" class="view-'+escapeHtml(r)+'">'+("details"==r?'<li class="header"><span class="name">Name</span><span class="size">Size</span><span class="date">Modified</span></li>':"");return a+=e.map(function(e){var r=[],a=e.stat&&e.stat.isDirectory(),i=n.split("/").map(function(e){return encodeURIComponent(e)});if(t)if(r.push("icon"),a)r.push("icon-directory");else{var o=extname(e.name),s=iconLookup(e.name);r.push("icon"),r.push("icon-"+o.substring(1)),-1===r.indexOf(s.className)&&r.push(s.className)}i.push(encodeURIComponent(e.name));var u=e.stat&&".."!==e.name?e.stat.mtime.toLocaleDateString()+" "+e.stat.mtime.toLocaleTimeString():"",l=e.stat&&!a?e.stat.size:"";return'<li><a href="'+escapeHtml(normalizeSlashes(normalize(i.join("/"))))+'" class="'+escapeHtml(r.join(" "))+'" title="'+escapeHtml(e.name)+'"><span class="name">'+escapeHtml(e.name)+'</span><span class="size">'+escapeHtml(l)+'</span><span class="date">'+escapeHtml(u)+"</span></a></li>"}).join("\n"),a+="</ul>"}function createHtmlRender(e){return function(n,t){fs.readFile(e,"utf8",function(e,r){if(e)return t(e);var a=r.replace(/\{style\}/g,n.style.concat(iconStyle(n.fileList,n.displayIcons))).replace(/\{files\}/g,createHtmlFileList(n.fileList,n.directory,n.displayIcons,n.viewName)).replace(/\{directory\}/g,escapeHtml(n.directory)).replace(/\{linked-path\}/g,htmlPath(n.directory));t(null,a)})}}function fileSort(e,n){return".."===e.name||".."===n.name?e.name===n.name?0:".."===e.name?-1:1:Number(n.stat&&n.stat.isDirectory())-Number(e.stat&&e.stat.isDirectory())||String(e.name).toLocaleLowerCase().localeCompare(String(n.name).toLocaleLowerCase())}function htmlPath(e){for(var n=e.split("/"),t=new Array(n.length),r=0;r<n.length;r++){var a=n[r];a&&(n[r]=encodeURIComponent(a),t[r]='<a href="'+escapeHtml(n.slice(0,r+1).join("/"))+'">'+escapeHtml(a)+"</a>")}return t.join(" / ")}function iconLookup(e){var n=extname(e);if(icons[n])return{className:"icon-"+n.substring(1),fileName:icons[n]};var t=mime.lookup(n);if(t===!1)return{className:"icon-default",fileName:icons["default"]};if(icons[t])return{className:"icon-"+t.replace("/","-"),fileName:icons[t]};var r=t.split("+")[1];if(r&&icons["+"+r])return{className:"icon-"+r,fileName:icons["+"+r]};var a=t.split("/")[0];return icons[a]?{className:"icon-"+a,fileName:icons[a]}:{className:"icon-default",fileName:icons["default"]}}function iconStyle(e,n){if(!n)return"";var r,a,s,i=[],o={},u={},l="";for(r=0;r<e.length;r++){var c=e[r],f=c.stat&&c.stat.isDirectory(),d=f?{className:"icon-directory",fileName:icons.folder}:iconLookup(c.name),a=d.fileName;s="#files ."+d.className+" .name",o[a]||(o[a]="background-image: url(data:image/png;base64,"+load(a)+");",u[a]=[],i.push(a)),-1===u[a].indexOf(s)&&u[a].push(s)}for(r=0;r<i.length;r++)a=i[r],l+=u[a].join(",\n")+" {\n  "+o[a]+"\n}\n";return l}function load(e){return cache[e]?cache[e]:cache[e]=fs.readFileSync(__dirname+"/public/icons/"+e,"base64")}function normalizeSlashes(e){return e.split(sep).join("/")}function removeHidden(e){return e.filter(function(e){return"."!=e[0]})}function stat(e,n,t){var r=new Batch;r.concurrency(10),n.forEach(function(n){r.push(function(t){fs.stat(join(e,n),function(e,n){return e&&"ENOENT"!==e.code?t(e):void t(null,n||null)})})}),r.end(t)}var accepts=require("accepts"),createError=require("http-errors"),debug=require("debug")("serve-index"),escapeHtml=require("escape-html"),fs=require("fs"),path=require("path"),normalize=path.normalize,sep=path.sep,extname=path.extname,join=path.join,Batch=require("batch"),mime=require("mime-types"),parseUrl=require("parseurl"),resolve=require("path").resolve;module.exports=serveIndex;var cache={},defaultTemplate=join(__dirname,"public","directory.html"),defaultStylesheet=join(__dirname,"public","style.css"),mediaTypes=["text/html","text/plain","application/json"],mediaType={"text/html":"html","text/plain":"plain","application/json":"json"};serveIndex.html=function(e,n,t,r,a,i,o,s,u,l,c){var f="function"!=typeof l?createHtmlRender(l):l;i&&t.unshift(".."),stat(s,t,function(e,i){if(e)return r(e);var l=t.map(function(e,n){return{name:e,stat:i[n]}});l.sort(fileSort),fs.readFile(c,"utf8",function(e,t){if(e)return r(e);var i={directory:a,displayIcons:Boolean(o),fileList:l,path:s,style:t,viewName:u};f(i,function(e,t){if(e)return r(e);var a=new Buffer(t,"utf8");n.setHeader("Content-Type","text/html; charset=utf-8"),n.setHeader("Content-Length",a.length),n.end(a)})})})},serveIndex.json=function(e,n,t){var r=JSON.stringify(t),a=new Buffer(r,"utf8");n.setHeader("Content-Type","application/json; charset=utf-8"),n.setHeader("Content-Length",a.length),n.end(a)},serveIndex.plain=function(e,n,t){var r=t.join("\n")+"\n",a=new Buffer(r,"utf8");n.setHeader("Content-Type","text/plain; charset=utf-8"),n.setHeader("Content-Length",a.length),n.end(a)};var icons={"default":"page_white.png",folder:"folder.png",image:"image.png",text:"page_white_text.png",video:"film.png","+json":"page_white_code.png","+xml":"page_white_code.png","+zip":"box.png","application/font-woff":"font.png","application/javascript":"page_white_code_red.png","application/json":"page_white_code.png","application/msword":"page_white_word.png","application/pdf":"page_white_acrobat.png","application/postscript":"page_white_vector.png","application/rtf":"page_white_word.png","application/vnd.ms-excel":"page_white_excel.png","application/vnd.ms-powerpoint":"page_white_powerpoint.png","application/vnd.oasis.opendocument.presentation":"page_white_powerpoint.png","application/vnd.oasis.opendocument.spreadsheet":"page_white_excel.png","application/vnd.oasis.opendocument.text":"page_white_word.png","application/x-7z-compressed":"box.png","application/x-sh":"application_xp_terminal.png","application/x-font-ttf":"font.png","application/x-msaccess":"page_white_database.png","application/x-shockwave-flash":"page_white_flash.png","application/x-sql":"page_white_database.png","application/x-tar":"box.png","application/x-xz":"box.png","application/xml":"page_white_code.png","application/zip":"box.png","image/svg+xml":"page_white_vector.png","text/css":"page_white_code.png","text/html":"page_white_code.png","text/less":"page_white_code.png",".accdb":"page_white_database.png",".apk":"box.png",".app":"application_xp.png",".as":"page_white_actionscript.png",".asp":"page_white_code.png",".aspx":"page_white_code.png",".bat":"application_xp_terminal.png",".bz2":"box.png",".c":"page_white_c.png",".cab":"box.png",".cfm":"page_white_coldfusion.png",".clj":"page_white_code.png",".cc":"page_white_cplusplus.png",".cgi":"application_xp_terminal.png",".cpp":"page_white_cplusplus.png",".cs":"page_white_csharp.png",".db":"page_white_database.png",".dbf":"page_white_database.png",".deb":"box.png",".dll":"page_white_gear.png",".dmg":"drive.png",".docx":"page_white_word.png",".erb":"page_white_ruby.png",".exe":"application_xp.png",".fnt":"font.png",".gam":"controller.png",".gz":"box.png",".h":"page_white_h.png",".ini":"page_white_gear.png",".iso":"cd.png",".jar":"box.png",".java":"page_white_cup.png",".jsp":"page_white_cup.png",".lua":"page_white_code.png",".lz":"box.png",".lzma":"box.png",".m":"page_white_code.png",".map":"map.png",".msi":"box.png",".mv4":"film.png",".otf":"font.png",".pdb":"page_white_database.png",".php":"page_white_php.png",".pl":"page_white_code.png",".pkg":"box.png",".pptx":"page_white_powerpoint.png",".psd":"page_white_picture.png",".py":"page_white_code.png",".rar":"box.png",".rb":"page_white_ruby.png",".rm":"film.png",".rom":"controller.png",".rpm":"box.png",".sass":"page_white_code.png",".sav":"controller.png",".scss":"page_white_code.png",".srt":"page_white_text.png",".tbz2":"box.png",".tgz":"box.png",".tlz":"box.png",".vb":"page_white_code.png",".vbs":"page_white_code.png",".xcf":"page_white_picture.png",".xlsx":"page_white_excel.png",".yaws":"page_white_code.png"};