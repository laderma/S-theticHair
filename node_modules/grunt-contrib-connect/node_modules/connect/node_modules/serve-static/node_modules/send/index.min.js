"use strict";function send(e,n,t){return new SendStream(e,n,t)}function SendStream(e,n,t){var r=t||{};if(this.options=r,this.path=n,this.req=e,this._etag=void 0!==r.etag?Boolean(r.etag):!0,this._dotfiles=void 0!==r.dotfiles?r.dotfiles:"ignore","ignore"!==this._dotfiles&&"allow"!==this._dotfiles&&"deny"!==this._dotfiles)throw new TypeError('dotfiles option must be "allow", "deny", or "ignore"');this._hidden=Boolean(r.hidden),void 0!==r.hidden&&deprecate("hidden: use dotfiles: '"+(this._hidden?"allow":"ignore")+"' instead"),void 0===r.dotfiles&&(this._dotfiles=void 0),this._extensions=void 0!==r.extensions?normalizeList(r.extensions,"extensions option"):[],this._index=void 0!==r.index?normalizeList(r.index,"index option"):["index.html"],this._lastModified=void 0!==r.lastModified?Boolean(r.lastModified):!0,this._maxage=r.maxAge||r.maxage,this._maxage="string"==typeof this._maxage?ms(this._maxage):Number(this._maxage),this._maxage=isNaN(this._maxage)?0:Math.min(Math.max(0,this._maxage),maxMaxAge),this._root=r.root?resolve(r.root):null,!this._root&&r.from&&this.from(r.from)}function containsDotFile(e){for(var n=0;n<e.length;n++)if("."===e[n][0])return!0;return!1}function decode(e){try{return decodeURIComponent(e)}catch(n){return-1}}function normalizeList(e,n){for(var t=[].concat(e||[]),r=0;r<t.length;r++)if("string"!=typeof t[r])throw new TypeError(n+" must be array of strings or false");return t}var createError=require("http-errors"),debug=require("debug")("send"),deprecate=require("depd")("send"),destroy=require("destroy"),escapeHtml=require("escape-html"),parseRange=require("range-parser"),Stream=require("stream"),mime=require("mime"),fresh=require("fresh"),path=require("path"),fs=require("fs"),normalize=path.normalize,join=path.join,etag=require("etag"),EventEmitter=require("events").EventEmitter,ms=require("ms"),onFinished=require("on-finished"),statuses=require("statuses"),extname=path.extname,maxMaxAge=31536e6,resolve=path.resolve,sep=path.sep,toString=Object.prototype.toString,upPathRegexp=/(?:^|[\\\/])\.\.(?:[\\\/]|$)/;module.exports=send,module.exports.mime=mime;var listenerCount=EventEmitter.listenerCount||function(e,n){return e.listeners(n).length};SendStream.prototype.__proto__=Stream.prototype,SendStream.prototype.etag=deprecate["function"](function(e){return e=Boolean(e),debug("etag %s",e),this._etag=e,this},"send.etag: pass etag as option"),SendStream.prototype.hidden=deprecate["function"](function(e){return e=Boolean(e),debug("hidden %s",e),this._hidden=e,this._dotfiles=void 0,this},"send.hidden: use dotfiles option"),SendStream.prototype.index=deprecate["function"](function t(e){var t=e?normalizeList(e,"paths argument"):[];return debug("index %o",e),this._index=t,this},"send.index: pass index as option"),SendStream.prototype.root=function(e){return e=String(e),this._root=resolve(e),this},SendStream.prototype.from=deprecate["function"](SendStream.prototype.root,"send.from: pass root as option"),SendStream.prototype.root=deprecate["function"](SendStream.prototype.root,"send.root: pass root as option"),SendStream.prototype.maxage=deprecate["function"](function(e){return e="string"==typeof e?ms(e):Number(e),isNaN(e)&&(e=0),1/0==e&&(e=31536e6),debug("max-age %d",e),this._maxage=e,this},"send.maxage: pass maxAge as option"),SendStream.prototype.error=function i(e,i){if(0!==listenerCount(this,"error"))return this.emit("error",createError(i,e,{expose:!1}));var n=this.res,t=statuses[e];n._headers=null,n.statusCode=e,n.setHeader("Content-Type","text/plain; charset=UTF-8"),n.setHeader("Content-Length",Buffer.byteLength(t)),n.setHeader("X-Content-Type-Options","nosniff"),n.end(t)},SendStream.prototype.hasTrailingSlash=function(){return"/"==this.path[this.path.length-1]},SendStream.prototype.isConditionalGET=function(){return this.req.headers["if-none-match"]||this.req.headers["if-modified-since"]},SendStream.prototype.removeContentHeaderFields=function(){for(var e=this.res,n=Object.keys(e._headers||{}),t=0;t<n.length;t++){var r=n[t];"content-"===r.substr(0,8)&&"content-location"!==r&&e.removeHeader(r)}},SendStream.prototype.notModified=function(){var e=this.res;debug("not modified"),this.removeContentHeaderFields(),e.statusCode=304,e.end()},SendStream.prototype.headersAlreadySent=function(){var e=new Error("Can't set headers after they are sent.");debug("headers already sent"),this.error(500,e)},SendStream.prototype.isCachable=function(){var e=this.res;return e.statusCode>=200&&e.statusCode<300||304==e.statusCode},SendStream.prototype.onStatError=function(e){switch(e.code){case"ENAMETOOLONG":case"ENOENT":case"ENOTDIR":this.error(404,e);break;default:this.error(500,e)}},SendStream.prototype.isFresh=function(){return fresh(this.req.headers,this.res._headers)},SendStream.prototype.isRangeFresh=function(){var e=this.req.headers["if-range"];return e?~e.indexOf('"')?~e.indexOf(this.res._headers.etag):Date.parse(this.res._headers["last-modified"])<=Date.parse(e):!0},SendStream.prototype.redirect=function(e){if(0!==listenerCount(this,"directory"))return void this.emit("directory");if(this.hasTrailingSlash())return void this.error(403);var n=e+"/",t='Redirecting to <a href="'+escapeHtml(n)+'">'+escapeHtml(n)+"</a>\n",r=this.res;r.statusCode=301,r.setHeader("Content-Type","text/html; charset=UTF-8"),r.setHeader("Content-Length",Buffer.byteLength(t)),r.setHeader("X-Content-Type-Options","nosniff"),r.setHeader("Location",n),r.end(t)},SendStream.prototype.pipe=function(e){var r=(arguments,this._root);this.res=e;var i=decode(this.path);if(-1===i)return this.error(400);if(~i.indexOf("\x00"))return this.error(400);var a;if(null!==r){if(upPathRegexp.test(normalize("."+sep+i)))return debug('malicious path "%s"',i),this.error(403);i=normalize(join(r,i)),r=normalize(r+sep),a=i.substr(r.length).split(sep)}else{if(upPathRegexp.test(i))return debug('malicious path "%s"',i),this.error(403);a=normalize(i).split(sep),i=resolve(i)}if(containsDotFile(a)){var o=this._dotfiles;switch(void 0===o&&(o="."===a[a.length-1][0]?this._hidden?"allow":"ignore":"allow"),debug('%s dotfile "%s"',o,i),o){case"allow":break;case"deny":return this.error(403);case"ignore":default:return this.error(404)}}return this._index.length&&"/"===this.path[this.path.length-1]?(this.sendIndex(i),e):(this.sendFile(i),e)},SendStream.prototype.send=function(e,n){var t=n.size,r=this.options,i={},a=this.res,o=this.req,s=o.headers.range,u=r.start||0;if(a._header)return this.headersAlreadySent();if(debug('pipe "%s"',e),this.setHeader(e,n),this.type(e),this.isConditionalGET()&&this.isCachable()&&this.isFresh())return this.notModified();if(t=Math.max(0,t-u),void 0!==r.end){var l=r.end-u+1;t>l&&(t=l)}if(s){if(s=parseRange(t,s),this.isRangeFresh()||(debug("range stale"),s=-2),-1==s)return debug("range unsatisfiable"),a.setHeader("Content-Range","bytes */"+n.size),this.error(416);-2!=s&&1===s.length&&(debug("range %j",s),a.statusCode=206,a.setHeader("Content-Range","bytes "+s[0].start+"-"+s[0].end+"/"+t),u+=s[0].start,t=s[0].end-s[0].start+1)}for(var c in r)i[c]=r[c];return i.start=u,i.end=Math.max(u,u+t-1),a.setHeader("Content-Length",t),"HEAD"==o.method?a.end():void this.stream(e,i)},SendStream.prototype.sendFile=function(e){function r(i){if(t._extensions.length<=n)return i?t.onStatError(i):t.error(404);var a=e+"."+t._extensions[n++];debug('stat "%s"',a),fs.stat(a,function(e,n){return e?r(e):n.isDirectory()?r():(t.emit("file",a,n),void t.send(a,n))})}var n=0,t=this;debug('stat "%s"',e),fs.stat(e,function(n,i){return n&&"ENOENT"===n.code&&!extname(e)&&e[e.length-1]!==sep?r(n):n?t.onStatError(n):i.isDirectory()?t.redirect(t.path):(t.emit("file",e,i),void t.send(e,i))})},SendStream.prototype.sendIndex=function(e){function r(i){if(++n>=t._index.length)return i?t.onStatError(i):t.error(404);var a=join(e,t._index[n]);debug('stat "%s"',a),fs.stat(a,function(e,n){return e?r(e):n.isDirectory()?r():(t.emit("file",a,n),void t.send(a,n))})}var n=-1,t=this;r()},SendStream.prototype.stream=function(e,n){var t=!1,r=this,i=this.res,o=(this.req,fs.createReadStream(e,n));this.emit("stream",o),o.pipe(i),onFinished(i,function(){t=!0,destroy(o)}),o.on("error",function(e){t||(t=!0,destroy(o),r.onStatError(e))}),o.on("end",function(){r.emit("end")})},SendStream.prototype.type=function(e){var n=this.res;if(!n.getHeader("Content-Type")){var t=mime.lookup(e),r=mime.charsets.lookup(t);debug("content-type %s",t),n.setHeader("Content-Type",t+(r?"; charset="+r:""))}},SendStream.prototype.setHeader=function(e,n){var t=this.res;if(this.emit("headers",t,e,n),t.getHeader("Accept-Ranges")||t.setHeader("Accept-Ranges","bytes"),t.getHeader("Cache-Control")||t.setHeader("Cache-Control","public, max-age="+Math.floor(this._maxage/1e3)),this._lastModified&&!t.getHeader("Last-Modified")){var r=n.mtime.toUTCString();debug("modified %s",r),t.setHeader("Last-Modified",r)}if(this._etag&&!t.getHeader("ETag")){var i=etag(n);debug("etag %s",i),t.setHeader("ETag",i)}};