function parseAccept(e){for(var n=splitMediaTypes(e),t=0,r=0;t<n.length;t++){var i=parseMediaType(n[t].trim(),t);i&&(n[r++]=i)}return n.length=r,n}function parseMediaType(e,n){var t=e.match(/\s*(\S+?)\/([^;\s]+)\s*(?:;(.*))?/);if(!t)return null;var r=t[1],i=t[2],a=""+r+"/"+i,o={},s=1;return t[3]&&(o=t[3].split(";").map(function(e){return e.trim().split("=")}).reduce(function(e,n){var t=n[0].toLowerCase(),r=n[1];return e[t]=r&&'"'===r[0]&&'"'===r[r.length-1]?r.substr(1,r.length-2):r,e},o),null!=o.q&&(s=parseFloat(o.q),delete o.q)),{type:r,subtype:i,params:o,q:s,i:n,full:a}}function getMediaTypePriority(e,n,t){for(var r={o:-1,q:0,s:0},i=0;i<n.length;i++){var a=specify(e,n[i],t);a&&(r.s-a.s||r.q-a.q||r.o-a.o)<0&&(r=a)}return r}function specify(e,n,t){var r=parseMediaType(e),i=0;if(!r)return null;if(n.type.toLowerCase()==r.type.toLowerCase())i|=4;else if("*"!=n.type)return null;if(n.subtype.toLowerCase()==r.subtype.toLowerCase())i|=2;else if("*"!=n.subtype)return null;var a=Object.keys(n.params);if(a.length>0){if(!a.every(function(e){return"*"==n.params[e]||(n.params[e]||"").toLowerCase()==(r.params[e]||"").toLowerCase()}))return null;i|=1}return{i:t,o:n.i,q:n.q,s:i}}function preferredMediaTypes(e,n){var t=parseAccept(void 0===e?"*/*":e||"");if(!n)return t.filter(isQuality).sort(compareSpecs).map(function(e){return e.full});var r=n.map(function(e,n){return getMediaTypePriority(e,t,n)});return r.filter(isQuality).sort(compareSpecs).map(function(e){return n[r.indexOf(e)]})}function compareSpecs(e,n){return n.q-e.q||n.s-e.s||e.o-n.o||e.i-n.i||0}function isQuality(e){return e.q>0}function quoteCount(e){for(var n=0,t=0;-1!==(t=e.indexOf('"',t));)n++,t++;return n}function splitMediaTypes(e){for(var n=e.split(","),t=1,r=0;t<n.length;t++)quoteCount(n[r])%2==0?n[++r]=n[t]:n[r]+=","+n[t];return n.length=r+1,n}module.exports=preferredMediaTypes,preferredMediaTypes.preferredMediaTypes=preferredMediaTypes;