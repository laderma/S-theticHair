"use strict";function escapeHtmlBlock(e){return escapeHtml(e).replace(doubleSpaceGlobalRegExp," &nbsp;").replace(newLineGlobalRegExp,"<br>")}function stringify(e){var n=e.stack;if(n)return String(n);var t=String(e);return t===toString.call(e)?inspect(e):t}function logerror(e,n){console.error(n)}var accepts=require("accepts"),escapeHtml=require("escape-html"),fs=require("fs"),util=require("util"),doubleSpaceGlobalRegExp=/  /g,inspect=util.inspect,newLineGlobalRegExp=/\n/g,toString=Object.prototype.toString,defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};exports=module.exports=function(e){var n=process.env.NODE_ENV||"development",t=e||{},r=void 0===t.log?"test"!==n:t.log;if("function"!=typeof r&&"boolean"!=typeof r)throw new TypeError("option log must be function or boolean");return r===!0&&(r=logerror),function(e,n,t,a){e.statusCode&&(t.statusCode=e.statusCode),e.status&&(t.statusCode=e.status),t.statusCode<400&&(t.statusCode=500);var i=stringify(e);if(r&&defer(r,e,i,n,t),t._header)return n.socket.destroy();var o=accepts(n),s=o.type("html","json","text");if(t.setHeader("X-Content-Type-Options","nosniff"),"html"===s)fs.readFile(__dirname+"/public/style.css","utf8",function(n,r){return n?a(n):void fs.readFile(__dirname+"/public/error.html","utf8",function(n,o){if(n)return a(n);var s=!e.stack&&String(e)===toString.call(e),u=s?"Error":escapeHtmlBlock(i.split("\n",1)[0]||"Error"),l=s?[i]:String(i).split("\n").slice(1),c=l.map(function(e){return"<li>"+escapeHtmlBlock(e)+"</li>"}).join(""),f=o.replace("{style}",r).replace("{stack}",c).replace("{title}",escapeHtml(exports.title)).replace("{statusCode}",t.statusCode).replace(/\{error\}/g,u);t.setHeader("Content-Type","text/html; charset=utf-8"),t.end(f)})});else if("json"===s){var u={message:e.message,stack:e.stack};for(var l in e)u[l]=e[l];var c=JSON.stringify({error:u});t.setHeader("Content-Type","application/json; charset=utf-8"),t.end(c)}else t.setHeader("Content-Type","text/plain; charset=utf-8"),t.end(i)}},exports.title="Connect";