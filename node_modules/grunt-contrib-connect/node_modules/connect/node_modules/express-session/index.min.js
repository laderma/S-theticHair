function session(e){var e=e||{},n=e.name||e.key||"connect.sid",t=e.store||new MemoryStore,r=e.cookie||{},i=e.proxy,a=!0,o=e.rolling||!1,s=e.resave,u=e.saveUninitialized,l=e.secret,c=e.genid||generateSessionId;if("function"!=typeof c)throw new TypeError("genid option must be a function");if(void 0===s&&(deprecate("undefined resave option; provide resave option"),s=!0),void 0===u&&(deprecate("undefined saveUninitialized option; provide saveUninitialized option"),u=!0),e.unset&&"destroy"!==e.unset&&"keep"!==e.unset)throw new TypeError('unset option must be "destroy" or "keep"');var f="destroy"===e.unset;if(Array.isArray(l)&&0===l.length)throw new TypeError("secret option array must contain one or more strings");l&&!Array.isArray(l)&&(l=[l]),l||deprecate("req.secret; provide secret option"),"production"==env&&t instanceof MemoryStore&&console.warn(warning),t.generate=function(e){e.sessionID=c(e),e.session=new Session(e),e.session.cookie=new Cookie(r)};var d="function"==typeof t.touch;return t.on("disconnect",function(){a=!1}),t.on("connect",function(){a=!0}),function(e,c,h){function S(){t.generate(e),v=e.sessionID,g=hash(e.session),x(e.session)}function x(e){function t(){debug("saving %s",this.id),b=hash(this),n.apply(this,arguments)}var n=e.save;Object.defineProperty(e,"save",{configurable:!0,enumerable:!1,value:t,writable:!0})}function T(e){return v!==e.id||g!==hash(e)}function M(e){return v===e.id&&b===hash(e)}function E(e){return e.sessionID&&f&&null==e.session}function A(e){return"string"!=typeof e.sessionID?(debug("session ignored because of bogus req.sessionID %o",e.sessionID),!1):u||_===e.sessionID?!M(e.session):T(e.session)}function L(e){return"string"!=typeof e.sessionID?(debug("session ignored because of bogus req.sessionID %o",e.sessionID),!1):_===e.sessionID&&!A(e)}function D(e){return"string"!=typeof e.sessionID?!1:o?!0:_!=e.sessionID?u||T(e.session):null!=e.session.cookie.expires&&T(e.session)}if(e.session)return h();if(!a)return debug("store is disconnected"),h();var p=parseUrl.original(e).pathname;if(0!=p.indexOf(r.path||"/"))return h();if(!l&&!e.secret)return void h(new Error("secret option required for sessions"));var g,v,b,m=l||[e.secret];e.sessionStore=t;var _=e.sessionID=getcookie(e,n,m);onHeaders(c,function(){if(!e.session)return void debug("no session");var t=e.session.cookie;return t.secure&&!issecure(e,i)?void debug("not secured"):void(D(e)&&setcookie(c,n,e.sessionID,m[0],t.data))});var y=c.end,k=c.write,w=!1;return c.end=function(n,r){function o(){return a?(i=y.call(c,n,r),void(a=!1)):void y.call(c)}function s(){if(!a)return i;if(null==n)return i=!0;var e=Number(c.getHeader("Content-Length"));return!isNaN(e)&&e>0&&(n=Buffer.isBuffer(n)?n:new Buffer(n,r),r=void 0,0!==n.length)?(debug("split response"),i=k.call(c,n.slice(0,n.length-1)),n=n.slice(n.length-1,n.length),i):(i=k.call(c,n,r),a=!1,i)}if(w)return!1;w=!0;var i,a=!0;return E(e)?(debug("destroying"),t.destroy(e.sessionID,function(e){e&&defer(h,e),debug("destroyed"),o()}),s()):e.session?(e.session.touch(),A(e)?(e.session.save(function(e){e&&defer(h,e),o()}),s()):d&&L(e)?(debug("touching"),t.touch(e.sessionID,e.session,function(e){e&&defer(h,e),debug("touched"),o()}),s()):y.call(c,n,r)):(debug("no session"),y.call(c,n,r))},e.sessionID?(debug("fetching %s",e.sessionID),void t.get(e.sessionID,function(n,r){if(n){if(debug("error %j",n),"ENOENT"!==n.code)return void h(n);S()}else r?(debug("session found"),t.createSession(e,r),v=e.sessionID,g=hash(r),s||(b=g),x(e.session)):(debug("no session found"),S());h()})):(debug("no SID sent, generating session"),S(),void h())}}function generateSessionId(e){return uid(24)}function getcookie(e,n,t){var i,a,r=e.headers.cookie;if(r){var o=cookie.parse(r);i=o[n],i&&("s:"===i.substr(0,2)?(a=unsigncookie(i.slice(2),t),a===!1&&(debug("cookie signature invalid"),a=void 0)):debug("cookie unsigned"))}return!a&&e.signedCookies&&(a=e.signedCookies[n],a&&deprecate("cookie should be available in req.headers.cookie")),!a&&e.cookies&&(i=e.cookies[n],i&&("s:"===i.substr(0,2)?(a=unsigncookie(i.slice(2),t),a&&deprecate("cookie should be available in req.headers.cookie"),a===!1&&(debug("cookie signature invalid"),a=void 0)):debug("cookie unsigned"))),a}function hash(e){return crc(JSON.stringify(e,function(e,n){return"cookie"!==e?n:void 0}))}function issecure(e,n){if(e.connection&&e.connection.encrypted)return!0;if(n===!1)return!1;if(n!==!0){var t=e.secure;return"boolean"==typeof t?t:!1}var r=e.headers["x-forwarded-proto"]||"",i=r.indexOf(","),a=-1!==i?r.substr(0,i).toLowerCase().trim():r.toLowerCase().trim();return"https"===a}function setcookie(e,n,t,r,i){var a="s:"+signature.sign(t,r),o=cookie.serialize(n,a,i);debug("set-cookie %s",o);var s=e.getHeader("set-cookie")||[],u=Array.isArray(s)?s.concat(o):Array.isArray(o)?[s].concat(o):[s,o];e.setHeader("set-cookie",u)}function unsigncookie(e,n){for(var t=0;t<n.length;t++){var r=signature.unsign(e,n[t]);if(r!==!1)return r}return!1}var cookie=require("cookie"),crc=require("crc").crc32,debug=require("debug")("express-session"),deprecate=require("depd")("express-session"),parseUrl=require("parseurl"),uid=require("uid-safe").sync,onHeaders=require("on-headers"),signature=require("cookie-signature"),Session=require("./session/session"),MemoryStore=require("./session/memory"),Cookie=require("./session/cookie"),Store=require("./session/store"),env=process.env.NODE_ENV;exports=module.exports=session,exports.Store=Store,exports.Cookie=Cookie,exports.Session=Session,exports.MemoryStore=MemoryStore;var warning="Warning: connect.session() MemoryStore is not\ndesigned for a production environment, as it will leak\nmemory, and will not scale past a single process.",defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};