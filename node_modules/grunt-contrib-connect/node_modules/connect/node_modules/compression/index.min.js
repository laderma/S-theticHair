"use strict";function compression(e){var n=e||{},t=n.filter||shouldCompress,r=bytes.parse(n.threshold);return null==r&&(r=1024),function(e,a,i){function h(e){debug("no compression: %s",e),addListeners(a,c,u),u=null}var s,d,o=!1,u=[],l=a.write,c=a.on,f=a.end;a.flush=function(){d&&d.flush()},a.write=function(e,n){return o?!1:(this._header||this._implicitHeader(),d?d.write(new Buffer(e,n)):l.call(this,e,n))},a.end=function(e,n){return o?!1:(this._header||(this.getHeader("Content-Length")||(s=chunkLength(e,n)),this._implicitHeader()),d?(o=!0,e?d.end(new Buffer(e,n)):d.end()):f.call(this,e,n))},a.on=function(e,n){return u&&"drain"===e?d?d.on(e,n):(u.push([e,n]),this):c.call(this,e,n)},onHeaders(a,function(){if(!t(e,a))return void h("filtered");if(vary(a,"Accept-Encoding"),Number(a.getHeader("Content-Length"))<r||r>s)return void h("size below threshold");var i=a.getHeader("Content-Encoding")||"identity";if("identity"!==i)return void h("already encoded");if("HEAD"===e.method)return void h("HEAD request");var o=accepts(e),p=o.encoding(["gzip","deflate","identity"]);return"deflate"===p&&o.encoding(["gzip"])&&(p=o.encoding(["gzip","identity"])),p&&"identity"!==p?(debug("%s compression",p),d="gzip"===p?zlib.createGzip(n):zlib.createDeflate(n),addListeners(d,d.on,u),a.setHeader("Content-Encoding",p),a.removeHeader("Content-Length"),d.on("data",function(e){l.call(a,e)===!1&&d.pause()}),d.on("end",function(){f.call(a)}),void c.call(a,"drain",function(){d.resume()})):void h("not acceptable")}),i()}}function addListeners(e,n,t){for(var r=0;r<t.length;r++)n.apply(e,t[r])}function chunkLength(e,n){return e?Buffer.isBuffer(e)?e.length:Buffer.byteLength(e,n):0}function shouldCompress(e,n){var t=n.getHeader("Content-Type");return void 0!==t&&compressible(t)?!0:(debug("%s not compressible",t),!1)}var accepts=require("accepts"),bytes=require("bytes"),compressible=require("compressible"),debug=require("debug")("compression"),onHeaders=require("on-headers"),vary=require("vary"),zlib=require("zlib");module.exports=compression,module.exports.filter=shouldCompress;