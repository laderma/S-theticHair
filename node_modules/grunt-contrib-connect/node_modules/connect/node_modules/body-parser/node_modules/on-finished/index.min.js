"use strict";function onFinished(e,n){return isFinished(e)!==!1?(defer(n,null,e),e):(attachListener(e,n),e)}function isFinished(e){var n=e.socket;return"boolean"==typeof e.finished?Boolean(e.finished||n&&!n.writable):"boolean"==typeof e.complete?Boolean(e.upgrade||!n||!n.readable||e.complete&&!e.readable):void 0}function attachFinishedListener(e,n){function a(e){t.cancel(),r.cancel(),i=!0,n(e)}function o(n){e.removeListener("socket",o),i||t===r&&(r=first([[n,"error","close"]],a))}var t,r,i=!1;return t=r=first([[e,"end","finish"]],a),e.socket?void o(e.socket):(e.on("socket",o),void(void 0===e.socket&&patchAssignSocket(e,o)))}function attachListener(e,n){var t=e.__onFinished;t&&t.queue||(t=e.__onFinished=createListener(e),attachFinishedListener(e,t)),t.queue.push(n)}function createListener(e){function n(t){if(e.__onFinished===n&&(e.__onFinished=null),n.queue){var r=n.queue;n.queue=null;for(var i=0;i<r.length;i++)r[i](t,e)}}return n.queue=[],n}function patchAssignSocket(e,n){var t=e.assignSocket;"function"==typeof t&&(e.assignSocket=function(e){t.call(this,e),n(e)})}module.exports=onFinished,module.exports.isFinished=isFinished;var first=require("ee-first"),defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};