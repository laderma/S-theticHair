"use strict";function getDecoder(e){if(!e)return null;try{return iconv.getDecoder(e)}catch(n){throw makeError("specified encoding unsupported","encoding.unsupported",{encoding:e,status:415,statusCode:415})}}function getRawBody(e,n,t){var r=t,i=n||{};if((n===!0||"string"==typeof n)&&(i={encoding:n}),"function"==typeof n&&(r=n,i={}),void 0!==r&&"function"!=typeof r)throw new TypeError("argument callback must be a function");if(!r&&!global.Promise)throw new TypeError("argument callback is required");var a=i.encoding!==!0?i.encoding:"utf-8",o=bytes.parse(i.limit),s=null==i.length||isNaN(i.length)?null:parseInt(i.length,10);return r?readStream(e,a,s,o,r):new Promise(function(n,t){readStream(e,a,s,o,function(e,r){return e?t(e):void n(r)})})}function halt(e){unpipe(e),"function"==typeof e.pause&&e.pause()}function makeError(e,n,t){var r=new Error;Error.captureStackTrace(r,makeError);for(var i in t)r[i]=t[i];return r.message=e,Object.defineProperty(r,"type",{value:n,enumerable:!0,writable:!0,configurable:!0}),r}function readStream(e,n,t,r,i){function c(n){h(),n&&halt(e),i.apply(this,arguments)}function f(){c(makeError("request aborted","request.aborted",{code:"ECONNABORTED",expected:t,length:t,received:s,status:400,statusCode:400}))}function d(e){s+=e.length,u?l+=u.write(e):l.push(e),null!==r&&s>r&&c(makeError("request entity too large","entity.too.large",{limit:r,received:s,status:413,statusCode:413}))}function p(e){if(e)return c(e);if(null!==t&&s!==t)c(makeError("request size did not match content length","request.size.invalid",{expected:t,length:t,received:s,status:400,statusCode:400}));else{var n=u?l+(u.end()||""):Buffer.concat(l);h(),c(null,n)}}function h(){s=l=null,e.removeListener("aborted",f),e.removeListener("data",d),e.removeListener("end",p),e.removeListener("error",p),e.removeListener("close",h)}if(null!==r&&null!==t&&t>r){var a=makeError("request entity too large","entity.too.large",{expected:t,length:t,limit:r,status:413,statusCode:413});return process.nextTick(function(){c(a)})}var o=e._readableState;if(e._decoder||o&&(o.encoding||o.decoder)){var a=makeError("stream encoding should not be set","stream.encoding.set",{status:500,statusCode:500});return process.nextTick(function(){c(a)})}var u,s=0;try{u=getDecoder(n)}catch(a){return process.nextTick(function(){c(a)})}var l=u?"":[];e.on("aborted",f),e.on("data",d),e.once("end",p),e.once("error",p),e.once("close",h)}var bytes=require("bytes"),iconv=require("iconv-lite"),unpipe=require("unpipe");module.exports=getRawBody;