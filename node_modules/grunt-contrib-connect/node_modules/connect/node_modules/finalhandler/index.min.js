"use strict";function finalhandler(e,n,t){var r=t||{},i=r.env||process.env.NODE_ENV||"development",a=r.onerror;return function(t){var r=n.statusCode;if(!t&&n._header)return void debug("cannot 404 after headers sent");if(t){t.statusCode&&(r=t.statusCode),t.status&&(r=t.status),(!r||400>r)&&(r=500);var o="production"===i?http.STATUS_CODES[r]:t.stack||t.toString();o=escapeHtml(o).replace(/\n/g,"<br>").replace(/  /g," &nbsp;")+"\n"}else r=404,o="Cannot "+escapeHtml(e.method)+" "+escapeHtml(e.originalUrl||e.url)+"\n";return debug("default %s",r),t&&a&&defer(a,t,e,n),n._header?e.socket.destroy():void send(e,n,r,o)}}function send(e,n,t,r){function i(){return n.statusCode=t,n.setHeader("X-Content-Type-Options","nosniff"),n.setHeader("Content-Type","text/html; charset=utf-8"),n.setHeader("Content-Length",Buffer.byteLength(r,"utf8")),"HEAD"===e.method?void n.end():void n.end(r,"utf8")}return isFinished(e)?void i():(unpipe(e),onFinished(e,i),void e.resume())}var debug=require("debug")("finalhandler"),escapeHtml=require("escape-html"),http=require("http"),onFinished=require("on-finished"),unpipe=require("unpipe"),defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))},isFinished=onFinished.isFinished;module.exports=finalhandler;