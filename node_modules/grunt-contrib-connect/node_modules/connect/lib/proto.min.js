function logerror(e){"test"!==env&&console.error(e.stack||e.toString())}var finalhandler=require("finalhandler"),http=require("http"),debug=require("debug")("connect:dispatcher"),parseUrl=require("parseurl"),app=module.exports={},env=process.env.NODE_ENV||"development",defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};app.use=function(e,n){if("string"!=typeof e&&(n=e,e="/"),"function"==typeof n.handle){var t=n;n.route=e,n=function(e,n,r){t.handle(e,n,r)}}return n instanceof http.Server&&(n=n.listeners("request")[0]),"/"==e[e.length-1]&&(e=e.slice(0,-1)),debug("use %s %s",e||"/",n.name||"anonymous"),this.stack.push({route:e,handle:n}),this},app.handle=function(e,n,t){function f(t){var a,i,h;if(u&&(e.url=e.url.substr(1),u=!1),e.url=o+l+e.url.substr(o.length),e.originalUrl=e.originalUrl||e.url,l="",a=r[c++],!a)return void defer(d,t);try{if(i=parseUrl(e).pathname,void 0==i&&(i="/"),0!=i.toLowerCase().indexOf(a.route.toLowerCase()))return f(t);if(h=i[a.route.length],h&&"/"!=h&&"."!=h)return f(t);l=a.route,e.url=o+e.url.substr(o.length+l.length),s||"/"==e.url[0]||(e.url="/"+e.url,u=!0),debug("%s %s : %s",a.handle.name||"anonymous",a.route,e.originalUrl);var p=a.handle.length;t?4===p?a.handle(t,e,n,f):f(t):4>p?a.handle(e,n,f):f()}catch(m){f(m)}}var r=this.stack,a=e.url.indexOf("?"),i=-1!==a?a:e.url.length,s="/"!==e.url[0]&&1+e.url.substr(0,i).indexOf("://"),o=s?e.url.substr(0,e.url.indexOf("/",2+s)):"",l="",u=!1,c=0,d=t||finalhandler(e,n,{env:env,onerror:logerror});f()},app.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};