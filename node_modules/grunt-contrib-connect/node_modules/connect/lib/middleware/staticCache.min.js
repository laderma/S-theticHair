function respondFromCache(e,n,t){function o(){for(;i.length;)if(!1===n.write(i.shift()))return void n.once("drain",o);n.end()}var r=t[0],a=merge({},t[1]),i=t.slice(2);switch(a.age=(new Date-new Date(a.date))/1e3||0,e.method){case"HEAD":n.writeHead(r,a),n.end();break;case"GET":fresh(e.headers,a)?(a["content-length"]=0,n.writeHead(304,a),n.end()):(n.writeHead(r,a),o());break;default:n.writeHead(500,""),n.end()}}function mustRevalidate(e,n){var t=n[1],r=utils.parseCacheControl(e.headers["cache-control"]||""),a=utils.parseCacheControl(t["cache-control"]||""),i=(new Date-new Date(t.date))/1e3||0;return a["no-cache"]||a["must-revalidate"]||a["proxy-revalidate"]?!0:r["no-cache"]?!0:null!=r["max-age"]?r["max-age"]<i:null!=a["max-age"]?a["max-age"]<i:!1}function cacheKey(e){return parseurl(e).path}var deprecate=require("depd")("connect"),utils=require("../utils"),parseurl=require("parseurl"),Cache=require("../cache"),fresh=require("fresh"),merge=require("utils-merge");module.exports=function(e){var e=e||{},n=new Cache(e.maxObjects||128),t=e.maxLength||262144;return function(e,r,a){var i=cacheKey(e),o=e.headers.range,s=e.headers.cookie,u=n.get(i);e.on("static",function(e){var l,a=r._headers,o=utils.parseCacheControl(a["cache-control"]||""),u=a["content-length"];if(a["set-cookie"])return s=!0;if(!s&&u&&!(u>t)&&!a["content-range"]&&!(o["no-cache"]||o["no-store"]||o["private"]||o["must-revalidate"])){if(l=n.get(i)){if(a.etag==l[0].etag)return void(l[0].date=new Date);n.remove(i)}if(null!=e){var c=[];e.on("data",function(e){c.push(e)}),e.on("end",function(){var e=n.add(i);delete a["x-cache"],e.push(200),e.push(a),e.push.apply(e,c)})}}}),"GET"==e.method||"HEAD"==e.method?o?a():s||!u||mustRevalidate(e,u)?(r.setHeader("X-Cache","MISS"),a()):(r.setHeader("X-Cache","HIT"),respondFromCache(e,r,u)):a()}},module.exports=deprecate["function"](module.exports,"staticCache: use varnish or similar reverse proxy caches");