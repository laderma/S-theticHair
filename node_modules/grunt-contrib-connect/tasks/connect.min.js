"use strict";module.exports=function(n){var e=require("path"),t=require("connect"),r=require("http"),a=require("https"),i=require("connect-livereload"),s=require("opn"),o=require("portscanner"),l=require("async"),u=require("util"),c=30,h=function(n,e){var t=[];Array.isArray(e.base)||(e.base=[e.base]);var r={},a=e.directory||e.base[e.base.length-1];return e.base.forEach(function(e){var a=e.path||e,i=e.options||r;t.push(n["static"](a,i))}),t.push(n.directory(a.path||a)),t};n.registerMultiTask("connect","Start a connect web server.",function(){var d=this.async(),f=this.options({protocol:"http",port:8e3,hostname:"0.0.0.0",base:".",directory:null,keepalive:!1,debug:!1,livereload:!1,open:!1,useAvailablePort:!1,onCreateServer:null,middleware:null});"http"!==f.protocol&&"https"!==f.protocol&&n.fatal("protocol option must be 'http' or 'https'"),Array.isArray(f.base)?f.base=f.base.map(function(n){return n.path?(n.path=e.resolve(n.path),n):e.resolve(n)}):f.base.path?f.base.path=e.resolve(f.base.path):f.base=e.resolve(f.base),"*"===f.hostname&&(f.hostname=""),"?"===f.port&&(f.port=0),f.onCreateServer&&!Array.isArray(f.onCreateServer)&&(f.onCreateServer=[f.onCreateServer]);var g;f.middleware instanceof Array?g=f.middleware:(g=h.call(this,t,f),"function"==typeof f.middleware&&(g=f.middleware.call(this,t,f,g))),(n.option("debug")||f.debug===!0)&&(t.logger.format("grunt","[D] server :method :url :status :res[content-length] - :response-time ms".magenta),g.unshift(t.logger("grunt")));var p=this.target,m=this.flags.keepalive||f.keepalive;l.waterfall([function(n){f.livereload!==!1?(f.livereload===!0&&(f.livereload=35729),g.unshift(i({port:f.livereload})),n(null)):n(null)},function(){var i=t(),l=null;g.forEach(function(n){u.isArray(n)||(n=[n]),i.use.apply(i,n)}),l="https"===f.protocol?a.createServer({key:f.key||n.file.read(e.join(__dirname,"certs","server.key")).toString(),cert:f.cert||n.file.read(e.join(__dirname,"certs","server.crt")).toString(),ca:f.ca||n.file.read(e.join(__dirname,"certs","ca.crt")).toString(),passphrase:f.passphrase||"grunt"},i):r.createServer(i),f.onCreateServer&&f.onCreateServer.forEach(function(n){n.call(null,l,t,f)}),o.findAPortNotInUse(f.port,f.port+c,f.hostname,function(e,t){f.port!==t&&f.useAvailablePort===!1&&n.fatal("Port "+f.port+" is already in use by another process."),l.listen(t,f.hostname).on("listening",function(){var e=l.address(),t=f.hostname||"0.0.0.0",r=f.protocol+"://"+t+":"+e.port;n.log.writeln("Started connect web server on "+r),n.config.set("connect."+p+".options.hostname",t),n.config.set("connect."+p+".options.port",e.port),n.event.emit("connect."+p+".listening",t,e.port),f.open===!0?s(r):"object"==typeof f.open?(f.open.target=f.open.target||r,f.open.appName=f.open.appName||null,f.open.callback=f.open.callback||function(){},s(f.open.target,f.open.appName,f.open.callback)):"string"==typeof f.open&&s(f.open),m||d()}).on("error",function(e){"EADDRINUSE"===e.code?n.fatal("Port "+t+" is already in use by another process."):n.fatal(e)})}),m&&n.log.write("Waiting forever...\n")}])})};