"use strict";var path=require("path"),chalk=require("chalk"),maxmin=require("maxmin"),getSourceMapLocation=function(n){var e=path.extname(n),t=path.dirname(n),r=path.basename(n,e);return t+path.sep+r+".map"},relativePath=function(n,e){var t=path.dirname(n),r=path.dirname(e);return t!==r?path.relative(t,r)+path.sep:""};module.exports=function(n){var e=require("./lib/uglify").init(n);n.registerMultiTask("uglify","Minify files with UglifyJS.",function(){var i,s,t=this.options({banner:"",footer:"",compress:{warnings:!1},mangle:{},beautify:!1,report:"min"}),r=t.banner,a=t.footer;this.files.forEach(function(o){var l=o.src.filter(function(e){return n.file.exists(e)?!0:(n.log.warn("Source file "+chalk.cyan(e)+" not found."),!1)});if(0===l.length)return void n.log.warn("Destination "+chalk.cyan(o.dest)+" not written because src files were empty.");if("function"==typeof t.sourceMapName&&(i=t.sourceMapName),"function"==typeof t.sourceMapIn&&(1!==l.length&&n.fail.warn("Cannot generate `sourceMapIn` for multiple source files."),s=t.sourceMapIn),i)try{t.generatedSourceMapName=i(o.dest)}catch(u){var c=new Error("SourceMap failed.");c.origError=u,n.fail.warn(c)}else t.sourceMapName?t.generatedSourceMapName=t.sourceMapName:t.generatedSourceMapName=getSourceMapLocation(o.dest);if(s)try{t.sourceMapIn=s(l[0])}catch(u){var c=new Error("SourceMapInName failed.");c.origError=u,n.fail.warn(c)}if(t.sourceMap){var h=relativePath(o.dest,t.generatedSourceMapName),d=path.basename(t.generatedSourceMapName);t.destToSourceMap=h+d}var f;try{f=e.minify(l,o.dest,t)}catch(u){console.log(u);var c=new Error("Uglification failed.");u.message&&(c.message+="\n"+u.message+". \n",u.line&&(c.message+="Line "+u.line+" in "+l+"\n")),c.origError=u,n.log.warn("Uglifying source "+chalk.cyan(l)+" failed."),n.fail.warn(c)}var g=f.min+a;t.sourceMap||(g=r+g),n.file.write(o.dest,g),t.sourceMap&&(n.file.write(t.generatedSourceMapName,f.sourceMap),n.log.writeln("File "+chalk.cyan(t.generatedSourceMapName)+" created (source map).")),n.log.writeln("File "+chalk.cyan(o.dest)+" created: "+maxmin(f.max,g,"gzip"===t.report))})})};