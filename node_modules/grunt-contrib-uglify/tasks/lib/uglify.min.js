"use strict";var path=require("path"),UglifyJS=require("uglify-js"),fs=require("fs");exports.init=function(e){var n={};n.minify=function(n,r,a){a=a||{},e.verbose.write("Minifying with UglifyJS...");var i=null,s="",o={},l=t(a,r),u=UglifyJS.OutputStream(l);if(n.forEach(function(n){var t=e.file.read(n);s+=t;var r=path.basename(n),l=path.dirname(n),u=path.dirname(a.generatedSourceMapName),c=path.relative(u,l),d=c?c+path.sep:"";n=d+r,o[n]=t,i=UglifyJS.parse(t,{filename:n,toplevel:i})}),a.wrap&&(i=i.wrap_commonjs(a.wrap,a.exportAll)),a.enclose){var c=e.util._.map(a.enclose,function(e,n){return n+":"+e});i=i.wrap_enclose(c)}if(i.figure_out_scope(),a.compress!==!1){a.compress.warnings!==!0&&(a.compress.warnings=!1);var d=UglifyJS.Compressor(a.compress);i=i.transform(d),i.figure_out_scope()}if(a.mangle!==!1&&i.mangle_names(a.mangle),a.sourceMap&&a.sourceMapIncludeSources)for(var f in o)o.hasOwnProperty(f)&&l.source_map.get().setSourceContent(f,o[f]);i.print(u);var h=u.get();a.sourceMap&&(h+="\n//# sourceMappingURL="+a.destToSourceMap);var p={max:s,min:h,sourceMap:l.source_map};return e.verbose.ok(),p};var t=function(n,t){var r={beautify:!1,source_map:null};if(n.preserveComments&&("all"===n.preserveComments||n.preserveComments===!0?r.comments=!0:"some"===n.preserveComments?r.comments=/^!|@preserve|@license|@cc_on/i:e.util._.isFunction(n.preserveComments)&&(r.comments=n.preserveComments)),n.banner&&n.sourceMap&&(r.preamble=n.banner),n.beautify&&(e.util._.isObject(n.beautify)?e.util._.extend(r,n.beautify):r.beautify=!0),n.sourceMap){var s,a=path.basename(t);path.dirname(t);n.sourceMapIn&&(s=e.file.readJSON(n.sourceMapIn)),r.source_map=UglifyJS.SourceMap({file:a,orig:s})}return void 0!==n.indentLevel&&(r.indent_level=n.indentLevel),r};return n};