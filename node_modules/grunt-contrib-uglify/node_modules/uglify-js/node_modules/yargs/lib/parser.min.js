var camelCase=require("camelcase"),fs=require("fs"),path=require("path");module.exports=function(e,n){function g(e,t,r){var i=x(t,n.narg);if(r.length-(e+1)<i)throw Error("not enough arguments following: "+t);for(var a=e+1;i+e+1>a;a++)v(t,r[a]);return e+i}function v(e,n){if((x(e,t.bools)||x(e,t.counts))&&"string"==typeof n&&(n="true"===n),/-/.test(e)&&(!r[e]||!r[e].length)){var a=camelCase(e);r[e]=[a],i[a]=!0}var s=!x(e,t.strings)&&E(n)?Number(n):n;x(e,t.counts)&&(s=function(e){return void 0!==e?e+1:0});var u=e.split(".");w(o,u,s),(r[u[0]]||[]).forEach(function(e){if(e=e.split("."),u.length>1){var n=[].concat(u);n.shift(),e=e.concat(n)}w(o,e,s)});for(var l=[e].concat(r[e]||[]),c=0,f=l.length;f>c;c++)if(t.normalize[l[c]]){l.forEach(function(e){o.__defineSetter__(e,function(e){n=path.normalize(e)}),o.__defineGetter__(e,function(){return"string"==typeof n?path.normalize(n):n})});break}}function b(e){var n={};y(n,r,a),Object.keys(t.configs).forEach(function(t){var r=e[t]||n[t];if(r)try{var i=JSON.parse(fs.readFileSync(r,"utf8"));Object.keys(i).forEach(function(n){void 0===e[n]&&(delete e[n],v(n,i[n]))})}catch(a){throw Error("invalid json config file: "+r)}})}function y(e,n,t){Object.keys(t).forEach(function(r){_(e,r.split("."))||(w(e,r.split("."),t[r]),(n[r]||[]).forEach(function(n){w(e,n.split("."),t[r])}))})}function _(e,n){var t=e;n.slice(0,-1).forEach(function(e){t=t[e]||{}});var r=n[n.length-1];return r in t}function w(e,n,r){var i=e;n.slice(0,-1).forEach(function(e){void 0===i[e]&&(i[e]={}),i=i[e]});var a=n[n.length-1];"function"==typeof r?i[a]=r(i[a]):void 0===i[a]&&x(a,t.arrays)?i[a]=Array.isArray(r)?r:[r]:void 0===i[a]||"boolean"==typeof i[a]?i[a]=r:Array.isArray(i[a])?i[a].push(r):i[a]=[i[a],r]}function k(e){Object.keys(e||{}).forEach(function(e){r[e]=[].concat(n.alias[e]||[]),r[e].concat(e).forEach(function(n){if(/-/.test(n)){var t=camelCase(n);r[e].push(t),i[t]=!0}}),r[e].forEach(function(n){r[n]=[e].concat(r[e].filter(function(e){return n!==e}))})})}function x(e,n){var t=!1,i=[].concat(r[e]||[],e);return i.forEach(function(e){n[e]&&(t=n[e])}),t}function S(e){var n={"boolean":!0,string:"",array:[]};return n[e]}function T(e,n){var t="boolean";return n.strings&&n.strings[e]?t="string":n.arrays&&n.arrays[e]&&(t="array"),t}function E(e){return"number"==typeof e?!0:/^0x[0-9a-f]+$/i.test(e)?!0:/^[-+]?(?:\d+(?:\.\d*)?|\.\d+)(e[-+]?\d+)?$/.test(e)}n||(n={});var t={arrays:{},bools:{},strings:{},counts:{},normalize:{},configs:{}};[].concat(n.array).filter(Boolean).forEach(function(e){t.arrays[e]=!0}),[].concat(n["boolean"]).filter(Boolean).forEach(function(e){t.bools[e]=!0}),[].concat(n.string).filter(Boolean).forEach(function(e){t.strings[e]=!0}),[].concat(n.count).filter(Boolean).forEach(function(e){t.counts[e]=!0}),[].concat(n.normalize).filter(Boolean).forEach(function(e){t.normalize[e]=!0}),[].concat(n.config).filter(Boolean).forEach(function(e){t.configs[e]=!0});var r={},i={};k(n.key),k(n.alias);var a=n["default"]||{};Object.keys(a).forEach(function(e){if(/-/.test(e)&&!n.alias[e]){var t=camelCase(e);r[e]=r[e]||[],-1===r[e].indexOf(t)&&(r[e]=(r[e]||[]).concat(t),i[t]=!0)}(r[e]||[]).forEach(function(n){a[n]=a[e]})});var o={_:[]};Object.keys(t.bools).forEach(function(e){v(e,e in a?a[e]:!1)});var s=[];-1!==e.indexOf("--")&&(s=e.slice(e.indexOf("--")+1),e=e.slice(0,e.indexOf("--")));for(var u=0;u<e.length;u++){var l=e[u];if(l.match(/^--.+=/)){var c=l.match(/^--([^=]+)=([\s\S]*)$/);v(c[1],c[2])}else if(l.match(/^--no-.+/)){var f=l.match(/^--no-(.+)/)[1];v(f,!1)}else if(l.match(/^--.+/)){var f=l.match(/^--(.+)/)[1];if(x(f,n.narg))u=g(u,f,e);else{var d=e[u+1];void 0===d||d.match(/^-/)||x(f,t.bools)||x(f,t.counts)?/^(true|false)$/.test(d)?(v(f,d),u++):v(f,S(T(f,t))):(v(f,d),u++)}}else if(l.match(/^-.\..+=/)){var c=l.match(/^-([^=]+)=([\s\S]*)$/);v(c[1],c[2])}else if(l.match(/^-.\..+/)){var f=l.match(/^-(.\..+)/)[1],d=e[u+1];void 0===d||d.match(/^-/)||x(f,t.bools)||x(f,t.counts)?v(f,S(T(f,t))):(v(f,d),u++)}else if(l.match(/^-[^-]+/)){for(var h=l.slice(1,-1).split(""),p=!1,m=0;m<h.length;m++){var d=l.slice(m+2);if(h[m+1]&&"="===h[m+1]){v(h[m],l.slice(m+3)),p=!0;break}if("-"!==d){if(/[A-Za-z]/.test(h[m])&&/-?\d+(\.\d*)?(e-?\d+)?$/.test(d)){v(h[m],d),p=!0;break}if(h[m+1]&&h[m+1].match(/\W/)){v(h[m],l.slice(m+2)),p=!0;break}v(h[m],S(T(h[m],t)))}else v(h[m],d)}var f=l.slice(-1)[0];p||"-"===f||(x(f,n.narg)?u=g(u,f,e):!e[u+1]||/^(-|--)[^-]/.test(e[u+1])||x(f,t.bools)||x(f,t.counts)?e[u+1]&&/true|false/.test(e[u+1])?(v(f,e[u+1]),u++):v(f,S(T(f,t))):(v(f,e[u+1]),u++))}else o._.push(t.strings._||!E(l)?l:Number(l))}return b(o),y(o,r,a),Object.keys(t.counts).forEach(function(e){v(e,a[e])}),s.forEach(function(e){o._.push(e)}),{argv:o,aliases:r,newAliases:i}};