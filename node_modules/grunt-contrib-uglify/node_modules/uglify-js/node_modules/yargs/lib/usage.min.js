var decamelize=require("decamelize"),wordwrap=require("wordwrap"),wsize=require("window-size");module.exports=function(e){function f(e,n){var t="[default: ";if(void 0===e)return null;if(n)t+=n;else switch(typeof e){case"string":t+=JSON.stringify(e);break;case"function":t+="("+(e.name.length?decamelize(e.name,"-"):"generated-value")+")";break;default:t+=e}return t+"]"}function d(e,n){var t=[],r=h(Object.keys(e));c&&(r=Math.min(r,parseInt(c/2)));var i=h(Object.keys(e).map(function(n){return e[n].desc}));return Object.keys(e).forEach(function(a){var o=e[a].desc,s=e[a].extra,u=null;c&&(o=wordwrap(r+n+1,c)(o).slice(r+n+1)),c&&a.length>r&&(u=wordwrap(2,r)(a.trim()).split("\n"),a="");var l=new Array(Math.max(r-a.length+n,0)).join(" "),f=new Array(Math.max(i-o.length+1,0)).join(" ");!c&&f.length>0&&(o+=f);var d="  "+a+l,h=[o,s].filter(Boolean).join("  ");if(c){var m=o.split("\n"),g=m.slice(-1)[0].length+(1===m.length?d.length:0);h=s.length>c?o+"\n"+wordwrap(r+4,c)(s):o+(g+s.length>c-2?"\n"+new Array(c-s.length+1).join(" ")+s:new Array(c-s.length-g+1).join(" ")+s)}if(u)for(var v=h.split("\n"),b=d+v[0],y=Math.max(u.length,v.length),_=0;y>_;_++){var a=u[_],w=_?v[_]:b;t.push(p(a,w,b.length))}else t.push(d+h)}),t}function h(e){return Math.max.apply(null,e.map(function(e){return e.length}))}function p(e,n,t){var r="";e=e||"",n=n||new Array(t).join(" ");for(var i=0;i<n.length;i++){var a=n.charAt(i);" "===a&&(a=e.charAt(i)||a),r+=a}return r}function m(){return wsize.width?Math.min(80,wsize.width):null}var n={},t=[];n.failFn=function(e){t.push(e)};var r=null,i=!0;n.showHelpOnFail=function(e,t){return"string"==typeof e?(t=e,e=!0):"undefined"==typeof e&&(e=!0),r=t,i=e,n},n.fail=function(n){if(t.length)t.forEach(function(e){e(n)});else{if(i&&e.showHelp("error"),n&&console.error(n),r&&(n&&console.error(""),console.error(r)),!e.getExitProcess())throw new Error(n);process.exit(1)}};var a;n.usage=function(e){a=e};var o=[];n.example=function(e,n){o.push([e,n||""])};var s=[];n.command=function(e,n){s.push([e,n||""])},n.getCommands=function(){return s};var u={};n.describe=function(e,t){"object"==typeof e?Object.keys(e).forEach(function(t){n.describe(t,e[t])}):u[e]=t},n.getDescriptions=function(){return u};var l;n.epilog=function(e){l=e};var c=m();n.wrap=function(e){c=e},n.help=function(){var n=e.getDemanded(),t=e.getOptions(),r=Object.keys(Object.keys(u).concat(Object.keys(n)).concat(Object.keys(t["default"])).reduce(function(e,n){return"_"!==n&&(e[n]=!0),e},{})),i=r.length?["Options:"]:[];if(s.length){i.unshift("");var h={};s.forEach(function(e){h[e[0]]={desc:e[1],extra:""}}),i=["Commands:"].concat(d(h,5),i)}if(a){var p=a.replace(/\$0/g,e.$0);c&&(p=wordwrap(0,c)(p)),i.unshift(p,"")}var m=(Object.keys(t.alias)||[]).concat(Object.keys(e.parsed.newAliases)||[]);r=r.filter(function(n){return!e.parsed.newAliases[n]&&m.every(function(e){return-1==(t.alias[e]||[]).indexOf(n)})});var g=r.reduce(function(e,n){return e[n]=[n].concat(t.alias[n]||[]).map(function(e){return(e.length>1?"--":"-")+e}).join(", "),e},{}),v={};if(r.forEach(function(e){var r=g[e],i=u[e]||"",a=null;t["boolean"][e]&&(a="[boolean]"),t.count[e]&&(a="[count]"),t.string[e]&&(a="[string]"),t.normalize[e]&&(a="[string]");var o=[a,n[e]?"[required]":null,f(t["default"][e],t.defaultDescription[e])].filter(Boolean).join("  ");v[r]={desc:i,extra:o}}),i.push.apply(i,d(v,3)),r.length&&i.push(""),o.length){o.forEach(function(n){n[0]=n[0].replace(/\$0/g,e.$0)});var b={};o.forEach(function(e){b[e[0]]={desc:e[1],extra:""}}),i.push.apply(i,["Examples:"].concat(d(b,5),""))}if(l){var y=l.replace(/\$0/g,e.$0);c&&(y=wordwrap(0,c)(y)),i.push(y,"")}return i.join("\n")},n.showHelp=function(e){e=e||"error",console[e](n.help())};var g=null;return n.version=function(e,n,t){g=e},n.showVersion=function(){"function"==typeof g?console.log(g()):console.log(g)},n};