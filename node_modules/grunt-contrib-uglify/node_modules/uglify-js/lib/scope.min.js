"use strict";function SymbolDef(e,n,t){this.name=t.name,this.orig=[t],this.scope=e,this.references=[],this.global=!1,this.mangled_name=null,this.undeclared=!1,this.constant=!1,this.index=n}SymbolDef.prototype={unmangleable:function(e){return e||(e={}),this.global&&!e.toplevel||this.undeclared||!e.eval&&(this.scope.uses_eval||this.scope.uses_with)||e.keep_fnames&&(this.orig[0]instanceof AST_SymbolLambda||this.orig[0]instanceof AST_SymbolDefun)},mangle:function(e){var n=e.cache&&e.cache.props;if(this.global&&n&&n.has(this.name))this.mangled_name=n.get(this.name);else if(!this.mangled_name&&!this.unmangleable(e)){var t=this.scope;!e.screw_ie8&&this.orig[0]instanceof AST_SymbolLambda&&(t=t.parent_scope),this.mangled_name=t.next_mangled(e,this),this.global&&n&&n.set(this.name,this.mangled_name)}}},AST_Toplevel.DEFMETHOD("figure_out_scope",function(e){e=defaults(e,{screw_ie8:!1,cache:null});var n=this,t=n.parent_scope=null,r=null,a=0,i=new TreeWalker(function(n,s){if(e.screw_ie8&&n instanceof AST_Catch){var o=t;return t=new AST_Scope(n),t.init_scope_vars(a),t.parent_scope=o,s(),t=o,!0}if(n instanceof AST_Scope){n.init_scope_vars(a);var o=n.parent_scope=t,l=r;return r=t=n,++a,s(),--a,t=o,r=l,!0}if(n instanceof AST_Directive)return n.scope=t,push_uniq(t.directives,n.value),!0;if(n instanceof AST_With)for(var u=t;u;u=u.parent_scope)u.uses_with=!0;else if(n instanceof AST_Symbol&&(n.scope=t),n instanceof AST_SymbolLambda)r.def_function(n);else if(n instanceof AST_SymbolDefun)(n.scope=r.parent_scope).def_function(n);else if(n instanceof AST_SymbolVar||n instanceof AST_SymbolConst){var c=r.def_variable(n);c.constant=n instanceof AST_SymbolConst,c.init=i.parent().value}else n instanceof AST_SymbolCatch&&(e.screw_ie8?t:r).def_variable(n)});n.walk(i);var s=null,o=n.globals=new Dictionary,i=new TreeWalker(function(e,t){if(e instanceof AST_Lambda){var r=s;return s=e,t(),s=r,!0}if(e instanceof AST_SymbolRef){var a=e.name,l=e.scope.find_variable(a);if(l)e.thedef=l;else{var u;if(o.has(a)?u=o.get(a):(u=new SymbolDef(n,o.size(),e),u.undeclared=!0,u.global=!0,o.set(a,u)),e.thedef=u,"eval"==a&&i.parent()instanceof AST_Call)for(var c=e.scope;c&&!c.uses_eval;c=c.parent_scope)c.uses_eval=!0;s&&"arguments"==a&&(s.uses_arguments=!0)}return e.reference(),!0}});n.walk(i),e.cache&&(this.cname=e.cache.cname)}),AST_Scope.DEFMETHOD("init_scope_vars",function(e){this.directives=[],this.variables=new Dictionary,this.functions=new Dictionary,this.uses_with=!1,this.uses_eval=!1,this.parent_scope=null,this.enclosed=[],this.cname=-1,this.nesting=e}),AST_Scope.DEFMETHOD("strict",function(){return this.has_directive("use strict")}),AST_Lambda.DEFMETHOD("init_scope_vars",function(){AST_Scope.prototype.init_scope_vars.apply(this,arguments),this.uses_arguments=!1}),AST_SymbolRef.DEFMETHOD("reference",function(){var e=this.definition();e.references.push(this);for(var n=this.scope;n&&(push_uniq(n.enclosed,e),n!==e.scope);)n=n.parent_scope;this.frame=this.scope.nesting-e.scope.nesting}),AST_Scope.DEFMETHOD("find_variable",function(e){return e instanceof AST_Symbol&&(e=e.name),this.variables.get(e)||this.parent_scope&&this.parent_scope.find_variable(e)}),AST_Scope.DEFMETHOD("has_directive",function(e){return this.parent_scope&&this.parent_scope.has_directive(e)||(this.directives.indexOf(e)>=0?this:null)}),AST_Scope.DEFMETHOD("def_function",function(e){this.functions.set(e.name,this.def_variable(e))}),AST_Scope.DEFMETHOD("def_variable",function(e){var n;return this.variables.has(e.name)?(n=this.variables.get(e.name),n.orig.push(e)):(n=new SymbolDef(this,this.variables.size(),e),this.variables.set(e.name,n),n.global=!this.parent_scope),e.thedef=n}),AST_Scope.DEFMETHOD("next_mangled",function(e){var n=this.enclosed;e:for(;;){var t=base54(++this.cname);if(is_identifier(t)&&!(e.except.indexOf(t)>=0)){for(var r=n.length;--r>=0;){var a=n[r],i=a.mangled_name||a.unmangleable(e)&&a.name;if(t==i)continue e}return t}}}),AST_Function.DEFMETHOD("next_mangled",function(e,n){for(var t=n.orig[0]instanceof AST_SymbolFunarg&&this.name&&this.name.definition();;){var r=AST_Lambda.prototype.next_mangled.call(this,e,n);if(!t||t.mangled_name!=r)return r}}),AST_Scope.DEFMETHOD("references",function(e){return e instanceof AST_Symbol&&(e=e.definition()),this.enclosed.indexOf(e)<0?null:e}),AST_Symbol.DEFMETHOD("unmangleable",function(e){return this.definition().unmangleable(e)}),AST_SymbolAccessor.DEFMETHOD("unmangleable",function(){return!0}),AST_Label.DEFMETHOD("unmangleable",function(){return!1}),AST_Symbol.DEFMETHOD("unreferenced",function(){return 0==this.definition().references.length&&!(this.scope.uses_eval||this.scope.uses_with)}),AST_Symbol.DEFMETHOD("undeclared",function(){return this.definition().undeclared}),AST_LabelRef.DEFMETHOD("undeclared",function(){return!1}),AST_Label.DEFMETHOD("undeclared",function(){return!1}),AST_Symbol.DEFMETHOD("definition",function(){return this.thedef}),AST_Symbol.DEFMETHOD("global",function(){return this.definition().global}),AST_Toplevel.DEFMETHOD("_default_mangler_options",function(e){return defaults(e,{except:[],eval:!1,sort:!1,toplevel:!1,screw_ie8:!1,keep_fnames:!1})}),AST_Toplevel.DEFMETHOD("mangle_names",function(e){e=this._default_mangler_options(e);var n=-1,t=[];e.cache&&this.globals.each(function(n){e.except.indexOf(n.name)<0&&t.push(n)});var r=new TreeWalker(function(a,i){if(a instanceof AST_LabeledStatement){var s=n;return i(),n=s,!0}if(a instanceof AST_Scope){var l=(r.parent(),[]);return a.variables.each(function(n){e.except.indexOf(n.name)<0&&l.push(n)}),e.sort&&l.sort(function(e,n){return n.references.length-e.references.length}),void t.push.apply(t,l)}if(a instanceof AST_Label){var u;do u=base54(++n);while(!is_identifier(u));return a.mangled_name=u,!0}return e.screw_ie8&&a instanceof AST_SymbolCatch?void t.push(a.definition()):void 0});this.walk(r),t.forEach(function(n){n.mangle(e)}),e.cache&&(e.cache.cname=this.cname)}),AST_Toplevel.DEFMETHOD("compute_char_frequency",function(e){e=this._default_mangler_options(e);var n=new TreeWalker(function(n){n instanceof AST_Constant?base54.consider(n.print_to_string()):n instanceof AST_Return?base54.consider("return"):n instanceof AST_Throw?base54.consider("throw"):n instanceof AST_Continue?base54.consider("continue"):n instanceof AST_Break?base54.consider("break"):n instanceof AST_Debugger?base54.consider("debugger"):n instanceof AST_Directive?base54.consider(n.value):n instanceof AST_While?base54.consider("while"):n instanceof AST_Do?base54.consider("do while"):n instanceof AST_If?(base54.consider("if"),n.alternative&&base54.consider("else")):n instanceof AST_Var?base54.consider("var"):n instanceof AST_Const?base54.consider("const"):n instanceof AST_Lambda?base54.consider("function"):n instanceof AST_For?base54.consider("for"):n instanceof AST_ForIn?base54.consider("for in"):n instanceof AST_Switch?base54.consider("switch"):n instanceof AST_Case?base54.consider("case"):n instanceof AST_Default?base54.consider("default"):n instanceof AST_With?base54.consider("with"):n instanceof AST_ObjectSetter?base54.consider("set"+n.key):n instanceof AST_ObjectGetter?base54.consider("get"+n.key):n instanceof AST_ObjectKeyVal?base54.consider(n.key):n instanceof AST_New?base54.consider("new"):n instanceof AST_This?base54.consider("this"):n instanceof AST_Try?base54.consider("try"):n instanceof AST_Catch?base54.consider("catch"):n instanceof AST_Finally?base54.consider("finally"):n instanceof AST_Symbol&&n.unmangleable(e)?base54.consider(n.name):n instanceof AST_Unary||n instanceof AST_Binary?base54.consider(n.operator):n instanceof AST_Dot&&base54.consider(n.property)});this.walk(n),base54.sort()});var base54=function(){function r(){t=Object.create(null),n=e.split("").map(function(e){return e.charCodeAt(0)}),n.forEach(function(e){t[e]=0})}function a(e){var t="",r=54;e++;do e--,t+=String.fromCharCode(n[e%r]),e=Math.floor(e/r),r=64;while(e>0);return t}var n,t,e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_0123456789";return a.consider=function(e){for(var n=e.length;--n>=0;){var r=e.charCodeAt(n);r in t&&++t[r]}},a.sort=function(){n=mergeSort(n,function(e,n){return is_digit(e)&&!is_digit(n)?1:is_digit(n)&&!is_digit(e)?-1:t[n]-t[e]})},a.reset=r,r(),a.get=function(){return n},a.freq=function(){return t},a}();AST_Toplevel.DEFMETHOD("scope_warnings",function(e){e=defaults(e,{undeclared:!1,unreferenced:!0,assign_to_global:!0,func_arguments:!0,nested_defuns:!0,eval:!0});var n=new TreeWalker(function(t){if(e.undeclared&&t instanceof AST_SymbolRef&&t.undeclared()&&AST_Node.warn("Undeclared symbol: {name} [{file}:{line},{col}]",{name:t.name,file:t.start.file,line:t.start.line,col:t.start.col}),e.assign_to_global){var r=null;t instanceof AST_Assign&&t.left instanceof AST_SymbolRef?r=t.left:t instanceof AST_ForIn&&t.init instanceof AST_SymbolRef&&(r=t.init),r&&(r.undeclared()||r.global()&&r.scope!==r.definition().scope)&&AST_Node.warn("{msg}: {name} [{file}:{line},{col}]",{msg:r.undeclared()?"Accidental global?":"Assignment to global",name:r.name,file:r.start.file,line:r.start.line,col:r.start.col})}e.eval&&t instanceof AST_SymbolRef&&t.undeclared()&&"eval"==t.name&&AST_Node.warn("Eval is used [{file}:{line},{col}]",t.start),e.unreferenced&&(t instanceof AST_SymbolDeclaration||t instanceof AST_Label)&&!(t instanceof AST_SymbolCatch)&&t.unreferenced()&&AST_Node.warn("{type} {name} is declared but not referenced [{file}:{line},{col}]",{type:t instanceof AST_Label?"Label":"Symbol",name:t.name,file:t.start.file,line:t.start.line,col:t.start.col}),e.func_arguments&&t instanceof AST_Lambda&&t.uses_arguments&&AST_Node.warn("arguments used in function {name} [{file}:{line},{col}]",{name:t.name?t.name.name:"anonymous",file:t.start.file,line:t.start.line,col:t.start.col}),e.nested_defuns&&t instanceof AST_Defun&&!(n.parent()instanceof AST_Scope)&&AST_Node.warn('Function {name} declared in nested statement "{type}" [{file}:{line},{col}]',{name:t.name.name,type:n.parent().TYPE,file:t.start.file,line:t.start.line,col:t.start.col})});this.walk(n)});