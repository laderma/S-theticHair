"use strict";function ReadableState(e,n){var t=require("./_stream_duplex");e=e||{},this.objectMode=!!e.objectMode,n instanceof t&&(this.objectMode=this.objectMode||!!e.readableObjectMode);var r=e.highWaterMark,i=this.objectMode?16:16384;this.highWaterMark=r||0===r?r:i,this.highWaterMark=~~this.highWaterMark,this.buffer=[],this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(StringDecoder||(StringDecoder=require("string_decoder/").StringDecoder),this.decoder=new StringDecoder(e.encoding),this.encoding=e.encoding)}function Readable(e){require("./_stream_duplex");return this instanceof Readable?(this._readableState=new ReadableState(e,this),this.readable=!0,e&&"function"==typeof e.read&&(this._read=e.read),void Stream.call(this)):new Readable(e)}function readableAddChunk(e,n,t,r,i){var a=chunkInvalid(n,t);if(a)e.emit("error",a);else if(null===t)n.reading=!1,onEofChunk(e,n);else if(n.objectMode||t&&t.length>0)if(n.ended&&!i){var o=new Error("stream.push() after EOF");e.emit("error",o)}else if(n.endEmitted&&i){var o=new Error("stream.unshift() after end event");e.emit("error",o)}else!n.decoder||i||r||(t=n.decoder.write(t)),i||(n.reading=!1),n.flowing&&0===n.length&&!n.sync?(e.emit("data",t),e.read(0)):(n.length+=n.objectMode?1:t.length,i?n.buffer.unshift(t):n.buffer.push(t),n.needReadable&&emitReadable(e)),maybeReadMore(e,n);else i||(n.reading=!1);return needMoreData(n)}function needMoreData(e){return!e.ended&&(e.needReadable||e.length<e.highWaterMark||0===e.length)}function roundUpToNextPowerOf2(e){if(e>=MAX_HWM)e=MAX_HWM;else{e--;for(var n=1;32>n;n<<=1)e|=e>>n;e++}return e}function howMuchToRead(e,n){return 0===n.length&&n.ended?0:n.objectMode?0===e?0:1:null===e||isNaN(e)?n.flowing&&n.buffer.length?n.buffer[0].length:n.length:0>=e?0:(e>n.highWaterMark&&(n.highWaterMark=roundUpToNextPowerOf2(e)),e>n.length?n.ended?n.length:(n.needReadable=!0,0):e)}function chunkInvalid(e,n){var t=null;return Buffer.isBuffer(n)||"string"==typeof n||null===n||void 0===n||e.objectMode||(t=new TypeError("Invalid non-string/buffer chunk")),t}function onEofChunk(e,n){if(!n.ended){if(n.decoder){var t=n.decoder.end();t&&t.length&&(n.buffer.push(t),n.length+=n.objectMode?1:t.length)}n.ended=!0,emitReadable(e)}}function emitReadable(e){var n=e._readableState;n.needReadable=!1,n.emittedReadable||(debug("emitReadable",n.flowing),n.emittedReadable=!0,n.sync?processNextTick(emitReadable_,e):emitReadable_(e))}function emitReadable_(e){debug("emit readable"),e.emit("readable"),flow(e)}function maybeReadMore(e,n){n.readingMore||(n.readingMore=!0,processNextTick(maybeReadMore_,e,n))}function maybeReadMore_(e,n){for(var t=n.length;!n.reading&&!n.flowing&&!n.ended&&n.length<n.highWaterMark&&(debug("maybeReadMore read 0"),e.read(0),t!==n.length);)t=n.length;n.readingMore=!1}function pipeOnDrain(e){return function(){var n=e._readableState;debug("pipeOnDrain",n.awaitDrain),n.awaitDrain&&n.awaitDrain--,0===n.awaitDrain&&EE.listenerCount(e,"data")&&(n.flowing=!0,flow(e))}}function nReadingNextTick(e){debug("readable nexttick read 0"),e.read(0)}function resume(e,n){n.resumeScheduled||(n.resumeScheduled=!0,processNextTick(resume_,e,n))}function resume_(e,n){n.reading||(debug("resume read 0"),e.read(0)),n.resumeScheduled=!1,e.emit("resume"),flow(e),n.flowing&&!n.reading&&e.read(0)}function flow(e){var n=e._readableState;if(debug("flow",n.flowing),n.flowing)do var t=e.read();while(null!==t&&n.flowing)}function fromList(e,n){var o,t=n.buffer,r=n.length,i=!!n.decoder,a=!!n.objectMode;if(0===t.length)return null;if(0===r)o=null;else if(a)o=t.shift();else if(!e||e>=r)o=i?t.join(""):Buffer.concat(t,r),t.length=0;else if(e<t[0].length){var s=t[0];o=s.slice(0,e),t[0]=s.slice(e)}else if(e===t[0].length)o=t.shift();else{o=i?"":new Buffer(e);for(var u=0,l=0,c=t.length;c>l&&e>u;l++){var s=t[0],f=Math.min(e-u,s.length);i?o+=s.slice(0,f):s.copy(o,u,0,f),f<s.length?t[0]=s.slice(f):t.shift(),u+=f}}return o}function endReadable(e){var n=e._readableState;if(n.length>0)throw new Error("endReadable called on non-empty stream");n.endEmitted||(n.ended=!0,processNextTick(endReadableNT,n,e))}function endReadableNT(e,n){e.endEmitted||0!==e.length||(e.endEmitted=!0,n.readable=!1,n.emit("end"))}function forEach(e,n){for(var t=0,r=e.length;r>t;t++)n(e[t],t)}function indexOf(e,n){for(var t=0,r=e.length;r>t;t++)if(e[t]===n)return t;return-1}module.exports=Readable;var processNextTick=require("process-nextick-args"),isArray=require("isarray"),Buffer=require("buffer").Buffer;Readable.ReadableState=ReadableState;var EE=require("events").EventEmitter;EE.listenerCount||(EE.listenerCount=function(e,n){return e.listeners(n).length});var Stream;!function(){try{Stream=require("stream")}catch(e){}finally{Stream||(Stream=require("events").EventEmitter)}}();var Buffer=require("buffer").Buffer,util=require("core-util-is");util.inherits=require("inherits");var debug=require("util");debug=debug&&debug.debuglog?debug.debuglog("stream"):function(){};var StringDecoder;util.inherits(Readable,Stream),Readable.prototype.push=function(e,n){var t=this._readableState;return t.objectMode||"string"!=typeof e||(n=n||t.defaultEncoding,n!==t.encoding&&(e=new Buffer(e,n),n="")),readableAddChunk(this,t,e,n,!1)},Readable.prototype.unshift=function(e){var n=this._readableState;return readableAddChunk(this,n,e,"",!0)},Readable.prototype.isPaused=function(){return this._readableState.flowing===!1},Readable.prototype.setEncoding=function(e){return StringDecoder||(StringDecoder=require("string_decoder/").StringDecoder),this._readableState.decoder=new StringDecoder(e),this._readableState.encoding=e,this};var MAX_HWM=8388608;Readable.prototype.read=function(e){debug("read",e);var n=this._readableState,t=e;if(("number"!=typeof e||e>0)&&(n.emittedReadable=!1),0===e&&n.needReadable&&(n.length>=n.highWaterMark||n.ended))return debug("read: emitReadable",n.length,n.ended),0===n.length&&n.ended?endReadable(this):emitReadable(this),null;if(e=howMuchToRead(e,n),0===e&&n.ended)return 0===n.length&&endReadable(this),null;var r=n.needReadable;debug("need readable",r),(0===n.length||n.length-e<n.highWaterMark)&&(r=!0,debug("length less than watermark",r)),(n.ended||n.reading)&&(r=!1,debug("reading or ended",r)),r&&(debug("do read"),n.reading=!0,n.sync=!0,0===n.length&&(n.needReadable=!0),this._read(n.highWaterMark),n.sync=!1),r&&!n.reading&&(e=howMuchToRead(t,n));var i;return i=e>0?fromList(e,n):null,null===i&&(n.needReadable=!0,e=0),n.length-=e,0!==n.length||n.ended||(n.needReadable=!0),t!==e&&n.ended&&0===n.length&&endReadable(this),null!==i&&this.emit("data",i),i},Readable.prototype._read=function(e){this.emit("error",new Error("not implemented"))},Readable.prototype.pipe=function(e,n){function o(e){debug("onunpipe"),e===t&&l()}function s(){debug("onend"),e.end()}function l(){debug("cleanup"),e.removeListener("close",d),e.removeListener("finish",p),e.removeListener("drain",u),e.removeListener("error",f),e.removeListener("unpipe",o),t.removeListener("end",s),t.removeListener("end",l),t.removeListener("data",c),!r.awaitDrain||e._writableState&&!e._writableState.needDrain||u()}function c(n){debug("ondata");var r=e.write(n);!1===r&&(debug("false write response, pause",t._readableState.awaitDrain),t._readableState.awaitDrain++,t.pause())}function f(n){debug("onerror",n),h(),e.removeListener("error",f),0===EE.listenerCount(e,"error")&&e.emit("error",n)}function d(){e.removeListener("finish",p),h()}function p(){debug("onfinish"),e.removeListener("close",d),h()}function h(){debug("unpipe"),t.unpipe(e)}var t=this,r=this._readableState;switch(r.pipesCount){case 0:r.pipes=e;break;case 1:r.pipes=[r.pipes,e];break;default:r.pipes.push(e)}r.pipesCount+=1,debug("pipe count=%d opts=%j",r.pipesCount,n);var i=(!n||n.end!==!1)&&e!==process.stdout&&e!==process.stderr,a=i?s:l;r.endEmitted?processNextTick(a):t.once("end",a),e.on("unpipe",o);var u=pipeOnDrain(t);return e.on("drain",u),t.on("data",c),e._events&&e._events.error?isArray(e._events.error)?e._events.error.unshift(f):e._events.error=[f,e._events.error]:e.on("error",f),e.once("close",d),e.once("finish",p),e.emit("pipe",t),r.flowing||(debug("pipe resume"),t.resume()),e},Readable.prototype.unpipe=function(e){var n=this._readableState;if(0===n.pipesCount)return this;if(1===n.pipesCount)return e&&e!==n.pipes?this:(e||(e=n.pipes),n.pipes=null,n.pipesCount=0,n.flowing=!1,e&&e.emit("unpipe",this),this);if(!e){var t=n.pipes,r=n.pipesCount;n.pipes=null,n.pipesCount=0,n.flowing=!1;for(var i=0;r>i;i++)t[i].emit("unpipe",this);return this}var i=indexOf(n.pipes,e);return-1===i?this:(n.pipes.splice(i,1),n.pipesCount-=1,1===n.pipesCount&&(n.pipes=n.pipes[0]),e.emit("unpipe",this),this)},Readable.prototype.on=function(e,n){var t=Stream.prototype.on.call(this,e,n);if("data"===e&&!1!==this._readableState.flowing&&this.resume(),"readable"===e&&this.readable){var r=this._readableState;r.readableListening||(r.readableListening=!0,r.emittedReadable=!1,r.needReadable=!0,r.reading?r.length&&emitReadable(this,r):processNextTick(nReadingNextTick,this))}return t},Readable.prototype.addListener=Readable.prototype.on,Readable.prototype.resume=function(){var e=this._readableState;return e.flowing||(debug("resume"),e.flowing=!0,resume(this,e)),this},Readable.prototype.pause=function(){return debug("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(debug("pause"),this._readableState.flowing=!1,this.emit("pause")),this},Readable.prototype.wrap=function(e){var n=this._readableState,t=!1,r=this;e.on("end",function(){if(debug("wrapped end"),n.decoder&&!n.ended){var e=n.decoder.end();e&&e.length&&r.push(e)}r.push(null)}),e.on("data",function(i){if(debug("wrapped data"),n.decoder&&(i=n.decoder.write(i)),(!n.objectMode||null!==i&&void 0!==i)&&(n.objectMode||i&&i.length)){var a=r.push(i);a||(t=!0,e.pause())}});for(var i in e)void 0===this[i]&&"function"==typeof e[i]&&(this[i]=function(n){return function(){return e[n].apply(e,arguments)}}(i));var a=["error","close","destroy","pause","resume"];return forEach(a,function(n){e.on(n,r.emit.bind(r,n))}),r._read=function(n){debug("wrapped _read",n),t&&(t=!1,e.resume())},r},Readable._fromList=fromList;