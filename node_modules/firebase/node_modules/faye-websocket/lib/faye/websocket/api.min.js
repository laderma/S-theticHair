var Stream=require("stream").Stream,util=require("util"),driver=require("websocket-driver"),EventTarget=require("./api/event_target"),Event=require("./api/event"),API=function(e){e=e||{},driver.validateOptions(e,["headers","extensions","maxLength","ping","proxy","tls","ca"]),this.readable=this.writable=!0;var n=e.headers;if(n)for(var t in n)this._driver.setHeader(t,n[t]);var r=e.extensions;r&&[].concat(r).forEach(this._driver.addExtension,this._driver),this._ping=e.ping,this._pingId=0,this.readyState=API.CONNECTING,this.bufferedAmount=0,this.protocol="",this.url=this._driver.url,this.version=this._driver.version;var i=this;this._driver.on("open",function(e){i._open()}),this._driver.on("message",function(e){i._receiveMessage(e.data)}),this._driver.on("close",function(e){i._beginClose(e.reason,e.code)}),this._driver.on("error",function(e){i._emitError(e.message)}),this.on("error",function(){}),this._driver.messages.on("drain",function(){i.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){i._pingId+=1,i.ping(i._pingId.toString())},1e3*this._ping)),this._configureStream(),this._proxy||(this._stream.pipe(this._driver.io),this._driver.io.pipe(this._stream))};util.inherits(API,Stream),API.CONNECTING=0,API.OPEN=1,API.CLOSING=2,API.CLOSED=3;var instance={write:function(e){return this.send(e)},end:function(e){void 0!==e&&this.send(e),this.close()},pause:function(){return this._driver.messages.pause()},resume:function(){return this._driver.messages.resume()},send:function(e){return this.readyState>API.OPEN?!1:(e instanceof Buffer||(e=String(e)),this._driver.messages.write(e))},ping:function(e,n){return this.readyState>API.OPEN?!1:this._driver.ping(e,n)},close:function(e,n){if(void 0===e&&(e=1e3),void 0===n&&(n=""),1e3!==e&&(3e3>e||e>4999))throw new Error("Failed to execute 'close' on WebSocket: The code must be either 1000, or between 3000 and 4999. "+e+" is neither.");this.readyState!==API.CLOSED&&(this.readyState=API.CLOSING),this._driver.close(n,e)},_configureStream:function(){var e=this;this._stream.setTimeout(0),this._stream.setNoDelay(!0),["close","end"].forEach(function(n){this._stream.on(n,function(){e._finalizeClose()})},this),this._stream.on("error",function(n){e._emitError("Network error: "+e.url+": "+n.message),e._finalizeClose()})},_open:function(){if(this.readyState===API.CONNECTING){this.readyState=API.OPEN,this.protocol=this._driver.protocol||"";var e=new Event("open");e.initEvent("open",!1,!1),this.dispatchEvent(e)}},_receiveMessage:function(e){if(this.readyState>API.OPEN)return!1;this.readable&&this.emit("data",e);var n=new Event("message",{data:e});n.initEvent("message",!1,!1),this.dispatchEvent(n)},_emitError:function(e){if(!(this.readyState>=API.CLOSING)){var n=new Event("error",{message:e});n.initEvent("error",!1,!1),this.dispatchEvent(n)}},_beginClose:function(e,n){this.readyState!==API.CLOSED&&(this.readyState=API.CLOSING,this._closeParams=[e,n],this._stream&&(this._stream.end(),this._stream.readable||this._finalizeClose()))},_finalizeClose:function(){if(this.readyState!==API.CLOSED){this.readyState=API.CLOSED,this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end(),this.readable&&this.emit("end"),this.readable=this.writable=!1;var e=this._closeParams?this._closeParams[0]:"",n=this._closeParams?this._closeParams[1]:1006,t=new Event("close",{code:n,reason:e});t.initEvent("close",!1,!1),this.dispatchEvent(t)}}};for(var method in instance)API.prototype[method]=instance[method];for(var key in EventTarget)API.prototype[key]=EventTarget[key];module.exports=API;