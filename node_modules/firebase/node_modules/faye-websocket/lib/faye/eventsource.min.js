var Stream=require("stream").Stream,util=require("util"),driver=require("websocket-driver"),Headers=require("websocket-driver/lib/websocket/driver/headers"),API=require("./websocket/api"),EventTarget=require("./websocket/api/event_target"),Event=require("./websocket/api/event"),EventSource=function(e,n,t){this.writable=!0,t=t||{},this._stream=n.socket,this._ping=t.ping||this.DEFAULT_PING,this._retry=t.retry||this.DEFAULT_RETRY;var r=driver.isSecureRequest(e)?"https:":"http:";this.url=r+"//"+e.headers.host+e.url,this.lastEventId=e.headers["last-event-id"]||"",this.readyState=API.CONNECTING;var a=new Headers,i=this;if(t.headers)for(var o in t.headers)a.set(o,t.headers[o]);if(this._stream&&this._stream.writable){process.nextTick(function(){i._open()}),this._stream.setTimeout(0),this._stream.setNoDelay(!0);var s="HTTP/1.1 200 OK\r\nContent-Type: text/event-stream\r\nCache-Control: no-cache, no-store\r\nConnection: close\r\n"+a.toString()+"\r\nretry: "+Math.floor(1e3*this._retry)+"\r\n\r\n";this._write(s),this._stream.on("drain",function(){i.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){i.ping()},1e3*this._ping)),["error","end"].forEach(function(e){i._stream.on(e,function(){i.close()})})}};util.inherits(EventSource,Stream),EventSource.isEventSource=function(e){if("GET"!==e.method)return!1;var n=(e.headers.accept||"").split(/\s*,\s*/);return n.indexOf("text/event-stream")>=0};var instance={DEFAULT_PING:10,DEFAULT_RETRY:5,_write:function(e){if(!this.writable)return!1;try{return this._stream.write(e,"utf8")}catch(n){return!1}},_open:function(){if(this.readyState===API.CONNECTING){this.readyState=API.OPEN;var e=new Event("open");e.initEvent("open",!1,!1),this.dispatchEvent(e)}},write:function(e){return this.send(e)},end:function(e){void 0!==e&&this.write(e),this.close()},send:function(e,n){if(this.readyState>API.OPEN)return!1;e=String(e).replace(/(\r\n|\r|\n)/g,"$1data: "),n=n||{};var t="";return n.event&&(t+="event: "+n.event+"\r\n"),n.id&&(t+="id: "+n.id+"\r\n"),t+="data: "+e+"\r\n\r\n",this._write(t)},ping:function(){return this._write(":\r\n\r\n")},close:function(){if(this.readyState>API.OPEN)return!1;this.readyState=API.CLOSED,this.writable=!1,this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end();var e=new Event("close");return e.initEvent("close",!1,!1),this.dispatchEvent(e),!0}};for(var method in instance)EventSource.prototype[method]=instance[method];for(var key in EventTarget)EventSource.prototype[key]=EventTarget[key];module.exports=EventSource;