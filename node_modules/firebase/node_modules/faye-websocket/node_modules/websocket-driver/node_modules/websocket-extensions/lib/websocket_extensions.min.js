"use strict";var Parser=require("./parser"),Pipeline=require("./pipeline"),Extensions=function(){this._rsv1=this._rsv2=this._rsv3=null,this._byName={},this._inOrder=[],this._sessions=[],this._index={}};Extensions.MESSAGE_OPCODES=[1,2];var instance={add:function(e){if("string"!=typeof e.name)throw new TypeError("extension.name must be a string");if("permessage"!==e.type)throw new TypeError('extension.type must be "permessage"');if("boolean"!=typeof e.rsv1)throw new TypeError("extension.rsv1 must be true or false");if("boolean"!=typeof e.rsv2)throw new TypeError("extension.rsv2 must be true or false");if("boolean"!=typeof e.rsv3)throw new TypeError("extension.rsv3 must be true or false");if(this._byName.hasOwnProperty(e.name))throw new TypeError('An extension with name "'+e.name+'" is already registered');this._byName[e.name]=e,this._inOrder.push(e)},generateOffer:function(){var e=[],n=[],t={};return this._inOrder.forEach(function(r){var i=r.createClientSession();if(i){var a=[r,i];e.push(a),t[r.name]=a;var o=i.generateOffer();o=o?[].concat(o):[],o.forEach(function(e){n.push(Parser.serializeParams(r.name,e))},this)}},this),this._sessions=e,this._index=t,n.length>0?n.join(", "):null},activate:function(e){var n=Parser.parseHeader(e),t=[];n.eachOffer(function(e,n){var r=this._index[e];if(!r)throw new Error('Server sent an extension response for unknown extension "'+e+'"');var i=r[0],a=r[1],o=this._reserved(i);if(o)throw new Error("Server sent two extension responses that use the RSV"+o[0]+' bit: "'+o[1]+'" and "'+i.name+'"');if(a.activate(n)!==!0)throw new Error("Server sent unacceptable extension parameters: "+Parser.serializeParams(e,n));this._reserve(i),t.push(r)},this),this._sessions=t,this._pipeline=new Pipeline(t)},generateResponse:function(e){var n=Parser.parseHeader(e),t=[],r=[];return this._inOrder.forEach(function(e){var i=n.byName(e.name);if(0!==i.length&&!this._reserved(e)){var a=e.createServerSession(i);a&&(this._reserve(e),t.push([e,a]),r.push(Parser.serializeParams(e.name,a.generateResponse())))}},this),this._sessions=t,this._pipeline=new Pipeline(t),r.length>0?r.join(", "):null},validFrameRsv:function(e){var t,n={rsv1:!1,rsv2:!1,rsv3:!1};if(Extensions.MESSAGE_OPCODES.indexOf(e.opcode)>=0)for(var r=0,i=this._sessions.length;i>r;r++)t=this._sessions[r][0],n.rsv1=n.rsv1||t.rsv1,n.rsv2=n.rsv2||t.rsv2,n.rsv3=n.rsv3||t.rsv3;return(n.rsv1||!e.rsv1)&&(n.rsv2||!e.rsv2)&&(n.rsv3||!e.rsv3)},processIncomingMessage:function(e,n,t){this._pipeline.processIncomingMessage(e,n,t)},processOutgoingMessage:function(e,n,t){this._pipeline.processOutgoingMessage(e,n,t)},close:function(e,n){return this._pipeline?void this._pipeline.close(e,n):e.call(n)},_reserve:function(e){this._rsv1=this._rsv1||e.rsv1&&e.name,this._rsv2=this._rsv2||e.rsv2&&e.name,this._rsv3=this._rsv3||e.rsv3&&e.name},_reserved:function(e){return this._rsv1&&e.rsv1?[1,this._rsv1]:this._rsv2&&e.rsv2?[2,this._rsv2]:this._rsv3&&e.rsv3?[3,this._rsv3]:!1}};for(var key in instance)Extensions.prototype[key]=instance[key];module.exports=Extensions;