"use strict";var RingBuffer=require("./ring_buffer"),Functor=function(e,n){this._session=e,this._method=n,this._queue=new RingBuffer(Functor.QUEUE_SIZE),this._stopped=!1,this.pending=0};Functor.QUEUE_SIZE=8,Functor.prototype.call=function(e,n,t,r){if(!this._stopped){var i={error:e,message:n,callback:t,context:r,done:!1},a=!1,o=this;return this._queue.push(i),i.error?(i.done=!0,this._stop(),this._flushQueue()):void this._session[this._method](n,function(e,n){a^(a=!0)&&(e?(o._stop(),i.error=e,i.message=null):i.message=n,i.done=!0,o._flushQueue())})}},Functor.prototype._stop=function(){this.pending=this._queue.length,this._stopped=!0},Functor.prototype._flushQueue=function(){for(var n,e=this._queue;e.length>0&&e.peek().done;)this.pending-=1,n=e.shift(),n.callback.call(n.context,n.error,n.message)},module.exports=Functor;