"use strict";var Functor=require("./functor"),Pledge=require("./pledge"),Cell=function(e){this._ext=e[0],this._session=e[1],this._functors={incoming:new Functor(this._session,"processIncomingMessage"),outgoing:new Functor(this._session,"processOutgoingMessage")}};Cell.prototype.pending=function(e){this._functors[e].pending+=1},Cell.prototype.incoming=function(e,n,t,r){this._exec("incoming",e,n,t,r)},Cell.prototype.outgoing=function(e,n,t,r){this._exec("outgoing",e,n,t,r)},Cell.prototype.close=function(){return this._closed=this._closed||new Pledge,this._doClose(),this._closed},Cell.prototype._exec=function(e,n,t,r,i){this._functors[e].call(n,t,function(e,n){e&&(e.message=this._ext.name+": "+e.message),r.call(i,e,n),this._doClose()},this)},Cell.prototype._doClose=function(){var e=this._functors.incoming,n=this._functors.outgoing;this._closed&&e.pending+n.pending===0&&(this._session&&this._session.close(),this._session=null,this._closed.done())},module.exports=Cell;