"use strict";var crypto=require("crypto"),url=require("url"),util=require("util"),HttpParser=require("../http_parser"),Base=require("./base"),Hybi=require("./hybi"),Proxy=require("./proxy"),Client=function(e,n){this.version="hybi-13",Hybi.call(this,null,e,n),this.readyState=-1,this._key=Client.generateKey(),this._accept=Hybi.generateAccept(this._key),this._http=new HttpParser("response");var t=url.parse(this.url),r=t.auth&&new Buffer(t.auth,"utf8").toString("base64");this._pathname=(t.pathname||"/")+(t.search||""),this._headers.set("Host",t.host),this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Key",this._key),this._headers.set("Sec-WebSocket-Version","13"),this._protocols.length>0&&this._headers.set("Sec-WebSocket-Protocol",this._protocols.join(", ")),r&&this._headers.set("Authorization","Basic "+r)};util.inherits(Client,Hybi),Client.generateKey=function(){return crypto.randomBytes(16).toString("base64")};var instance={proxy:function(e,n){return new Proxy(this,e,n)},start:function(){return-1!==this.readyState?!1:(this._write(this._handshakeRequest()),this.readyState=0,!0)},parse:function(e){if(3!==this.readyState){if(this.readyState>0)return Hybi.prototype.parse.call(this,e);this._http.parse(e),this._http.isComplete()&&(this._validateHandshake(),3!==this.readyState&&(this._open(),this.parse(this._http.body)))}},_handshakeRequest:function(){var e=this._extensions.generateOffer();e&&this._headers.set("Sec-WebSocket-Extensions",e);var n="GET "+this._pathname+" HTTP/1.1",t=[n,this._headers.toString(),""];return new Buffer(t.join("\r\n"),"utf8")},_failHandshake:function(e){e="Error during WebSocket handshake: "+e,this.readyState=3,this.emit("error",new Error(e)),this.emit("close",new Base.CloseEvent(this.ERRORS.protocol_error,e))},_validateHandshake:function(){if(this.statusCode=this._http.statusCode,this.headers=this._http.headers,101!==this._http.statusCode)return this._failHandshake("Unexpected response code: "+this._http.statusCode);var e=this._http.headers,n=e.upgrade||"",t=e.connection||"",r=e["sec-websocket-accept"]||"",i=e["sec-websocket-protocol"]||"";if(""===n)return this._failHandshake("'Upgrade' header is missing");if("websocket"!==n.toLowerCase())return this._failHandshake("'Upgrade' header value is not 'WebSocket'");if(""===t)return this._failHandshake("'Connection' header is missing");if("upgrade"!==t.toLowerCase())return this._failHandshake("'Connection' header value is not 'Upgrade'");if(r!==this._accept)return this._failHandshake("Sec-WebSocket-Accept mismatch");if(this.protocol=null,""!==i){if(this._protocols.indexOf(i)<0)return this._failHandshake("Sec-WebSocket-Protocol mismatch");this.protocol=i}try{this._extensions.activate(this.headers["sec-websocket-extensions"])}catch(a){return this._failHandshake(a.message)}}};for(var key in instance)Client.prototype[key]=instance[key];module.exports=Client;