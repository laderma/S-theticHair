"use strict";var crypto=require("crypto"),util=require("util"),Extensions=require("websocket-extensions"),Base=require("./base"),Frame=require("./hybi/frame"),Message=require("./hybi/message"),Hybi=function(e,n,t){if(Base.apply(this,arguments),this._extensions=new Extensions,this._stage=0,this._masking=this._options.masking,this._protocols=this._options.protocols||[],this._requireMasking=this._options.requireMasking,this._pingCallbacks={},"string"==typeof this._protocols&&(this._protocols=this._protocols.split(/ *, */)),this._request){var r=this._request.headers["sec-websocket-key"],i=this._request.headers["sec-websocket-protocol"],a=this._request.headers["sec-websocket-version"],o=this._protocols;this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Accept",Hybi.generateAccept(r)),void 0!==i&&("string"==typeof i&&(i=i.split(/ *, */)),this.protocol=i.filter(function(e){return o.indexOf(e)>=0})[0],this.protocol&&this._headers.set("Sec-WebSocket-Protocol",this.protocol)),this.version="hybi-"+a}};util.inherits(Hybi,Base),Hybi.mask=function(e,n,t){if(!n||0===n.length)return e;t=t||0;for(var r=0,i=e.length-t;i>r;r++)e[t+r]=e[t+r]^n[r%4];return e},Hybi.generateAccept=function(e){var n=crypto.createHash("sha1");return n.update(e+Hybi.GUID),n.digest("base64")},Hybi.GUID="258EAFA5-E914-47DA-95CA-C5AB0DC85B11";var instance={FIN:128,MASK:128,RSV1:64,RSV2:32,RSV3:16,OPCODE:15,LENGTH:127,OPCODES:{continuation:0,text:1,binary:2,close:8,ping:9,pong:10},OPCODE_CODES:[0,1,2,8,9,10],MESSAGE_OPCODES:[0,1,2],OPENING_OPCODES:[1,2],ERRORS:{normal_closure:1e3,going_away:1001,protocol_error:1002,unacceptable:1003,encoding_error:1007,policy_violation:1008,too_large:1009,extension_error:1010,unexpected_condition:1011},ERROR_CODES:[1e3,1001,1002,1003,1007,1008,1009,1010,1011],DEFAULT_ERROR_CODE:1e3,MIN_RESERVED_ERROR:3e3,MAX_RESERVED_ERROR:4999,UTF8_MATCH:/^([\x00-\x7F]|[\xC2-\xDF][\x80-\xBF]|\xE0[\xA0-\xBF][\x80-\xBF]|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}|\xED[\x80-\x9F][\x80-\xBF]|\xF0[\x90-\xBF][\x80-\xBF]{2}|[\xF1-\xF3][\x80-\xBF]{3}|\xF4[\x80-\x8F][\x80-\xBF]{2})*$/,addExtension:function(e){return this._extensions.add(e),!0},parse:function(e){this._reader.put(e);for(var n=!0;n;)switch(this._stage){case 0:n=this._reader.read(1),n&&this._parseOpcode(n[0]);break;case 1:n=this._reader.read(1),n&&this._parseLength(n[0]);break;case 2:n=this._reader.read(this._frame.lengthBytes),n&&this._parseExtendedLength(n);break;case 3:n=this._reader.read(4),n&&(this._stage=4,this._frame.maskingKey=n);break;case 4:n=this._reader.read(this._frame.length),n&&(this._stage=0,this._emitFrame(n));break;default:n=null}},text:function(e){return this.readyState>1?!1:this.frame(e,"text")},binary:function(e){return this.readyState>1?!1:this.frame(e,"binary")},ping:function(e,n){return this.readyState>1?!1:(e=e||"",n&&(this._pingCallbacks[e]=n),this.frame(e,"ping"))},pong:function(e){return this.readyState>1?!1:(e=e||"",this.frame(e,"pong"))},close:function(e,n){return e=e||"",n=n||this.ERRORS.normal_closure,this.readyState<=0?(this.readyState=3,this.emit("close",new Base.CloseEvent(n,e)),!0):1===this.readyState?(this.readyState=2,this._extensions.close(function(){this.frame(e,"close",n)},this),!0):!1},frame:function(e,n,t){if(this.readyState<=0)return this._queue([e,n,t]);if(this.readyState>2)return!1;e instanceof Array&&(e=new Buffer(e));var a,o,r=new Message,i="string"==typeof e;r.rsv1=r.rsv2=r.rsv3=!1,r.opcode=this.OPCODES[n||(i?"text":"binary")],a=i?new Buffer(e,"utf8"):e,t&&(o=a,a=new Buffer(2+o.length),a.writeUInt16BE(t,0),o.copy(a,2)),r.data=a;var s=function(e){var n=new Frame;n["final"]=!0,n.rsv1=e.rsv1,n.rsv2=e.rsv2,n.rsv3=e.rsv3,n.opcode=e.opcode,n.masked=!!this._masking,n.length=e.data.length,n.payload=e.data,n.masked&&(n.maskingKey=crypto.randomBytes(4)),this._sendFrame(n)};return this.MESSAGE_OPCODES.indexOf(r.opcode)>=0?this._extensions.processOutgoingMessage(r,function(e,n){return e?this._fail("extension_error",e.message):void s.call(this,n)},this):s.call(this,r),!0},_sendFrame:function(e){var n=e.length,t=125>=n?2:65535>=n?4:10,r=t+(e.masked?4:0),i=new Buffer(r+n),a=e.masked?this.MASK:0;i[0]=(e["final"]?this.FIN:0)|(e.rsv1?this.RSV1:0)|(e.rsv2?this.RSV2:0)|(e.rsv3?this.RSV3:0)|e.opcode,125>=n?i[1]=a|n:65535>=n?(i[1]=126|a,i.writeUInt16BE(n,2)):(i[1]=127|a,i.writeUInt32BE(Math.floor(n/4294967296),2),i.writeUInt32BE(n%4294967296,6)),e.masked?(e.maskingKey.copy(i,t),Hybi.mask(e.payload,e.maskingKey).copy(i,r)):e.payload.copy(i,r),this._write(i)},_handshakeResponse:function(){try{var e=this._extensions.generateResponse(this._request.headers["sec-websocket-extensions"])}catch(n){return this._fail("protocol_error",n.message)}e&&this._headers.set("Sec-WebSocket-Extensions",e);var t="HTTP/1.1 101 Switching Protocols",r=[t,this._headers.toString(),""];return new Buffer(r.join("\r\n"),"utf8")},_shutdown:function(e,n,t){delete this._frame,delete this._message,this._stage=5;var r=1===this.readyState;this.readyState=2,this._extensions.close(function(){r&&this.frame(n,"close",e),this.readyState=3,t&&this.emit("error",new Error(n)),this.emit("close",new Base.CloseEvent(e,n))},this)},_fail:function(e,n){this.readyState>1||this._shutdown(this.ERRORS[e],n,!0)},_parseOpcode:function(e){var n=[this.RSV1,this.RSV2,this.RSV3].map(function(n){return(e&n)===n}),t=this._frame=new Frame;return t["final"]=(e&this.FIN)===this.FIN,t.rsv1=n[0],t.rsv2=n[1],t.rsv3=n[2],t.opcode=e&this.OPCODE,this._stage=1,this._extensions.validFrameRsv(t)?this.OPCODE_CODES.indexOf(t.opcode)<0?this._fail("protocol_error","Unrecognized frame opcode: "+t.opcode):this.MESSAGE_OPCODES.indexOf(t.opcode)<0&&!t["final"]?this._fail("protocol_error","Received fragmented control frame: opcode = "+t.opcode):this._message&&this.OPENING_OPCODES.indexOf(t.opcode)>=0?this._fail("protocol_error","Received new data frame but previous continuous frame is unfinished"):void 0:this._fail("protocol_error","One or more reserved bits are on: reserved1 = "+(t.rsv1?1:0)+", reserved2 = "+(t.rsv2?1:0)+", reserved3 = "+(t.rsv3?1:0))},_parseLength:function(e){var n=this._frame;if(n.masked=(e&this.MASK)===this.MASK,n.length=e&this.LENGTH,n.length>=0&&n.length<=125){if(this._stage=n.masked?3:4,!this._checkFrameLength())return}else this._stage=2,n.lengthBytes=126===n.length?2:8;return this._requireMasking&&!n.masked?this._fail("unacceptable","Received unmasked frame but masking is required"):void 0},_parseExtendedLength:function(e){var n=this._frame;return n.length=this._readUInt(e),this._stage=n.masked?3:4,this.MESSAGE_OPCODES.indexOf(n.opcode)<0&&n.length>125?this._fail("protocol_error","Received control frame having too long payload: "+n.length):void!this._checkFrameLength()},_checkFrameLength:function(){var e=this._message?this._message.length:0;return e+this._frame.length>this._maxLength?(this._fail("too_large","WebSocket frame length too large"),!1):!0},_emitFrame:function(e){var i,a,o,s,u,n=this._frame,t=n.payload=Hybi.mask(e,n.maskingKey),r=n.opcode;if(delete this._frame,r===this.OPCODES.continuation){if(!this._message)return this._fail("protocol_error","Received unexpected continuation frame");this._message.pushFrame(n)}return(r===this.OPCODES.text||r===this.OPCODES.binary)&&(this._message=new Message,this._message.pushFrame(n)),n["final"]&&this.MESSAGE_OPCODES.indexOf(r)>=0?this._emitMessage(this._message):(r===this.OPCODES.close&&(a=t.length>=2?t.readUInt16BE(0):null,o=t.length>2?this._encode(t.slice(2)):null,0!==t.length&&!(null!==a&&a>=this.MIN_RESERVED_ERROR&&a<=this.MAX_RESERVED_ERROR)&&this.ERROR_CODES.indexOf(a)<0&&(a=this.ERRORS.protocol_error),(t.length>125||t.length>2&&!o)&&(a=this.ERRORS.protocol_error),this._shutdown(a||this.DEFAULT_ERROR_CODE,o||"")),r===this.OPCODES.ping&&this.frame(t,"pong"),void(r===this.OPCODES.pong&&(s=this._pingCallbacks,i=this._encode(t),u=s[i],delete s[i],u&&u())))},_emitMessage:function(e){var e=this._message;e.read(),delete this._message,this._extensions.processIncomingMessage(e,function(e,n){if(e)return this._fail("extension_error",e.message);var t=n.data;return n.opcode===this.OPCODES.text&&(t=this._encode(t)),null===t?this._fail("encoding_error","Could not decode a text frame as UTF-8"):void this.emit("message",new Base.MessageEvent(t))},this)},_encode:function(e){try{var n=e.toString("binary",0,e.length);if(!this.UTF8_MATCH.test(n))return null}catch(t){}return e.toString("utf8",0,e.length)},_readUInt:function(e){return 2===e.length?e.readUInt16BE(0):4294967296*e.readUInt32BE(0)+e.readUInt32BE(4)}};for(var key in instance)Hybi.prototype[key]=instance[key];module.exports=Hybi;