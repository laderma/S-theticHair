var WebSocket=require(".."),deflate=require("permessage-deflate"),fs=require("fs"),http=require("http"),https=require("https"),port=process.argv[2]||7e3,secure="tls"===process.argv[3],options={extensions:[deflate],ping:5},upgradeHandler=function(e,n,t){var r=new WebSocket(e,n,t,["irc","xmpp"],options);console.log("[open]",r.url,r.version,r.protocol,e.headers),r.pipe(r),r.onclose=function(e){console.log("[close]",e.code,e.reason),r=null}},requestHandler=function(e,n){if(!WebSocket.EventSource.isEventSource(e))return staticHandler(e,n);var t=new WebSocket.EventSource(e,n),r=parseInt(t.lastEventId,10)||0;console.log("[open]",t.url,t.lastEventId);var a=setInterval(function(){r+=1,t.send("Time: "+r),setTimeout(function(){t&&t.send("Update!!",{event:"update",id:r})},1e3)},2e3);fs.createReadStream(__dirname+"/haproxy.conf").pipe(t,{end:!1}),t.onclose=function(){clearInterval(a),console.log("[close]",t.url),t=null}},staticHandler=function(e,n){var t=e.url;fs.readFile(__dirname+t,function(e,t){var r=e?404:200;n.writeHead(r,{"Content-Type":"text/html"}),n.write(t||"Not found"),n.end()})},server=secure?https.createServer({key:fs.readFileSync(__dirname+"/../spec/server.key"),cert:fs.readFileSync(__dirname+"/../spec/server.crt")}):http.createServer();server.on("request",requestHandler),server.on("upgrade",upgradeHandler),server.listen(port);