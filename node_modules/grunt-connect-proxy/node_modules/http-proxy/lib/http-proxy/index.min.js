function createRightProxy(e){return function(n){return function(t,r){var s,u,a="ws"===e?this.wsPasses:this.webPasses,i=[].slice.call(arguments),o=i.length-1;if("function"==typeof i[o]&&(u=i[o],o--),i[o]instanceof Buffer||i[o]===r||(n=extend({},n),extend(n,i[o]),o--),i[o]instanceof Buffer&&(s=i[o]),["target","forward"].forEach(function(e){"string"==typeof n[e]&&(n[e]=parse_url(n[e]))}),!n.target&&!n.forward)return this.emit("error",new Error("Must provide a proper URL as target"));for(var l=0;l<a.length&&!a[l](t,r,n,s,this,u);l++);}}}function ProxyServer(e){EE3.call(this),e=e||{},e.prependPath=e.prependPath===!1?!1:!0,this.web=this.proxyRequest=createRightProxy("web")(e),this.ws=this.proxyWebsocketRequest=createRightProxy("ws")(e),this.options=e,this.webPasses=Object.keys(web).map(function(e){return web[e]}),this.wsPasses=Object.keys(ws).map(function(e){return ws[e]}),this.on("error",this.onError,this)}var httpProxy=exports,extend=require("util")._extend,parse_url=require("url").parse,EE3=require("eventemitter3"),http=require("http"),https=require("https"),web=require("./passes/web-incoming"),ws=require("./passes/ws-incoming");httpProxy.Server=ProxyServer,httpProxy.createRightProxy=createRightProxy,require("util").inherits(ProxyServer,EE3),ProxyServer.prototype.onError=function(e){if(1===this.listeners("error").length)throw e},ProxyServer.prototype.listen=function(e,n){var t=this,r=function(e,n){t.web(e,n)};return this._server=this.options.ssl?https.createServer(this.options.ssl,r):http.createServer(r),this.options.ws&&this._server.on("upgrade",function(e,n,r){t.ws(e,n,r)}),this._server.listen(e,n),this},ProxyServer.prototype.close=function(e){function t(){n._server=null,e&&e.apply(null,arguments)}var n=this;this._server&&this._server.close(t)},ProxyServer.prototype.before=function(e,n,t){if("ws"!==e&&"web"!==e)throw new Error("type must be `web` or `ws`");var r="ws"===e?this.wsPasses:this.webPasses,a=!1;if(r.forEach(function(e,t){e.name===n&&(a=t)}),a===!1)throw new Error("No such pass");r.splice(a,0,t)},ProxyServer.prototype.after=function(e,n,t){if("ws"!==e&&"web"!==e)throw new Error("type must be `web` or `ws`");var r="ws"===e?this.wsPasses:this.webPasses,a=!1;if(r.forEach(function(e,t){e.name===n&&(a=t)}),a===!1)throw new Error("No such pass");r.splice(a++,0,t)};