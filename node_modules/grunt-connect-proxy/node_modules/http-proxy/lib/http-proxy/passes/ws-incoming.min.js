var http=require("http"),https=require("https"),common=require("../common"),passes=exports,passes=exports;[function(e,n){return"GET"===e.method&&e.headers.upgrade?"websocket"!==e.headers.upgrade.toLowerCase()?(n.destroy(),!0):void 0:(n.destroy(),!0)},function(e,n,t){if(t.xfwd){var r={"for":e.connection.remoteAddress||e.socket.remoteAddress,port:common.getPort(e),proto:common.hasEncryptedConnection(e)?"wss":"ws"};["for","port","proto"].forEach(function(n){e.headers["x-forwarded-"+n]=(e.headers["x-forwarded-"+n]||"")+(e.headers["x-forwarded-"+n]?",":"")+r[n]})}},function(e,n,t,r,i,a){function s(t){a?a(t,e,n):i.emit("error",t,e,n),n.end()}common.setupSocket(n),r&&r.length&&n.unshift(r);var o=(common.isSSL.test(t.target.protocol)?https:http).request(common.setupOutgoing(t.ssl||{},t,e));return o.on("error",s),o.on("response",function(e){e.upgrade||n.end()}),o.on("upgrade",function(e,t,r){t.on("error",s),t.on("end",function(){i.emit("close",e,t,r)}),n.on("error",function(){t.end()}),common.setupSocket(t),r&&r.length&&t.unshift(r),n.write(Object.keys(e.headers).reduce(function(n,t){var r=e.headers[t];if(!Array.isArray(r))return n.push(t+": "+r),n;for(var i=0;i<r.length;i++)n.push(t+": "+r[i]);return n},["HTTP/1.1 101 Switching Protocols"]).join("\r\n")+"\r\n\r\n"),t.pipe(n).pipe(t),i.emit("open",t),i.emit("proxySocket",t)}),o.end()}].forEach(function(e){passes[e.name]=e});