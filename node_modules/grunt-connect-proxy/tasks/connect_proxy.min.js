"use strict";var utils=require("../lib/utils"),_=require("lodash");module.exports=function(n){n.registerTask("configureProxies","Configure any specified connect proxies.",function(e){var r,t=require("http-proxy"),a=[],i=function(e){return _.isUndefined(e.host)||_.isUndefined(e.context)?(n.log.error("Proxy missing host or context configuration"),!1):(e.https&&80===e.port&&n.log.warn("Proxy  for "+e.context+" is using https on port 80. Are you sure this is correct?"),!0)};if(utils.reset(),utils.log=n.log,e){var s=n.config("connect."+e)||[];("undefined"==typeof s.appendProxies||s.appendProxies)&&(a=a.concat(n.config("connect.proxies")||[])),a=a.concat(s.proxies||[])}else a=a.concat(n.config("connect.proxies")||[]);a.forEach(function(e){r=_.defaults(e,{port:80,https:!1,xforward:!1,rules:[],ws:!1}),i(r)&&(r.rules=utils.processRewrites(r.rewrite),utils.registerProxy({server:t.createProxyServer({target:r,secure:r.https,xfwd:r.xforward}).on("error",function(e,t,r){n.log.error("Proxy error: ",e.code)}),config:r}),n.log.writeln("Proxy created for: "+r.context+" to "+r.host+":"+r.port))})})};