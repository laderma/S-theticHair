function safeStringify(n){var e;try{e=JSON.stringify(n)}catch(r){e=_safeStringify(n)}return e}function isReadStream(n){return n.readable&&n.path&&n.mode?!0:void 0}function toBase64(n){return new Buffer(n||"","ascii").toString("base64")}function md5(n){return crypto.createHash("md5").update(n).digest("hex")}function Request(n){stream.Stream.call(this),this.readable=!0,this.writable=!0,"string"==typeof n&&(n={uri:n});var e=Object.keys(Request.prototype);for(var r in n)-1===e.indexOf(r)?this[r]=n[r]:"function"==typeof n[r]&&delete n[r];n.method&&(this.explicitMethod=!0),this.canTunnel=n.tunnel!==!1&&tunnel,this.init(n)}function toJSON(){return getSafe(this,"__"+(65536*(1+Math.random())|0).toString(16))}var optional=require("./lib/optional"),http=require("http"),https=optional("https"),tls=optional("tls"),url=require("url"),util=require("util"),stream=require("stream"),qs=require("qs"),querystring=require("querystring"),crypto=require("crypto"),oauth=optional("oauth-sign"),hawk=optional("hawk"),aws=optional("aws-sign"),httpSignature=optional("http-signature"),uuid=require("node-uuid"),mime=require("mime"),tunnel=optional("tunnel-agent"),_safeStringify=require("json-stringify-safe"),ForeverAgent=require("forever-agent"),FormData=optional("form-data"),Cookie=optional("tough-cookie"),CookieJar=Cookie&&Cookie.CookieJar,cookieJar=CookieJar&&new CookieJar,copy=require("./lib/copy"),debug=require("./lib/debug"),getSafe=require("./lib/getSafe"),globalPool={},isUrl=/^https?:/i;https&&!https.Agent&&(https.Agent=function(n){http.Agent.call(this,n)},util.inherits(https.Agent,http.Agent),https.Agent.prototype._getConnection=function(n,e,r){var a=tls.connect(e,n,this.options,function(){r&&r()});return a}),util.inherits(Request,stream.Stream),Request.prototype.init=function(n){var e=this;if(n||(n={}),e.method||(e.method=n.method||"GET"),e.localAddress=n.localAddress,debug(n),e.pool||e.pool===!1||(e.pool=globalPool),e.dests=e.dests||[],e.__isRequestRequest=!0,!e._callback&&e.callback&&(e._callback=e.callback,e.callback=function(){e._callbackCalled||(e._callbackCalled=!0,e._callback.apply(e,arguments))},e.on("error",e.callback.bind()),e.on("complete",e.callback.bind(e,null))),e.url&&!e.uri&&(e.uri=e.url,delete e.url),!e.uri)return e.emit("error",new Error("options.uri is a required argument"));if("string"==typeof e.uri&&(e.uri=url.parse(e.uri)),e.strictSSL===!1&&(e.rejectUnauthorized=!1),e.proxy&&("string"==typeof e.proxy&&(e.proxy=url.parse(e.proxy)),http.globalAgent&&"https:"===e.uri.protocol&&e.canTunnel)){var r="http:"===e.proxy.protocol?tunnel.httpsOverHttp:tunnel.httpsOverHttps,a={proxy:{host:e.proxy.hostname,port:+e.proxy.port,proxyAuth:e.proxy.auth,headers:{Host:e.uri.hostname+":"+(e.uri.port||"https:"===e.uri.protocol?443:80)}},rejectUnauthorized:e.rejectUnauthorized,ca:this.ca};e.agent=r(a),e.tunnel=!0}if(e.uri.pathname||(e.uri.pathname="/"),!e.uri.host){var t=url.format(e.uri),i='Invalid URI "'+t+'"';return 0===Object.keys(n).length&&(i+=". This can be caused by a crappy redirection."),void e.emit("error",new Error(i))}if(e._redirectsFollowed=e._redirectsFollowed||0,e.maxRedirects=void 0!==e.maxRedirects?e.maxRedirects:10,e.followRedirect=void 0!==e.followRedirect?e.followRedirect:!0,e.followAllRedirects=void 0!==e.followAllRedirects?e.followAllRedirects:!1,(e.followRedirect||e.followAllRedirects)&&(e.redirects=e.redirects||[]),e.headers=e.headers?copy(e.headers):{},e.setHost=!1,e.hasHeader("host")||(e.setHeader("host",e.uri.hostname),e.uri.port&&(80===e.uri.port&&"http:"===e.uri.protocol||443===e.uri.port&&"https:"===e.uri.protocol||e.setHeader("host",e.getHeader("host")+(":"+e.uri.port))),e.setHost=!0),e.jar(e._jar||n.jar),e.uri.port||("http:"==e.uri.protocol?e.uri.port=80:"https:"==e.uri.protocol&&(e.uri.port=443)),e.proxy&&!e.tunnel?(e.port=e.proxy.port,e.host=e.proxy.hostname):(e.port=e.uri.port,e.host=e.uri.hostname),e.clientErrorHandler=function(n){if(!e._aborted){if(e.req&&e.req._reusedSocket&&"ECONNRESET"===n.code&&e.agent.addRequestNoreuse)return e.agent={addRequest:e.agent.addRequestNoreuse.bind(e.agent)},e.start(),void e.req.end();e.timeout&&e.timeoutTimer&&(clearTimeout(e.timeoutTimer),e.timeoutTimer=null),e.emit("error",n)}},e._parserErrorHandler=function(n){this.res?this.res.request?this.res.request.emit("error",n):this.res.emit("error",n):this._httpMessage.emit("error",n)},n.form&&e.form(n.form),n.qs&&e.qs(n.qs),e.uri.path?e.path=e.uri.path:e.path=e.uri.pathname+(e.uri.search||""),0===e.path.length&&(e.path="/"),n.oauth&&e.oauth(n.oauth),n.aws&&e.aws(n.aws),n.hawk&&e.hawk(n.hawk),n.httpSignature&&e.httpSignature(n.httpSignature),n.auth&&(Object.prototype.hasOwnProperty.call(n.auth,"username")&&(n.auth.user=n.auth.username),Object.prototype.hasOwnProperty.call(n.auth,"password")&&(n.auth.pass=n.auth.password),e.auth(n.auth.user,n.auth.pass,n.auth.sendImmediately)),e.uri.auth&&!e.hasHeader("authorization")){var s=e.uri.auth.split(":").map(function(n){return querystring.unescape(n)});e.auth(s[0],s.slice(1).join(":"),!0)}if(e.proxy&&e.proxy.auth&&!e.hasHeader("proxy-authorization")&&!e.tunnel&&e.setHeader("proxy-authorization","Basic "+toBase64(e.proxy.auth.split(":").map(function(n){return querystring.unescape(n)}).join(":"))),e.proxy&&!e.tunnel&&(e.path=e.uri.protocol+"//"+e.uri.host+e.path),n.json?e.json(n.json):n.multipart&&(e.boundary=uuid(),e.multipart(n.multipart)),e.body){var l=0;if(Buffer.isBuffer(e.body))l=e.body.length;else if(Array.isArray(e.body))for(var o=0;o<e.body.length;o++)l+=e.body[o].length;else e.body=new Buffer(e.body),l=e.body.length;if(!l)throw new Error("Argument error, options.body.");e.hasHeader("content-length")||e.setHeader("content-length",l)}var u=e.proxy&&!e.tunnel?e.proxy.protocol:e.uri.protocol,h={"http:":http,"https:":https},c=e.httpModules||{};return e.httpModule=c[u]||h[u],e.httpModule?(n.ca&&(e.ca=n.ca),e.agent||(n.agentOptions&&(e.agentOptions=n.agentOptions),n.agentClass?e.agentClass=n.agentClass:n.forever?e.agentClass="http:"===u?ForeverAgent:ForeverAgent.SSL:e.agentClass=e.httpModule.Agent),e.pool===!1?e.agent=!1:(e.agent=e.agent||e.getAgent(),e.maxSockets&&(e.agent.maxSockets=e.maxSockets),e.pool.maxSockets&&(e.agent.maxSockets=e.pool.maxSockets)),e.on("pipe",function(n){if(e.ntick&&e._started)throw new Error("You cannot pipe to this stream after the outbound request has started.");if(e.src=n,isReadStream(n))e.hasHeader("content-type")||e.setHeader("content-type",mime.lookup(n.path));else{if(n.headers)for(var r in n.headers)e.hasHeader(r)||e.setHeader(r,n.headers[r]);e._json&&!e.hasHeader("content-type")&&e.setHeader("content-type","application/json"),n.method&&!e.explicitMethod&&(e.method=n.method)}}),void process.nextTick(function(){e._aborted||(e._form&&(e.setHeaders(e._form.getHeaders()),e._form.pipe(e)),e.body?(Array.isArray(e.body)?e.body.forEach(function(n){e.write(n)}):e.write(e.body),e.end()):e.requestBodyStream?(console.warn("options.requestBodyStream is deprecated, please pass the request object to stream.pipe."),e.requestBodyStream.pipe(e)):e.src||("GET"!==e.method&&"undefined"!=typeof e.method&&e.setHeader("content-length",0),e.end()),e.ntick=!0)})):this.emit("error",new Error("Invalid protocol"))},Request.prototype._updateProtocol=function(){var n=this,e=n.uri.protocol;if("https:"===e){if(n.proxy&&n.canTunnel){n.tunnel=!0;var r="http:"===n.proxy.protocol?tunnel.httpsOverHttp:tunnel.httpsOverHttps,a={proxy:{host:n.proxy.hostname,port:+n.proxy.port,proxyAuth:n.proxy.auth},rejectUnauthorized:n.rejectUnauthorized,ca:n.ca};return void(n.agent=r(a))}switch(n.httpModule=https,n.agentClass){case ForeverAgent:n.agentClass=ForeverAgent.SSL;break;case http.Agent:n.agentClass=https.Agent;break;default:return}n.agent&&(n.agent=n.getAgent())}else{switch(n.tunnel&&(n.tunnel=!1),n.httpModule=http,n.agentClass){case ForeverAgent.SSL:n.agentClass=ForeverAgent;break;case https.Agent:n.agentClass=http.Agent;break;default:return}n.agent&&(n.agent=null,n.agent=n.getAgent())}},Request.prototype.getAgent=function(){var n=this.agentClass,e={};if(this.agentOptions)for(var r in this.agentOptions)e[r]=this.agentOptions[r];this.ca&&(e.ca=this.ca),this.ciphers&&(e.ciphers=this.ciphers),this.secureProtocol&&(e.secureProtocol=this.secureProtocol),"undefined"!=typeof this.rejectUnauthorized&&(e.rejectUnauthorized=this.rejectUnauthorized),this.cert&&this.key&&(e.key=this.key,e.cert=this.cert);var a="";n!==this.httpModule.Agent&&(a+=n.name),this.httpModule.globalAgent||(e.host=this.host,e.port=this.port,a&&(a+=":"),a+=this.host+":"+this.port);var t=this.proxy;"string"==typeof t&&(t=url.parse(t));var i=t&&"https:"===t.protocol||"https:"===this.uri.protocol;return i&&(e.ca&&(a&&(a+=":"),a+=e.ca),"undefined"!=typeof e.rejectUnauthorized&&(a&&(a+=":"),a+=e.rejectUnauthorized),e.cert&&(a+=e.cert.toString("ascii")+e.key.toString("ascii")),e.ciphers&&(a&&(a+=":"),a+=e.ciphers),e.secureProtocol&&(a&&(a+=":"),a+=e.secureProtocol)),this.pool===globalPool&&!a&&0===Object.keys(e).length&&this.httpModule.globalAgent?this.httpModule.globalAgent:(a=this.uri.protocol+a,this.pool[a]?this.pool[a]:this.pool[a]=new n(e))},Request.prototype.start=function(){var n=this;if(!n._aborted){n._started=!0,n.method=n.method||"GET",n.href=n.uri.href,n.src&&n.src.stat&&n.src.stat.size&&!n.hasHeader("content-length")&&n.setHeader("content-length",n.src.stat.size),n._aws&&n.aws(n._aws,!0);var e=copy(n);delete e.auth,debug("make request",n.uri.href),n.req=n.httpModule.request(e,n.onResponse.bind(n)),n.timeout&&!n.timeoutTimer&&(n.timeoutTimer=setTimeout(function(){n.req.abort();var e=new Error("ETIMEDOUT");e.code="ETIMEDOUT",n.emit("error",e)},n.timeout),n.req.setTimeout&&n.req.setTimeout(n.timeout,function(){if(n.req){n.req.abort();var e=new Error("ESOCKETTIMEDOUT");e.code="ESOCKETTIMEDOUT",n.emit("error",e)}})),n.req.on("error",n.clientErrorHandler),n.req.on("drain",function(){n.emit("drain")}),n.on("end",function(){n.req.connection&&n.req.connection.removeListener("error",n._parserErrorHandler)}),n.emit("request",n.req)}},Request.prototype.onResponse=function(n){var e=this;if(debug("onResponse",e.uri.href,n.statusCode,n.headers),n.on("end",function(){debug("response end",e.uri.href,n.statusCode,n.headers)}),-1===n.connection.listeners("error").indexOf(e._parserErrorHandler)&&n.connection.once("error",e._parserErrorHandler),e._aborted)return debug("aborted",e.uri.href),void n.resume();if(e._paused?n.pause():n.resume(),e.response=n,n.request=e,n.toJSON=toJSON,e.httpModule===https&&e.strictSSL&&!n.client.authorized){debug("strict ssl error",e.uri.href);var r=n.client.authorizationError;return void e.emit("error",new Error("SSL Error: "+r))}e.setHost&&e.hasHeader("host")&&delete e.headers[e.hasHeader("host")],e.timeout&&e.timeoutTimer&&(clearTimeout(e.timeoutTimer),e.timeoutTimer=null);var a=function(n){if(e._jar){var r=e._jar.setCookie?e._jar:cookieJar;r.setCookie(n,e.uri.href,function(n){n&&console.warn("set cookie failed,"+n)})}};if(hasHeader("set-cookie",n.headers)&&!e._disableCookies){var t=hasHeader("set-cookie",n.headers);Array.isArray(n.headers[t])?n.headers[t].forEach(a):a(n.headers[t])}var i=null;if(n.statusCode>=300&&n.statusCode<400&&hasHeader("location",n.headers)){var s=n.headers[hasHeader("location",n.headers)];if(debug("redirect",s),e.followAllRedirects)i=s;else if(e.followRedirect)switch(e.method){case"PATCH":case"PUT":case"POST":case"DELETE":break;default:i=s}}else if(401==n.statusCode&&e._hasAuth&&!e._sentAuth){var l=n.headers[hasHeader("www-authenticate",n.headers)],o=l&&l.split(" ")[0];switch(debug("reauth",o),o){case"Basic":e.auth(e._user,e._pass,!0),i=e.uri;break;case"Digest":for(var u={},h=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/gi;;){var c=h.exec(l);if(!c)break;u[c[1]]=c[2]||c[3]}var d=md5(e._user+":"+u.realm+":"+e._pass),f=md5(e.method+":"+e.uri.path),g=/(^|,)\s*auth\s*($|,)/.test(u.qop)&&"auth",m=g&&"00000001",p=g&&uuid().replace(/-/g,""),b=md5(g?d+":"+u.nonce+":"+m+":"+p+":"+g+":"+f:d+":"+u.nonce+":"+f),H={username:e._user,realm:u.realm,nonce:u.nonce,uri:e.uri.path,qop:g,response:b,nc:m,cnonce:p,algorithm:u.algorithm,opaque:u.opaque};l=[];for(var k in H)H[k]&&("qop"===k||"nc"===k||"algorithm"===k?l.push(k+"="+H[k]):l.push(k+'="'+H[k]+'"'));l="Digest "+l.join(", "),e.setHeader("authorization",l),e._sentAuth=!0,i=e.uri}}if(i){if(debug("redirect to",i),e._paused&&n.resume(),e._redirectsFollowed>=e.maxRedirects)return void e.emit("error",new Error("Exceeded maxRedirects. Probably stuck in a redirect loop "+e.uri.href));e._redirectsFollowed+=1,isUrl.test(i)||(i=url.resolve(e.uri.href,i));var v=e.uri;return e.uri=url.parse(i),e.uri.protocol!==v.protocol&&e._updateProtocol(),e.redirects.push({statusCode:n.statusCode,redirectUri:i}),e.followAllRedirects&&401!=n.statusCode&&(e.method="GET"),delete e.src,delete e.req,delete e.agent,delete e._started,401!=n.statusCode&&(delete e.body,delete e._form,e.headers&&(e.hasHeader("host")&&delete e.headers[e.hasHeader("host")],e.hasHeader("content-type")&&delete e.headers[e.hasHeader("content-type")],e.hasHeader("content-length")&&delete e.headers[e.hasHeader("content-length")])),e.emit("redirect"),void e.init()}if(e._redirectsFollowed=e._redirectsFollowed||0,n.on("close",function(){e._ended||e.response.emit("end")}),e.encoding&&(0!==e.dests.length?console.error("Ignoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid."):n.setEncoding(e.encoding)),e.emit("response",n),e.dests.forEach(function(n){e.pipeDest(n)}),n.on("data",function(n){e._destdata=!0,e.emit("data",n)}),n.on("end",function(n){e._ended=!0,e.emit("end",n)}),n.on("close",function(){e.emit("close")}),e.callback){var S=[],w=0;e.on("data",function(n){S.push(n),w+=n.length}),e.on("end",function(){if(debug("end event",e.uri.href),e._aborted)return void debug("aborted",e.uri.href);if(S.length&&Buffer.isBuffer(S[0])){debug("has body",e.uri.href,w);var r=new Buffer(w),a=0;S.forEach(function(n){n.copy(r,a,0,n.length),a+=n.length}),null===e.encoding?n.body=r:n.body=r.toString(e.encoding)}else S.length&&("utf8"===e.encoding&&S[0].length>0&&"\ufeff"===S[0][0]&&(S[0]=S[0].substring(1)),n.body=S.join(""));if(e._json)try{n.body=JSON.parse(n.body)}catch(t){}debug("emitting complete",e.uri.href),void 0!=n.body||e._json||(n.body=""),e.emit("complete",n,n.body)})}else e.on("end",function(){return e._aborted?void debug("aborted",e.uri.href):void e.emit("complete",n)});debug("finish init function",e.uri.href)},Request.prototype.abort=function(){this._aborted=!0,this.req?this.req.abort():this.response&&this.response.abort(),this.emit("abort")},Request.prototype.pipeDest=function(n){var e=this.response;if(n.headers&&!n.headersSent){if(hasHeader("content-type",e.headers)){var r=hasHeader("content-type",e.headers);n.setHeader?n.setHeader(r,e.headers[r]):n.headers[r]=e.headers[r]}if(hasHeader("content-length",e.headers)){var a=hasHeader("content-length",e.headers);n.setHeader?n.setHeader(a,e.headers[a]):n.headers[a]=e.headers[a]}}if(n.setHeader&&!n.headersSent){for(var t in e.headers)n.setHeader(t,e.headers[t]);n.statusCode=e.statusCode}this.pipefilter&&this.pipefilter(e,n)},Request.prototype.setHeader=function(n,e,r){return void 0===r&&(r=!0),r||!this.hasHeader(n)?this.headers[n]=e:this.headers[this.hasHeader(n)]+=","+e,this},Request.prototype.setHeaders=function(n){for(var e in n)this.setHeader(e,n[e]);return this},Request.prototype.hasHeader=function(n,e){var e=Object.keys(e||this.headers),r=e.map(function(n){return n.toLowerCase()});n=n.toLowerCase();for(var a=0;a<r.length;a++)if(r[a]===n)return e[a];return!1};var hasHeader=Request.prototype.hasHeader;Request.prototype.qs=function(n,e){var r;r=!e&&this.uri.query?qs.parse(this.uri.query):{};for(var a in n)r[a]=n[a];return""===qs.stringify(r)?this:(this.uri=url.parse(this.uri.href.split("?")[0]+"?"+qs.stringify(r)),this.url=this.uri,this.path=this.uri.path,this)},Request.prototype.form=function(n){return n?(this.setHeader("content-type","application/x-www-form-urlencoded; charset=utf-8"),this.body=qs.stringify(n).toString("utf8"),this):(this._form=new FormData,this._form)},Request.prototype.multipart=function(n){var e=this;if(e.body=[],e.hasHeader("content-type")){var r=e.hasHeader("content-type");e.setHeader(r,e.headers[r].split(";")[0]+"; boundary="+e.boundary)}else e.setHeader("content-type","multipart/related; boundary="+e.boundary);if(!n.forEach)throw new Error("Argument error, options.multipart.");return e.preambleCRLF&&e.body.push(new Buffer("\r\n")),n.forEach(function(n){var r=n.body;if(null==r)throw Error("Body attribute missing in multipart.");delete n.body;var a="--"+e.boundary+"\r\n";Object.keys(n).forEach(function(e){a+=e+": "+n[e]+"\r\n"}),a+="\r\n",e.body.push(new Buffer(a)),e.body.push(new Buffer(r)),e.body.push(new Buffer("\r\n"))}),e.body.push(new Buffer("--"+e.boundary+"--")),e},Request.prototype.json=function(n){var e=this;return e.hasHeader("accept")||e.setHeader("accept","application/json"),this._json=!0,"boolean"==typeof n?"object"==typeof this.body&&(this.body=safeStringify(this.body),e.setHeader("content-type","application/json")):(this.body=safeStringify(n),e.setHeader("content-type","application/json")),this},Request.prototype.getHeader=function(n,e){var r,a,t;return e||(e=this.headers),Object.keys(e).forEach(function(i){a=new RegExp(n,"i"),t=i.match(a),t&&(r=e[i])}),r};var getHeader=Request.prototype.getHeader;Request.prototype.auth=function(n,e,r){if("string"!=typeof n||void 0!==e&&"string"!=typeof e)throw new Error("auth() received invalid user or password");this._user=n,this._pass=e,this._hasAuth=!0;var a="undefined"!=typeof e?n+":"+e:n;return(r||"undefined"==typeof r)&&(this.setHeader("authorization","Basic "+toBase64(a)),this._sentAuth=!0),this},Request.prototype.aws=function(n,e){if(!e)return this._aws=n,this;var r=new Date;this.setHeader("date",r.toUTCString());var a={key:n.key,secret:n.secret,verb:this.method.toUpperCase(),date:r,contentType:this.getHeader("content-type")||"",md5:this.getHeader("content-md5")||"",amazonHeaders:aws.canonicalizeHeaders(this.headers)};return n.bucket&&this.path?a.resource="/"+n.bucket+this.path:n.bucket&&!this.path?a.resource="/"+n.bucket:!n.bucket&&this.path?a.resource=this.path:n.bucket||this.path||(a.resource="/"),a.resource=aws.canonicalizeResource(a.resource),this.setHeader("authorization",aws.authorization(a)),this},Request.prototype.httpSignature=function(n){var e=this;return httpSignature.signRequest({getHeader:function(n){return getHeader(n,e.headers)},setHeader:function(n,r){e.setHeader(n,r)},method:this.method,path:this.path},n),debug("httpSignature authorization",this.getHeader("authorization")),this},Request.prototype.hawk=function(n){this.setHeader("Authorization",hawk.client.header(this.uri,this.method,n).field)},Request.prototype.oauth=function(n){var e;this.hasHeader("content-type")&&"application/x-www-form-urlencoded"===this.getHeader("content-type").slice(0,"application/x-www-form-urlencoded".length)&&(e=qs.parse(this.body)),this.uri.query&&(e=qs.parse(this.uri.query)),e||(e={});var r={};for(var a in e)r[a]=e[a];for(var a in n)r["oauth_"+a]=n[a];r.oauth_version||(r.oauth_version="1.0"),r.oauth_timestamp||(r.oauth_timestamp=Math.floor(Date.now()/1e3).toString()),r.oauth_nonce||(r.oauth_nonce=uuid().replace(/-/g,"")),r.oauth_signature_method="HMAC-SHA1";var t=r.oauth_consumer_secret;delete r.oauth_consumer_secret;var i=r.oauth_token_secret;delete r.oauth_token_secret;var s=r.oauth_timestamp,l=this.uri.protocol+"//"+this.uri.host+this.uri.pathname,o=oauth.hmacsign(this.method,l,r,t,i);for(var a in e)a.slice(0,"oauth_")in n||(delete r["oauth_"+a],"x_auth_mode"!==a&&delete r[a]);r.oauth_timestamp=s;var u="OAuth "+Object.keys(r).sort().map(function(n){return n+'="'+oauth.rfc3986(r[n])+'"'}).join(",");return u+=',oauth_signature="'+oauth.rfc3986(o)+'"',this.setHeader("Authorization",u),this},Request.prototype.jar=function(n){var e;if(0===this._redirectsFollowed&&(this.originalCookieHeader=this.getHeader("cookie")),n){var r=n&&n.getCookieString?n:cookieJar,a=this.uri.href;r.getCookieString(a,function(n,r){n?console.warn("get cookieString failed,"+n):e=r})}else e=!1,this._disableCookies=!0;return e&&e.length&&(this.originalCookieHeader?this.setHeader("cookie",this.originalCookieHeader+"; "+e):this.setHeader("cookie",e)),this._jar=n,this},Request.prototype.pipe=function(n,e){if(this.response){if(this._destdata)throw new Error("You cannot pipe after data has been emitted from the response.");if(this._ended)throw new Error("You cannot pipe after the response has been ended.");return stream.Stream.prototype.pipe.call(this,n,e),this.pipeDest(n),n}return this.dests.push(n),stream.Stream.prototype.pipe.call(this,n,e),n},Request.prototype.write=function(){return this._started||this.start(),this.req.write.apply(this.req,arguments)},Request.prototype.end=function(n){n&&this.write(n),this._started||this.start(),this.req.end()},Request.prototype.pause=function(){this.response?this.response.pause.apply(this.response,arguments):this._paused=!0},Request.prototype.resume=function(){this.response?this.response.resume.apply(this.response,arguments):this._paused=!1},Request.prototype.destroy=function(){this._ended?this.response&&this.response.destroy():this.end()},Request.prototype.toJSON=toJSON,module.exports=Request;