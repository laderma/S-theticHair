var Lab=require("lab"),Hoek=require("hoek"),Hawk=require("../lib"),Browser=require("../lib/browser"),LocalStorage=require("localStorage"),internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("Browser",function(){var e=function(e,n){var t={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"1"===e?"sha1":"sha256",user:"steve"};return n(null,t)};it("should generate a header then successfully parse it (configuration)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,a){t.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,ext:"some-app-data"}).field,expect(t.authorization).to.exist,Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),n()})})}),it("should generate a header then successfully parse it (node request)",function(n){var t={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},r="some not so random text";e("123456",function(a,i){var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:i,ext:"some-app-data",payload:r,contentType:t.headers["content-type"]});t.headers.authorization=s.field,Hawk.server.authenticate(t,e,{},function(e,a,i){expect(e).to.not.exist,expect(a.user).to.equal("steve"),expect(i.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(r,a,i,t.headers["content-type"])).to.equal(!0);var s={headers:{"content-type":"text/plain"},getResponseHeader:function(e){return s.headers[e.toLowerCase()]}};s.headers["server-authorization"]=Hawk.server.header(a,i,{payload:"some reply",contentType:"text/plain",ext:"response-specific"}),expect(s.headers["server-authorization"]).to.exist,expect(Browser.client.authenticate(s,a,i,{payload:"some reply"})).to.equal(!0),n()})})}),it("should generate a header then successfully parse it (no server header options)",function(n){var t={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},r="some not so random text";e("123456",function(a,i){var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:i,ext:"some-app-data",payload:r,contentType:t.headers["content-type"]});t.headers.authorization=s.field,Hawk.server.authenticate(t,e,{},function(e,a,i){expect(e).to.not.exist,expect(a.user).to.equal("steve"),expect(i.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(r,a,i,t.headers["content-type"])).to.equal(!0);var s={headers:{"content-type":"text/plain"},getResponseHeader:function(e){return s.headers[e.toLowerCase()]}};s.headers["server-authorization"]=Hawk.server.header(a,i),expect(s.headers["server-authorization"]).to.exist,expect(Browser.client.authenticate(s,a,i)).to.equal(!0),n()})})}),it("should generate a header then successfully parse it (no server header)",function(n){var t={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},r="some not so random text";e("123456",function(a,i){var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:i,ext:"some-app-data",payload:r,contentType:t.headers["content-type"]});t.headers.authorization=s.field,Hawk.server.authenticate(t,e,{},function(e,a,i){expect(e).to.not.exist,expect(a.user).to.equal("steve"),expect(i.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(r,a,i,t.headers["content-type"])).to.equal(!0);var s={headers:{"content-type":"text/plain"},getResponseHeader:function(e){return s.headers[e.toLowerCase()]}};expect(Browser.client.authenticate(s,a,i)).to.equal(!0),n()})})}),it("should generate a header with stale ts and successfully authenticate on second call",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,a){Browser.utils.setNtpOffset(36e5);var i=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,ext:"some-app-data"});t.authorization=i.field,expect(t.authorization).to.exist,Hawk.server.authenticate(t,e,{},function(r,a,s){expect(r).to.exist,expect(r.message).to.equal("Stale timestamp");var o={headers:{"www-authenticate":r.response.headers["WWW-Authenticate"]},getResponseHeader:function(e){return o.headers[e.toLowerCase()]}};expect(Browser.utils.getNtpOffset()).to.equal(36e5),expect(Browser.client.authenticate(o,a,i.artifacts)).to.equal(!0),expect(Browser.utils.getNtpOffset()).to.equal(0),t.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,ext:"some-app-data"}).field,expect(t.authorization).to.exist,Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),n()})})})}),it("should generate a header with stale ts and successfully authenticate on second call (manual localStorage)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,a){Browser.utils.setStorage(LocalStorage),Browser.utils.setNtpOffset(36e5);var i=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,ext:"some-app-data"});t.authorization=i.field,expect(t.authorization).to.exist,Hawk.server.authenticate(t,e,{},function(r,a,s){expect(r).to.exist,expect(r.message).to.equal("Stale timestamp");var o={headers:{"www-authenticate":r.response.headers["WWW-Authenticate"]},getResponseHeader:function(e){return o.headers[e.toLowerCase()]}};expect(parseInt(LocalStorage.getItem("hawk_ntp_offset"))).to.equal(36e5),expect(Browser.utils.getNtpOffset()).to.equal(36e5),expect(Browser.client.authenticate(o,a,i.artifacts)).to.equal(!0),expect(Browser.utils.getNtpOffset()).to.equal(0),expect(parseInt(LocalStorage.getItem("hawk_ntp_offset"))).to.equal(0),t.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,ext:"some-app-data"}).field,expect(t.authorization).to.exist,Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),n()})})})}),it("should generate a header then fails to parse it (missing server header hash)",function(n){var t={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},r="some not so random text";e("123456",function(a,i){var s=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:i,ext:"some-app-data",payload:r,contentType:t.headers["content-type"]});t.headers.authorization=s.field,Hawk.server.authenticate(t,e,{},function(e,a,i){expect(e).to.not.exist,expect(a.user).to.equal("steve"),expect(i.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(r,a,i,t.headers["content-type"])).to.equal(!0);var s={headers:{"content-type":"text/plain"},getResponseHeader:function(e){return s.headers[e.toLowerCase()]}};s.headers["server-authorization"]=Hawk.server.header(a,i),expect(s.headers["server-authorization"]).to.exist,expect(Browser.client.authenticate(s,a,i,{payload:"some reply"})).to.equal(!1),n()})})}),it("should generate a header then successfully parse it (with hash)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,a){t.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,payload:"hola!",ext:"some-app-data"}).field,Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),n()})})}),it("should generate a header then successfully parse it then validate payload",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,a){t.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,payload:"hola!",ext:"some-app-data"}).field,Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload("hola!",t,r)).to.be["true"],expect(Hawk.server.authenticatePayload("hello!",t,r)).to.be["false"],n()})})}),it("should generate a header then successfully parse it (app)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,a){t.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,ext:"some-app-data",app:"asd23ased"}).field,Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),expect(r.app).to.equal("asd23ased"),n()})})}),it("should generate a header then successfully parse it (app, dlg)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,a){t.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,ext:"some-app-data",app:"asd23ased",dlg:"23434szr3q4d"}).field,Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),expect(r.app).to.equal("asd23ased"),expect(r.dlg).to.equal("23434szr3q4d"),n()})})}),it("should generate a header then fail authentication due to bad hash",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,a){t.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,payload:"hola!",ext:"some-app-data"}).field,Hawk.server.authenticate(t,e,{payload:"byebye!"},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad payload hash"),n()})})}),it("should generate a header for one resource then fail to authenticate another",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(r,a){t.authorization=Browser.client.header("http://example.com:8080/resource/4?filter=a",t.method,{credentials:a,ext:"some-app-data"}).field,t.url="/something/else",Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(t).to.exist,n()})})}),describe("client",function(){describe("#header",function(){it("should return a valid authorization header (sha1)",function(e){var n={id:"123456",key:"2983d45yun89q",algorithm:"sha1"},t=Browser.client.header("http://example.net/somewhere/over/the/rainbow","POST",{credentials:n,ext:"Bazinga!",timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about"}).field;expect(t).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="bsvY3IfUllw6V5rvk4tStEvpBhE=", ext="Bazinga!", mac="qbf1ZPG/r/e06F4ht+T77LXi5vw="'),e()}),it("should return a valid authorization header (sha256)",function(e){var n={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},t=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:n,ext:"Bazinga!",timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"}).field;expect(t).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", ext="Bazinga!", mac="q1CwFoSHzPZSkbIvl0oYlD+91rBUEvFk763nMjMndj8="'),e()}),it("should return a valid authorization header (no ext)",function(e){var n={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},t=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:n,timestamp:1353809207,nonce:"Ygvqdz",payload:"something to write about",contentType:"text/plain"}).field;expect(t).to.equal('Hawk id="123456", ts="1353809207", nonce="Ygvqdz", hash="2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=", mac="HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs="'),e()}),it("should return an empty authorization header on missing options",function(e){var n=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST").field;expect(n).to.equal(""),e()}),it("should return an empty authorization header on invalid credentials",function(e){var n={key:"2983d45yun89q",algorithm:"sha256"},t=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:n,ext:"Bazinga!",timestamp:1353809207}).field;expect(t).to.equal(""),e()}),it("should return an empty authorization header on invalid algorithm",function(e){var n={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"},t=Browser.client.header("https://example.net/somewhere/over/the/rainbow","POST",{credentials:n,payload:"something, anything!",ext:"Bazinga!",timestamp:1353809207}).field;expect(t).to.equal(""),e()})}),describe("#authenticate",function(){it("should return false on invalid header",function(e){var n={headers:{"server-authorization":'Hawk mac="abc", bad="xyz"'},getResponseHeader:function(e){return n.headers[e.toLowerCase()]}};expect(Browser.client.authenticate(n,{})).to.equal(!1),e()}),it("should return false on invalid mac",function(e){var n={headers:{"content-type":"text/plain","server-authorization":'Hawk mac="_IJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'},getResponseHeader:function(e){return n.headers[e.toLowerCase()]}},t={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1362336900",nonce:"eb5S_L",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",app:void 0,dlg:void 0,mac:"BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=",id:"123456"},r={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};expect(Browser.client.authenticate(n,r,t)).to.equal(!1),e()}),it("should return true on ignoring hash",function(e){var n={headers:{"content-type":"text/plain","server-authorization":'Hawk mac="XIJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=", hash="f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=", ext="response-specific"'},getResponseHeader:function(e){return n.headers[e.toLowerCase()]}},t={method:"POST",host:"example.com",port:"8080",resource:"/resource/4?filter=a",ts:"1362336900",nonce:"eb5S_L",hash:"nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=",ext:"some-app-data",app:void 0,dlg:void 0,mac:"BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=",id:"123456"},r={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};expect(Browser.client.authenticate(n,r,t)).to.equal(!0),e()}),it("should fail on invalid WWW-Authenticate header format",function(e){var n={headers:{"www-authenticate":'Hawk ts="1362346425875", tsm="PhwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", x="Stale timestamp"'},getResponseHeader:function(e){return n.headers[e.toLowerCase()]}};expect(Browser.client.authenticate(n,{})).to.equal(!1),e()}),it("should fail on invalid WWW-Authenticate header format",function(e){var n={id:"123456",key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"},t={headers:{"www-authenticate":'Hawk ts="1362346425875", tsm="hwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=", error="Stale timestamp"'},getResponseHeader:function(e){return t.headers[e.toLowerCase()]}};expect(Browser.client.authenticate(t,n)).to.equal(!1),e()})}),describe("#message",function(){it("should generate an authorization then successfully parse it",function(n){e("123456",function(t,r){var a=Browser.client.message("example.com",8080,"some message",{credentials:r});expect(a).to.exist,Hawk.server.authenticateMessage("example.com",8080,"some message",a,e,{},function(e,t){expect(e).to.not.exist,expect(t.user).to.equal("steve"),n()})})}),it("should fail on missing host",function(n){e("123456",function(e,t){var r=Browser.client.message(null,8080,"some message",{credentials:t});expect(r).to.not.exist,n()})}),it("should fail on missing credentials",function(e){var n=Browser.client.message("example.com",8080,"some message",{});expect(n).to.not.exist,e()}),it("should fail on invalid algorithm",function(n){e("123456",function(e,t){var r=Hoek.clone(t);r.algorithm="blah";var a=Browser.client.message("example.com",8080,"some message",{credentials:r});expect(a).to.not.exist,n()})})})}),describe("#parseAuthorizationHeader",function(e){it("returns null on missing header",function(e){expect(Browser.utils.parseAuthorizationHeader()).to.equal(null),e()}),it("returns null on bad header syntax (structure)",function(e){expect(Browser.utils.parseAuthorizationHeader("Hawk")).to.equal(null),e()}),it("returns null on bad header syntax (parts)",function(e){expect(Browser.utils.parseAuthorizationHeader(" ")).to.equal(null),e()}),it("returns null on bad scheme name",function(e){expect(Browser.utils.parseAuthorizationHeader("Basic asdasd")).to.equal(null),e()}),it("returns null on bad attribute value",function(e){expect(Browser.utils.parseAuthorizationHeader('Hawk test="	"',["test"])).to.equal(null),e()}),it("returns null on duplicated attribute",function(e){expect(Browser.utils.parseAuthorizationHeader('Hawk test="a", test="b"',["test"])).to.equal(null),e()})})});