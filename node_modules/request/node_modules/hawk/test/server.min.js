var Url=require("url"),Lab=require("lab"),Hawk=require("../lib"),internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("Hawk",function(){describe("server",function(){var e=function(e,n){var t={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"1"===e?"sha1":"sha256",user:"steve"};return n(null,t)};describe("#authenticate",function(){it("should parse a valid authentication header (sha1)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),n()})}),it("should parse a valid authentication header (sha256)",function(n){var t={method:"GET",url:"/resource/1?b=1&a=2",host:"example.com",port:8e3,authorization:'Hawk id="dh37fgj492je", ts="1353832234", nonce="j4h3g2", mac="m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=", ext="some-app-data"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353832234e3-Hawk.utils.now()},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),n()})}),it("should parse a valid authentication header (host override)",function(n){var t={method:"GET",url:"/resource/4?filter=a",headers:{host:"example1.com:8080",authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'}};Hawk.server.authenticate(t,e,{host:"example.com",localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),n()})}),it("should parse a valid authentication header (host port override)",function(n){var t={method:"GET",url:"/resource/4?filter=a",headers:{host:"example1.com:80",authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'}};Hawk.server.authenticate(t,e,{host:"example.com",port:8080,localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),n()})}),it("should parse a valid authentication header (POST with payload)",function(n){var t={method:"POST",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123456", ts="1357926341", nonce="1AwuJD", hash="qAiXIVv+yjDATneWxZP2YCTa9aHRgQdnH9b3Wc+o3dg=", ext="some-app-data", mac="UeYcj5UoTVaAWXNvJfLVia7kU3VabxCqrccXP8sUGC4="'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1357926341e3-Hawk.utils.now()},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),n()})}),it("should fail on missing hash",function(n){var t={method:"GET",url:"/resource/1?b=1&a=2",host:"example.com",port:8e3,authorization:'Hawk id="dh37fgj492je", ts="1353832234", nonce="j4h3g2", mac="m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=", ext="some-app-data"'};Hawk.server.authenticate(t,e,{payload:"body",localtimeOffsetMsec:1353832234e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing required payload hash"),n()})}),it("should fail on a stale timestamp",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123456", ts="1362337299", nonce="UzmxSs", ext="some-app-data", mac="wnNUxchvvryMH2RxckTdZ/gY3ijzvccx4keVvELC61w="'};Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Stale timestamp");var a=e.response.headers["WWW-Authenticate"],i=a.match(/^Hawk ts\=\"(\d+)\"\, tsm\=\"([^\"]+)\"\, error=\"Stale timestamp\"$/),s=Hawk.utils.now();expect(1e3*parseInt(i[1],10)).to.be.within(s-1e3,s+1e3);var o={headers:{"www-authenticate":a}};expect(Hawk.client.authenticate(o,t,r)).to.equal(!0),n()})}),it("should fail on a replay",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="bXx7a7p1h9QYQNZ8x7QhvDQym8ACgab4m3lVSFn4DBw=", ext="hello"'},r={},a={localtimeOffsetMsec:1353788437e3-Hawk.utils.now(),nonceFunc:function(e,n,t){return r[e]?t(new Error):(r[e]=!0,t())}};Hawk.server.authenticate(t,e,a,function(r,i,s){expect(r).to.not.exist,expect(i.user).to.equal("steve"),Hawk.server.authenticate(t,e,a,function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid nonce"),n()})})}),it("should fail on an invalid authentication header: wrong scheme",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"Basic asdasdasdasd"};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.not.exist,n()})}),it("should fail on an invalid authentication header: no scheme",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"!@#"};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid header syntax"),n()})}),it("should fail on an missing authorization header",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};Hawk.server.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.isMissing).to.equal(!0),n()})}),it("should fail on an missing host header",function(n){var t={method:"GET",url:"/resource/4?filter=a",headers:{authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),n()})}),it("should fail on an missing authorization attribute (id)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),n()})}),it("should fail on an missing authorization attribute (ts)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),n()})}),it("should fail on an missing authorization attribute (nonce)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),n()})}),it("should fail on an missing authorization attribute (mac)",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),n()})}),it("should fail on an unknown authorization attribute",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", x="3", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Unknown attribute: x"),n()})}),it("should fail on an bad authorization header format",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123\\", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad header format"),n()})}),it("should fail on an bad authorization attribute value",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="	", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad attribute value: id"),n()})}),it("should fail on an empty authorization attribute value",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad attribute value: id"),n()})}),it("should fail on duplicated authorization attribute key",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", id="456", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Duplicate attribute: id"),n()})}),it("should fail on an invalid authorization header format",function(n){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"Hawk"};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid header syntax"),n()})}),it("should fail on an bad host header (missing host)",function(n){var t={method:"GET",url:"/resource/4?filter=a",headers:{host:":8080",authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),n()})}),it("should fail on an bad host header (pad port)",function(n){var t={method:"GET",url:"/resource/4?filter=a",headers:{host:"example.com:something",authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(t,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),n()})}),it("should fail on credentialsFunc error",function(e){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},t=function(e,n){return n(new Error("Unknown user"))};Hawk.server.authenticate(n,t,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(n,t,r){expect(n).to.exist,expect(n.message).to.equal("Unknown user"),e()})}),it("should fail on missing credentials",function(e){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},t=function(e,n){return n(null,null)};Hawk.server.authenticate(n,t,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(n,t,r){expect(n).to.exist,expect(n.response.payload.message).to.equal("Unknown credentials"),e()})}),it("should fail on invalid credentials",function(e){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},t=function(e,n){var t={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",user:"steve"};return n(null,t)};Hawk.server.authenticate(n,t,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(n,t,r){expect(n).to.exist,expect(n.message).to.equal("Invalid credentials"),expect(n.response.payload.message).to.equal("An internal server error occurred"),e()})}),it("should fail on unknown credentials algorithm",function(e){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},t=function(e,n){var t={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"hmac-sha-0",user:"steve"};return n(null,t)};Hawk.server.authenticate(n,t,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(n,t,r){expect(n).to.exist,expect(n.message).to.equal("Unknown algorithm"),expect(n.response.payload.message).to.equal("An internal server error occurred"),e()})}),it("should fail on unknown bad mac",function(e){var n={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcU4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},t=function(e,n){var t={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};return n(null,t)};Hawk.server.authenticate(n,t,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(n,t,r){expect(n).to.exist,expect(n.response.payload.message).to.equal("Bad mac"),e()})})}),describe("#header",function(){it("should return an empty authorization header on missing options",function(e){var n=Hawk.server.header();expect(n).to.equal(""),e()}),it("should return an empty authorization header on missing credentials",function(e){var n=Hawk.server.header(null,{});expect(n).to.equal(""),e()}),it("should return an empty authorization header on invalid credentials",function(e){var n={key:"2983d45yun89q"},t=Hawk.server.header(n);expect(t).to.equal(""),e()}),it("should return an empty authorization header on invalid algorithm",function(e){var n={id:"123456"},t={key:"2983d45yun89q",algorithm:"hmac-sha-0"},r=Hawk.server.header(t,n);expect(r).to.equal(""),e()})})})});