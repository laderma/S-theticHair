var Http=require("http"),Lab=require("lab"),Hawk=require("../lib"),internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("Hawk",function(){describe("Uri",function(){var e=function(e,n){var t={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};return n(null,t)};it("should generate a bewit then successfully authenticate it",function(n){var t={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(r,a){var i=Hawk.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:a,ttlSec:31536e5,ext:"some-app-data"});t.url+="&bewit="+i,Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),n()})})}),it("should generate a bewit then successfully authenticate it (no ext)",function(n){var t={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(r,a){var i=Hawk.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:a,ttlSec:31536e5});t.url+="&bewit="+i,Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),n()})})}),it("should successfully authenticate a request (last param)",function(n){var t={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),n()})}),it("should successfully authenticate a request (first param)",function(n){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ&a=1&b=2",host:"example.com",port:8080};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),n()})}),it("should successfully authenticate a request (only param)",function(n){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.not.exist,expect(t.user).to.equal("steve"),expect(r.ext).to.equal("some-app-data"),n()})}),it("should fail on multiple authentication",function(n){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080,authorization:"Basic asdasdasdasd"};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Multiple authentications"),n()})}),it("should fail on method other than GET",function(n){e("123456",function(t,r){var a={method:"POST",url:"/resource/4?filter=a",host:"example.com",port:8080},i=Math.floor(Hawk.utils.now()/1e3)+60,s="some-app-data",o=Hawk.crypto.calculateMac("bewit",r,{timestamp:i,nonce:"",method:a.method,resource:a.url,host:a.host,port:a.port,ext:s}),l=r.id+"\\"+i+"\\"+o+"\\"+s;a.url+="&bewit="+Hawk.utils.base64urlEncode(l),Hawk.uri.authenticate(a,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid method"),n()})})}),it("should fail on invalid host header",function(n){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",headers:{host:"example.com:something"}};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),n()})}),it("should fail on empty bewit",function(n){var t={method:"GET",url:"/resource/4?bewit=",host:"example.com",port:8080};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Empty bewit"),expect(e.isMissing).to.not.exist,n()})}),it("should fail on invalid bewit",function(n){var t={method:"GET",url:"/resource/4?bewit=*",host:"example.com",port:8080};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid bewit encoding"),expect(e.isMissing).to.not.exist,n()})}),it("should fail on missing bewit",function(n){var t={method:"GET",url:"/resource/4",host:"example.com",port:8080};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.not.exist,expect(e.isMissing).to.equal(!0),n()})}),it("should fail on invalid bewit structure",function(n){var t={method:"GET",url:"/resource/4?bewit=abc",host:"example.com",port:8080};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid bewit structure"),n()})}),it("should fail on empty bewit attribute",function(n){var t={method:"GET",url:"/resource/4?bewit=YVxcY1xk",host:"example.com",port:8080};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing bewit attributes"),n()})}),it("should fail on expired access",function(n){var t={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDEzNTY0MTg1ODNcWk1wZlMwWU5KNHV0WHpOMmRucTRydEk3NXNXTjFjeWVITTcrL0tNZFdVQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,e,{},function(e,t,r){expect(e).to.exist,expect(e.response.payload.message).to.equal("Access expired"),n()})}),it("should fail on credentials function error",function(e){var n={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(n,function(e,n){n(Hawk.error.badRequest("Boom"))},{},function(n,t,r){expect(n).to.exist,expect(n.response.payload.message).to.equal("Boom"),e()})}),it("should fail on null credentials function response",function(e){var n={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(n,function(e,n){n(null,null)},{},function(n,t,r){expect(n).to.exist,expect(n.response.payload.message).to.equal("Unknown credentials"),e()})}),it("should fail on invalid credentials function response",function(e){var n={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(n,function(e,n){n(null,{})},{},function(n,t,r){expect(n).to.exist,expect(n.message).to.equal("Invalid credentials"),e()})}),it("should fail on invalid credentials function response (unknown algorithm)",function(e){var n={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(n,function(e,n){n(null,{key:"xxx",algorithm:"xxx"})},{},function(n,t,r){expect(n).to.exist,expect(n.message).to.equal("Unknown algorithm"),e()})}),it("should fail on expired access",function(e){var n={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(n,function(e,n){n(null,{key:"xxx",algorithm:"sha256"})},{},function(n,t,r){expect(n).to.exist,expect(n.response.payload.message).to.equal("Bad mac"),e()})})}),describe("#getBewit",function(){it("should return a valid bewit value",function(e){var n={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},t=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:n,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(t).to.equal("MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6"),e()}),it("should return an empty bewit on invalid credentials",function(e){var n={key:"2983d45yun89q",algorithm:"sha256"},t=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:n,ttlSec:3e3,ext:"xandyandz"});expect(t).to.equal(""),e()}),it("should return an empty bewit on invalid algorithm",function(e){var n={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"},t=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:n,ttlSec:300,ext:"xandyandz"});expect(t).to.equal(""),e()}),it("should return an empty bewit on missing options",function(e){var t=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow");expect(t).to.equal(""),e()})})});