var Url=require("url"),Lab=require("lab"),Hoek=require("hoek"),Hawk=require("../lib"),internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("Hawk",function(){var e=function(e,n){var t={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"1"===e?"sha1":"sha256",user:"steve"};return n(null,t)};it("should generate an authorization then successfully parse it",function(n){e("123456",function(t,r){var a=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(a).to.exist,Hawk.server.authenticateMessage("example.com",8080,"some message",a,e,{},function(e,t){expect(e).to.not.exist,expect(t.user).to.equal("steve"),n()})})}),it("should fail authorization on mismatching host",function(n){e("123456",function(t,r){var a=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(a).to.exist,Hawk.server.authenticateMessage("example1.com",8080,"some message",a,e,{},function(e,t){expect(e).to.exist,expect(e.message).to.equal("Bad mac"),n()})})}),it("should fail authorization on stale timestamp",function(n){e("123456",function(t,r){var a=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(a).to.exist,Hawk.server.authenticateMessage("example.com",8080,"some message",a,e,{localtimeOffsetMsec:1e5},function(e,t){expect(e).to.exist,expect(e.message).to.equal("Stale timestamp"),n()})})}),it("should fail authorization on invalid authorization",function(n){e("123456",function(t,r){var a=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(a).to.exist,delete a.id,Hawk.server.authenticateMessage("example.com",8080,"some message",a,e,{},function(e,t){expect(e).to.exist,expect(e.message).to.equal("Invalid authorization"),n()})})}),it("should fail authorization on bad hash",function(n){e("123456",function(t,r){var a=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(a).to.exist,Hawk.server.authenticateMessage("example.com",8080,"some message1",a,e,{},function(e,t){expect(e).to.exist,expect(e.message).to.equal("Bad message hash"),n()})})}),it("should fail authorization on nonce error",function(n){e("123456",function(t,r){var a=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(a).to.exist,Hawk.server.authenticateMessage("example.com",8080,"some message",a,e,{nonceFunc:function(e,n,t){t(new Error("kaboom"))}},function(e,t){expect(e).to.exist,expect(e.message).to.equal("Invalid nonce"),n()})})}),it("should fail authorization on credentials error",function(n){e("123456",function(e,t){var r=Hawk.client.message("example.com",8080,"some message",{credentials:t});expect(r).to.exist;var a=function(e,n){n(new Error("kablooey"))};Hawk.server.authenticateMessage("example.com",8080,"some message",r,a,{},function(e,t){expect(e).to.exist,expect(e.message).to.equal("kablooey"),n()})})}),it("should fail authorization on missing credentials",function(n){e("123456",function(e,t){var r=Hawk.client.message("example.com",8080,"some message",{credentials:t});expect(r).to.exist;var a=function(e,n){n()};Hawk.server.authenticateMessage("example.com",8080,"some message",r,a,{},function(e,t){expect(e).to.exist,expect(e.message).to.equal("Unknown credentials"),n()})})}),it("should fail authorization on invalid credentials",function(n){e("123456",function(e,t){var r=Hawk.client.message("example.com",8080,"some message",{credentials:t});expect(r).to.exist;var a=function(e,n){n(null,{})};Hawk.server.authenticateMessage("example.com",8080,"some message",r,a,{},function(e,t){expect(e).to.exist,expect(e.message).to.equal("Invalid credentials"),n()})})}),it("should fail authorization on invalid credentials algorithm",function(n){e("123456",function(e,t){var r=Hawk.client.message("example.com",8080,"some message",{credentials:t});expect(r).to.exist;var a=function(e,n){n(null,{key:"123",algorithm:"456"})};Hawk.server.authenticateMessage("example.com",8080,"some message",r,a,{},function(e,t){expect(e).to.exist,expect(e.message).to.equal("Unknown algorithm"),n()})})}),it("should fail on missing host",function(n){e("123456",function(e,t){var r=Hawk.client.message(null,8080,"some message",{credentials:t});expect(r).to.not.exist,n()})}),it("should fail on missing credentials",function(e){var n=Hawk.client.message("example.com",8080,"some message",{});expect(n).to.not.exist,e()}),it("should fail on invalid algorithm",function(n){e("123456",function(e,t){var r=Hoek.clone(t);r.algorithm="blah";var a=Hawk.client.message("example.com",8080,"some message",{credentials:r});expect(a).to.not.exist,n()})})});