var Fs=require("fs"),Escape=require("./escape"),internals={};exports.clone=function(e,n){if("object"!=typeof e||null===e)return e;n=n||{orig:[],copy:[]};var t=n.orig.indexOf(e);if(-1!==t)return n.copy[t];var r=e instanceof Array?[]:{};n.orig.push(e),n.copy.push(r);for(var i in e)if(e.hasOwnProperty(i))if(e[i]instanceof Buffer)r[i]=new Buffer(e[i]);else if(e[i]instanceof Date)r[i]=new Date(e[i].getTime());else if(e[i]instanceof RegExp){var a=""+(e[i].global?"g":"")+(e[i].ignoreCase?"i":"")+(e[i].multiline?"m":"");r[i]=new RegExp(e[i].source,a)}else r[i]=exports.clone(e[i],n);return r},exports.merge=function(e,n,t,r){if(exports.assert(e&&"object"==typeof e,"Invalid target value: must be an object"),exports.assert(null===n||void 0===n||"object"==typeof n,"Invalid source value: must be null, undefined, or an object"),!n)return e;if(n instanceof Array){exports.assert(e instanceof Array,"Cannot merge array onto an object"),r===!1&&(e.length=0);for(var i=0,a=n.length;a>i;++i)e.push(n[i]);return e}for(var o=Object.keys(n),s=0,u=o.length;u>s;++s){var l=o[s],c=n[l];c&&"object"==typeof c?e[l]&&"object"==typeof e[l]?exports.merge(e[l],n[l],t,r):e[l]=exports.clone(c):null!==c&&void 0!==c?e[l]=c:t!==!1&&(e[l]=c)}return e},exports.applyToDefaults=function(e,n){if(exports.assert(e&&"object"==typeof e,"Invalid defaults value: must be an object"),exports.assert(!n||n===!0||"object"==typeof n,"Invalid options value: must be true, falsy or an object"),!n)return null;var t=exports.clone(e);return n===!0?t:exports.merge(t,n,!1,!1)},exports.unique=function(e,n){for(var t={},r=[],i=0,a=e.length;a>i;++i){var o=n?e[i][n]:e[i];t[o]!==!0&&(r.push(e[i]),t[o]=!0)}return r},exports.mapToObject=function(e,n){if(!e)return null;for(var t={},r=0,i=e.length;i>r;++r)n?e[r][n]&&(t[e[r][n]]=!0):t[e[r]]=!0;return t},exports.intersect=function(e,n,t){if(!e||!n)return[];for(var r=[],i=e instanceof Array?exports.mapToObject(e):e,a={},o=0,s=n.length;s>o;++o)if(i[n[o]]&&!a[n[o]]){if(t)return n[o];r.push(n[o]),a[n[o]]=!0}return t?null:r},exports.matchKeys=function(e,n){for(var t=[],r=0,i=n.length;i>r;++r)e.hasOwnProperty(n[r])&&t.push(n[r]);return t},exports.flatten=function(e,n){for(var t=n||[],r=0,i=e.length;i>r;++r)Array.isArray(e[r])?exports.flatten(e[r],t):t.push(e[r]);return t},exports.removeKeys=function(e,n){for(var t=0,r=n.length;r>t;t++)delete e[n[t]]},exports.reach=function(e,n){for(var t=n.split("."),r=e,i=0,a=t.length;a>i;++i)r&&(r=r[t[i]]);return r},exports.inheritAsync=function(e,n,t){t=t||null;for(var r in n)if(n.hasOwnProperty(r)){if(t instanceof Array&&t.indexOf(r)<0)continue;e.prototype[r]=function(e){return function(n){var t=null;try{t=e()}catch(r){return n(r)}return n(null,t)}}(n[r])}},exports.formatStack=function(e){for(var n=[],t=0,r=e.length;r>t;++t){var i=e[t];n.push([i.getFileName(),i.getLineNumber(),i.getColumnNumber(),i.getFunctionName(),i.isConstructor()])}return n},exports.formatTrace=function(e){for(var n=[],t=0,r=e.length;r>t;++t){var i=e[t];n.push((i[4]?"new ":"")+i[3]+" ("+i[0]+":"+i[1]+":"+i[2]+")")}return n},exports.callStack=function(e){var n=Error.prepareStackTrace;Error.prepareStackTrace=function(e,n){return n};var t={};Error.captureStackTrace(t,arguments.callee);var r=t.stack;Error.prepareStackTrace=n;var i=exports.formatStack(r);return e?i.slice(e):i},exports.displayStack=function(e){var n=exports.callStack(void 0===e?1:e+1);return exports.formatTrace(n)},exports.abortThrow=!1,exports.abort=function(e,n){if("test"===process.env.NODE_ENV||exports.abortThrow===!0)throw new Error(e||"Unknown error");var t="";n||(t=exports.displayStack(1).join("\n	")),console.log("ABORT: "+e+"\n	"+t),process.exit(1)},exports.assert=function(e){if(!e){var n=Array.prototype.slice.call(arguments,1);throw n=n.map(function(e){return"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}),new Error(n.join(" ")||"Unknown error")}},exports.loadDirModules=function(e,n,t){for(var r={},i=0,a=n.length;a>i;++i)r[n[i]+".js"]=!0;var o=Fs.readdirSync(e);for(i=0,a=o.length;a>i;++i){var s=o[i];if(/\.js$/.test(s)&&!r[s]){var u=s.substr(0,s.lastIndexOf(".")),l=u.charAt(0).toUpperCase()+u.substr(1).toLowerCase();"function"!=typeof t?t[l]=require(e+"/"+u):t(e+"/"+u,u,l)}}},exports.rename=function(e,n,t){e[t]=e[n],delete e[n]},exports.Timer=function(){this.reset()},exports.Timer.prototype.reset=function(){this.ts=Date.now()},exports.Timer.prototype.elapsed=function(){return Date.now()-this.ts},exports.loadPackage=function(e){var n={},t=(e||process.env.PWD)+"/package.json";if(Fs.existsSync(t))try{n=JSON.parse(Fs.readFileSync(t))}catch(r){}return n},exports.escapeRegex=function(e){return e.replace(/[\^\$\.\*\+\-\?\=\!\:\|\\\/\(\)\[\]\{\}\,]/g,"\\$&")},exports.toss=function(e){var n=3===arguments.length?arguments[1]:"",t=3===arguments.length?arguments[2]:arguments[1],r=n instanceof Error?n:n?new Error(n):e instanceof Error?e:new Error;return e instanceof Error||!e?t(r):void 0},exports.base64urlEncode=function(e){return new Buffer(e,"binary").toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")},exports.base64urlDecode=function(e){if(e&&!e.match(/^[\w\-]*$/))return new Error("Invalid character");try{return new Buffer(e.replace(/-/g,"+").replace(/:/g,"/"),"base64").toString("binary")}catch(n){return n}},exports.escapeHeaderAttribute=function(e){return exports.assert(e.match(/^[ \w\!#\$%&'\(\)\*\+,\-\.\/\:;<\=>\?@\[\]\^`\{\|\}~\"\\]*$/),"Bad attribute value ("+e+")"),e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')},exports.escapeHtml=function(e){return Escape.escapeHtml(e)},exports.escapeJavaScript=function(e){return Escape.escapeJavaScript(e)},exports.consoleFunc=console.log,exports.printEvent=function(e){var n=function(e){return(10>e?"0":"")+e},t=new Date(e.timestamp),r=(t.getYear()-100).toString()+n(t.getMonth()+1)+n(t.getDate())+"/"+n(t.getHours())+n(t.getMinutes())+n(t.getSeconds())+"."+t.getMilliseconds(),i=e.data;if("string"!=typeof e.data)try{i=JSON.stringify(e.data)}catch(a){i="JSON Error: "+a.message}var o=r+", "+e.tags[0]+", "+i;exports.consoleFunc(o)},exports.nextTick=function(e){return function(){var n=arguments;process.nextTick(function(){e.apply(null,n)})}};