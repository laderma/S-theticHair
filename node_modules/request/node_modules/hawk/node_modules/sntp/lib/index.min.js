var Dgram=require("dgram"),Dns=require("dns"),Hoek=require("hoek"),internals={};exports.time=function(e,n){2!==arguments.length&&(n=arguments[0],e={});var t=Hoek.clone(e);t.host=t.host||"pool.ntp.org",t.port=t.port||123,t.resolveReference=t.resolveReference||!1;var r=0,i=0,a=!1,o=function(e,t){return r&&(clearTimeout(r),r=0),a?void 0:(a=!0,s.removeAllListeners(),s.close(),n(e,t))},s=Dgram.createSocket("udp4");s.once("error",function(e){return o(e)}),s.on("message",function(e,n){var r=Date.now(),a=new internals.NtpMessage(e);if(!a.isValid)return o(new Error("Invalid server response"),a);if(a.originateTimestamp!==i)return o(new Error("Wrong originate timestamp"),a);var s=a.originateTimestamp,u=a.receiveTimestamp,l=a.transmitTimestamp,c=r;return a.d=c-s-(l-u),a.t=(u-s+(l-c))/2,a.receivedLocally=r,t.resolveReference&&"secondary"===a.stratum?void Dns.reverse(a.referenceId,function(e,n){return e||(a.referenceHost=n[0]),o(null,a)}):o(null,a)}),t.timeout&&(r=setTimeout(function(){return r=0,o(new Error("Timeout"))},t.timeout));for(var u=new Buffer(48),l=0;48>l;l++)u[l]=0;u[0]=35,i=Date.now(),internals.fromMsecs(i,u,40),s.send(u,0,u.length,t.port,t.host,function(e,n){return e||48!==n?o(e||new Error("Could not send entire message")):void 0})},internals.NtpMessage=function(e){if(this.isValid=!1,48===e.length){var n=e[0]>>6;switch(n){case 0:this.leapIndicator="no-warning";break;case 1:this.leapIndicator="last-minute-61";break;case 2:this.leapIndicator="last-minute-59";break;case 3:this.leapIndicator="alarm"}var t=(56&e[0])>>3;this.version=t;var r=7&e[0];switch(r){case 1:this.mode="symmetric-active";break;case 2:this.mode="symmetric-passive";break;case 3:this.mode="client";break;case 4:this.mode="server";break;case 5:this.mode="broadcast";break;case 0:case 6:case 7:this.mode="reserved"}var i=e[1];0===i?this.stratum="death":1===i?this.stratum="primary":15>=i?this.stratum="secondary":this.stratum="reserved",this.pollInterval=1e3*Math.round(Math.pow(2,e[2])),this.precision=1e3*Math.pow(2,e[3]);var a=256*(256*(256*e[4]+e[5])+e[6])+e[7];switch(this.rootDelay=1e3*(a/65536),this.rootDispersion=1e3*((e[8]<<8)+e[9]+((e[10]<<8)+e[11])/Math.pow(2,16)),this.referenceId="",this.stratum){case"death":case"primary":this.referenceId=String.fromCharCode(e[12])+String.fromCharCode(e[13])+String.fromCharCode(e[14])+String.fromCharCode(e[15]);break;case"secondary":this.referenceId=""+e[12]+"."+e[13]+"."+e[14]+"."+e[15]}return this.referenceTimestamp=internals.toMsecs(e,16),this.originateTimestamp=internals.toMsecs(e,24),this.receiveTimestamp=internals.toMsecs(e,32),this.transmitTimestamp=internals.toMsecs(e,40),4===this.version&&"reserved"!==this.stratum&&"server"===this.mode&&this.originateTimestamp&&this.receiveTimestamp&&this.transmitTimestamp&&(this.isValid=!0),this}},internals.toMsecs=function(e,n){for(var t=0,r=0,i=0;4>i;++i)t=256*t+e[n+i];for(i=4;8>i;++i)r=256*r+e[n+i];return 1e3*(t-2208988800+r/Math.pow(2,32))},internals.fromMsecs=function(e,n,t){var r=Math.floor(e/1e3)+2208988800,i=Math.round(e%1e3/1e3*Math.pow(2,32));n[t+0]=(4278190080&r)>>24,n[t+1]=(16711680&r)>>16,n[t+2]=(65280&r)>>8,n[t+3]=255&r,n[t+4]=(4278190080&i)>>24,n[t+5]=(16711680&i)>>16,n[t+6]=(65280&i)>>8,n[t+7]=255&i},internals.last={offset:0,expires:0,host:"",port:0},exports.offset=function(e,n){2!==arguments.length&&(n=arguments[0],e={});var t=Date.now(),r=e.clockSyncRefresh||864e5;return internals.last.offset&&internals.last.host===e.host&&internals.last.port===e.port&&t<internals.last.expires?void process.nextTick(function(){n(null,internals.last.offset)}):void exports.time(e,function(i,a){return i?n(i,0):(internals.last={offset:Math.round(a.t),expires:t+r,host:e.host,port:e.port},n(null,internals.last.offset))})},internals.now={intervalId:0},exports.start=function(e,n){return 2!==arguments.length&&(n=arguments[0],e={}),internals.now.intervalId?void process.nextTick(function(){n()}):void exports.offset(e,function(t,r){return internals.now.intervalId=setInterval(function(){exports.offset(e,function(){})},e.clockSyncRefresh||864e5),n()})},exports.stop=function(){internals.now.intervalId&&(clearInterval(internals.now.intervalId),internals.now.intervalId=0)},exports.isLive=function(){return!!internals.now.intervalId},exports.now=function(){var e=Date.now();return!exports.isLive()||e>=internals.last.expires?e:e+internals.last.offset};