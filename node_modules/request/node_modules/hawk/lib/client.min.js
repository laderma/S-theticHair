var Url=require("url"),Hoek=require("hoek"),Cryptiles=require("cryptiles"),Crypto=require("./crypto"),Utils=require("./utils"),internals={};exports.header=function(e,n,t){var r={field:"",artifacts:{}};if(!e||"string"!=typeof e&&"object"!=typeof e||!n||"string"!=typeof n||!t||"object"!=typeof t)return r;var a=t.timestamp||Math.floor((Utils.now()+(t.localtimeOffsetMsec||0))/1e3),i=t.credentials;if(!(i&&i.id&&i.key&&i.algorithm))return r;if(-1===Crypto.algorithms.indexOf(i.algorithm))return r;"string"==typeof e&&(e=Url.parse(e));var s={ts:a,nonce:t.nonce||Cryptiles.randomString(6),method:n,resource:e.pathname+(e.search||""),host:e.hostname,port:e.port||("http:"===e.protocol?80:443),hash:t.hash,ext:t.ext,app:t.app,dlg:t.dlg};r.artifacts=s,!s.hash&&t.hasOwnProperty("payload")&&(s.hash=Crypto.calculatePayloadHash(t.payload,i.algorithm,t.contentType));var o=Crypto.calculateMac("header",i,s),l=null!==s.ext&&void 0!==s.ext&&""!==s.ext,u='Hawk id="'+i.id+'", ts="'+s.ts+'", nonce="'+s.nonce+(s.hash?'", hash="'+s.hash:"")+(l?'", ext="'+Utils.escapeHeaderAttribute(s.ext):"")+'", mac="'+o+'"';return s.app&&(u+=', app="'+s.app+(s.dlg?'", dlg="'+s.dlg:"")+'"'),r.field=u,r},exports.authenticate=function(e,n,t,r){if(t=Hoek.clone(t),r=r||{},e.headers["www-authenticate"]){var a=Utils.parseAuthorizationHeader(e.headers["www-authenticate"],["ts","tsm","error"]);if(a instanceof Error)return!1;if(a.ts){var i=Crypto.calculateTsMac(a.ts,n);if(i!==a.tsm)return!1}}if(!e.headers["server-authorization"]&&!r.required)return!0;var a=Utils.parseAuthorizationHeader(e.headers["server-authorization"],["mac","ext","hash"]);if(a instanceof Error)return!1;t.ext=a.ext,t.hash=a.hash;var s=Crypto.calculateMac("response",n,t);if(s!==a.mac)return!1;if(!r.hasOwnProperty("payload"))return!0;if(!a.hash)return!1;var o=Crypto.calculatePayloadHash(r.payload,n.algorithm,e.headers["content-type"]);return o===a.hash},exports.getBewit=function(e,n){if(!e||"string"!=typeof e&&"object"!=typeof e||!n||"object"!=typeof n||!n.ttlSec)return"";n.ext=null===n.ext||void 0===n.ext?"":n.ext;var t=Utils.now()+(n.localtimeOffsetMsec||0),r=n.credentials;if(!(r&&r.id&&r.key&&r.algorithm))return"";if(-1===Crypto.algorithms.indexOf(r.algorithm))return"";"string"==typeof e&&(e=Url.parse(e));var a=Math.floor(t/1e3)+n.ttlSec,i=Crypto.calculateMac("bewit",r,{ts:a,nonce:"",method:"GET",resource:e.pathname+(e.search||""),host:e.hostname,port:e.port||("http:"===e.protocol?80:443),ext:n.ext}),s=r.id+"\\"+a+"\\"+i+"\\"+n.ext;return Utils.base64urlEncode(s)},exports.message=function(e,n,t,r){if(!e||"string"!=typeof e||!n||"number"!=typeof n||null===t||void 0===t||"string"!=typeof t||!r||"object"!=typeof r)return null;var a=r.timestamp||Math.floor((Utils.now()+(r.localtimeOffsetMsec||0))/1e3),i=r.credentials;if(!(i&&i.id&&i.key&&i.algorithm))return null;if(-1===Crypto.algorithms.indexOf(i.algorithm))return null;var s={ts:a,nonce:r.nonce||Cryptiles.randomString(6),host:e,port:n,hash:Crypto.calculatePayloadHash(t,i.algorithm)},o={id:i.id,ts:s.ts,nonce:s.nonce,hash:s.hash,mac:Crypto.calculateMac("message",i,s)};return o};