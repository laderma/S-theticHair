var Boom=require("boom"),Hoek=require("hoek"),Cryptiles=require("cryptiles"),Crypto=require("./crypto"),Utils=require("./utils"),internals={};exports.authenticate=function(e,n,t,r){r=Utils.nextTick(r),t.nonceFunc=t.nonceFunc||function(e,n,t){return t()},t.timestampSkewSec=t.timestampSkewSec||60;var a=Utils.now()+(t.localtimeOffsetMsec||0),i=Utils.parseRequest(e,t);if(i instanceof Error)return r(Boom.badRequest(i.message));var s=Utils.parseAuthorizationHeader(i.authorization);if(s instanceof Error)return r(s);var o={method:i.method,host:i.host,port:i.port,resource:i.url,ts:s.ts,nonce:s.nonce,hash:s.hash,ext:s.ext,app:s.app,dlg:s.dlg,mac:s.mac,id:s.id};return s.id&&s.ts&&s.nonce&&s.mac?void n(s.id,function(e,n){if(e)return r(e,n||null,o);if(!n)return r(Boom.unauthorized("Unknown credentials","Hawk"),null,o);if(!n.key||!n.algorithm)return r(Boom.internal("Invalid credentials"),n,o);if(-1===Crypto.algorithms.indexOf(n.algorithm))return r(Boom.internal("Unknown algorithm"),n,o);var l=Crypto.calculateMac("header",n,o);if(!Cryptiles.fixedTimeComparison(l,s.mac))return r(Boom.unauthorized("Bad mac","Hawk"),n,o);if(null!==t.payload&&void 0!==t.payload){if(!s.hash)return r(Boom.unauthorized("Missing required payload hash","Hawk"),n,o);var u=Crypto.calculatePayloadHash(t.payload,n.algorithm,i.contentType);if(!Cryptiles.fixedTimeComparison(u,s.hash))return r(Boom.unauthorized("Bad payload hash","Hawk"),n,o)}t.nonceFunc(s.nonce,s.ts,function(e){if(e)return r(Boom.unauthorized("Invalid nonce","Hawk"),n,o);if(Math.abs(1e3*s.ts-a)>1e3*t.timestampSkewSec){var i=Math.floor((Utils.now()+(t.localtimeOffsetMsec||0))/1e3),l=Crypto.calculateTsMac(i,n);return r(Boom.unauthorized("Stale timestamp","Hawk",{ts:i,tsm:l}),n,o)}return r(null,n,o)})}):r(Boom.badRequest("Missing attributes"),null,o)},exports.authenticatePayload=function(e,n,t,r){var a=Crypto.calculatePayloadHash(e,n.algorithm,r);return Cryptiles.fixedTimeComparison(a,t.hash)},exports.header=function(e,n,t){if(t=t||{},!n||"object"!=typeof n||"object"!=typeof t)return"";if(n=Hoek.clone(n),delete n.mac,n.hash=t.hash,n.ext=t.ext,!e||!e.key||!e.algorithm)return"";if(-1===Crypto.algorithms.indexOf(e.algorithm))return"";!n.hash&&t.hasOwnProperty("payload")&&(n.hash=Crypto.calculatePayloadHash(t.payload,e.algorithm,t.contentType));var r=Crypto.calculateMac("response",e,n),a='Hawk mac="'+r+'"'+(n.hash?', hash="'+n.hash+'"':"");return null!==n.ext&&void 0!==n.ext&&""!==n.ext&&(a+=', ext="'+Utils.escapeHeaderAttribute(n.ext)+'"'),a},exports.authenticateBewit=function(e,n,t,r){r=Utils.nextTick(r);var a=Utils.now()+(t.localtimeOffsetMsec||0),i=Utils.parseRequest(e,t);if(i instanceof Error)return r(Boom.badRequest(i.message));var s=i.url.match(/^(\/.*)([\?&])bewit\=([^&$]*)(?:&(.+))?$/);if(!s)return r(Boom.unauthorized(null,"Hawk"));if(!s[3])return r(Boom.unauthorized("Empty bewit","Hawk"));if("GET"!==i.method&&"HEAD"!==i.method)return r(Boom.unauthorized("Invalid method","Hawk"));if(i.authorization)return r(Boom.badRequest("Multiple authentications","Hawk"));var o=Utils.base64urlDecode(s[3]);if(o instanceof Error)return r(Boom.badRequest("Invalid bewit encoding"));var l=o.split("\\");if(!l||4!==l.length)return r(Boom.badRequest("Invalid bewit structure"));var u={id:l[0],exp:parseInt(l[1],10),mac:l[2],ext:l[3]||""};if(!u.id||!u.exp||!u.mac)return r(Boom.badRequest("Missing bewit attributes"));var c=s[1];return s[4]&&(c+=s[2]+s[4]),1e3*u.exp<=a?r(Boom.unauthorized("Access expired","Hawk"),null,u):void n(u.id,function(e,n){if(e)return r(e,n||null,u.ext);if(!n)return r(Boom.unauthorized("Unknown credentials","Hawk"),null,u);if(!n.key||!n.algorithm)return r(Boom.internal("Invalid credentials"),n,u);if(-1===Crypto.algorithms.indexOf(n.algorithm))return r(Boom.internal("Unknown algorithm"),n,u);var t=Crypto.calculateMac("bewit",n,{ts:u.exp,nonce:"",method:"GET",resource:c,host:i.host,port:i.port,ext:u.ext});return Cryptiles.fixedTimeComparison(t,u.mac)?r(null,n,u):r(Boom.unauthorized("Bad mac","Hawk"),n,u)})},exports.authenticateMessage=function(e,n,t,r,a,i,s){s=Utils.nextTick(s),i.nonceFunc=i.nonceFunc||function(e,n,t){return t()},i.timestampSkewSec=i.timestampSkewSec||60;var o=Utils.now()+(i.localtimeOffsetMsec||0);return r.id&&r.ts&&r.nonce&&r.hash&&r.mac?void a(r.id,function(a,l){if(a)return s(a,l||null);if(!l)return s(Boom.unauthorized("Unknown credentials","Hawk"));if(!l.key||!l.algorithm)return s(Boom.internal("Invalid credentials"),l);if(-1===Crypto.algorithms.indexOf(l.algorithm))return s(Boom.internal("Unknown algorithm"),l);var u={ts:r.ts,nonce:r.nonce,host:e,port:n,hash:r.hash},c=Crypto.calculateMac("message",l,u);if(!Cryptiles.fixedTimeComparison(c,r.mac))return s(Boom.unauthorized("Bad mac","Hawk"),l);var f=Crypto.calculatePayloadHash(t,l.algorithm);return Cryptiles.fixedTimeComparison(f,r.hash)?void i.nonceFunc(r.nonce,r.ts,function(e){return e?s(Boom.unauthorized("Invalid nonce","Hawk"),l):Math.abs(1e3*r.ts-o)>1e3*i.timestampSkewSec?s(Boom.unauthorized("Stale timestamp"),l):s(null,l)}):s(Boom.unauthorized("Bad message hash","Hawk"),l)}):s(Boom.badRequest("Invalid authorization"))};