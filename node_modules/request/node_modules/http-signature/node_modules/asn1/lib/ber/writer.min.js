function merge(e,n){assert.ok(e),assert.equal(typeof e,"object"),assert.ok(n),assert.equal(typeof n,"object");var t=Object.getOwnPropertyNames(e);return t.forEach(function(t){if(!n[t]){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r)}}),n}function Writer(e){e=merge(DEFAULT_OPTS,e||{}),this._buf=new Buffer(e.size||1024),this._size=this._buf.length,this._offset=0,this._options=e,this._seq=[];var n=this;this.__defineGetter__("buffer",function(){if(n._seq.length)throw new InvalidAsn1Error(n._seq.length+" unended sequence(s)");return n._buf.slice(0,n._offset)})}var assert=require("assert"),ASN1=require("./types"),errors=require("./errors"),newInvalidAsn1Error=errors.newInvalidAsn1Error,DEFAULT_OPTS={size:1024,growthFactor:8};Writer.prototype.writeByte=function(e){if("number"!=typeof e)throw new TypeError("argument must be a Number");this._ensure(1),this._buf[this._offset++]=e},Writer.prototype.writeInt=function(e,n){if("number"!=typeof e)throw new TypeError("argument must be a Number");"number"!=typeof n&&(n=ASN1.Integer);for(var t=4;(0===(4286578688&e)||4286578688===(4286578688&e))&&t>1;)t--,e<<=8;if(t>4)throw new InvalidAsn1Error("BER ints cannot be > 0xffffffff");for(this._ensure(2+t),this._buf[this._offset++]=n,this._buf[this._offset++]=t;t-->0;)this._buf[this._offset++]=(4278190080&e)>>24,e<<=8},Writer.prototype.writeNull=function(){this.writeByte(ASN1.Null),this.writeByte(0)},Writer.prototype.writeEnumeration=function(e,n){if("number"!=typeof e)throw new TypeError("argument must be a Number");return"number"!=typeof n&&(n=ASN1.Enumeration),this.writeInt(e,n)},Writer.prototype.writeBoolean=function(e,n){if("boolean"!=typeof e)throw new TypeError("argument must be a Boolean");"number"!=typeof n&&(n=ASN1.Boolean),this._ensure(3),this._buf[this._offset++]=n,this._buf[this._offset++]=1,this._buf[this._offset++]=e?255:0},Writer.prototype.writeString=function(e,n){if("string"!=typeof e)throw new TypeError("argument must be a string (was: "+typeof e+")");"number"!=typeof n&&(n=ASN1.OctetString);var t=Buffer.byteLength(e);this.writeByte(n),this.writeLength(t),t&&(this._ensure(t),this._buf.write(e,this._offset),this._offset+=t)},Writer.prototype.writeBuffer=function(e,n){if("number"!=typeof n)throw new TypeError("tag must be a number");if(!Buffer.isBuffer(e))throw new TypeError("argument must be a buffer");this.writeByte(n),this.writeLength(e.length),this._ensure(e.length),e.copy(this._buf,this._offset,0,e.length),this._offset+=e.length},Writer.prototype.writeStringArray=function(e){if(!e instanceof Array)throw new TypeError("argument must be an Array[String]");var n=this;e.forEach(function(e){n.writeString(e)})},Writer.prototype.writeOID=function(e,n){function t(e,n){128>n?e.push(n):16384>n?(e.push(n>>>7|128),e.push(127&n)):2097152>n?(e.push(n>>>14|128),e.push(255&(n>>>7|128)),e.push(127&n)):268435456>n?(e.push(n>>>21|128),e.push(255&(n>>>14|128)),e.push(255&(n>>>7|128)),e.push(127&n)):(e.push(255&(n>>>28|128)),e.push(255&(n>>>21|128)),e.push(255&(n>>>14|128)),e.push(255&(n>>>7|128)),e.push(127&n))}if("string"!=typeof e)throw new TypeError("argument must be a string");if("number"!=typeof n&&(n=ASN1.OID),!/^([0-9]+\.){3,}[0-9]+$/.test(e))throw new Error("argument is not a valid OID string");var r=e.split("."),i=[];i.push(40*parseInt(r[0],10)+parseInt(r[1],10)),r.slice(2).forEach(function(e){t(i,parseInt(e,10))});var a=this;this._ensure(2+i.length),this.writeByte(n),this.writeLength(i.length),i.forEach(function(e){a.writeByte(e)})},Writer.prototype.writeLength=function(e){if("number"!=typeof e)throw new TypeError("argument must be a Number");if(this._ensure(4),127>=e)this._buf[this._offset++]=e;else if(255>=e)this._buf[this._offset++]=129,this._buf[this._offset++]=e;else if(65535>=e)this._buf[this._offset++]=130,this._buf[this._offset++]=e>>8,this._buf[this._offset++]=e;else{if(!(16777215>=e))throw new InvalidAsn1ERror("Length too long (> 4 bytes)");this._shift(start,e,1),this._buf[this._offset++]=131,this._buf[this._offset++]=e>>16,this._buf[this._offset++]=e>>8,this._buf[this._offset++]=e}},Writer.prototype.startSequence=function(e){"number"!=typeof e&&(e=ASN1.Sequence|ASN1.Constructor),this.writeByte(e),this._seq.push(this._offset),this._ensure(3),this._offset+=3},Writer.prototype.endSequence=function(){var e=this._seq.pop(),n=e+3,t=this._offset-n;if(127>=t)this._shift(n,t,-2),this._buf[e]=t;else if(255>=t)this._shift(n,t,-1),this._buf[e]=129,this._buf[e+1]=t;else if(65535>=t)this._buf[e]=130,this._buf[e+1]=t>>8,this._buf[e+2]=t;else{if(!(16777215>=t))throw new InvalidAsn1Error("Sequence too long");this._shift(n,t,1),this._buf[e]=131,this._buf[e+1]=t>>16,this._buf[e+2]=t>>8,this._buf[e+3]=t}},Writer.prototype._shift=function(e,n,t){assert.ok(void 0!==e),assert.ok(void 0!==n),assert.ok(t),this._buf.copy(this._buf,e+t,e,e+n),this._offset+=t},Writer.prototype._ensure=function(e){if(assert.ok(e),this._size-this._offset<e){var n=this._size*this._options.growthFactor;n-this._offset<e&&(n+=e);var t=new Buffer(n);this._buf.copy(t,0,0,this._offset),this._buf=t,this._size=n}},module.exports=Writer;