var test=require("tap").test,sys=require("sys"),BerWriter,BerReader;test("load library",function(e){BerWriter=require("../../lib/index").BerWriter,e.ok(BerWriter),e.ok(new BerWriter),e.end()}),test("write byte",function(e){var n=new BerWriter;n.writeByte(194);var t=n.buffer;e.ok(t),e.equal(t.length,1,"Wrong length"),e.equal(t[0],194,"value wrong"),e.end()}),test("write 1 byte int",function(e){var n=new BerWriter;n.writeInt(127);var t=n.buffer;e.ok(t),e.equal(t.length,3,"Wrong length for an int: "+t.length),e.equal(t[0],2,"ASN.1 tag wrong (2) -> "+t[0]),e.equal(t[1],1,"length wrong(1) -> "+t[1]),e.equal(t[2],127,"value wrong(3) -> "+t[2]),e.end()}),test("write 2 byte int",function(e){var n=new BerWriter;n.writeInt(32766);var t=n.buffer;e.ok(t),e.equal(t.length,4,"Wrong length for an int"),e.equal(t[0],2,"ASN.1 tag wrong"),e.equal(t[1],2,"length wrong"),e.equal(t[2],127,"value wrong (byte 1)"),e.equal(t[3],254,"value wrong (byte 2)"),e.end()}),test("write 3 byte int",function(e){var n=new BerWriter;n.writeInt(8388606);var t=n.buffer;e.ok(t),e.equal(t.length,5,"Wrong length for an int"),e.equal(t[0],2,"ASN.1 tag wrong"),e.equal(t[1],3,"length wrong"),e.equal(t[2],127,"value wrong (byte 1)"),e.equal(t[3],255,"value wrong (byte 2)"),e.equal(t[4],254,"value wrong (byte 3)"),e.end()}),test("write 4 byte int",function(e){var n=new BerWriter;n.writeInt(2147483646);var t=n.buffer;e.ok(t),e.equal(t.length,6,"Wrong length for an int"),e.equal(t[0],2,"ASN.1 tag wrong"),e.equal(t[1],4,"length wrong"),e.equal(t[2],127,"value wrong (byte 1)"),e.equal(t[3],255,"value wrong (byte 2)"),e.equal(t[4],255,"value wrong (byte 3)"),e.equal(t[5],254,"value wrong (byte 4)"),e.end()}),test("write boolean",function(e){var n=new BerWriter;n.writeBoolean(!0),n.writeBoolean(!1);var t=n.buffer;e.ok(t),e.equal(t.length,6,"Wrong length"),e.equal(t[0],1,"tag wrong"),e.equal(t[1],1,"length wrong"),e.equal(t[2],255,"value wrong"),e.equal(t[3],1,"tag wrong"),e.equal(t[4],1,"length wrong"),e.equal(t[5],0,"value wrong"),e.end()}),test("write string",function(e){var n=new BerWriter;n.writeString("hello world");var t=n.buffer;e.ok(t),e.equal(t.length,13,"wrong length"),e.equal(t[0],4,"wrong tag"),e.equal(t[1],11,"wrong length"),e.equal(t.slice(2).toString("utf8"),"hello world","wrong value"),e.end()}),test("write buffer",function(e){var n=new BerWriter;n.writeString("hello world");var t=n.buffer,r=new Buffer([4,11,48,9,2,1,15,1,1,255,1,1,255]);n.writeBuffer(r.slice(2,r.length),4),t=n.buffer,e.ok(t),e.equal(t.length,26,"wrong length"),e.equal(t[0],4,"wrong tag"),e.equal(t[1],11,"wrong length"),e.equal(t.slice(2,13).toString("utf8"),"hello world","wrong value"),e.equal(t[13],r[0],"wrong tag"),e.equal(t[14],r[1],"wrong length");for(var i=13,a=0;i<t.length&&a<r.length;i++,a++)e.equal(t[i],r[a],"buffer contents not identical");e.end()}),test("write string array",function(e){var n=new BerWriter;n.writeStringArray(["hello world","fubar!"]);var t=n.buffer;e.ok(t),e.equal(t.length,21,"wrong length"),e.equal(t[0],4,"wrong tag"),e.equal(t[1],11,"wrong length"),e.equal(t.slice(2,13).toString("utf8"),"hello world","wrong value"),e.equal(t[13],4,"wrong tag"),e.equal(t[14],6,"wrong length"),e.equal(t.slice(15).toString("utf8"),"fubar!","wrong value"),e.end()}),test("resize internal buffer",function(e){var n=new BerWriter({size:2});n.writeString("hello world");var t=n.buffer;e.ok(t),e.equal(t.length,13,"wrong length"),e.equal(t[0],4,"wrong tag"),e.equal(t[1],11,"wrong length"),e.equal(t.slice(2).toString("utf8"),"hello world","wrong value"),e.end()}),test("sequence",function(e){var n=new BerWriter({size:25});n.startSequence(),n.writeString("hello world"),n.endSequence();var t=n.buffer;e.ok(t),console.log(t),e.equal(t.length,15,"wrong length"),e.equal(t[0],48,"wrong tag"),e.equal(t[1],13,"wrong length"),e.equal(t[2],4,"wrong tag"),e.equal(t[3],11,"wrong length"),e.equal(t.slice(4).toString("utf8"),"hello world","wrong value"),e.end()}),test("nested sequence",function(e){var n=new BerWriter({size:25});n.startSequence(),n.writeString("hello world"),n.startSequence(),n.writeString("hello world"),n.endSequence(),n.endSequence();var t=n.buffer;e.ok(t),e.equal(t.length,30,"wrong length"),e.equal(t[0],48,"wrong tag"),e.equal(t[1],28,"wrong length"),e.equal(t[2],4,"wrong tag"),e.equal(t[3],11,"wrong length"),e.equal(t.slice(4,15).toString("utf8"),"hello world","wrong value"),e.equal(t[15],48,"wrong tag"),e.equal(t[16],13,"wrong length"),e.equal(t[17],4,"wrong tag"),e.equal(t[18],11,"wrong length"),e.equal(t.slice(19,30).toString("utf8"),"hello world","wrong value"),e.end()}),test("LDAP bind message",function(e){var n="cn=foo,ou=unit,o=test",t=new BerWriter;t.startSequence(),t.writeInt(3),t.startSequence(96),t.writeInt(3),t.writeString(n),t.writeByte(128),t.writeByte(0),t.endSequence(),t.endSequence();var r=t.buffer;e.ok(r),e.equal(r.length,35,"wrong length (buffer)"),e.equal(r[0],48,"wrong tag"),e.equal(r[1],33,"wrong length"),e.equal(r[2],2,"wrong tag"),e.equal(r[3],1,"wrong length"),e.equal(r[4],3,"wrong value"),e.equal(r[5],96,"wrong tag"),e.equal(r[6],28,"wrong length"),e.equal(r[7],2,"wrong tag"),e.equal(r[8],1,"wrong length"),e.equal(r[9],3,"wrong value"),e.equal(r[10],4,"wrong tag"),e.equal(r[11],n.length,"wrong length"),e.equal(r.slice(12,33).toString("utf8"),n,"wrong value"),e.equal(r[33],128,"wrong tag"),e.equal(r[34],0,"wrong len"),e.end()}),test("Write OID",function(e){var n="1.2.840.113549.1.1.1",t=new BerWriter;t.writeOID(n);var r=t.buffer;e.ok(r),console.log(require("util").inspect(r)),console.log(require("util").inspect(new Buffer([6,9,42,134,72,134,247,13,1,1,1]))),e.end()});