function FormData(){this._overheadLength=0,this._valueLength=0,this._lengthRetrievers=[],CombinedStream.call(this)}function populate(e,n){for(var t in n)e[t]||(e[t]=n[t]);return e}var CombinedStream=require("combined-stream"),util=require("util"),path=require("path"),http=require("http"),https=require("https"),parseUrl=require("url").parse,fs=require("fs"),mime=require("mime"),async=require("async");module.exports=FormData,util.inherits(FormData,CombinedStream),FormData.LINE_BREAK="\r\n",FormData.prototype.append=function(e,n,t){t=t||{};var r=CombinedStream.prototype.append.bind(this);if("number"==typeof n&&(n=""+n),util.isArray(n))return void this._error(new Error("Arrays are not supported."));var a=this._multiPartHeader(e,n,t),i=this._multiPartFooter(e,n,t);r(a),r(n),r(i),this._trackLength(a,n,t)},FormData.prototype._trackLength=function(e,n,t){var r=0;null!=t.knownLength?r+=+t.knownLength:Buffer.isBuffer(n)?r=n.length:"string"==typeof n&&(r=Buffer.byteLength(n)),this._valueLength+=r,this._overheadLength+=Buffer.byteLength(e)+ +FormData.LINE_BREAK.length,n&&(n.path||n.readable&&n.hasOwnProperty("httpVersion"))&&(t.knownLength||this._lengthRetrievers.push(function(e){n.hasOwnProperty("fd")?void 0!=n.end&&n.end!=1/0&&void 0!=n.start?e(null,n.end+1-(n.start?n.start:0)):fs.stat(n.path,function(t,r){var a;return t?void e(t):(a=r.size-(n.start?n.start:0),void e(null,a))}):n.hasOwnProperty("httpVersion")?e(null,+n.headers["content-length"]):n.hasOwnProperty("httpModule")?(n.on("response",function(t){n.pause(),e(null,+t.headers["content-length"])}),n.resume()):e("Unknown stream")}))},FormData.prototype._multiPartHeader=function(e,n,t){var r=this.getBoundary(),a="";return null!=t.header?a=t.header:(a+="--"+r+FormData.LINE_BREAK+'Content-Disposition: form-data; name="'+e+'"',t.filename||n.path?a+='; filename="'+path.basename(t.filename||n.path)+'"'+FormData.LINE_BREAK+"Content-Type: "+(t.contentType||mime.lookup(t.filename||n.path)):n.readable&&n.hasOwnProperty("httpVersion")&&(a+='; filename="'+path.basename(n.client._httpMessage.path)+'"'+FormData.LINE_BREAK+"Content-Type: "+n.headers["content-type"]),a+=FormData.LINE_BREAK+FormData.LINE_BREAK),a},FormData.prototype._multiPartFooter=function(e,n,t){return function(e){var n=FormData.LINE_BREAK,t=0===this._streams.length;t&&(n+=this._lastBoundary()),e(n)}.bind(this)},FormData.prototype._lastBoundary=function(){return"--"+this.getBoundary()+"--"},FormData.prototype.getHeaders=function(e){var n={"content-type":"multipart/form-data; boundary="+this.getBoundary()};for(var t in e)n[t.toLowerCase()]=e[t];return n},FormData.prototype.getCustomHeaders=function(e){e=e?e:"multipart/form-data";var n={"content-type":e+"; boundary="+this.getBoundary(),"content-length":this.getLengthSync()};return n},FormData.prototype.getBoundary=function(){return this._boundary||this._generateBoundary(),this._boundary},FormData.prototype._generateBoundary=function(){for(var e="--------------------------",n=0;24>n;n++)e+=Math.floor(10*Math.random()).toString(16);this._boundary=e},FormData.prototype.getLengthSync=function(e){var n=this._overheadLength+this._valueLength;return this._streams.length&&(n+=this._lastBoundary().length),this._lengthRetrievers.length&&this._error(new Error("Cannot calculate proper length in synchronous way.")),n},FormData.prototype.getLength=function(e){var n=this._overheadLength+this._valueLength;return this._streams.length&&(n+=this._lastBoundary().length),this._lengthRetrievers.length?void async.parallel(this._lengthRetrievers,function(t,r){return t?void e(t):(r.forEach(function(e){n+=e}),void e(null,n))}):void process.nextTick(e.bind(this,null,n))},FormData.prototype.submit=function(e,n){var t,r,a={method:"post"};return"string"==typeof e?(e=parseUrl(e),r=populate({port:e.port,path:e.pathname,host:e.hostname},a)):(r=populate(e,a),r.port||(r.port="https:"==r.protocol?443:80)),r.headers=this.getHeaders(e.headers),t="https:"==e.protocol?https.request(r):http.request(r),this.getLength(function(e,r){t.setHeader("Content-Length",r),this.pipe(t),n&&(t.on("error",n),t.on("response",n.bind(this,null)))}.bind(this)),t},FormData.prototype._error=function(e){this.error||(this.error=e,this.pause(),this.emit("error",e))};