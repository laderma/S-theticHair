function parseDate(e,n){if(e){var t,r,a,i,s=e.split(DATE_DELIM);if(s){var o=new Date;o.setMilliseconds(0);for(var l=0;l<s.length;l++){var u=s[l].trim();if(u.length){var c;if(t||!(c=(n?STRICT_TIME:TIME).exec(u)))if(r||!(c=DAY_OF_MONTH.exec(u)))if(a||!(c=MONTH.exec(u)))if(i||!(c=YEAR.exec(u)));else{var f=c[0];if(f>=70&&99>=f?f+=1900:f>=0&&69>=f&&(f+=2e3),1601>f)return;i=!0,o.setUTCFullYear(f)}else a=!0,o.setUTCMonth(MONTH_TO_NUM[c[1].toLowerCase()]);else r=!0,o.setUTCDate(c[1]);else t=!0,o.setUTCHours(c[1]),o.setUTCMinutes(c[2]),o.setUTCSeconds(c[3])}}if(t&&r&&a&&i)return o}}}function formatDate(e){var n=e.getUTCDate();n=n>=10?n:"0"+n;var t=e.getUTCHours();t=t>=10?t:"0"+t;var r=e.getUTCMinutes();r=r>=10?r:"0"+r;var a=e.getUTCSeconds();return a=a>=10?a:"0"+a,NUM_TO_DAY[e.getUTCDay()]+", "+n+" "+NUM_TO_MONTH[e.getUTCMonth()]+" "+e.getUTCFullYear()+" "+t+":"+r+":"+a+" GMT"}function canonicalDomain(e){return null==e?null:(e=e.trim().replace(/^\./,""),punycode&&/[^\u0001-\u007f]/.test(e)&&(e=punycode.toASCII(e)),e.toLowerCase())}function domainMatch(e,n,t){if(null==e||null==n)return null;if(t!==!1&&(e=canonicalDomain(e),n=canonicalDomain(n)),e==n)return!0;if(net.isIP(e))return!1;var r=e.indexOf(n);return 0>=r?!1:e.length!==n.length+r?!1:"."!==e.substr(r-1,1)?!1:!0}function defaultPath(e){if(!e||"/"!==e.substr(0,1))return"/";if("/"===e)return e;var n=e.lastIndexOf("/");return 0===n?"/":e.slice(0,n)}function pathMatch(e,n){if(n===e)return!0;var t=e.indexOf(n);if(0===t){if("/"===n.substr(-1))return!0;if("/"===e.substr(n.length,1))return!0}return!1}function parse(e,n){e=e.trim();var t=TRAILING_SEMICOLON.exec(e);if(t){if(n)return;e=e.slice(0,t.index)}var r=e.indexOf(";"),a=n?COOKIE_PAIR_STRICT:COOKIE_PAIR,i=a.exec(-1===r?e:e.substr(0,r));if(i){var s=new Cookie;if(s.key=i[1],s.value=i[3],-1===r)return s;var o=e.slice(r).replace(/^\s*;\s*/,"").trim();if(0===o.length)return s;for(var l=o.split(/\s*;\s*/);l.length;){var u=l.shift();if(n&&!EXTENSION_AV.test(u))return;var f,d,c=u.indexOf("=");switch(-1===c?(f=u,d=null):(f=u.substr(0,c),d=u.substr(c+1)),f=f.trim().toLowerCase(),d&&(d=d.trim()),f){case"expires":if(!d){if(n)return;break}var h=parseDate(d,n);if(null==h){if(n)return;break}s.expires=h;break;case"max-age":if(!d){if(n)return;break}if(!/^-?[0-9]+$/.test(d)){if(n)return;break}var p=parseInt(d,10);if(n&&0>=p)return;s.setMaxAge(p);break;case"domain":if(!d){if(n)return;break}var m=d.trim().replace(/^\./,"");if(!m){if(n)return;break}s.domain=m.toLowerCase();break;case"path":if(!d||"/"!=d.substr(0,1)){if(n)return;break}s.path=d;break;case"secure":if(null!=d&&n)return;s.secure=!0;break;case"httponly":if(null!=d&&n)return;s.httpOnly=!0;break;default:s.extensions=s.extensions||[],s.extensions.push(u)}}return s.creation=new Date,s}}function fromJSON(e){if(!e)return null;var n;try{n=JSON.parse(e)}catch(t){return null}for(var r=new Cookie,a=0;numCookieProperties>a;a++){var i=cookieProperties[a];null!=n[i]&&("expires"===i||"creation"===i||"lastAccessed"===i?r[i]="Infinity"==n[i]?"Infinity":new Date(n[i]):r[i]=n[i])}return r.creation=r.creation||new Date,r}function cookieCompare(e,n){var t=(n.path?n.path.length:0)-(e.path?e.path.length:0);return 0!==t?t:(e.creation?e.creation.getTime():MAX_TIME)-(n.creation?n.creation.getTime():MAX_TIME)}function permuteDomain(e){var n=pubsuffix.getPublicSuffix(e);if(!n)return null;if(n==e)return[e];for(var t=e.slice(0,-(n.length+1)),r=t.split(".").reverse(),a=n,i=[a];r.length;)a=r.shift()+"."+a,i.push(a);return i}function permutePath(e){if("/"===e)return["/"];e.lastIndexOf("/")===e.length-1&&(e=e.substr(0,e.length-1));for(var t=[e];e.length>1;){var r=e.lastIndexOf("/");if(0===r)break;e=e.substr(0,r),t.push(e)}return t.push("/"),t}function Cookie(e){"object"==typeof e&&Object.keys(e).forEach(function(n){Cookie.prototype.hasOwnProperty(n)&&(this[n]=e[n]||Cookie.prototype[n])}.bind(this))}function CookieJar(e,n){null!=n&&(this.rejectPublicSuffixes=n),e||(memstore=memstore||require("./memstore"),e=new memstore.MemoryCookieStore),this.store=e}var net=require("net"),urlParse=require("url").parse,pubsuffix=require("./pubsuffix"),punycode;try{punycode=require("punycode")}catch(e){console.warn("cookie: can't load punycode; won't use punycode for domain normalization")}var DATE_DELIM=/[\x09\x20-\x2F\x3B-\x40\x5B-\x60\x7B-\x7E]/,TOKEN=/[\x21\x23-\x26\x2A\x2B\x2D\x2E\x30-\x39\x41-\x5A\x5E-\x7A\x7C\x7E]/,COOKIE_OCTET=/[\x21\x23-\x2B\x2D-\x3A\x3C-\x5B\x5D-\x7E]/,COOKIE_OCTETS=/^[\x21\x23-\x2B\x2D-\x3A\x3C-\x5B\x5D-\x7E]+$/,COOKIE_PAIR_STRICT=new RegExp("^("+TOKEN.source+'+)=("?)('+COOKIE_OCTET.source+"*)\\2"),COOKIE_PAIR=/^([^=\s]+)\s*=\s*("?)\s*(.*)\s*\2/,NON_CTL_SEMICOLON=/[\x20-\x3A\x3C-\x7E]+/,EXTENSION_AV=NON_CTL_SEMICOLON,PATH_VALUE=NON_CTL_SEMICOLON,TRAILING_SEMICOLON=/;+$/,DAY_OF_MONTH=/^(0?[1-9]|[12][0-9]|3[01])$/,TIME=/(0?[0-9]|1[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])/,STRICT_TIME=/^(0?[0-9]|1[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/,MONTH=/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)$/i,MONTH_TO_NUM={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11},NUM_TO_MONTH=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],NUM_TO_DAY=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],YEAR=/^([1-9][0-9]{1,3})$/,MAX_TIME=2147483647e3,MAX_DATE=new Date(CookieJar.MAX_TIME),MIN_TIME=0,MIN_DATE=new Date(CookieJar.MIN_TIME);Cookie.parse=parse,Cookie.fromJSON=fromJSON,Cookie.prototype.key="",Cookie.prototype.value="",Cookie.prototype.expires="Infinity",Cookie.prototype.maxAge=null,Cookie.prototype.domain=null,Cookie.prototype.path=null,Cookie.prototype.secure=!1,Cookie.prototype.httpOnly=!1,Cookie.prototype.extensions=null,Cookie.prototype.hostOnly=null,Cookie.prototype.pathIsDefault=null,Cookie.prototype.creation=null,Cookie.prototype.lastAccessed=null;var cookieProperties=Object.freeze(Object.keys(Cookie.prototype).map(function(e){return e instanceof Function?void 0:e})),numCookieProperties=cookieProperties.length;Cookie.prototype.inspect=function(){var e=Date.now();return'Cookie="'+this.toString()+"; hostOnly="+(null!=this.hostOnly?this.hostOnly:"?")+"; aAge="+(this.lastAccessed?e-this.lastAccessed.getTime()+"ms":"?")+"; cAge="+(this.creation?e-this.creation.getTime()+"ms":"?")+'"'},Cookie.prototype.validate=function(){if(!COOKIE_OCTETS.test(this.value))return!1;if(!(this.expires==1/0||this.expires instanceof Date||parseDate(this.expires,!0)))return!1;if(null!=this.maxAge&&this.maxAge<=0)return!1;if(null!=this.path&&!PATH_VALUE.test(this.path))return!1;var e=this.cdomain();if(e){if(e.match(/\.$/))return!1;var n=pubsuffix.getPublicSuffix(e);if(null==n)return!1}return!0},Cookie.prototype.setExpires=function(e){e instanceof Date?this.expires=e:this.expires=parseDate(e)||"Infinity"},Cookie.prototype.setMaxAge=function(e){e===1/0||e===-(1/0)?this.maxAge=e.toString():this.maxAge=e},Cookie.prototype.cookieString=function(){var e=this.value;return null==e&&(e=""),!e.length||COOKIE_OCTETS.test(e)?this.key+"="+e:this.key+'="'+e+'"'},Cookie.prototype.toString=function(){var e=this.cookieString();return this.expires!=1/0&&(e+=this.expires instanceof Date?"; Expires="+formatDate(this.expires):"; Expires="+this.expires),null!=this.maxAge&&this.maxAge!=1/0&&(e+="; Max-Age="+this.maxAge),this.domain&&!this.hostOnly&&(e+="; Domain="+this.domain),this.path&&(e+="; Path="+this.path),this.secure&&(e+="; Secure"),this.httpOnly&&(e+="; HttpOnly"),this.extensions&&this.extensions.forEach(function(n){e+="; "+n}),e},Cookie.prototype.TTL=function(e){if(null!=this.maxAge)return this.maxAge<=0?0:1e3*this.maxAge;var n=this.expires;return n!=1/0?(n instanceof Date||(n=parseDate(n)||1/0),n==1/0?1/0:n.getTime()-(e||Date.now())):1/0},Cookie.prototype.expiryTime=function(e){if(null!=this.maxAge){var n=this.creation||e||new Date,t=this.maxAge<=0?-(1/0):1e3*this.maxAge;return n.getTime()+t}return this.expires==1/0?1/0:this.expires.getTime()},Cookie.prototype.expiryDate=function(e){var n=this.expiryTime(e);return n==1/0?new Date(MAX_TIME):n==-(1/0)?new Date(MIN_TIME):new Date(n)},Cookie.prototype.isPersistent=function(){return null!=this.maxAge||this.expires!=1/0},Cookie.prototype.cdomain=Cookie.prototype.canonicalizedDomain=function(){return null==this.domain?null:canonicalDomain(this.domain)};var memstore;CookieJar.prototype.store=null,CookieJar.prototype.rejectPublicSuffixes=!0,CookieJar.prototype.setCookie=function(e,n,t,r){var a,i=n instanceof Object?n:urlParse(n);t instanceof Function&&(r=t,t={});var s=canonicalDomain(i.hostname);if(e instanceof Cookie||(e=Cookie.parse(e,t.strict===!0)),!e)return a=new Error("Cookie failed to parse"),r(t.ignoreError?null:a);var o=t.now||new Date;if(this.rejectPublicSuffixes&&e.domain){var l=pubsuffix.getPublicSuffix(e.cdomain());if(null==l)return a=new Error("Cookie has domain set to a public suffix"),r(t.ignoreError?null:a)}if(e.domain){if(!domainMatch(s,e.cdomain(),!1))return a=new Error("Cookie not in this host's domain. Cookie:"+e.cdomain()+" Request:"+s),r(t.ignoreError?null:a);null==e.hostOnly&&(e.hostOnly=!1)}else e.hostOnly=!0,e.domain=s;if(e.path?e.path.length>1&&"/"==e.path.substr(-1)&&(e.path=e.path.slice(0,-1)):(e.path=defaultPath(i.pathname),e.pathIsDefault=!0),t.http===!1&&e.httpOnly)return a=new Error("Cookie is HttpOnly and this isn't an HTTP API"),r(t.ignoreError?null:a);var u=this.store;u.updateCookie||(u.updateCookie=function(e,n,t){this.putCookie(n,t)}),u.findCookie(e.domain,e.path,e.key,function(n,a){if(n)return r(n);var i=function(n){return n?r(n):void r(null,e)};if(a){if(t.http===!1&&a.httpOnly)return n=new Error("old Cookie is HttpOnly and this isn't an HTTP API"),r(t.ignoreError?null:n);e.creation=a.creation,e.lastAccessed=o,u.updateCookie(a,e,i)}else e.creation=e.lastAccessed=o,u.putCookie(e,i)})},CookieJar.prototype.getCookies=function(e,n,t){function d(e){if(e.hostOnly){if(e.domain!=a)return!1}else if(!domainMatch(a,e.domain,!1))return!1;return c||pathMatch(i,e.path)?e.secure&&!s?!1:e.httpOnly&&!o?!1:u&&e.expiryTime()<=l?(f.removeCookie(e.domain,e.path,e.key,function(){}),!1):!0:!1}var r=e instanceof Object?e:urlParse(e);n instanceof Function&&(t=n,n={});var a=canonicalDomain(r.hostname),i=r.pathname||"/",s=n.secure;null!=s||!r.protocol||"https:"!=r.protocol&&"wss:"!=r.protocol||(s=!0);var o=n.http;null==o&&(o=!0);var l=n.now||Date.now(),u=n.expire!==!1,c=!!n.allPaths,f=this.store;f.findCookies(a,c?null:i,function(e,r){if(e)return t(e);r=r.filter(d),n.sort!==!1&&(r=r.sort(cookieCompare));var a=new Date;r.forEach(function(e){e.lastAccessed=a}),t(null,r)})},CookieJar.prototype.getCookieString=function(){var e=Array.prototype.slice.call(arguments,0),n=e.pop(),t=function(e,t){e?n(e):n(null,t.map(function(e){return e.cookieString()}).join("; "))};e.push(t),this.getCookies.apply(this,e)},CookieJar.prototype.getSetCookieStrings=function(){var e=Array.prototype.slice.call(arguments,0),n=e.pop(),t=function(e,t){e?n(e):n(null,t.map(function(e){return e.toString()}))};e.push(t),this.getCookies.apply(this,e)},module.exports={CookieJar:CookieJar,Cookie:Cookie,parseDate:parseDate,formatDate:formatDate,parse:parse,fromJSON:fromJSON,domainMatch:domainMatch,defaultPath:defaultPath,pathMatch:pathMatch,getPublicSuffix:pubsuffix.getPublicSuffix,cookieCompare:cookieCompare,permuteDomain:permuteDomain,permutePath:permutePath,canonicalDomain:canonicalDomain};