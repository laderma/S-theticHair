"use strict";var _=require("lodash"),utils=require("./utils.js"),marked=require("marked"),dateFormatter=require("./dateformatter.js");"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(e){return 0==this.indexOf(e)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return this.slice(-e.length)==e}),module.exports.init=function(e){var t="",n={},i={},s=function(e){return e.toUpperCase()},o=function(e,t,n){return"string"==typeof e?e.slice(t,t+n):Array.isArray(e)?e.slice(t||0,t+n):utils.sliceDictionary(e,n,t)},r=function(e,t){if(!e||!t)return e;if(e.length>t&&e.length>0){var n=e+" ";return n=e.substr(0,t),n=e.substr(0,n.lastIndexOf(" ")),n=n.length>0?n:e.substr(0,t),n+"..."}return e},a=function(e,t,n){if(0===_.size(e))return e;var i=e[0],s="_sort_"+t;return i[s]&&(t=s),n?_.sortBy(e,t).reverse():_.sortBy(e,t)},l=function(e,t){return _(e).reverse()},c=function(e,t){if(!_.isArray(e))return e;var n={};return _.forEach(e,function(e){if(e.hasOwnProperty(t)){var i=e[t];utils.extend({},e);n[i]||(n[i]=[]),n[i].push(e)}}),n},f=function(e,t,n,i){var s=e.resize_url;return"auto"===t&&"auto"===n?e.resize_url:("auto"===t&&n?s+="=h"+n:t&&"auto"===n?s+="=w"+t:t&&n?s+="=w"+t+"-h"+n:t&&!n&&(s+="=s"+t),i&&(s+="-c"),0===s.indexOf("http://")&&(s=s.replace("http://","https://")),s)},m=function(e,t,n,i){var s=e.resize_url,o=s.split("."),r=o.length>1?"."+o.pop():"";return s=o.join("."),"auto"===t&&"auto"===n?s+"-0x0"+r:("auto"===t&&n?s+="-0x"+n:t&&"auto"===n?s+="-"+t+"x0":t&&n?s+="-"+t+"x"+n:t&&!n&&(s+="-"+t+"x"+t),s+=i?"-c":"-a",s+=r)},d=function(e,i,s,o){if(!e)return"";var r="";if("object"==typeof e)return i&&e.resize_url?0===e.resize_url.indexOf("http://static-cdn.jtvnw.net")?m(e,i,s):f(e,i,s):e.url;if("string"==typeof e){console.log("The imageSize filter only supports image objects and not raw urls.".red);var a=[];i&&a.push("width="+i),s&&a.push("height="+s),o&&a.push("grow="+o),-1===e.indexOf("http://")&&(e="http://"+t+e),a.push("url="+encodeURIComponent(e)),n.embedly?a.push("key="+n.embedly):a.push("key=13dde81b8137446e89c7933edca679eb"),r="http://i.embed.ly/1/display/resize?"+a.join("&")}return r},u=function(e,i,s){if(!e)return"";var o="";if("object"==typeof e)return i?0===e.resize_url.indexOf("http://static-cdn.jtvnw.net")?m(e,i,s,!0):f(e,i,s,!0):e.url;if("string"==typeof e){console.log("The imageCrop filter only supports image objects and not raw urls.".red);var r=[];i&&r.push("width="+i),s&&r.push("height="+s),-1===e.indexOf("http://")&&(e="http://"+t+e),r.push("url="+encodeURIComponent(e)),n.embedly?r.push("key="+n.embedly):r.push("key=13dde81b8137446e89c7933edca679eb"),o="http://i.embed.ly/1/display/crop?"+r.join("&")}return o},h=function(e){return _(e).size()},g=function(e){return marked(e)},p=function(e,t){return"string"!=typeof e?!1:e.startsWith(t)},k=function(e,t){return"string"!=typeof e?!1:e.endsWith(t)};this.setTypeInfo=function(e){i=e},this.setSiteDns=function(e){t=e},this.setFirebaseConf=function(e){n=e};var v=function(e,t,n,i){var r,s=t.length,o=new dateFormatter.DateZ(e),a=0,l="";if(!n&&"string"==typeof e){var c=e.match(/[\+-]\d{2}:\d{2}$/),f=1;if(c){c=c[0],"+"===c[0]&&(f=-1),c=c.slice(1);var m=c.split(":"),d=1*m[0],u=1*m[1];n=f*(60*d+u)}}for(n&&o.setTimezoneOffset(n,i),a;s>a;a+=1)r=t.charAt(a),l+=dateFormatter.hasOwnProperty(r)?dateFormatter[r](o,n,i):r;return l},b=function(e){var t="",n="",i="",s="",o=Math.floor(e%60),r=Math.floor(e/60),a=r%60,l=Math.floor(r/60);return n=0===a?"00":10>a?"0"+a:""+a,i=0===o?"00":10>o?"0"+o:""+o,s=0===l?"":10>l?"0"+l:""+l,t=n+":"+i,l>0&&(t=s+":"+t),t},C=function(e,t){var n=[],i=[].slice.apply(arguments),s=i.slice(2);return e.forEach(function(e){0===s.length?e[t]&&n.push(e):s.forEach(function(i){return e[t]===i?(n.push(e),!1):void 0})}),n},y=function(e,t,n){var i=[],s=[].slice.apply(arguments),o=s.slice(3);return e.forEach(function(e){var s=e[t];if(s)if(Array.isArray(s)){var r=!1;s.forEach(function(e){0===o.length&&e&&e[n]&&(r=!0),o.length>0&&o.forEach(function(t){e&&e[n]===t&&(r=!0)})}),r&&i.push(e)}else 0===o.length&&s&&s[n]&&i.push(e),o.length>0&&o.forEach(function(t){subItem&&subItem[n]===t&&i.push(e)})}),i},w=function(e,t){var n=[],i=[].slice.apply(arguments),s=i.slice(2);return e.forEach(function(e){var i=!0;0===s.length?e[t]||n.push(e):(s.forEach(function(n){if(Array.isArray(n))n.forEach(function(n){return e[t]===n[t]?(i=!1,!1):void 0});else if(e[t]===n)return i=!1,!1}),i&&n.push(e))}),n},$=function(e){return Math.abs(e)},S=function(e){var t=e.replace("\r\n","\n").replace("\r","\n").split("\n"),n=t.join("<br/>");return"<p>"+n+"</p>"},x=function(e,t){if(!e)return t;if(!t)return t;if(!this._type)return t;var n=i[this._type]||{},s=n.controls||{},o=_.where(s,{name:e});if(0===o.length)return t;var r=o[0];if("relation"===r.controlType){var a="";return Array.isArray(t)?(a=[],t.forEach(function(e){e._id?a.push(e._type+" "+e._id):a.push(e._type+" "+e._type)})):a+=t._id?t._type+" "+t._id:t._type+" "+t._type,a}return t},I=function(e){return JSON.stringify(e,x)},T=function(e,t){return t||(t="callback"),"/**/"+t+"("+JSON.stringify(e,x)+")"},F=function(e,t,n){t&&!n&&(n=t,t=""),t||n||(n="s",t="");var i=e;return _.isArray(e)&&(i=e.length),"number"!=typeof i?t:i>1||0===i?n:t},D=function(e){var t=/(<img.*)?alt=(['"](.*?)\|(.*?)['"])(.*>)/,n="";return e.split("\n").forEach(function(e,i){n+=e.replace(t,'$1alt="$3" class="$4"$5')}),n};g.safe=!0,S.safe=!0,T.safe=!0,I.safe=!0,e.setFilter("upper",s),e.setFilter("slice",o),e.setFilter("truncate",r),e.setFilter("sort",a),e.setFilter("startsWith",p),e.setFilter("endsWith",k),e.setFilter("reverse",l),e.setFilter("imageSize",d),e.setFilter("imageCrop",u),e.setFilter("size",h),e.setFilter("groupBy",c),e.setFilter("markdown",g),e.setFilter("date",v),e.setFilter("where",C),e.setFilter("relationshipHas",y),e.setFilter("exclude",w),e.setFilter("duration",b),e.setFilter("abs",$),e.setFilter("linebreaks",S),e.setFilter("pluralize",F),e.setFilter("jsonp",T),e.setFilter("json",I),e.setFilter("imgAltClass",D)};