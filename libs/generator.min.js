"use strict";var firebase=require("firebase"),request=require("request"),mkdirp=require("mkdirp"),path=require("path"),fs=require("fs"),glob=require("glob"),tinylr=require("tiny-lr"),_=require("lodash"),wrench=require("wrench"),utils=require("./utils.js"),websocketServer=require("nodejs-websocket"),Zip=require("adm-zip"),slug=require("uslug"),async=require("async"),spawn=require("win-spawn"),md5=require("MD5"),$=require("cheerio"),exec=require("child_process").exec;require("colors");var swig=require("swig");swig.setDefaults({loader:swig.loaders.fs(__dirname+"/..")});var swigFunctions=require("./swig_functions").swigFunctions(),swigFilters=require("./swig_filters"),swigTags=require("./swig_tags");swigFilters.init(swig),swigTags.init(swig),swig.setDefaults({cache:!1});var wrap=function(){var e=Array.prototype.slice.call(arguments),t=e.pop();return t="debugger;var global = null;var console = null;var v8debug = null;var setTimeout = null;var setInterval = null;var setImmediate = null;var clearTimeout = null;var clearInterval = null;var clearImmediate = null;var root = null;var GLOBAL = null;var window = null;var process = null;var eval = null;var require = null;var __filename = null;var __dirname = null;var modules = null;var exports = null;"+t,e.push(t),Function.prototype.constructor.apply(this,e)};wrap.prototype=Function.prototype,Function=wrap;var cmsSocketPort=6557;module.exports.generator=function(e,t,n,o){var s=this,i=e.get("webhook").firebase||"webhook",a=e.get("connect")["wh-server"].options.livereload;35730!==a&&(cmsSocketPort=a+1);var r=null,l=!1,c=!1;this.versionString=null,this.cachedData=null,a===!0&&(a=35729),n=n||{ok:function(){},error:function(){},write:function(){},writeln:function(){}},i?this.root=new firebase("https://"+i+".firebaseio.com/"):this.root=null;var m=function(){return s.root.child("buckets/"+e.get("webhook").siteName+"/"+e.get("webhook").secretKey+"/dev")},d=function(){return s.root.child("management/sites/"+e.get("webhook").siteName+"/dns")},f=function(e,t){m().child("contentType").child(e).once("value",function(e){t(e.val())})},u=function(t){if(s.cachedData)return swigFunctions.setData(s.cachedData.data),swigFunctions.setTypeInfo(s.cachedData.typeInfo),swigFunctions.setSettings(s.cachedData.settings),swigFilters.setSiteDns(s.cachedData.siteDns),swigFilters.setFirebaseConf(e.get("webhook")),swigFilters.setTypeInfo(s.cachedData.typeInfo),void t(s.cachedData.data,s.cachedData.typeInfo);if(!s.root)throw new Error("Missing firebase reference, may need to run init");m().once("value",function(n){n=n.val();var o={},i={};o=n&&n.contentType?n.contentType:{},i=n&&n.settings?n.settings:{},n=n&&n.data?n.data:{},s.cachedData={data:n,typeInfo:o,settings:i},swigFunctions.setData(n),swigFunctions.setTypeInfo(o),swigFunctions.setSettings(i),swigFilters.setTypeInfo(o),d().once("value",function(i){var a=i.val()||e.get("webhook").siteName+".webhook.org";s.cachedData.siteDns=a,swigFilters.setSiteDns(a),swigFilters.setFirebaseConf(e.get("webhook")),t(n,o)})},function(t){if("PERMISSION_DENIED"!==t.code)throw new Error(t);console.log("\n========================================================".red),console.log("# Permission denied                                         #".red),console.log("========================================================".red),console.log("#".red+" You don't have permission to this site or your subscription expired.".red),console.log("# Visit ".red+"https://billing.webhook.com/site/".yellow+e.get("webhook").siteName.yellow+"/".yellow+" to manage your subscription.".red),console.log("# ---------------------------------------------------- #".red),process.exit(0)})},h=null;this.openSearchEntryStream=function(t){return e.get("webhook").noSearch===!0?void t():(fs.existsSync("./.build/.wh/")||mkdirp.sync("./.build/.wh/"),h=fs.createWriteStream("./.build/.wh/searchjson.js"),h.write('var tipuesearch = {"pages": [\n'),void t())},this.closeSearchEntryStream=function(t){return e.get("webhook").noSearch!==!0&&h?(h.end("]}"),void h.on("close",function(){t()})):void t()};var g=function(t,n){if(e.get("webhook").noSearch!==!0&&h){var o=t.replace("./.build","");if(".html"===path.extname(o)&&"/404.html"!==o&&0!==o.indexOf("/_wh_previews")){o=o.replace("index.html","");var s=$.load(n),i=s("title").text(),a=s("body");if("false"!==a.attr("data-search-index")){var r=a.find('[data-search-index="true"]');r.length>0&&(a=r.first()),a.find("script").remove(),a.find("iframe").remove(),a.find("object").remove(),a.find('[data-search-index="false"]').remove();var l=a.text().trim(),c="";if(s('meta[name="keywords"]').length>0&&(c=s('meta[name="keywords"]').attr("content")),h){var m={title:i,text:l,tags:c,loc:o};h.write(JSON.stringify(m)+",\n"),m=null}i="",l=""}}}},k=function(t,n,o){o=o||{},o.firebase_conf=e.get("webhook");var i=n;o=utils.extend(o,swigFunctions.getFunctions()),o.cmsSocketPort=cmsSocketPort,swigFunctions.init();var a=n.replace("index.html","").replace("./.build","");swigFunctions.setParams({CURRENT_URL:a}),o.item&&(o.item=o._realGetItem(o.item._type,o.item._id,!0)),o.production=c;var r="";try{r=swig.renderFile(t,o)}catch(m){if(s.sendSockMessage(m.toString()),l)throw m;console.log("Error while rendering template: "+t),console.log(m.toString().red);try{r=swig.renderFile("./libs/debug500.html",{template:t,error:m.toString(),backtrace:m.stack.toString()})}catch(m){return""}}for(mkdirp.sync(path.dirname(n)),fs.writeFileSync(n,r),g(n,r),swigFunctions.increasePage();swigFunctions.shouldPaginate();){n=i.replace("/index.html","/"+swigFunctions.pageUrl+swigFunctions.curPage+"/index.html"),a=n.replace("index.html","").replace("./.build",""),swigFunctions.setParams({CURRENT_URL:a});try{var r=swig.renderFile(t,o)}catch(m){if(s.sendSockMessage(m.toString()),l)throw m;console.log("Error while rendering template: "+t),console.log(m.toString().red);try{r=swig.renderFile("./libs/debug500.html",{template:t,error:m.toString(),backtrace:m.stack.toString()})}catch(m){return""}}mkdirp.sync(path.dirname(n)),fs.writeFileSync(n,r),g(n,r),swigFunctions.increasePage()}return n.replace("./.build","")},p=function(e,t){n.ok("Downloading preset...");var o=!1,s=request(e);s.on("response",function(e){200!==e.statusCode&&(o=!0,fs.unlinkSync(".preset.zip"),t(!0))}).pipe(fs.createWriteStream(".preset.zip")).on("close",function(){if(!o){var e=new Zip(".preset.zip"),n=e.getEntries();if(fs.existsSync("package.json")&&fs.renameSync("package.json","old.package.json"),n.forEach(function(e){var t=e.entryName.split("/").slice(1).join("/");e.entryName=t}),e.extractAllTo(".",!0),fs.existsSync("old.package.json")&&fs.existsSync("package.json")){var s=JSON.parse(fs.readFileSync("package.json")),i=JSON.parse(fs.readFileSync("old.package.json")),a=s.dependencies,r=i.dependencies;_.assign(a,r),s.dependencies=a,fs.writeFileSync("package.json",JSON.stringify(s,null,"  ")),fs.unlinkSync("old.package.json")}else fs.existsSync("old.package.json")&&fs.renameSync("old.package.json","package.json");fs.unlinkSync(".preset.zip"),t()}})},v=function(t){n.ok("Resetting Generator...");var o="http://dump.webhook.com/static/generate-repo.zip",i=!1,a=request(o);a.on("response",function(e){200!==e.statusCode&&(i=!0,fs.unlinkSync(".reset.zip"),t(!0))}).pipe(fs.createWriteStream(".reset.zip")).on("close",function(){if(!i){var n=new Zip(".reset.zip"),o=n.getEntries();S(".pages-old",function(){S(".templates-old",function(){S(".static-old",function(){try{fs.renameSync("pages",".pages-old")}catch(i){return fs.unlinkSync(".reset.zip"),void t(!0)}try{fs.renameSync("templates",".templates-old")}catch(i){return fs.renameSync(".pages-old","pages"),fs.unlinkSync(".reset.zip"),void t(!0)}try{fs.renameSync("static",".static-old")}catch(i){return fs.renameSync(".pages-old","pages"),fs.renameSync(".templates-old","templates"),fs.unlinkSync(".reset.zip"),void t(!0)}o.forEach(function(e){(0===e.entryName.indexOf("pages/")||0===e.entryName.indexOf("templates/")||0===e.entryName.indexOf("static/"))&&n.extractEntryTo(e.entryName,".",!0,!0)}),S(".pages-old",function(){S(".templates-old",function(){S(".static-old",function(){fs.unlinkSync(".reset.zip"),s.init(e.get("webhook").siteName,e.get("webhook").secretKey,!0,e.get("webhook").firebase,e.get("webhook").server,function(){t()})})})})})})})}})},b=function(e,t){fs.writeFileSync(".preset.zip",e,{encoding:"base64"});var s=new Zip(".preset.zip"),i=s.getEntries();if(fs.existsSync("package.json")&&fs.renameSync("package.json","old.package.json"),i.forEach(function(e){var t=e.entryName.split("/").slice(1).join("/");e.entryName=t}),s.extractAllTo(".",!0),fs.existsSync("old.package.json")&&fs.existsSync("package.json")){var a=JSON.parse(fs.readFileSync("package.json")),r=JSON.parse(fs.readFileSync("old.package.json")),l=a.dependencies,c=r.dependencies;_.assign(l,c),a.dependencies=l,fs.writeFileSync("package.json",JSON.stringify(a,null,"  ")),fs.unlinkSync("old.package.json")}else fs.existsSync("old.package.json")&&fs.renameSync("old.package.json","package.json");if(fs.unlinkSync(".preset.zip"),fs.existsSync(".preset-data.json")){var m=o.readJSON(".preset-data.json");fs.unlinkSync(".preset-data.json"),n.ok("Done extracting."),t(m)}else n.ok("Done extracting."),t(null)},C=function(e,t){p(e,function(){if(fs.existsSync(".preset-data.json")){var e=o.readJSON(".preset-data.json");fs.unlinkSync(".preset-data.json"),n.ok("Done downloading."),t(e)}else n.ok("Done downloading."),t(null)})};this.renderPages=function(e,t){n.ok("Rendering Pages\n"),u(function(o){glob("pages/**/*",function(o,s){s.forEach(function(e){if(fs.lstatSync(e).isDirectory())return!0;var t=e.replace("pages","./.build"),n=path.dirname(t),o=path.basename(t,path.extname(e)),s=path.extname(e);".html"===path.extname(e)&&"index"!==o&&"404.html"!==path.basename(t)&&-1===e.indexOf(".raw.html")&&(n=n+"/"+o,o="index"),-1!==o.indexOf(".raw")&&o.indexOf(".raw")===o.length-4&&".html"===s&&(o=o.slice(0,o.length-4)),t=n+"/"+o+path.extname(e),".html"===s||".xml"===s||".rss"===s||".xhtml"===s||".atom"===s||".txt"===s?k(e,t):(mkdirp.sync(path.dirname(t)),fs.writeFileSync(t,fs.readFileSync(e)))}),fs.existsSync("./libs/.supported.js")&&(mkdirp.sync("./.build/.wh/_supported"),fs.writeFileSync("./.build/.wh/_supported/index.html",fs.readFileSync("./libs/.supported.js"))),n.ok("Finished Rendering Pages\n"),t&&t(e)})})};var w={},y=function(e){if(w[e._type]||(w[e._type]={}),e.slug)return w[e._type][e.slug]=!0,e.slug;for(var t=slug(e.name).toLowerCase(),n=2;w[e._type][t];)t=slug(e.name).toLowerCase()+"_"+n,n++;return w[e._type][t]=!0,t};this.renderTemplates=function(e,t){n.ok("Rendering Templates"),w={},u(function(o,s){glob("templates/**/*.html",function(i,a){a.forEach(function(e){if(".html"===path.extname(e)&&0!==e.indexOf("templates/partials")){if(path.dirname(e).split("/").length<=1)return!0;var t=path.basename(e,".html"),i=path.dirname(e).replace("templates","./.build").split("/").slice(0,3).join("/"),a=path.dirname(e).split("/"),r=a[1],l=o[r],m=(s[r],path.dirname(e)),d=null;l||n.error("Missing data for content type "+r),l=_.map(l,function(e,t){return e._id=t,e._type=r,e});var f=_.filter(l,function(e){if(!e.publish_date)return!1;var t=Date.now(),n=Date.parse(e.publish_date);return n>t+6e4?!1:!0}),u="",h=null;s[r]&&s[r].controls.forEach(function(e){"layout"===e.controlType&&(h=e.name)});var g=null;if(s[r]&&s[r].customUrls&&s[r].customUrls.listUrl){var p=i.split("/");"#"===s[r].customUrls.listUrl?(g=p.join("/"),p.splice(2,1)):p[2]=s[r].customUrls.listUrl,i=p.join("/")}var v=i;if("list"===t)i+="/index.html",g&&(i=g+"/index.html"),k(e,i);else if("individual"===t){u=i;var b=u.replace("./.build","./.build/_wh_previews");for(var C in f){var $=f[C];h&&$[h]&&(d="templates/"+r+"/layouts/"+$[h]);var w=!0;$.slug?(u="./.build/"+$.slug+"/",w=!1):u=s[r]&&s[r].customUrls&&s[r].customUrls.individualUrl?v+"/"+utils.parseCustomUrl(s[r].customUrls.individualUrl,$)+"/":v+"/";var S="";S=$.slug?$.slug:y($),w?($.slug=u.replace("./.build/","")+S,i=u+S+"/index.html"):i=u+"index.html",fs.existsSync(d)?(k(d,i,{item:$}),d=null):k(e,i,{item:$})}for(var C in l){var $=l[C];h&&$[h]&&(d="templates/"+r+"/layouts/"+$[h]),i=b+"/"+$.preview_url+"/index.html",fs.existsSync(d)?(k(d,i,{item:$}),d=null):k(e,i,{item:$})}}else if(0!==m.indexOf("templates/"+r+"/layouts")){u=i;var x=m.replace("templates/"+r,"")+"/"+t;x=x.substring(1);for(var C in f){var $=f[C],w=!0;$.slug?(u="./.build/"+$.slug+"/",w=!1):u=s[r]&&s[r].customUrls&&s[r].customUrls.individualUrl?v+"/"+utils.parseCustomUrl(s[r].customUrls.individualUrl,$)+"/":v+"/";var S="";S=$.slug?$.slug:y($),w?($.slug=u.replace("./.build/","")+S,i=u+S+"/"+x+"/index.html"):i=u+x+"/index.html",k(e,i,{item:$})}}}}),n.ok("Finished Rendering Templates"),t&&t(e)})})},this.copyStatic=function(e){n.ok("Copying static"),fs.existsSync("static")&&(mkdirp.sync(".build/static"),wrench.copyDirSyncRecursive("static",".build/static",{forceDelete:!0})),e()};var S=function(e,t){var n=/^win/.test(process.platform);n?exec("rmdir /s /q "+e,function(n){n&&fs.existsSync(e)&&wrench.rmdirSyncRecursive(e),t()}):(fs.existsSync(e)&&wrench.rmdirSyncRecursive(e),t())};s.staticHashs=!1,s.changedStaticFiles=[];var x=function(){if(s.staticHashs={},s.changedStaticFiles=[],fs.existsSync(".build/static")){var e=wrench.readdirSyncRecursive(".build/static");e.forEach(function(e){var e=".build/static/"+e;if(!fs.lstatSync(e).isDirectory()){var t=md5(fs.readFileSync(e));s.staticHashs[e]=t}})}else s.staticHashs=!1,s.changedStaticFiles=[]};this.cleanFiles=function(e,t){n.ok("Cleaning files"),S(".build",function(){t&&t(),e&&e(!0)})};var I=async.queue(function(e,t){"static"===e.type?(x(),S(".build/static",function(){s.copyStatic(function(){s.reloadFiles(t)})})):s.realBuildBoth(function(){t()},s.reloadFiles)},1);this.buildBoth=function(e){I.push({type:"all"},function(t){e()})},this.buildStatic=function(e){I.push({type:"static"},function(t){e()})},this.realBuildBoth=function(e,t){s.cachedData=null,s.cleanFiles(null,function(){s.openSearchEntryStream(function(){s.renderTemplates(null,function(){s.copyStatic(function(){s.renderPages(function(){},function(){s.closeSearchEntryStream(function(){t(e)})})})})})})},this.checkScaffoldingMD5=function(e,t){s.cachedData=null,u(function(n,o){var s="templates/"+e+"/",i=s+"individual.html",a=s+"list.html",r="pages/"+e+".html",l=null,c=null,m=null;if(o[e].oneOff){if(fs.existsSync(r)){var d=fs.readFileSync(r);m=md5(d)}}else{if(fs.existsSync(i)){var f=fs.readFileSync(i);l=md5(f)}if(fs.existsSync(a)){var u=fs.readFileSync(a);c=md5(u)}}t(l,c,m)})},this.makeScaffolding=function(e,t,o){n.ok("Creating Scaffolding for "+e+"\n");var i="templates/"+e+"/",a=i+"list.html",r=i+"individual.html",l="pages/"+e+".html",c=fs.readFileSync("./libs/scaffolding_individual.html"),m=fs.readFileSync("./libs/scaffolding_list.html"),d=fs.readFileSync("./libs/scaffolding_oneoff.html"),f=[];fs.existsSync("./libs/widgets")&&(f=wrench.readdirSyncRecursive("./libs/widgets"));var h=[];f.forEach(function(e){h[(path.dirname(e)+"/"+path.basename(e,".html")).replace("./","")]=!0});var g=function(e,t,n,o){var s=[];n.controls&&_.each(n.controls,function(e){s[e.name]=e});var i=o||"item.",a=_.template(fs.readFileSync("./libs/widgets/"+e+".html"),{value:i+t,controlInfo:n,renderWidget:g,controls:s,widgetFiles:h}),r=a.split("\n"),l=[],c=!0;return r.forEach(function(e){if(c)c=!1,l.push(e);else{var t="        "+e;l.push(t)}}),l.join("\n")};return s.cachedData=null,u(function(s,f){var u=f[e]?f[e].controls:[],k={};_.each(u,function(e){k[e.name]=e});var p=null,v=null,b=null;if(f[e].oneOff){if(!o&&fs.existsSync(l))return t&&t(null,null,null),n.error("Scaffolding for "+e+" already exists, use --force to overwrite"),!1;var C=_.template(d,{widgetFiles:h,typeName:e,typeInfo:f[e]||{},controls:k},{imports:{renderWidget:g}});C=C.replace(/^\s*\n/gm,""),b=md5(C),fs.writeFileSync(l,C)}else{if(!o&&fs.existsSync(i))return t&&t(null,null,null),n.error("Scaffolding for "+e+" already exists, use --force to overwrite"),!1;mkdirp.sync(i);var $=_.template(c,{widgetFiles:h,typeName:e,typeInfo:f[e]||{},controls:k},{imports:{renderWidget:g}});$=$.replace(/^\s*\n/gm,""),p=md5($),fs.writeFileSync(r,$);var w=_.template(m,{typeName:e});v=md5(w),fs.writeFileSync(a,w)}t&&t(p,v,b)}),!0},this.reloadFiles=function(e){var t="true";if(s.staticHashs!==!1&&fs.existsSync(".build/static")){var n=wrench.readdirSyncRecursive(".build/static");n.forEach(function(e){var e=".build/static/"+e;if(!fs.lstatSync(e).isDirectory()){var t=md5(fs.readFileSync(e));t!==s.staticHashs[e]&&s.changedStaticFiles.push(e.replace(".build","")),e in s.staticHashs&&delete s.staticHashs[e]}});for(var o in s.staticHashs)s.changedStaticFiles.push(o.replace(".build",""));if(0===s.changedStaticFiles.length)return e&&e(!0),s.staticHashs=!1,void(s.changedStaticFiles=[]);t=s.changedStaticFiles.join(","),s.staticHashs=!1,s.changedStaticFiles=[]}request({url:"http://localhost:"+a+"/changed?files="+t,timeout:10},function(t,n,o){e&&e(!0)})},this.startLiveReload=function(){tinylr({liveCSS:!0,liveImg:!0}).listen(a)},this.sendSockMessage=function(e){r&&r.sendText("message:"+JSON.stringify(e))};var T=function(e,t,n,o,s){"function"==typeof o&&(s=o,o=!1);var i=spawn(e,n,{stdio:[process.stdin,o?"pipe":process.stdout,process.stderr],cwd:t}),a="";o&&i.stdout.on("data",function(e){a+=e}),i.on("close",function(){s(a)})},F=function(e){t.npmCache?T(t.npm||"npm",".",["config","get","cache"],!0,function(n){var o=n.trim();T(t.npm||"npm",".",["config","set","cache",t.npmCache],function(){T(t.npm||"npm",".",["install"],function(){T(t.npm||"npm",".",["config","set","cache",o],function(){e()})})})}):T(t.npm||"npm",".",["install"],function(){console.log("NPM done"),e()})};return this.webListener=function(){new websocketServer.createServer(function(e){r=e,e.on("close",function(){r=null}),e.on("error",function(){}),e.on("text",function(t){if(0===t.indexOf("scaffolding:")){var n=t.replace("scaffolding:","");s.makeScaffolding(n,function(t,n,o){e.sendText("done:"+JSON.stringify({individualMD5:t,listMD5:n,oneOffMD5:o}))})}else if(0===t.indexOf("scaffolding_force:")){var n=t.replace("scaffolding_force:","");s.makeScaffolding(n,function(t,n,o){e.sendText("done:"+JSON.stringify({individualMD5:t,listMD5:n,oneOffMD5:o}))},!0)}else if(0===t.indexOf("check_scaffolding:")){var n=t.replace("check_scaffolding:","");s.checkScaffoldingMD5(n,function(t,n,o){e.sendText("done:"+JSON.stringify({individualMD5:t,listMD5:n,oneOffMD5:o}))})}else if("reset_files"===t)v(function(t){t?e.sendText("done:"+JSON.stringify({err:"Error while resetting files"})):e.sendText("done")});else if("supported_messages"===t)e.sendText("done:"+JSON.stringify(["scaffolding","scaffolding_force","check_scaffolding","reset_files","supported_messages","push","build","preset","layouts","preset_localv2","generate_slug_v2"]));else if(0===t.indexOf("generate_slug_v2:")){var o=JSON.parse(t.replace("generate_slug_v2:","")),i=o.type,n=o.name,a=o.date;f(i,function(t){var o="";o=slug(n).toLowerCase(),t&&t.customUrls&&t.customUrls.individualUrl&&(o=utils.parseCustomUrl(t.customUrls.individualUrl,a)+"/"+o),o=t&&t.customUrls&&t.customUrls.listUrl?"#"===t.customUrls.listUrl?o:t.customUrls.listUrl+"/"+o:i+"/"+o,e.sendText("done:"+JSON.stringify(o))})}else if("build"===t)I.push({type:"all"},function(t){e.sendText("done")});else if(0===t.indexOf("preset_local:")){var r=t.replace("preset_local:","");if(!r)return void e.sendText("done");b(r,function(t){F(function(){e.sendText("done:"+JSON.stringify(t))})})}else if(0===t.indexOf("preset:")){var l=t.replace("preset:","");if(!l)return void e.sendText("done");C(l,function(t){F(function(){e.sendText("done:"+JSON.stringify(t))})})}else e.sendText("done")})}).listen(cmsSocketPort,"0.0.0.0")},this.init=function(t,n,o,s,i,a){var r=e.get("webhook"),l=fs.readFileSync("./libs/.firebase.conf.jst");(s||i)&&(l=fs.readFileSync("./libs/.firebase-custom.conf.jst"));var c=null;null!==r.noSearch&&"undefined"!=typeof r.noSearch&&(c=r.noSearch);var m=_.template(l,{secretKey:n,siteName:t,firebase:s,embedlyKey:r.embedly||"your-embedly-key",serverAddr:r.server||i||"your-server-address",noSearch:c,imageproxy:r.imageproxy||null});if(fs.writeFileSync("./.firebase.conf",m),o){var d=fs.readFileSync("./libs/cms.html"),f=_.template(d,{siteName:t});mkdirp.sync("./pages/"),fs.writeFileSync("./pages/cms.html",f)}a(!0)},this.assets=function(e,t){S(".whdist",function(){mkdirp.sync(".whdist");var n=wrench.readdirSyncRecursive("pages");n.forEach(function(e){var t="pages/"+e,n=".whdist/pages/"+e;if(!fs.lstatSync(t).isDirectory()){var o=fs.readFileSync(t);".html"===path.extname(t)&&(o=o.toString(),o=o.replace("\r\n","\n").replace("\r","\n")),mkdirp.sync(path.dirname(n)),fs.writeFileSync(n,o)}}),n=wrench.readdirSyncRecursive("templates"),n.forEach(function(e){var t="templates/"+e,n=".whdist/templates/"+e;if(!fs.lstatSync(t).isDirectory()){var o=fs.readFileSync(t);".html"===path.extname(t)&&(o=o.toString(),o=o.replace("\r\n","\n").replace("\r","\n")),mkdirp.sync(path.dirname(n)),fs.writeFileSync(n,o)}}),n=wrench.readdirSyncRecursive("static"),n.forEach(function(e){var t="static/"+e,n=".whdist/static/"+e;if(!fs.lstatSync(t).isDirectory()){var o=fs.readFileSync(t);".html"===path.extname(t)&&(o=o.toString(),o=o.replace("\r\n","\n").replace("\r","\n")),mkdirp.sync(path.dirname(n)),fs.writeFileSync(n,o)}}),e.task.run("useminPrepare"),e.task.run("assetsMiddle"),t()})},this.assetsMiddle=function(e){e.option("force",!0),_.isEmpty(e.config.get("concat"))||e.task.run("concat"),_.isEmpty(e.config.get("uglify"))||e.task.run("uglify"),_.isEmpty(e.config.get("cssmin"))||e.task.run("cssmin"),e.task.run("rev"),e.task.run("usemin"),e.task.run("assetsAfter")},this.assetsAfter=function(e,t){S(".tmp",function(){var e=wrench.readdirSyncRecursive("static");e.forEach(function(e){var t="static/"+e,n=".whdist/static/"+e;if(!fs.lstatSync(t).isDirectory()&&!fs.existsSync(n)){var o=fs.readFileSync(t);fs.writeFileSync(n,o)}}),t()})},this.enableStrictMode=function(){l=!0},this.enableProduction=function(){c=!0,swig.setDefaults({cache:"memory"})},this};